---
name: Рефакторинг привязок к персонам
overview: "Привести привязки «файл/прямоугольник → персона» к трём типам: (1) через кластер, (2) ручная к прямоугольнику, (3) прямая на файле. Удалить person_rectangles; рассмотреть удаление face_cluster_members с переносом cluster_id в photo_rectangles."
todos:
  - id: remove-person-rectangles
    content: Удалить таблицу person_rectangles и весь код, её использующий
    status: pending
  - id: consider-face-cluster-members
    content: Рассмотреть удаление face_cluster_members и перенос cluster_id в photo_rectangles
    status: pending
isProject: false
---

# Рефакторинг привязок к персонам

## Целевая модель: 3 типа привязки

1. **Через кластер** — прямоугольник в кластере, кластер привязан к персоне (сейчас: `photo_rectangles` → `face_cluster_members` → `face_clusters.person_id`).
2. **Ручная к прямоугольнику** — `photo_rectangles` + `person_rectangle_manual_assignments`.
3. **Прямая на файле** — `file_persons` (файл целиком → персона).

---

## Шаг 1: Удаление person_rectangles

**Исходные данные:** скрипт `backend/scripts/debug/analyze_person_rectangles.py` показал, что таблица **пуста** — миграция данных не нужна.

**Действия:**

1. **Схема БД ([backend/common/db.py](backend/common/db.py))**

- Убрать создание таблицы `person_rectangles` и индексов по ней из `_ensure_face_schema()` (или эквивалентного места инициализации).
- Либо один раз выполнить `DROP TABLE IF EXISTS person_rectangles` через миграционный скрипт.

2. **Код в db.py**

- Удалить методы: `insert_person_rectangle`, `delete_person_rectangle`, `list_person_rectangles`.
- Убрать из метода, собирающего персон по файлу (и аналогичных), любые обращения к `person_rectangles` и к перечисленным методам.

3. **API и роутеры**

- [backend/web_api/routers/faces.py](backend/web_api/routers/faces.py): убрать фильтры/счётчики/запросы по `person_rectangles`.
- [backend/web_api/routers/face_clusters.py](backend/web_api/routers/face_clusters.py): убрать статистику и запросы по `person_rectangles`, удалить/переписать API, которые создавали или читали «прямоугольники без лица» через эту таблицу.

4. **Шаблоны/JS**

- Убрать или переключить вызовы API, завязанные на `person_rectangles` (если есть).

5. **Диаграммы**

- [docs/diagrams/entities_as_is.puml](docs/diagrams/entities_as_is.puml): удалить класс `person_rectangles` и все связи с ним.

---

## Шаг 2: face_cluster_members — убрать как избыточную, перенести cluster_id в photo_rectangles

**Идея:** хранить принадлежность прямоугольника кластеру в самом `photo_rectangles` через колонку `cluster_id` (FK на `face_clusters.id`), таблицу `face_cluster_members` удалить.

**Отношение к шагу:** шаг считаю **разумным и допустимым**.

**Плюсы:**

- Меньше таблиц и один JOIN вместо двух при запросе «прямоугольник → персона по кластеру»: достаточно `photo_rectangles.cluster_id` → `face_clusters.person_id`.
- Схема проще: «у прямоугольника есть кластер» явно в той же сущности, где и сам прямоугольник.
- Объединение/расформирование кластеров по-прежнему сводится к массовому `UPDATE photo_rectangles SET cluster_id = ? WHERE cluster_id = ?` (или `NULL`), по смыслу то же, что сейчас делается через `face_cluster_members`.

**Минусы/риски:**

- Нужна миграция: для каждой строки в `face_cluster_members` выполнить `UPDATE photo_rectangles SET cluster_id = ? WHERE id = rectangle_id`, затем удалить таблицу и обновить все запросы.
- При очень больших объёмах один столбец в `photo_rectangles` увеличивает размер таблицы, но для типичного проекта это несущественно.

**Рекомендация:** делать **после** шага 1 (удаление `person_rectangles`). План работ по шагу 2:

1. Добавить в `photo_rectangles` колонку `cluster_id INTEGER NULL REFERENCES face_clusters(id)` (или аналог без явного FK, если в проекте так принято).
2. Миграционный скрипт: для всех записей из `face_cluster_members` выполнить `UPDATE photo_rectangles SET cluster_id = :cluster_id WHERE id = :rectangle_id`.
3. Удалить таблицу `face_cluster_members` (DROP или перестав создавать в миграциях).
4. Во всех местах, где использовались JOIN с `face_cluster_members`, заменить на использование `photo_rectangles.cluster_id` и JOIN с `face_clusters` по нему.
5. Обновить логику добавления/удаления прямоугольника в/из кластера: вместо INSERT/DELETE в `face_cluster_members` делать UPDATE `photo_rectangles.cluster_id`.
6. Обновить [docs/diagrams/entities_as_is.puml](docs/diagrams/entities_as_is.puml) (и при необходимости to-be): убрать `face_cluster_members`, у `photo_rectangles` показать связь с `face_clusters` через `cluster_id`.

В план действий этот шаг вносится как следующий после завершения удаления `person_rectangles`.