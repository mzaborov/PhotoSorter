---
name: Завершение UI сортировки исходной папки
overview: Реализация расширенной системы привязки файлов к персонам (3 способа), реорганизация закладок с подзакладками по персонам, улучшение работы с видео, и целевая сортировка по папкам.
todos:
  - id: db_schema
    content: "Создать таблицы: person_rectangles, file_persons, file_groups, file_group_persons в backend/common/db.py"
    status: completed
  - id: api_person_assignments
    content: "Реализовать API для 3 способов привязки к персоне: POST /api/persons/assign-rectangle, assign-file, remove-assignment"
    status: completed
  - id: faces_tab_rename
    content: Переименовать вкладку 'Есть лица' в 'Люди' в faces.html и faces.py
    status: pending
  - id: person_subtabs
    content: Реализовать подзакладки по персонам в закладке Люди (динамические на основе кластеров и назначений)
    status: pending
  - id: people_no_face_move
    content: "Перенести 'Люди без лица' в подзакладку 'Люди' -> 'К разбору' (вместе с файлами, где есть лица, но персона не назначена)"
    status: completed
  - id: quarantine_subtab
    content: "Перенести 'Карантин' в подзакладку 'Нет людей' -> 'К разбору' (или отдельная подзакладка 'Карантин')"
    status: completed
  - id: no_faces_rename
    content: Переименовать 'Нет лиц' в 'Нет людей'
    status: pending
  - id: file_groups_hierarchical
    content: Реализовать иерархические группы для Нет людей (Поездки, Мемы, Здоровье и т.д.)
    status: completed
  - id: multiple_persons_ui
    content: "Реализовать UI для режима 'несколько персон': галочка 'Персона не одна' (при включении - выбор нескольких персон чекбоксами за один сеанс), кнопка '+ Добавить персону'"
    status: pending
  - id: tab_switching_logic
    content: "Реализовать логику переключения закладок: файл пропадает с 'к разбору', появляется на подзакладках персон"
    status: pending
  - id: persons_list_stats
    content: "Рефакторинг списка персон: добавить колонки статистики по всем 3 способам привязки (Через лица, Через прямоугольники, Прямая привязка)"
    status: pending
  - id: person_detail_display
    content: "Рефакторинг карточки персоны: по умолчанию показывать единый список всех CROP (лица + прямоугольники) и файлов целиком; отдельные карточки по типам (кластеры лиц, прямоугольники без лиц, фотки); отображать все привязки файла"
    status: pending
  - id: sort_rules_folders
    content: Реализовать применение правил сортировки из folders к файлам прогона
    status: pending
  - id: local_sort_folders
    content: Реализовать локальную сортировку файлов по правилам в папки прогона
    status: pending
  - id: video_keyframes_improve
    content: Улучшить выбор ключевых кадров видео (приоритет кадров с лицами)
    status: pending
  - id: video_change_keyframe
    content: Реализовать смену ключевого кадра с автодетекцией лиц
    status: pending
  - id: video_face_marking_fix
    content: Исправить разметку лиц и прямоугольников на кадрах видео
    status: pending
  - id: move_to_archive
    content: "Реализовать перемещение отсортированных файлов в фотоархив на YaDisk с аккуратным переносом всех привязок (face_labels, person_rectangles, file_persons, file_groups) и миграцией в архивный режим"
    status: pending
  - id: update_diagrams
    content: "Обновить диаграммы сущностей: docs/diagrams/entities_as_is.puml и entities_to_be.puml (добавить таблицы person_rectangles, file_persons, file_groups, file_group_persons), перегенерировать PNG"
    status: pending
  - id: update_readme
    content: "Обновить docs/README.md: описать новые способы привязки к персоне, реорганизацию закладок, группы для 'Нет людей', целевую сортировку"
    status: pending
  - id: update_history
    content: "Добавить запись в History.log о завершении UI сортировки исходной папки с описанием всех изменений"
    status: pending
  - id: fix_face_detection_resume
    content: "Исправить проблему с resume детекции лиц: при resume файлы пропускаются, но face_rectangles не сохраняются (для прогона 26 нужно перезапустить детекцию или исправить логику)"
    status: pending
---

# План: Завершение UI сортировки исходной папки

## Цели и ключевые идеи

### Основная цель

Завершить разработку UI для сортировки исходной папки (прогон 26), обеспечив полноценную работу с привязкой файлов к персонам, удобную организацию закладок и автоматическую сортировку по правилам.

### Ключевой User Story

**Основной сценарий использования:**

1. **Указание исходной папки:** Пользователь указывает исходную папку, которую нужно отсортировать
2. **Работа с дубликатами:** Сортировщик-автомат показывает дубликаты, пользователь их просматривает и нажимает кнопку "Удалить"
3. **Автоматическая категоризация:** Сортировщик-автомат раскладывает файлы по категориям (лица, животные, нет людей и т.д.)
4. **Ручная проверка и уточнение:** Пользователь проходит по категориям и проверяет/уточняет автоматическую сортировку:

- Назначает персон (3 способами: через лица, через прямоугольники, напрямую)
- Группирует файлы "Нет людей" по категориям (поездки, мемы, здоровье и т.д.)
- Исправляет ошибки автоматической сортировки

5. **Завершение и отправка в архив:** Пользователь нажимает "Ручная сортировка завершена" — файлы уезжают в фотоархив на YaDisk
6. **Удаление мусора:** Все отфильтрованное удаляется как мусор (только то, что пользователь явно пометил для удаления)

**Важные принципы:**

- **Ничего не теряется:** Все файлы можно восстановить (кроме мусора, который пользователь явно сказал удалить)
- **Сохранение ручных операций:** Все ручные операции сохраняются в БД, можно восстановить сортировку по истории действий
- **Обучение системы (фантазия):** Сортировщик обучается на ручных правках, автоматическая сортировка становится точнее, количество ручных действий сокращается

### Ключевые идеи

1. **Три способа привязки к персоне:**

- Через лица (face_labels) — уже реализовано
- Через прямоугольники без лица (person_rectangles) — новый способ для случаев, когда человек виден, но лицо не распознано
- Прямая привязка файла к персоне (file_persons) — для случаев, когда на фото есть человек, но нет конкретного прямоугольника

2. **Гибкая система закладок:**

- "Люди" (бывшая "Есть лица") с подзакладками по персонам
- "Нет людей" (бывшая "Нет лиц") с иерархическими группами
- Динамические подзакладки на основе кластеров и назначений
- Логика "к разбору" для файлов без назначенных персон

3. **Режим "несколько персон на файл":**

- Файл может быть привязан к нескольким персонам одновременно
- Файл показывается на всех соответствующих подзакладках персон
- Галочка "Персона не одна" для контроля поведения при назначении

4. **Улучшение работы с видео:**

- Умный выбор ключевых кадров (приоритет кадров с лицами)
- Возможность смены ключевого кадра с автодетекцией
- Исправление разметки на кадрах

5. **Целевая сортировка:**

- Правила сортировки из таблицы `folders`
- Локальная сортировка в папки прогона
- Перемещение в фотоархив на YaDisk с заполнением метаданных

6. **UX принципы:**

- Файлы "улетают" на подзакладки персон при назначении (без дерганий)
- Файлы с "к разбору" просто пропадают при назначении персоны
- Файлы с подзакладки персоны удаляются при изменении/удалении привязки
- Интуитивный интерфейс для работы с несколькими персонами

## 1. Привязка фото к персоне (3 способа)

### 1.1. База данных ✅ ВЫПОЛНЕНО

**Новые таблицы:**

- ✅ `person_rectangles` — прямоугольники без лица, но с человеком:
  - `id`, `pipeline_run_id`, `file_path`, `frame_idx` (для видео), `bbox_x/y/w/h`, `person_id`, `created_at`
  - Создана в `backend/common/db.py` в методе `_ensure_face_schema()`
  - Индексы: `idx_person_rect_run`, `idx_person_rect_file`, `idx_person_rect_person`
- ✅ `file_persons` — простая привязка файла к персоне (без прямоугольника):
  - `pipeline_run_id`, `file_path`, `person_id`, `created_at`, PRIMARY KEY (pipeline_run_id, file_path, person_id)
  - Создана в `backend/common/db.py` в методе `_ensure_face_schema()`
  - Индексы: `idx_file_persons_run`, `idx_file_persons_file`, `idx_file_persons_person`
- ✅ `file_groups` — группы для файлов "Нет людей" (иерархические)
- ✅ `file_group_persons` — привязка персон к файлам в группах "Артефакты людей"

**Изменения в существующих таблицах:**

- `face_labels` — уже есть, используется для привязки через лица
- `files_manual_labels.people_no_face_person` — можно оставить для обратной совместимости, но основной механизм через `file_persons`

### 1.2. API для работы с привязками ✅ ВЫПОЛНЕНО

**Новые эндпойнты (реализованы в `backend/web_api/routers/face_clusters.py`):**

- ✅ `POST /api/persons/assign-rectangle` — назначить персону через прямоугольник без лица
  - Параметры: `pipeline_run_id`, `file_path`, `frame_idx` (опционально), `bbox_x/y/w/h`, `person_id`
  - Валидация параметров, проверка существования pipeline_run_id и person_id
- ✅ `POST /api/persons/assign-file` — назначить персону файлу напрямую (без прямоугольника)
  - Параметры: `pipeline_run_id`, `file_path`, `person_id`
- ✅ `POST /api/persons/remove-assignment` — удалить привязку (любого типа)
  - Параметры: `assignment_type` ("face"|"person_rectangle"|"file"), `person_id`, и дополнительные в зависимости от типа
- ✅ `GET /api/persons/file-assignments` — получить все привязки файла (лица + прямоугольники + файлы)
  - Параметры: `pipeline_run_id`, `file_path`
  - Возвращает структурированный ответ со всеми привязками

**Методы в FaceStore (реализованы в `backend/common/db.py`):**

- ✅ `insert_person_rectangle()` — вставка прямоугольника без лица
- ✅ `delete_person_rectangle()` — удаление прямоугольника
- ✅ `list_person_rectangles()` — список прямоугольников с фильтрами
- ✅ `insert_file_person()` — вставка прямой привязки файла
- ✅ `delete_file_person()` — удаление прямой привязки
- ✅ `list_file_persons()` — список прямых привязок
- ✅ `get_file_all_assignments()` — получение всех привязок файла (3 способа)
  - Обновлен для работы с `pipeline_run_id`: получает `face_run_id` из `pipeline_runs` для фильтрации `face_rectangles` по локальным прогонам

**Проверка детекции лиц:**
- ⚠️ **ПРОБЛЕМА:** Для прогона 26 в UI показывается 5090 файлов с лицами, но в `face_rectangles` для `run_id=27` только 4 записи
- Причина: при resume файлы пропускаются (если `faces_scanned_at` установлен), но `face_rectangles` не сохраняются
- Решение: нужно либо перезапустить детекцию лиц для прогона 26 (очистить `faces_scanned_at`), либо исправить логику resume
- ✅ Создан скрипт `backend/scripts/debug/check_pipeline_faces.py` для проверки детекции лиц

**Изменения существующих (TODO):**

- `POST /api/faces/assign-person` — расширить для поддержки режима "несколько персон" (флаг `allow_multiple`)

### 1.3. Отображение в UI

**Рефакторинг списка персон (`/persons`):**

- Добавить колонки статистики: "Через лица", "Через прямоугольники", "Прямая привязка"
- Показывать количество файлов по каждому способу привязки
- Обновить `backend/web_api/templates/persons_list.html` и соответствующий роутер

**Рефакторинг карточки персоны (`/persons/{person_id}`):**

- **По умолчанию:** показывать единый список всех CROP и файлов целиком:
  - CROP лиц (`face_rectangles`) — как сейчас
  - CROP прямоугольников без лиц (`person_rectangles`) — новое
  - Файлы целиком (для `file_persons` — привязка без прямоугольника) — новое
- **Отдельные карточки/представления по типам:**
  - "Кластеры лиц" — группировка похожих лиц (как сейчас)
  - "Прямоугольники без лиц" — все `person_rectangles` с этой персоной
  - "Фотки" — все файлы с прямой привязкой (`file_persons`)
- В карточке файла показывать все привязки (если файл привязан несколькими способами)
- Обновить `backend/web_api/templates/person_detail.html` и соответствующий роутер

## 2. Работа с видео

### 2.1. Улучшение выбора ключевых кадров

**Изменения:**

- В `backend/scripts/tools/video_keyframes.py` — улучшить алгоритм выбора кадров (искать кадры с лицами, избегать черных кадров)
- Добавить параметр `--prefer-faces` для приоритета кадров с лицами

### 2.2. Смена ключевого кадра с автодетекцией

**Новый API:**

- `POST /api/faces/video-change-keyframe` — изменить ключевой кадр для видео
- Параметры: `pipeline_run_id`, `path`, `frame_idx`, `auto_detect_faces` (bool)
- При `auto_detect_faces=true` — автоматически детектировать лица на новом кадре

**UI:**

- В модалке просмотра видео добавить кнопку "Изменить ключевой кадр"
- Показывать 3 кадра с возможностью выбора другого
- При выборе нового кадра — автоматически детектировать лица

### 2.3. Исправление разметки лиц и прямоугольников на кадрах

**Проблема:** Разметка может "съезжать" из-за изменения разрешения или ориентации кадра.

**Решение:**

- Использовать существующий `POST /api/faces/fix-clipping` (уже есть)
- Добавить автоматическую проверку при загрузке кадра (если координаты выходят за границы изображения — предупреждение)

### 2.4. Перекладывание видео в подзакладку при определении персоны

**Логика:**

- При назначении персоны видео (через любое из 3 способов) — файл автоматически появляется на подзакладке персоны
- Если персон несколько — файл показывается на всех соответствующих подзакладках

## 3. Реорганизация закладок

### 3.1. Структура базовых закладок

**Три базовые закладки (верхний уровень):**

1. **Люди** (бывшая "Есть лица")
2. **Животные** (оставляем как есть)
3. **Нет людей** (бывшая "Нет лиц")

### 3.2. Закладка "Люди"

**Переименование:**

- Вкладка "Есть лица" → "Люди"
- В `backend/web_api/routers/faces.py` и `backend/web_api/templates/faces.html`

**Подзакладки внутри "Люди":**

- **"К разбору"** — файлы без назначенных персон:
  - Есть лица, но персона не назначена
  - Есть люди без лиц (с `people_no_face_manual=1` или `person_rectangles` без `person_id`)
- **Подзакладки по каждой персоне** — динамические подзакладки для каждой персоны, у которой есть хотя бы один файл в прогоне (любым из 3 способов):
  - Через `face_labels`
  - Через `person_rectangles`
  - Через `file_persons`

**API для подзакладок:**

- `GET /api/faces/results` — добавить параметры `tab` ("people"), `subtab` ("to_review" или `person_id`) для фильтрации
- `GET /api/faces/person-subtabs` — получить список подзакладок персон для текущего прогона

**Логика отображения файлов:**

- Файл показывается на подзакладке "К разбору", если нет назначенных персон
- Файл показывается на подзакладке персоны, если:
  - Есть `face_labels` с этой персоной, ИЛИ
  - Есть `person_rectangles` с этой персоной, ИЛИ
  - Есть `file_persons` с этой персоной
- Файл с несколькими персонами показывается на всех соответствующих подзакладках

### 3.3. Закладка "Животные"

**Изменения:**

- Оставляем как есть (без изменений)

### 3.4. Закладка "Нет людей"

**Переименование:**

- Вкладка "Нет лиц" → "Нет людей"
- Вкладка "Карантин" → подзакладка "Нет людей" → "К разбору" (или отдельная подзакладка "Карантин")

**Подзакладки внутри "Нет людей":**

- **"К разбору"** — файлы без категории:
  - Нет категории (нет группы)
  - Карантин (`quarantine_manual=1` или `faces_auto_quarantine=1`)
  - Другие файлы без категории
- **Подзакладки по категориям** — иерархические группы:
  - Поездки (с подгруппами: 2023 Турция, 2024 Турция и т.д.)
  - Мемы
  - Здоровье
  - Чеки
  - Дом и ремонт
  - Артефакты людей (можно привязать персон)

**Группы для "Нет людей" (подзакладки по категориям):**

- Иерархическая структура групп:
  - Поездки
    - 2023 Турция
    - 2024 Турция
    - (другие поездки)
  - Мемы
  - Здоровье
  - Чеки
  - Дом и ремонт
  - Артефакты людей (можно привязать персон)

**База данных:**

- Таблица `file_groups`:
- `id`, `pipeline_run_id`, `file_path`, `group_path` (например, "Поездки/2023 Турция"), `created_at`
- PRIMARY KEY (pipeline_run_id, file_path, group_path)
- Таблица `file_group_persons` (для "Артефакты людей"):
- `pipeline_run_id`, `file_path`, `group_path`, `person_id`, `created_at`
- PRIMARY KEY (pipeline_run_id, file_path, group_path, person_id)

**API:**

- `POST /api/files/assign-group` — назначить группу файлу
- `GET /api/files/groups` — получить список групп для прогона
- `POST /api/files/assign-group-person` — привязать персону к файлу в группе "Артефакты людей"

**UI:**

- В закладке "Нет людей" показывать подзакладки по группам
- При клике на файл — выпадашка для выбора группы (как сейчас персоны в кластерах)
- Для "Артефакты людей" — дополнительно возможность выбрать персону

## 4. Режим "несколько персон на файл"

### 4.1. UI для назначения персон

**В выпадашке назначения персоны:**

- Галочка "Персона не одна" (по умолчанию выключена)
- **Если галочка выключена (по умолчанию):**
  - Выбор одной персоны (как сейчас) — файл улетает на подзакладку персоны
- **Если галочка включена:**
  - Показывать список персон с чекбоксами (множественный выбор)
  - Пользователь может выбрать несколько персон за один сеанс
  - Кнопка "Назначить" применяет все выбранные персоны сразу
  - Файл НЕ улетает с текущей подзакладки (остается на месте)
  - Файл появляется на всех подзакладках выбранных персон
- Кнопка "+ Добавить персону" (для закладок типа "персона") — открывает выпадашку с галочкой

**Логика переключения закладок:**

- Если закладка "к разбору" — при назначении персоны файл просто пропадает (без дерганий)
- Если закладка "персона" — при изменении/удалении персоны файл удаляется оттуда и появляется только у тех персон, что остались, или "к разбору" если персон нет

### 4.2. Отображение нескольких персон

**В карточке файла:**

- Показывать список всех назначенных персон (например, "Агата, Санек")
- Кнопка "+ Добавить персону" рядом со списком
- При клике на персону в списке — возможность удалить привязку

## 5. Целевая сортировка по папкам

### 5.1. Правила сортировки в Folders

**Изменения в таблице `folders`:**

- Уже есть поле `content_rule` — использовать для хранения правил
- Правила в формате JSON или текстовом формате (см. README)

**Примеры правил:**

- `только:[Агата] `→ `disk:/Фото/Агата`
- `вместе:[Агата, Санек, Нюся, Темка] `→ `disk:/Фото/Дети вместе`
- `содержит:[Миша, Аня] `→ `disk:/Фото/Миша и Аня`

### 5.2. Локальная сортировка

**Новый API:**

- `POST /api/pipeline/sort-to-folders` — применить правила сортировки к файлам прогона
- Параметры: `pipeline_run_id`, `dry_run` (bool)
- Логика:

1. Для каждого файла определяем персон (через все 3 способа)
2. Применяем правила из `folders` по приоритету
3. Перемещаем файлы в соответствующие папки локально (в рамках прогона)

**Изменения в `_determine_target_folder`:**

- Расширить логику для учета персон и правил из `folders`

### 5.3. Перекладывание в фотоархив

**Новый API:**

- `POST /api/pipeline/move-to-archive` — переместить файлы из локальной сортировки в фотоархив на YaDisk
- Параметры: `pipeline_run_id`, `dry_run` (bool)
- Логика:

1. Читаем файлы из отсортированных папок прогона
2. Для каждого файла определяем целевую папку в архиве по правилам
3. Загружаем файл на YaDisk в целевую папку
4. **Важно:** При переносе файлов в архив аккуратно переносить все привязки:
   - Обновить `file_path` в `face_labels` (через `face_rectangles`)
   - Обновить `file_path` в `person_rectangles`
   - Обновить `file_path` в `file_persons`
   - Обновить `file_path` в `file_groups` и `file_group_persons`
   - Мигрировать данные из прогона (`pipeline_run_id`) в архивный режим (`archive_scope='archive'`, `run_id=NULL`)
5. Заполняем метаданные (персоны, группы, даты и т.д.)

## Файлы для изменения

### База данных

- `backend/common/db.py` — добавление таблиц `person_rectangles`, `file_persons`, `file_groups`, `file_group_persons`

### API роутеры

- `backend/web_api/routers/faces.py` — изменения для подзакладок, групп, работы с видео
- `backend/web_api/routers/face_clusters.py` — расширение для режима "несколько персон"
- `backend/web_api/routers/persons.py` — новый роутер для работы с привязками персон (или расширение существующего)

### Шаблоны

- `backend/web_api/templates/faces.html` — реорганизация закладок, подзакладки по персонам, группы
- `backend/web_api/templates/person_detail.html` — отображение файлов по способам привязки
- `backend/web_api/templates/persons_list.html` — статистика по способам привязки

### Скрипты

- `backend/scripts/tools/video_keyframes.py` — улучшение выбора ключевых кадров
- `backend/scripts/tools/local_sort_by_faces.py` — интеграция с правилами сортировки

## Порядок реализации

1. ✅ **База данных** — создать новые таблицы и миграции (ВЫПОЛНЕНО)
2. ✅ **API для привязок** — реализовать 3 способа привязки к персоне (ВЫПОЛНЕНО)
3. **Реорганизация закладок** — переименование, подзакладки по персонам (В РАБОТЕ)
4. **Группы для "Нет людей"** — иерархические группы
5. **Режим "несколько персон"** — UI и логика
6. **Целевая сортировка (локальная)** — правила и локальная сортировка в папки прогона
7. **Работа с видео** — улучшение ключевых кадров, смена кадра, исправление разметки
8. **Целевая сортировка (финальная)** — перемещение отсортированных файлов в фотоархив на YaDisk
9. **Документация** — обновить диаграммы сущностей, README, History.log

## Документация

### Обновление диаграмм сущностей

**Файлы:**
- `docs/diagrams/entities_as_is.puml` — текущее состояние БД
- `docs/diagrams/entities_to_be.puml` — целевое состояние БД

**Изменения:**
- Добавить таблицы: `person_rectangles`, `file_persons`, `file_groups`, `file_group_persons`
- Показать связи между таблицами (FOREIGN KEY)
- Обновить связи с существующими таблицами (`persons`, `files`, `pipeline_runs`)

**Регенерация PNG:**
- После обновления `.puml` файлов запустить `python scripts/render_diagrams.py --in-dir docs/diagrams`
- Проверить обновление `entities_as_is.png` и `entities_to_be.png`

### Обновление README

**Файл:** `docs/README.md`

**Разделы для обновления:**
- **Распознавание лиц** — добавить описание 3 способов привязки к персоне
- **Требования к интерфейсу** — обновить описание закладок (Люди, Нет людей, подзакладки)
- **Результаты шагов конвейера** — обновить описание вкладок на `/faces`
- **Целевая сортировка** — добавить описание правил сортировки и перемещения в архив

### Обновление History.log

**Файл:** `History.log` (в корне проекта)

**Формат записи:**
```
YYYY-MM-DD HH:MM (+03:00)- Завершение UI сортировки исходной папки: <описание всех изменений>
```

**Что включить:**
- Добавление 3 способов привязки к персоне (через лица, через прямоугольники, прямая привязка)
- Реорганизация закладок (Люди, Нет людей, подзакладки по персонам)
- Иерархические группы для "Нет людей"
- Режим "несколько персон на файл"
- Улучшения работы с видео
- Целевая сортировка по правилам
