# Рефакторинг карточки фотографий

## Цель

Создать единый компонент карточки фотографий, который будет использоваться во всех местах проекта для отображения и редактирования фото с rectangles (квадратами лиц и людей).

## Места использования

- `backend/web_api/templates/faces.html` - основная страница с лицами (сортируемые фото)
- `backend/web_api/templates/person_detail.html` - карточка персоны (архивные + сортируемые)
- `backend/web_api/templates/face_cluster_detail.html` - детали кластера (архивные + сортируемые)

## Архитектура решения

### 1. Создание единого модуля карточки

**Файл:** `backend/web_api/static/photo_card.js`

Единый JavaScript модуль, который экспортирует функцию `openPhotoCard(options)` для открытия карточки.

#### 1.1 Параметры функции

```javascript
openPhotoCard({
  file_id: number | null,       // Опционально: ID файла из таблицы files (приоритет)
  file_path: string | null,     // Опционально: путь к файлу (fallback, для обратной совместимости)
  list_context: object | null,  // Опционально: контекст списка для навигации
  highlight_rectangle: object | null  // Опционально: rectangle для выделения
})
```

**Параметры:**

1. **`file_id: number | null`** (опционально, приоритет)

   - ID файла из таблицы `files` (результат миграции ЭТАП 1.2-1.3)
   - **Если передан `list_context`**: игнорируется, берется из `list_context.items[current_index].file_id`
   - **Если `list_context` нет**: приоритет над `file_path`
   - Используется для:
     - Всех API эндпойнтов (приоритет)
     - Определения режима (archive/sorting) через JOIN с `files`
   - **ОБНОВЛЕНО:** Миграция file_path → file_id выполнена. Используйте `file_id` для файлов из таблицы `files`.

2. **`file_path: string | null`** (опционально, fallback)

   - Путь к файлу (для обратной совместимости и файлов, которых нет в `files`)
   - Используется только если `file_id` не передан
   - Используется для:
     - Определения режима (archive/sorting) через проверку пути
     - Генерации URL для загрузки изображения
     - API эндпойнтов (fallback, если `file_id` не передан)

3. **`list_context: object | null`** (опционально)

   - Контекст списка для навигации между файлами
   - **Если передан**: `file_path` берется из `items[current_index].file_path`, навигация доступна
   - **Если не передан**: `file_path` обязателен, навигация недоступна
   - Структура:
     ```javascript
     {
       source_page: string,              // "faces" | "person_detail" | "face_cluster_detail"
       items: array,                     // Массив элементов для навигации
       current_index: number,            // Текущая позиция в items (0-based)
       total_count: number,              // Общее количество элементов (может быть > items.length)
       api_fallback: object | null       // Опционально: параметры для загрузки элементов за пределами items
     }
     ```

   - **`items: array`** - каждый элемент содержит:
     ```javascript
     {
       file_id: number | null,           // ID файла из files (приоритет, после миграции ЭТАП 1.2-1.3)
       file_path: string | null,         // Путь к файлу (fallback, для обратной совместимости)
       face_rectangle_id: number | null, // ID из face_rectangles (для выделения при открытии)
       person_rectangle_id: number | null // ID из person_rectangles (если есть)
       // Дополнительные данные из исходного API ответа (опционально)
     }
     ```

   - **`api_fallback: object | null`** - если навигация выходит за границы `items`:
     ```javascript
     {
       endpoint: string,                 // API эндпойнт (например, "/api/faces/results")
       params: object                    // Параметры запроса (pipeline_run_id, tab, subtab, etc.)
     }
     ```


4. **`highlight_rectangle: object | null`** (опционально)

   - Rectangle для выделения синим цветом при открытии карточки
   - Структура:
     ```javascript
     {
       type: "face_rectangle" | "person_rectangle",  // Тип rectangle
       id: number                                     // face_rectangle_id или person_rectangle_id
     }
     ```


#### 1.2 Автоматически вычисляемые значения

- **Режим** (archive/sorting):
  - Если передан `file_id`: определяется через JOIN с `files` (проверка `files.inventory_scope` или `files.path`)
  - Если передан только `file_path`: `archive` - если `file_path LIKE 'disk:/Фото%'`, иначе `sorting`

- **URL изображения**:
  - Генерируется автоматически из `file_path` внутри карточки
  - Для YaDisk: `/api/yadisk/preview-image?size=XL&path=...`
  - Для локальных: `/api/local/preview?path=...`
  - Не передается как параметр

- **`pipeline_run_id`**:
  - Для сортируемых файлов: из глобальной переменной на странице или из URL параметра
  - Для архивных файлов: не нужен (определяется по `file_path LIKE 'disk:/Фото%'`)

### 2. HTML структура карточки

**Файл:** `backend/web_api/templates/photo_card.html` (новый)

Единый HTML шаблон с:

- Заголовком с путем файла
- Кнопками действий (зависят от режима)
- Областью изображения с canvas для отрисовки rectangles
- Плашками со списком rectangles внизу
- Навигацией (стрелки влево/вправо, позиция "13 из 488")

### 3. Цвета и стили rectangles

- **Синий сплошной** - текущий rectangle (когда карточка открыта для конкретного rectangle)
- **Зеленый сплошной** - выделенный rectangle (при клике на плашку или rectangle для редактирования)
- **Желтый сплошной** - кластеры (не текущие, не выделенные)
- **Желтый прерывистой** - ручные привязки (не текущие, не выделенные)

### 4. Функциональность

#### 4.1 Отрисовка rectangles

- Все rectangles (кластеры + ручные) на одном фото
- Имя персоны на квадрате (если назначена)
- Клик по имени - переход на карточку персоны с нужной вкладкой (см. `.cursor/plans/рефакторинг_списка_и_карточки_персоны.plan.md`)
- Кнопка показать/скрыть квадраты

#### 4.2 Редактирование rectangles

- **Перемещение** - drag & drop rectangle
- **Изменение типа привязки** - переключение между "лицо" и "человек без лица"
- **Удаление** - удаление rectangle (с пометкой "не человек")
- **Добавление новых** - рисование нового rectangle (разных типов)
- **Назначение персоны** - назначить персону к квадрату, если она не назначена
- **Изменение персоны** - с переездом в другой кластер или превращением в ручную привязку

**Важное правило: взаимная исключительность привязок**

- Rectangle может принадлежать **либо кластеру, либо ручной привязке**, но не обоим одновременно
- При назначении персоны через ручную привязку:
  - Если rectangle находится в кластере - удалить из кластера (`face_cluster_members`)
  - Создать/обновить запись в `face_person_manual_assignments`
- При назначении персоны через кластер:
  - Если rectangle имеет ручную привязку - удалить из `face_person_manual_assignments`
  - Добавить в кластер через `face_cluster_members`
- При изменении типа привязки (кластер ↔ ручная):
  - Удалить старую привязку перед созданием новой
- Контроль на уровне API: проверять и очищать конфликтующие привязки

#### 4.3 Специальные действия

- Кнопка "Все остальные - посторонние" - назначает все неназначенные квадраты персоне "Посторонний"
- Кнопка - "Удалить  все не назначенные" (на любую персону включая "Посторонний" )
- Для сортируемых фото:
- "Это кот" - удаляет все квадраты, перемещает в группу "кот" на интерфейсе faces
- "Нет людей" - удаляет все квадраты, перемещает в группу "Нет людей"

#### 4.4 Контроль дубликатов

- Проверка: один человек не должен быть дважды на одном фото
- Warning: красный восклицательный знак (⚠) перед именем персоны на квадрате

#### 4.5 Плашки со списком rectangles

- Внизу карточки список всех rectangles
- Клик по плашке → подсветка rectangle на фото (зеленым)
- Клик по rectangle → подсветка плашки
- Кнопки действий в выпадашке на плашке

#### 4.6 Навигация по списку

- Стрелки влево/вправо для листания
- Позиция в списке (13 из 488) - отображается как `current_index + 1 из total_count`
- При навигации:
- Вычисляется новый индекс: `new_index = current_index ± 1`
- Если `new_index` в пределах массива `items` (0 <= new_index < items.length):
- Берется элемент из `items[new_index]`
- Открывается карточка для этого элемента с обновленным `current_index = new_index`
- Если `new_index` выходит за границы `items` и есть `api_fallback`:
- Вычисляется нужная страница: `page = Math.floor(new_index / page_size) + 1`
- Делается API запрос с параметрами из `api_fallback.params`, но с новой страницей
- Из ответа берется нужный элемент по индексу внутри страницы
- Открывается карточка для этого элемента
- Если `api_fallback` нет - навигация ограничена границами `items` (кнопки стрелок отключаются на границах)
- При закрытии - возврат к исходной закладке на позицию, до которой долистали в карточке:
  - Сохраняется `list_context` с обновленным `current_index` (который мог измениться при навигации в карточке)
  - Возврат на исходную страницу (`source_page`)
  - Восстановление вкладок/подвкладок из `list_context` (tab, subtab)
  - Прокрутка/позиционирование на элемент с индексом `current_index` в исходной таблице
  - Если `current_index` выходит за границы загруженных элементов - загрузить нужную страницу через `api_fallback` (если есть)

#### 4.7 UNDO

- История действий в рамках сессии карточки
- Кнопка UNDO для отмены последнего действия

### 5. API изменения

#### 5.1 Новые/обновленные эндпойнты

**Файл:** `backend/web_api/routers/faces.py`

- `GET /api/faces/rectangles` - расширить для поддержки всех типов rectangles:
- Добавить `assignment_type: "cluster" | "manual_face" | "person_rectangle"`
- Добавить `face_rectangle_id` и `person_rectangle_id` для каждого rectangle
- Добавить проверку дубликатов (`duplicate_person_ids` для каждого rectangle)
- Определять режим (archive/sorting) по `file_path` автоматически
- `POST /api/faces/rectangle/update` - обновление rectangle (координаты, тип, персона):
  - При изменении персоны контролировать взаимную исключительность:
    - Если создается ручная привязка - удалить rectangle из кластера (если был)
    - Если добавляется в кластер - удалить ручную привязку (если была)
- `POST /api/faces/rectangle/delete` - удаление rectangle
- `POST /api/faces/rectangles/assign-outsider` - назначить посторонним все неназначенные
- `POST /api/faces/file/mark-as-cat` - пометить как "кот" (для сортируемых)
- `POST /api/faces/file/mark-as-no-people` - пометить как "нет людей" (для сортируемых)
- `GET /api/faces/rectangles/duplicates-check` - проверка дубликатов персоны на фото

### 6. Интеграция в существующие страницы

#### 6.1 faces.html

**Файл:** `backend/web_api/templates/faces.html`

- Заменить существующий lightbox на вызов `openPhotoCard()`
- Вызов: `openPhotoCard({ list_context: {...}, highlight_rectangle: {...} })`
- `file_path` не передается, берется из `list_context.items[current_index].file_path`
- Формировать `list_context`:
  - `source_page: "faces"`
  - `items` - массив из `data.items`, каждый элемент:
    - `file_path: item.path`
    - `face_rectangle_id: null` (если открывается не из crop)
    - `person_rectangle_id: null`
    - Дополнительные данные из `item` (опционально)
  - `current_index` - вычисляется как `rowIndex - startRow`, где `startRow = (page - 1) * pageSize + 1`
  - `total_count` - из `data.total`
  - `api_fallback: { endpoint: "/api/faces/results", params: { pipeline_run_id, tab, subtab, sort, from, to, page_size: 60 } }`

#### 6.2 person_detail.html

**Файл:** `backend/web_api/templates/person_detail.html`

- Заменить существующий lightbox на вызов `openPhotoCard()`
- Вызов: `openPhotoCard({ list_context: {...}, highlight_rectangle: {...} })`
- `file_path` не передается, берется из `list_context.items[current_index].file_path`
- Формировать `list_context`:
  - `source_page: "person_detail"`
  - `items` - массив из `personData.faces` после фильтрации по `tab`/`subtab`, каждый элемент:
    - `file_path: face.file_path`
    - `face_rectangle_id: face.face_id` (API возвращает `face_id`, это алиас для `face_rectangles.id`)
    - `person_rectangle_id: null`
    - Дополнительные данные из `face` (опционально)
  - `current_index` - позиция в отфильтрованном массиве
  - `total_count` - `items.length`
  - `api_fallback: null`
- Поддержать переход на карточку персоны при клике на имя

#### 6.3 face_cluster_detail.html

**Файл:** `backend/web_api/templates/face_cluster_detail.html`

- Заменить существующий lightbox на вызов `openPhotoCard()`
- Вызов: `openPhotoCard({ list_context: {...}, highlight_rectangle: {...} })`
- `file_path` не передается, берется из `list_context.items[current_index].file_path`
- Формировать `list_context`:
  - `source_page: "face_cluster_detail"`
  - `items` - массив из ответа API кластера, каждый элемент:
    - `file_path: face.file_path`
    - `face_rectangle_id: face.face_id` (API возвращает `face_id`, это алиас для `face_rectangles.id`)
    - `person_rectangle_id: null`
    - Дополнительные данные из `face` (опционально)
  - `current_index` - позиция в массиве
  - `total_count` - `items.length`
  - `api_fallback: null`

### 7. Кнопка "Исправить клиппинг"

- Скрыть на уровне интерфейса (оставить в коде для возможного восстановления)

## Порядок выполнения

1. **Создание единого модуля** (`photo_card.js`) ✅ ЗАВЕРШЕНО

- ✅ Базовая структура карточки
- ✅ Отрисовка rectangles с правильными цветами
- ✅ Плашки со списком rectangles
- ✅ Поддержка file_id (приоритет) и file_path (fallback)
- ✅ Загрузка изображений (YaDisk и локальные)
- ✅ Загрузка rectangles через API `/api/faces/rectangles`
- ✅ Базовая навигация (структура готова, полная реализация в ЭТАП 2.4)

2. **API для редактирования** ✅ ЗАВЕРШЕНО

- ✅ Эндпойнты для обновления/удаления rectangles
- ✅ Контроль взаимной исключительности привязок (кластер ↔ ручная)
- ✅ Проверка дубликатов
- ✅ Специальные действия (кот, нет людей, посторонний)
- ✅ Все эндпойнты поддерживают file_id (приоритет) и file_path (fallback)

3. **Функциональность редактирования** ✅ ЗАВЕРШЕНО (частично)

- ✅ Drag & drop для перемещения (через якоря в режиме редактирования)
- ✅ Изменение типа привязки (кластер ↔ ручная)
- ✅ Изменение персоны
- ✅ Удаление rectangles
- ⚠️ Добавление новых rectangles (рисование) - отложено (требует доработки API)

4. **Навигация и UNDO** ✅ ЗАВЕРШЕНО

- ✅ Реализована логика навигации (см. раздел 4.6) с поддержкой api_fallback
- ✅ Сохранение контекста (для возврата при закрытии) в sessionStorage
- ✅ UNDO система для отмены действий (update, delete, assign, change_assignment_type)

5. **Интеграция в страницы** ✅ ЗАВЕРШЕНО

- ✅ faces.html - интегрирована единая карточка с list_context
- ✅ person_detail.html - интегрирована единая карточка с list_context
- ✅ face_cluster_detail.html - интегрирована единая карточка с list_context

6. **Тестирование и доработка**

- Проверка всех режимов
- Проверка всех типов rectangles
- Проверка навигации и UNDO

## Файлы для изменения

- `backend/web_api/static/photo_card.js` - новый файл, единый модуль карточки
- `backend/web_api/templates/photo_card.html` - новый файл, HTML структура
- `backend/web_api/routers/faces.py` - новые/обновленные API эндпойнты
- `backend/web_api/templates/faces.html` - интеграция единой карточки
- `backend/web_api/templates/person_detail.html` - интеграция единой карточки
- `backend/web_api/templates/face_cluster_detail.html` - интеграция единой карточки
- `backend/web_api/static/face_rectangles_viewer.js` - возможно, частичное использование или замена

## Примечания

- Сохранить обратную совместимость с существующими данными
- Кнопка "Исправить клиппинг" скрыта, но код оставлен
- Определение архива через `file_path LIKE 'disk:/Фото%'` (вычисляется автоматически, не передается как параметр)
- URL изображения генерируется автоматически из `file_path` внутри карточки (не передается как параметр)
- **Взаимная исключительность привязок**: rectangle может быть либо в кластере, либо иметь ручную привязку, но не оба одновременно. При изменении типа привязки старые привязки удаляются автоматически.
- `pipeline_run_id` вычисляется автоматически:
- Для сортируемых файлов: из глобальной переменной на странице (например, `pipelineRunId` в `faces.html`) или из URL параметра
- Для архивных файлов: не нужен (определяется по `file_path LIKE 'disk:/Фото%'`)
- `highlight_rectangle` может быть разных типов:
- `face_rectangle_id` - для rectangles из кластеров или ручных привязок
- `person_rectangle_id` - для rectangles без лица
- При вызове карточки нужно определить тип rectangle по контексту (откуда был клик: на crop из кластера или на person_rectangle)
- Поддержка всех типов привязки: кластеры, ручные привязки, person_rectangles, file_persons

## Известные ограничения архитектуры

- **ОБНОВЛЕНО: Миграция file_path → file_id выполнена (ЭТАП 1.2-1.3 Master Plan)**
  - Колонки `file_id` добавлены во все таблицы
  - Данные мигрированы: 54356 записей обновлено
  - Теперь можно использовать `file_id` для файлов из таблицы `files`
  - API эндпойнты должны быть обновлены для принятия `file_id` (приоритет) с fallback на `file_path` (обратная совместимость)
  - В рамках данного рефакторинга карточки фотографий используем `file_id` как приоритет, `file_path` как fallback