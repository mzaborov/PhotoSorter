---
name: Универсальная карточка видео
overview: Карточка видео по аналогии с карточкой фото — вкладки Видео/Кадр 1–3, rects, привязка лиц, кластеризация.
todos:
  - id: 1
    content: Создать video_card.html (разметка, вкладки Видео/Кадр 1–3, стили)
    status: completed
  - id: 2
    content: Создать video_card.js (openVideoCard, загрузка, переключение, рисование rects)
    status: completed
  - id: 3
    content: "Миграция БД: frame_idx, frame_t_sec в photo_rectangles; video_frame1–3_t_sec в files"
    status: pending
  - id: 4
    content: "Детекция лиц по видео: запись в photo_rectangles (пайплайн + скрипт)"
    status: pending
  - id: 5
    content: Интеграция в faces.html (замена openVideoViewer на openVideoCard)
    status: completed
  - id: A
    content: "A. Embeddings и кластеры ручных привязок в архиве (backfill + при загрузке)"
    status: completed
  - id: B
    content: "B. Кластеризация embeddings для видео и назначение персон"
    status: completed
isProject: true
---

# Универсальная карточка видео (по аналогии с карточкой фото)

План завершён 2026-02-09.

## Результат

- **video_card.html**, **video_card.js** — карточка видео с вкладками Видео/Кадр 1–3, отрисовка rects, привязка к персонам, person_name из кластера, кнопка «Досчитать embeddings».
- **face_recognition.py** — кластеризация лиц для видео (run_id=27), защита кластеров с person_id, progress_callback.
- **db.py** — `get_video_manual_frames` с JOIN на face_clusters, `upsert_video_manual_frame` без удаления всех rect.
- **main.py** — `POST /api/archive/backfill-manual-embeddings`.
- **folders.html** — блок «Ручные привязки в архиве», кнопка «Досчитать embeddings и кластеры».
- **Скрипты**: clusterize_faces, cleanup_video_rect_duplicates.

Задачи 3 и 4 (миграция БД frame_idx/frame_t_sec, детекция в пайплайне) — при необходимости в отдельном плане.
