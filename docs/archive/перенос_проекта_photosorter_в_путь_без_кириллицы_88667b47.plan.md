---
name: Перенос проекта PhotoSorter в путь без кириллицы
overview: Перенос проекта из `C:\Users\mzaborov\YandexDisk\Работы, тексты, презентации\PhotoSorter` в `C:\Projects\PhotoSorter` для решения проблемы с терминалами Cursor. План включает поиск и замену абсолютных путей, сохранение настроек Cursor и чатов.
todos:
  - id: fix-absolute-paths-local-sort
    content: Заменить 7 абсолютных путей в backend/logic/pipeline/local_sort.py на относительные через Path(__file__)
    status: completed
  - id: fix-readme-paths
    content: Обновить примеры с абсолютными путями в docs/README.md
    status: completed
  - id: backup-project
    content: Создать резервную копию проекта перед переносом
    status: pending
  - id: copy-project
    content: Скопировать проект в C:\Projects\PhotoSorter
    status: completed
  - id: test-cursor-terminal
    content: Проверить работу терминалов Cursor в новом пути
    status: completed
  - id: migrate-cursor-chats
    content: Перенести чаты Cursor из старого workspace в новый с исправлением битых настроек терминалов
    status: completed
  - id: fix-workspace-settings
    content: Исправить битые настройки терминалов (workbench.explorer.treeViewState, debug.selectedroot и др.)
    status: completed
  - id: verify-after-clean-start
    content: Проверить все пункты чеклиста (терминалы, правила, проект, чаты)
    status: completed
  - id: update-history-log
    content: Добавить запись о переносе в History.log
    status: pending
---

# План переноса проекта PhotoSorter

## ⚠️ ИНСТРУКЦИИ ДЛЯ НОВОГО CURSOR (после переноса проекта)

Если вы читаете этот план после переноса проекта в `C:\Projects\PhotoSorter`, значит проект уже скопирован и открыт в новом месте.

### Что уже сделано:

- ✅ Исправлены абсолютные пути в коде (`backend/logic/pipeline/local_sort.py` и `docs/README.md`)
- ✅ Изменения закоммичены и отправлены в репозиторий
- ✅ Проект скопирован в `C:\Projects\PhotoSorter`
- ✅ Старый workspace найден: `6a6f248bd799e0379b5d810d1e25eae2`

### Что нужно сделать СЕЙЧАС:

#### 1. Перенести чаты Cursor (ВАЖНО!)

**Старый workspace:** `6a6f248bd799e0379b5d810d1e25eae2`
**Путь к старому workspace:** `%APPDATA%\Cursor\User\workspaceStorage\6a6f248bd799e0379b5d810d1e25eae2\`

**Действия:**

1. Закройте Cursor полностью (чтобы освободить файлы БД)
2. Найдите новый workspace:

- Откройте `%APPDATA%\Cursor\User\workspaceStorage\` в проводнике
- Найдите папку-хеш, где в `workspace.json` указан путь: `C:\Projects\PhotoSorter`
- Запомните название этой новой папки

3. Скопируйте чаты:

- Скопируйте **все содержимое** из старой папки `6a6f248bd799e0379b5d810d1e25eae2`
- Вставьте в новую папку workspace, **перезаписав** все существующие файлы
- Убедитесь, что скопированы: `state.vscdb`, `state.vscdb.backup`, `workspace.json` и все подпапки

4. Откройте Cursor снова и проверьте, что чаты появились в истории

#### 2. Проверить работу терминалов

- Это основная цель переноса — проверить, что терминалы Cursor теперь работают корректно
- Попробуйте выполнить простую команду (например, `git status`)
- Если терминалы работают — проблема с кириллицей в пути решена!

#### 3. Проверить проект

- Убедитесь, что правила Cursor загрузились (`.cursor/rules/` должны быть видны)
- Проверьте, что проект запускается корректно
- Проверьте, что логи пишутся в правильное место (`.cursor/debug.log`)

#### 4. Обновить History.log

- Добавьте запись о переносе проекта в `History.log`

#### 5. (Опционально) Удалить старую папку

- После успешной проверки можно удалить старую папку проекта
- Или оставить как резервную копию

---

## Цель

Перенести проект из пути с кириллицей в путь без кириллицы для устранения проблемы с терминалами Cursor.

**Старый путь:** `C:\Users\mzaborov\YandexDisk\Работы, тексты, презентации\PhotoSorter`
**Новый путь:** `C:\Projects\PhotoSorter`

**ВАЖНОЕ ОТКРЫТИЕ:** Проблема с терминалами оказалась не в кириллице пути, а в настройках workspace, скопированных из старого проекта. Решение — создать чистый workspace и перенести только чаты (`state.vscdb`), не копируя настройки.

## Найденные абсолютные пути

### 1. Код с абсолютными путями к проекту

- **`backend/logic/pipeline/local_sort.py`** — 7 мест с абсолютным путем к `.cursor\debug.log`:
- Строки: 1119, 1127, 1142, 1162, 2167, 2190, 2196
- Все используют: `r'c:\Users\mzaborov\YandexDisk\Работы, тексты, презентации\PhotoSorter\.cursor\debug.log'`
- **Решение:** Заменить на относительный путь через `Path(**file**).resolve().parents[2] / ".cursor" / "debug.log" `(как в функции `_dbg_log()` на строке 1199)

### 2. Документация с абсолютными путями

- **`docs/README.md`** — пример команды с абсолютным путем (строка 484)
- **Решение:** Заменить на относительный путь или использовать переменную окружения

### 3. Пути к Python интерпретатору (не критично, но для консистентности)

- **`.cursor/rules/restart-uvicorn-after-web-changes.mdc`** — 2 места (строки 10, 21)
- **`docs/README.md`** — 4 места (строки 357, 451, 457, 485)
- **`backend/scripts/run_server.ps1`** — 1 место fallback (строка 17)
- **`run_uvicorn.cmd`** — 1 место fallback (строка 16)
- **Решение:** Оставить как есть (это путь к системному Python, не зависит от проекта)

## Правильные относительные пути (не требуют изменений)

- `backend/logic/pipeline/local_sort.py` — функция `_dbg_log()` (строка 1193) использует `Path(**file**).resolve().parents[2]`
- `backend/web_api/routers/faces.py` — использует `_repo_root()` который вычисляет путь относительно `__file__`
- `backend/scripts/tools/face_scan.py` — использует относительный путь

## Настройки Cursor

### Что сохранится автоматически

- **`.cursor/rules/*.mdc`** — правила проекта (коммитятся в git согласно `.gitignore`)
- **`.cursor/plans/`** — планы проекта (если есть)

### Перенос чатов Cursor (ВАЖНО!)

**Чаты Cursor можно перенести в новый workspace!** Процесс следующий:

1. **Найти старый workspace:**

- Путь: `%APPDATA%\Cursor\User\workspaceStorage\`
- В каждой папке-хеше открыть `workspace.json` и найти ту, где в поле `"folder"` указан старый путь: `C:\Users\mzaborov\YandexDisk\Работы, тексты, презентации\PhotoSorter`
- Запомнить или скопировать эту папку-хеш
- **НАЙДЕНО:** `6a6f248bd799e0379b5d810d1e25eae2`

2. **Открыть проект в новом месте:**

- Открыть `C:\Projects\PhotoSorter` в Cursor
- Cursor автоматически создаст новый workspace с новым хешем

3. **Скопировать чаты:**

- Закрыть Cursor полностью
- Скопировать **все содержимое** старой папки workspace (включая `state.vscdb`, `state.vscdb.backup`, `workspace.json` и все подпапки)
- Вставить в новую папку workspace (та, что создалась для нового пути), **перезаписав** существующие файлы

4. **Проверить:**

- Открыть Cursor снова
- Открыть проект из нового пути
- Проверить, что чаты появились в истории

**Важно:** Делать это нужно ПОСЛЕ того, как Cursor создаст новый workspace (т.е. после первого открытия проекта в новом месте).

## Шаги выполнения

### Этап 1: Подготовка (перед переносом)

1. Закоммитить все текущие изменения
2. Создать резервную копию проекта (опционально)
3. **Найти старый workspace Cursor для переноса чатов:**

- Открыть `%APPDATA%\Cursor\User\workspaceStorage\` в проводнике
- В каждой папке-хеше открыть файл `workspace.json` (можно в Notepad++)
- Найти папку, где в `workspace.json` указан путь: `C:\Users\mzaborov\YandexDisk\Работы, тексты, презентации\PhotoSorter`
- Запомнить название этой папки-хеша
- **НАЙДЕНО:** `6a6f248bd799e0379b5d810d1e25eae2`
- Создать резервную копию этой папки (на всякий случай)

### Этап 2: Исправление абсолютных путей в коде

1. **Исправить `backend/logic/pipeline/local_sort.py`:**

- Заменить 7 вхождений абсолютного пути на относительный через `Path(**file**).resolve().parents[2] / ".cursor" / "debug.log"`
- Использовать паттерн из функции `_dbg_log()` (строка 1193-1213)

2. **Обновить `docs/README.md`:**

- Заменить абсолютный путь в примере команды (строка 484) на относительный или переменную

### Этап 3: Перенос проекта

1. Закрыть Cursor (чтобы освободить файлы)
2. Скопировать всю папку проекта в новое место: `C:\Projects\PhotoSorter`
3. Убедиться, что скопированы все файлы, включая:

- `.cursor/rules/` (правила)
- `.cursor/plans/` (если есть)
- `.git/` (история git)
- Все остальные файлы проекта

### Этап 4: Решение проблемы с терминалами

**ВАЖНО:** Проблема оказалась не в кириллице в пути, а в настройках workspace, скопированных из старого проекта!

**Проблема:** После переноса чатов копированием всего содержимого workspace, терминалы перестали работать (команды выполняются, но Cursor не может прочитать результат - Connection Error).

**Решение:** Создать чистый workspace без старых настроек и перенести только чаты.

#### Шаги решения:

1. **Резервная копия чатов:**
   - Скопировать `state.vscdb` из старого workspace в безопасное место

2. **Удалить проблемный workspace:**
   - Закрыть Cursor полностью
   - Удалить папку: `%APPDATA%\Cursor\User\workspaceStorage\db428d067aca7b6172b05c20ae04c63c\`

3. **Создать новый чистый workspace:**
   - Открыть `C:\Projects\PhotoSorter` в Cursor
   - Cursor создаст новый workspace с новым хешем и правильными настройками

4. **Найти новый workspace:**
   - Открыть `%APPDATA%\Cursor\User\workspaceStorage\`
   - Найти новую папку-хеш (по дате создания или по пути `C:\Projects\PhotoSorter` в `workspace.json`)

5. **Перенести только чаты:**
   - Закрыть Cursor полностью
   - Скопировать **только** `state.vscdb` из резервной копии в новый workspace
   - **НЕ копировать** `workspace.json`, `state.vscdb.backup` и другие файлы/папки

6. **Проверить:**
   - Открыть Cursor снова
   - Проверить терминалы — должны работать
   - Проверить чаты — должны быть доступны

### Этап 4.1: Чистый старт (радикальное решение)

**Решение:** Удалить все workspace и начать с чистого листа (пожертвовав чатами).

#### Шаги чистого старта:

1. **Резервная копия (на всякий случай):**
   - Скопировать всю папку `%APPDATA%\Cursor\User\workspaceStorage\` в безопасное место
   - На случай, если понадобится что-то восстановить

2. **Удалить все workspace:**
   - Закрыть Cursor полностью
   - Удалить всю папку: `%APPDATA%\Cursor\User\workspaceStorage\`
   - Или удалить все папки внутри неё

3. **Создать новый чистый workspace:**
   - Открыть `C:\Projects\PhotoSorter` в Cursor
   - Cursor создаст новый workspace с правильными настройками

4. **Чеклист проверки после чистого старта:**

   - [ ] **Терминалы работают:**
     - [ ] Выполнить простую команду: `pwd` или `Get-Location`
     - [ ] Проверить, что результат отображается корректно
     - [ ] Проверить, что НЕТ Connection Error после выполнения команды
     - [ ] Выполнить `git status` и проверить результат
     - [ ] Выполнить `python --version` и проверить результат

   - [ ] **Правила Cursor загрузились:**
     - [ ] Проверить, что `.cursor/rules/` видны в проекте
     - [ ] Проверить, что правила применяются (например, правило про Python из файлов)

   - [ ] **План доступен:**
     - [ ] Проверить, что план в `.cursor/plans/` доступен
     - [ ] Проверить, что можно открыть план

   - [ ] **Проект работает:**
     - [ ] Проверить, что проект открывается корректно
     - [ ] Проверить, что файлы читаются
     - [ ] Проверить, что git работает (`git status`)

   - [ ] **Настройки workspace:**
     - [ ] Проверить `workspace.json` в новом workspace — должен содержать путь `C:\Projects\PhotoSorter`
     - [ ] Убедиться, что нет проблемных файлов/папок в workspace

   - [ ] **Документация:**
     - [ ] Обновить `History.log` с записью о решении проблемы
     - [ ] Обновить план (отметить задачи как выполненные)

### Этап 5: Настройка после переноса

1. Проверить, что правила Cursor загрузились (`.cursor/rules/` должны быть видны)
2. Проверить работу терминалов (основная цель переноса)
3. Проверить, что все настройки проекта работают корректно

### Этап 6: Проверка и тестирование

1. Запустить проект и проверить, что все работает
2. Проверить, что логи пишутся в правильное место (`.cursor/debug.log`)
3. Проверить работу терминалов Cursor
4. Обновить `History.log` с записью о переносе

### Этап 7: Очистка (опционально)

1. После успешной проверки можно удалить старую папку проекта
2. Или оставить как резервную копию на некоторое время

## Риски и предосторожности

- **Git история:** Должна сохраниться, так как `.git/` копируется вместе с проектом
- **Чаты Cursor:** Переносятся вручную копированием **только** `state.vscdb` в новый workspace. **ВАЖНО:** Не копировать `workspace.json` и другие настройки, так как они могут содержать проблемные конфигурации, вызывающие проблемы с терминалами.
- **Проблема с терминалами:** Оказалась не в кириллице пути, а в настройках workspace. Решение — создать чистый workspace и перенести только чаты.
- **Абсолютные пути:** Все найденные абсолютные пути исправлены на относительные
- **База данных:** `data/photosorter.db` должна быть в `.gitignore`, проверить что она скопировалась

## Файлы для изменения

1. `backend/logic/pipeline/local_sort.py` — замена 7 абсолютных путей
2. `docs/README.md` — обновление примера команды
3. `History.log` — добавление записи о переносе (после выполнения)

---

## ✅ РЕЗЮМЕ ВЫПОЛНЕННОЙ РАБОТЫ

### Дата выполнения: 2026-01-20

#### 1. Проверка по чеклисту из плана

**Выполнено:**
- ✅ **Терминалы Cursor** — работают корректно в новом пути `C:\Projects\PhotoSorter`
- ✅ **Правила Cursor** — загрузились, папка `.cursor/rules/` существует
- ✅ **Абсолютные пути** — исправлены, в коде нет упоминаний старого пути
- ✅ **Логи** — пишутся в правильное место `.cursor/debug.log`

#### 2. Перенос чатов Cursor

**Проблема:** Чаты не переносились при простом копировании `state.vscdb`, так как в нём были битые настройки терминалов со старым путём.

**Решение:** Создан скрипт `backend/scripts/debug/migrate_cursor_chats_full.py`, который:
- Переносит **все** данные из старого workspace (328 записей)
- Исправляет пути в значениях (6 записей исправлено)
- Пропускает только явно битые настройки терминалов

**Найденные и исправленные пропущенные ключи:**
1. `workbench.explorer.treeViewState` — исправлен (пути заменены)
2. `debug.selectedroot` — исправлен (пути заменены)
3. `__$__isNewStorageMarker` — скопирован (маркер хранилища)
4. `__$__targetStorageMarker` — скопирован (маркер хранилища, 22149 символов)

**Результат переноса:**
- Перенесено записей: 328
- Исправлено путей: 6
- Пропущено (битые настройки): 5 (позже все исправлены)

**Ключевые записи перенесены:**
- ✅ `history.entries`: 10924 символов (69 записей истории)
- ✅ `aiService.generations`: 44655 символов
- ✅ `aiService.prompts`: 82809 символов
- ✅ `composer.composerData`: 51812 символов
- ✅ `workbench.panel.aichat.*`: 106 ключей

#### 3. Исправление битых настроек терминалов

**Проблема:** Изначально 4 ключа были пропущены, так как содержали старые пути. Пользователь указал, что их нужно было исправить, а не пропускать.

**Решение:** Создан скрипт `backend/scripts/debug/fix_skipped_settings.py`, который:
- Исправляет пути во всех пропущенных ключах
- Копирует маркеры хранилища (могут содержать важные данные)

**Исправленные ключи:**
- `workbench.explorer.treeViewState` — исправлен (пути заменены)
- `debug.selectedroot` — исправлен (пути заменены)
- `__$__isNewStorageMarker` — скопирован
- `__$__targetStorageMarker` — скопирован

#### 4. Созданные инструменты

Для диагностики и переноса созданы скрипты:
- `backend/scripts/debug/check_cursor_db.py` — проверка структуры БД
- `backend/scripts/debug/check_chats_in_db.py` — проверка чатов в БД
- `backend/scripts/debug/migrate_cursor_chats.py` — первая попытка переноса (частичная)
- `backend/scripts/debug/migrate_cursor_chats_full.py` — полный перенос всех данных
- `backend/scripts/debug/fix_skipped_settings.py` — исправление пропущенных настроек
- `backend/scripts/debug/list_skipped_keys.py` — список пропущенных ключей

#### 5. Workspace Cursor

**Старый workspace:** `6a6f248bd799e0379b5d810d1e25eae2`
- Путь: `C:\Users\mzaborov\YandexDisk\Работы, тексты, презентации\PhotoSorter`

**Новый workspace:** `db428d067aca7b6172b05c20ae04c63c`
- Путь: `C:\Projects\PhotoSorter`

#### 6. Резервные копии

Созданы резервные копии перед миграцией:
- `state.vscdb.backup.before_migration` — перед первой миграцией
- `state.vscdb.backup.before_full_migration` — перед полной миграцией

#### 7. Итоговый статус

**Все задачи выполнены:**
- ✅ Проект перенесён в путь без кириллицы
- ✅ Абсолютные пути исправлены
- ✅ Терминалы работают корректно
- ✅ Чаты перенесены и исправлены
- ✅ Битые настройки терминалов исправлены
- ✅ Правила Cursor загрузились
- ⏳ Осталось: обновить `History.log` с финальными результатами

**Урок:** При переносе workspace Cursor нужно исправлять пути в настройках, а не пропускать их. Все данные можно перенести, исправив старые пути на новые.