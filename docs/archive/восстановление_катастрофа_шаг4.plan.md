---
name: ""
overview: ""
todos: []
isProject: false
---

# План восстановления после катастрофы (шаг 4 с apply вместо dry-run)

**Цель:** восстановить связь записей в БД с файлами на диске. **Ничего не удалять и не помечать как deleted** — только находить файлы на диске и обновлять поле `path` в БД.

**Причина катастрофы:** кнопка «Досортировка» (только шаг 4) всегда запускала шаг с `--apply`, из‑за чего файлы физически переместились. Для многих записей в `files` поле `path` не обновилось (процесс прервался, database locked и т.п.). В итоге тысячи записей указывают на несуществующий путь — это не «потеря файлов», а потеря **связи** записей БД с реальным расположением файлов.

---

## Принципы плана

1. **Действовать медленно:** сначала диагностика (сколько файлов, сколько разъехалось), потом восстановление.
2. **Только восстановление:** обновлять `path` в БД, чтобы он указывал на фактическое расположение файла на диске.
3. **Никакого удаления:** не удалять записи из БД, не ставить `status='deleted'` для «ненайденных».
4. **Поиск файлов на диске:** под корнем прогона ищем файлы по совпадению (имя+размер), по имени (если размер в БД NULL), при необходимости по хешу.

---

## Фаза 0: Диагностика (сначала понять масштаб)

Перед любым восстановлением нужно понять:

1. **Сколько у нас реально файлов: на диске и в БД**
  - На диске: число файлов под корнем прогона (например `C:\tmp\Photo`), рекурсивно.
  - В БД: число записей в `files`, у которых `path` под тем же корнем (например `path LIKE 'local:C:\tmp\Photo\%'`).
2. **Сколько из них разъехалось**
  - Записи в БД, у которых `path` указывает на несуществующий файл (файл по этому пути не найден на диске) — это «разъехавшиеся» записи.
  - Опционально: файлы на диске, для которых в БД нет записи с таким путём (если нужно считать «только на диске»).

**Как получить числа:** скрипт `backend/scripts/debug/count_files_disk_vs_db.py`:

```powershell
python backend/scripts/debug/count_files_disk_vs_db.py --pipeline-run-id 26
```

Вывод: `файлов на диске`, `записей в БД под корнем`, `из них path не на диске (разъехались)`.

После получения чисел — зафиксировать в плане или в заметках и переходить к фазе восстановления только когда масштаб понятен.

---

## Шаги восстановления (после диагностики)

### Шаг 1. Reconcile: поиск по (имя, размер)

Скрипт `backend/scripts/debug/reconcile_paths_with_disk.py` ищет под корнем прогона файлы с тем же именем и размером, что в БД, и обновляет `path` в таблице `files` (и связанные таблицы).

- Запуск (сначала dry-run, потом без):

```powershell
  python backend/scripts/debug/reconcile_paths_with_disk.py --pipeline-run-id 26 --dry-run
  python backend/scripts/debug/reconcile_paths_with_disk.py --pipeline-run-id 26
  

```

- Ограничение: если в БД у записи `size = NULL`, ключ (имя, -1) не совпадает с диском (там реальный размер). Поэтому многие записи «не найдены» — нужен шаг 2.

### Шаг 2. Reconcile: fallback по имени

В том же скрипте добавлен fallback: когда по (имя, размер) совпадений нет, ищем **все** файлы под корнем с таким же именем. Если найден **ровно один** — обновляем `path` на него. Так восстанавливаются записи с `size = NULL` и случаи, когда размер в БД не совпадает с диском при одном имени.

### Шаг 3. Reconcile: поиск по хешу (опционально)

Для записей, которые так и остались «ненайденными», но в БД есть `hash_value`, можно искать файл на диске по хешу:

```powershell
python backend/scripts/debug/reconcile_paths_with_disk.py --pipeline-run-id 26 --by-hash
```

### Шаг 4. Заполнить target_folder для отчёта (обязательно)

**Всё, что перемещено в целевые папки**, должно иметь в БД заполненное поле `target_folder`, иначе в отчёте шага 4 эти файлы не отображаются. Скрипт `refresh_report_target_folders.py` заполняет `target_folder` по правилам для каждого файла под корнем, существующего на диске.

```powershell
python backend/scripts/debug/refresh_report_target_folders.py --pipeline-run-id 26 --dry-run
python backend/scripts/debug/refresh_report_target_folders.py --pipeline-run-id 26
```

### Шаг 5. Проверка

- Открыть отчёт шага 4 по прогону.
- При необходимости: `python backend/scripts/debug/diagnose_target_folder_report.py --pipeline-run-id 26`

---

## Что уже исправлено (чтобы не повторялось)

- **Шаг 4 учитывает apply прогона:** при dry-run досортировка больше не перемещает файлы (`backend/web_api/routers/local_pipeline.py`).

---

## Чего в плане нет (намеренно)

- Нет шагов «пометить записи как deleted» или «удалить записи с битым путём». Оставшиеся ненайденные записи остаются в БД.

---

## Итог

1. **Диагностика:** сколько файлов на диске, сколько в БД, сколько разъехались.
2. Reconcile по (имя, размер) → по имени → при необходимости по хешу (`--by-hash`).
3. Заполнить target_folder (`refresh_report_target_folders.py`).
4. Проверка по отчёту.

