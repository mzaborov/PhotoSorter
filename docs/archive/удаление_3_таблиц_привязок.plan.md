---
name: Удаление 3 таблиц привязок
overview: Удаление таблиц person_rectangles, face_cluster_members и person_rectangle_manual_assignments с сохранением существенных данных (перенос cluster_id и manual_person_id в photo_rectangles). CHECK: у прямоугольника только один способ привязки к персоне. Перед миграцией — свежий бекап, проверка целостности бекапа, удаление всех старых бекапов.
todos:
  - id: backup-and-verify
    content: Сделать свежий бекап (backup_database.py), проверить целостность (PRAGMA integrity_check/foreign_key_check)
    status: pending
  - id: cleanup-old-backups
    content: Удалить все старые бекапы из data/backups/, оставив только свежий
    status: pending
  - id: remove-person-rectangles
    content: Удалить таблицу person_rectangles и весь код, её использующий
    status: pending
  - id: migrate-face-cluster-members
    content: Перенести face_cluster_members в photo_rectangles.cluster_id, DROP таблицы, обновить код
    status: pending
  - id: migrate-person-rectangle-manual
    content: Перенести person_rectangle_manual_assignments в photo_rectangles.manual_person_id, DROP таблицы, обновить код
    status: pending
  - id: add-check-rect-one-source
    content: Добавить CHECK (cluster_id IS NULL OR manual_person_id IS NULL) в photo_rectangles
    status: pending
  - id: update-diagrams
    content: Обновить entities_as_is.puml и перегенерировать PNG
    status: pending
isProject: false
---

# Удаление 3 таблиц привязок с сохранением данных

## Перед миграцией (обязательный порядок)

### 1. Свежий бекап и проверка целостности

- **Создать бекап:**  
`python backend/scripts/tools/backup_database.py`
Файл появится в `data/backups/photosorter_backup_YYYYMMDD_HHMMSS.db`.

- **Проверить, что бекап целый:**
- Открыть файл бекапа в SQLite и выполнить `PRAGMA integrity_check;` — ожидается `ok`.
- Выполнить `PRAGMA foreign_key_check;` — пустой результат.
- (Опционально) Сравнить размер с исходной БД и/или количество строк в ключевых таблицах (`photo_rectangles`, `face_cluster_members`, `person_rectangle_manual_assignments`).
- Логику можно взять из `backend/scripts/migration/rename_rectangles_tables.py` (функция `check_integrity`), при необходимости вынести в маленький скрипт `backend/scripts/debug/verify_backup_integrity.py`, принимающий путь к `.db`.

- **Не продолжать миграцию,** пока бекап не создан и проверка не пройдена.

### 2. Удаление старых бекапов

- **После** успешной проверки свежего бекапа удалить все остальные файлы в `data/backups/` (все старые бекапы).
- В папке должен остаться только один актуальный бекап перед миграцией.

---

## Три таблицы и действия

| Таблица | Данные | Действие |
|--------|--------|----------|
| **person_rectangles** | Пуста | DROP таблицы и удаление всего кода (миграция данных не нужна). |
| **face_cluster_members** | Есть | Добавить в `photo_rectangles` колонку `cluster_id`, перенести данные, DROP таблицы, обновить код. |
| **person_rectangle_manual_assignments** | Есть | Добавить в `photo_rectangles` колонку `manual_person_id` (и при необходимости `manual_source`/`manual_created_at`), перенести данные, DROP таблицы, обновить код. |

---

## Шаг 1: Удаление person_rectangles

- Таблица пуста (подтверждено `backend/scripts/debug/analyze_person_rectangles.py`). Миграция данных не нужна.
- **Схема:** в [backend/common/db.py](backend/common/db.py) убрать создание таблицы `person_rectangles` и индексы; выполнить `DROP TABLE IF EXISTS person_rectangles` (миграция или разовый скрипт).
- **Код в db.py:** удалить `insert_person_rectangle`, `delete_person_rectangle`, `list_person_rectangles` и все обращения к `person_rectangles` (в т.ч. в методе персон по файлу).
- **Роутеры:** [backend/web_api/routers/faces.py](backend/web_api/routers/faces.py), [backend/web_api/routers/face_clusters.py](backend/web_api/routers/face_clusters.py) — убрать использование `person_rectangles`.
- **Диаграмма:** в [docs/diagrams/entities_as_is.puml](docs/diagrams/entities_as_is.puml) удалить класс `person_rectangles` и связи с ним.

---

## Шаг 2: face_cluster_members → photo_rectangles.cluster_id

- **Схема:** добавить в `photo_rectangles` колонку `cluster_id INTEGER NULL REFERENCES face_clusters(id)` (или без явного FK, если в проекте так принято).
- **Миграция:** для каждой строки в `face_cluster_members` выполнить `UPDATE photo_rectangles SET cluster_id = :cluster_id WHERE id = :rectangle_id`.
- CHECK для взаимоисключения с manual_person_id добавляется после шага 3 (см. ниже).
- **Удаление:** DROP таблицы `face_cluster_members` и её индексов; убрать создание таблицы в db.py.
- **Код:** везде заменить JOIN с `face_cluster_members` на использование `photo_rectangles.cluster_id` и JOIN с `face_clusters`. Добавление/удаление прямоугольника в/из кластера — через UPDATE `photo_rectangles.cluster_id`. Ключевые места: [backend/common/db.py](backend/common/db.py), [backend/web_api/routers/faces.py](backend/web_api/routers/faces.py), [backend/web_api/routers/face_clusters.py](backend/web_api/routers/face_clusters.py), [backend/logic/face_recognition.py](backend/logic/face_recognition.py).
- **Диаграмма:** убрать сущность `face_cluster_members`, у `photo_rectangles` показать связь с `face_clusters` через `cluster_id`.

---

## Шаг 3: person_rectangle_manual_assignments → photo_rectangles.manual_person_id

- **Схема:** добавить в `photo_rectangles` колонку `manual_person_id INTEGER NULL REFERENCES persons(id)`. По решению по обсуждению: `confidence` из этой таблицы не переносить; при необходимости сохранить `source`/`created_at` в колонках `manual_source`/`manual_created_at` в `photo_rectangles`.
- **Миграция:** для каждой строки в `person_rectangle_manual_assignments` выполнить `UPDATE photo_rectangles SET manual_person_id = :person_id WHERE id = :rectangle_id`. Если у одного rectangle_id несколько записей — зафиксировать правило (например, брать одну по id или по created_at). Если у прямоугольника уже заполнен `cluster_id` (из шага 2) и есть ручная привязка — при переносе задать приоритет: например, ручная перекрывает кластер (`SET manual_person_id = :person_id, cluster_id = NULL`) или не трогать строку; в итоге после миграции не должно быть строк с обоими полями.
- **Удаление:** DROP таблицы `person_rectangle_manual_assignments` и индексов; убрать создание таблицы в db.py.
- **Код:** заменить все обращения к `person_rectangle_manual_assignments` на чтение/запись `photo_rectangles.manual_person_id` (и при наличии — `manual_source`/`manual_created_at`). Ключевые места: [backend/common/db.py](backend/common/db.py), [backend/web_api/routers/faces.py](backend/web_api/routers/faces.py), [backend/web_api/routers/face_clusters.py](backend/web_api/routers/face_clusters.py).
- **Диаграмма:** убрать сущность `person_rectangle_manual_assignments`, у `photo_rectangles` показать связь с `persons` через `manual_person_id`.

### CHECK: взаимоисключение cluster_id и manual_person_id

- **После** появления в `photo_rectangles` обеих колонок (`cluster_id`, `manual_person_id`) и миграции данных добавить ограничение: у прямоугольника может быть задан только один способ привязки к персоне — либо через кластер, либо ручная.
- **В схеме:** `ALTER TABLE photo_rectangles ADD CONSTRAINT chk_rect_one_person_source CHECK (cluster_id IS NULL OR manual_person_id IS NULL);` (SQLite 3.37.0+).
- В [backend/common/db.py](backend/common/db.py) при создании/миграции таблицы обеспечить наличие этого CHECK (если таблица пересоздаётся — включить в CREATE TABLE; если только добавляются колонки — выполнить ADD CONSTRAINT после шагов 2 и 3).
- Логика при записи: при установке `manual_person_id` обнулять `cluster_id`; при установке `cluster_id` обнулять `manual_person_id`.

---

## После миграции

- Перегенерировать PNG диаграмм: `python scripts/render_diagrams.py --in-dir docs/diagrams` (правило [diagrams-on-schema-changes.mdc](.cursor/rules/diagrams-on-schema-changes.mdc)).
- При необходимости обновить README и History.log по правилам проекта.

---

## Важные файлы

- Схема и хранилище: [backend/common/db.py](backend/common/db.py)
- Роутеры лиц и кластеров: [backend/web_api/routers/faces.py](backend/web_api/routers/faces.py), [backend/web_api/routers/face_clusters.py](backend/web_api/routers/face_clusters.py)
- Логика кластеризации: [backend/logic/face_recognition.py](backend/logic/face_recognition.py)
- Диаграмма: [docs/diagrams/entities_as_is.puml](docs/diagrams/entities_as_is.puml)
- Бекап: [backend/scripts/tools/backup_database.py](backend/scripts/tools/backup_database.py); папка бекапов — `data/backups/`
