---
name: Привязка фото напрямую и закладки
overview: "Три блока доработок: (1) в карточке фото — отображение и редактирование прямой привязки (file_persons); (2) при привязке людей (любым из 3 способов, кроме Посторонних) — переход файла из закладки «Нет людей» в «Люди»; (3) для «Нет людей» — возможность назначить группу (в т.ч. из карточки), чтобы фото переезжало в подзакладку группы."
todos: []
isProject: false
---

# План: привязка фото напрямую и логика закладок

## Контекст

- **Прямая привязка** — таблица `file_persons` (файл целиком → персона), без прямоугольников. API: `GET /api/faces/file-persons`, `POST /api/persons/assign-file`, remove-assignment (assignment_type: "file").
- **Закладки**: «Люди» (tab=faces) с подзакладками «К разбору», «Много лиц», «person_&lt;id&gt;»; «Нет людей» (tab=no_faces) с «Фото к разбору», «Видео к разбору», «group_&lt;path&gt;».
- **eff_sql** в [backend/web_api/routers/faces.py](backend/web_api/routers/faces.py) (около строк 817–851) определяет, в какую закладку попадает файл. Сейчас `has_person_binding` учитывает только `photo_rectangles` (manual + cluster), **не** `file_persons`.
- **Карточка фото** — [backend/web_api/static/photo_card.js](backend/web_api/static/photo_card.js): загружает только rectangles через `/api/faces/rectangles`, прямой привязки (file_persons) не показывает и не даёт удалить/поменять.

---

## 1. Прямая привязка в карточке фото

**Цель:** В карточке фото должна быть видна прямая привязка (не через прямоугольник), её можно удалить или сменить на другую персону.

**Решение по данным:** используется **вариант Б** — карточка дополнительно вызывает `GET /api/faces/file-persons` при загрузке, хранит результат в `currentState.directBindings`. Бэкенд rectangles не меняем.

### UI: прямая привязка как плашка с выпадашкой

- **Формат:** для каждой прямой привязки (file_persons) — **отдельная плашка** в том же списке, что и плашки прямоугольников, но **другого цвета** (например зелёный/бирюзовый акцент, чтобы визуально отличать «файл целиком → персона» от «прямоугольник → персона»).
- **Содержимое плашки:** имя персоны + иконка/кнопка «действия», по клику открывается **выпадающее меню** с пунктами:
- **«Другой человек»** — открыть диалог выбора персоны (как при «к фото целиком»), после выбора: удалить текущую привязку и создать assign-file для выбранной персоны; обновить плашки и при необходимости список на faces.
- **«Удалить»** — вызов `POST /api/persons/remove-assignment` (assignment_type: "file", pipeline_run_id, file_id/path, person_id); после успеха — перезапросить file-persons, убрать плашку, при открытии с faces — обновить список (карточка «уедет» с подзакладки персоны или появится в «К разбору»).
- **Расположение:** плашки прямой привязки рендерятся в том же контейнере, что и плашки rectangles, например **сверху** списка (сначала все прямые привязки, потом прямоугольники) или в одном общем списке с явным визуальным отличием по цвету.
- **Добавление:** кнопка/пункт «к фото целиком» оставить как есть; после добавления — появляется новая плашка прямой привязки (того же типа и цвета).

Файлы: [backend/web_api/static/photo_card.js](backend/web_api/static/photo_card.js).

---

## 2. Переход «Нет людей» → «Люди» при привязке людей (кроме Посторонних)

**Цель:** При привязке людей любым из трёх способов (лица/кластеры, прямоугольники, прямая привязка file_persons) фото должно переезжать из закладки «Нет людей» в закладку «Люди». Это касается всех людей **кроме** «Посторонних».

**Шаги:**

1. **Учёт file_persons и исключение «Посторонний» в eff_sql**

- В [backend/web_api/routers/faces.py](backend/web_api/routers/faces.py) в выражении `has_person_binding_sql_results` (около 812–836) добавить условие:
- «ИЛИ есть запись в `file_persons` для данного `f.id` и `pipeline_run_id` с `person_id != &lt;id персоны «Посторонний»&gt;`».
- Идентификатор персоны «Посторонний» получать один раз в начале обработчика (через существующий хелпер из [backend/web_api/routers/face_clusters.py](backend/web_api/routers/face_clusters.py) — например `get_ignored_person_id()`, или запрос к БД по имени/флагу).
- Параметры запроса: к текущим `person_binding_params_results` добавить `pipeline_run_id` и `ignored_person_id` там, где в запросе используется новая подстрока для file_persons.
- Важно: файл переводится в «Люди» только если есть **хотя бы одна** привязка к персоне, **не** являющейся «Посторонний». Если привязаны только «Посторонние» (и по прямоугольникам, и по file_persons) — файл остаётся в «Нет людей». То есть общее условие «has_person_binding» = (текущая логика по rectangles с учётом кластеров и manual) ИЛИ (существует file_persons для этого file/run с person_id != ignored_person_id). При этом для rectangles логику «исключить только посторонних» при необходимости нужно явно учесть: сейчас привязка к кластеру/ручная с персоной «Посторонний» уже даёт has_person_binding и переводит в «Люди». По ТЗ при только посторонних файл должен оставаться в «Нет людей», значит в has_person_binding нужно считать только привязки к **не-**постороннему: и для rectangles (manual_person_id / fc.person_id != ignored), и для file_persons (person_id != ignored).

2. **Согласование с фильтром «К разбору»**

- В «Люди» → «К разбору» уже используется фильтр «нет привязки к персонам» (в т.ч. через file_persons, строки 887–890). После добавления file_persons в eff_sql файлы с прямой привязкой к не-постороннему будут уходить в «Люди», а в «К разбору» не попадут — дополнительных правок не нужно.
- Убедиться, что во всех местах, где подставляются `person_binding_params_results`, порядок и количество плейсхолдеров совпадают с новым фрагментом SQL (pipeline_run_id, ignored_person_id).

Файлы: [backend/web_api/routers/faces.py](backend/web_api/routers/faces.py). При необходимости — общий хелпер в [backend/web_api/routers/face_clusters.py](backend/web_api/routers/face_clusters.py) для получения ignored_person_id, если его ещё нет в контексте faces.

---

## 3. Посторонние и группы «Нет людей»: назначение группы и переход в подзакладку

**Цель:** Для фото, где только посторонние или непривязанные люди, при назначении группы (например «Поездки/2024») фото должно уходить из подзакладки «Нет людей» → «К разбору» в соответствующую подзакладку группы.

**Текущее состояние:**

- Назначение группы уже есть: `POST /api/faces/assign-group`, таблица `file_groups`. В списке на [backend/web_api/templates/faces.html](backend/web_api/templates/faces.html) для вкладки «Нет людей» на каждой карточке есть выпадающий список «Назначить группу» (стр. ~1927–1929). После успешного assign-group карточка удаляется из списка, делается refresh/load — файл исчезает из «К разбору» и при следующем открытии подзакладки группы он там отображается. То есть **переезд в подзакладку группы уже реализован** на уровне API и фильтров.

**Нехватка (по формулировке «сейчас нет этой фичи»):**

- В **полноэкранной карточке фото** (photo_card), когда её открывают из «Нет людей», нет возможности назначить группу — выбор группы есть только на превью-карточке в сетке. Поэтому пользователь не может, не закрывая карточку, назначить группу и сразу «отправить» фото в подзакладку группы.

### UI: блок «Назначить группу» в карточке фото

- **Где:** в боковой панели карточки, ниже блока «Прямая привязка» и списка прямоугольников. Показывать **только** при `mode === 'sorting'` и `list_context?.api_fallback?.params?.tab === 'no_faces'`.
- **Внешний вид:** выпадающий список (select) «Назначить группу…» + кнопка «Назначить». Список групп — те же данные, что на странице faces (например `GET /api/faces/groups-subtabs` или уже используемый эндпоинт списка групп). Стиль — как у выпадашки «Назначить группу» на превью-карточке в сетке (минимальная ширина ~180px, border, padding).
- **Поведение:** по выбору группы и клику «Назначить» — `POST /api/faces/assign-group`. После успеха — закрыть карточку и обновить список на faces (тот же механизм, что после assign-group с превью), чтобы текущий файл исчез из «К разбору» и при открытии подзакладки группы он там отображался. Toast: «Файл назначен в группу "…"».
- **Загрузка списка групп:** при первом открытии карточки с tab=no_faces — один раз запросить список групп и сохранить в состоянии (или переиспользовать кэш faces, если он доступен через общий скрипт/событие).

2. **Контур «только посторонние / непривязанные»**

- Явно не менять фильтрацию: файлы с только посторонними остаются в «Нет людей» (это уже обеспечивается п.2 плана). Назначение группы таким файлам делается так же, как и любым другим в «Нет людей» — через тот же assign-group. Отдельной «фичи только для посторонних» не вводить; достаточно единого блока «Назначить группу» на вкладке «Нет людей» в карточке.

Файлы: [backend/web_api/static/photo_card.js](backend/web_api/static/photo_card.js), при необходимости — небольшая доработка в [backend/web_api/templates/faces.html](backend/web_api/templates/faces.html), если нужно единое API списка групп для и списка, и карточки.

---

## Порядок внедрения

1. П. 2 (бэкенд eff_sql) — без него привязка через file_persons не переводит файл в «Люди».
2. П. 1 (прямая привязка в карточке) — отображение и удаление/смена в UI.
3. П. 3 (назначение группы в карточке при «Нет людей») — улучшение UX без смены существующей логики переезда.

---

## Риски и замечания

- **Синхронизация списка после действий в карточке:** после «Удалить прямую привязку», «Поменять персону», «Назначить группу» список на faces может требовать обновления (refreshTabCounts/load). Сейчас при закрытии карточки список уже перезагружается в части сценариев; при действиях без закрытия нужно либо вызывать то же обновление (через общий колбэк/событие), либо явно удалять текущую карточку из DOM и обновлять счётчики.
- **Исключение «Посторонний» в eff_sql:** необходимо единообразно трактовать «привязка к не-постороннему» и для rectangles, и для file_persons, иначе появятся расхождения между вкладками «Люди» и «Нет людей».