---
name: Исправление проблемы с терминалом Cursor при выполнении Python
overview: Диагностика и решение проблемы, когда выполнение команд Python в терминале Cursor вызывает Connection Error и ломает ВСЕ чаты (и старые, и новые). Удаление workspaceStorage временно решает проблему. План включает тестирование по ступенькам для выявления точной причины (слэши или кириллица в путях).
todos:
  - id: clean_start
    content: Удалить workspaceStorage и начать с чистого листа для диагностики
    status: pending
  - id: test_step_a1
    content: "Тест A1: Get-Date (базовая команда без путей)"
    status: pending
  - id: test_step_a2
    content: "Тест A2: Get-Location (команда с выводом пути)"
    status: pending
  - id: test_step_b1
    content: "Тест B1: Чтение README.md из корня проекта"
    status: pending
  - id: test_step_b2
    content: "Тест B2: Чтение файла из подпапки (backend/scripts/debug/)"
    status: pending
  - id: test_step_b3
    content: "Тест B3: Чтение через powershell -NoProfile"
    status: pending
  - id: test_step_c1
    content: "Тест C1: python --version"
    status: pending
  - id: test_step_c2
    content: "Тест C2: python -c \"print('test')\""
    status: pending
  - id: test_step_c3
    content: "Тест C3: python -c с выводом пути (sys.executable)"
    status: pending
  - id: test_step_d1
    content: "Тест D1: python backend/scripts/debug/list_pipeline_runs.py (без аргументов, проверка работы скрипта из файла)"
    status: pending
  - id: test_step_d2
    content: "Тест D2: python скрипт с аргументами (--limit 1, проверка что скрипт выполнился)"
    status: pending
  - id: test_step_d3
    content: "Тест D3: python скрипт с путями в аргументах (--sql-file, проверка выполнения и вывода)"
    status: pending
  - id: test_step_e1
    content: "Тест E1: Запись в temp файл (без операций)"
    status: pending
  - id: test_step_e2
    content: "Тест E2: Запись с replace операцией"
    status: pending
  - id: test_step_f1
    content: "Тест F1: Чтение файла с кириллицей в пути"
    status: pending
  - id: test_step_f2
    content: "Тест F2: Python с путями с кириллицей"
    status: pending
  - id: test_step_g
    content: "Тест G: Python скрипт с выводом (diagnose_terminal_issue.py)"
    status: pending
  - id: fix_based_on_results
    content: Применить решение на основе результатов диагностики
    status: pending
  - id: update_documentation
    content: Обновить документацию с найденной причиной и решением
    status: pending
---

# План исправления проблемы с терминалом Cursor при выполнении Python

## Проблема (ОБНОВЛЕНО)

- Терминал ломается практически на любой команде Python (появляется Connection Error)
- **Ломаются ВСЕ чаты** - и старые, и новые (не только новые, как считалось ранее)
- Терминал также ломается после длительной работы в чате (даже без выполнения Python команд)
- Удаление `%APPDATA%\Cursor\User\workspaceStorage\` решает проблему, но только до нового запуска Python
- Нужно выяснить, что именно ломает терминал: слэши в путях или кириллица

## Гипотезы причин

1. **Shell Integration конфликт** - Python выводит escape-последовательности, которые ломают интеграцию Cursor с терминалом
2. **Настройки терминала портятся** - при выполнении Python команды сохраняются битые настройки в workspace
3. **Проблема с кодировкой/буферизацией** - Python выводит данные, которые Cursor не может корректно обработать
4. **Конфликт с PowerShell** - специфичная проблема взаимодействия Python + PowerShell + Cursor

## Этап 0: Чистый старт (ПРИОРИТЕТ)

### 0.1 Удаление workspaceStorage для чистого тестирования

**Действия:**

1. Закрыть Cursor полностью
2. Удалить всю папку `%APPDATA%\Cursor\User\workspaceStorage\`
3. Открыть проект `C:\Projects\PhotoSorter` в Cursor заново
4. Cursor создаст новый чистый workspace

**Цель:** Исключить влияние битых настроек из предыдущих сессий на диагностику

## Этап 1: Диагностика по ступенькам ("деградация команды")

### 1.1 Тестирование базовых команд PowerShell

**Цель:** Выяснить, что именно ломает терминал - слэши в путях, кириллица или Python

**Порядок тестирования (по ступенькам, от простого к сложному):**

**A1) Базовая команда PowerShell (без путей):**

```powershell
Get-Date
```

- Проверить, работает ли терминал после этой команды
- Проверить, не ломаются ли чаты

**A2) Базовая команда с выводом пути:**

```powershell
Get-Location
```

- Проверить, ломается ли терминал/чаты при выводе пути

**B1) Чтение простого файла из корня проекта:**

```powershell
Get-Content -LiteralPath 'C:\Projects\PhotoSorter\README.md' -Raw | Measure-Object -Character
```

- Проверить, ломается ли терминал/чаты при чтении файла

**B2) Чтение файла из подпапки (с путями со слэшами):**

```powershell
Get-Content -LiteralPath 'C:\Projects\PhotoSorter\backend\scripts\debug\list_pipeline_runs.py' -Raw | Select-Object -First 5
```

- Проверить, ломается ли терминал/чаты при чтении файла из подпапки

**B3) Чтение файла через PowerShell с параметрами:**

```powershell
powershell -NoProfile -Command "Get-Content -LiteralPath 'C:\Projects\PhotoSorter\History.log' -Raw | Measure-Object -Character"
```

- Проверить, ломается ли терминал/чаты при использовании `-NoProfile`

**C1) Python --version (минимальная Python команда):**

```powershell
python --version
```

- Проверить, ломается ли терминал/чаты при базовой Python команде

**C2) Python inline команда:**

```powershell
python -c "print('test')"
```

- Проверить, ломается ли терминал/чаты при inline Python команде

**C3) Python с выводом пути:**

```powershell
python -c "import sys; print(sys.executable)"
```

- Проверить, ломается ли терминал/чаты при выводе пути из Python

**D1) Python скрипт без аргументов (простой скрипт из файла):**

```powershell
python backend/scripts/debug/list_pipeline_runs.py
```

- Проверить, ломается ли терминал/чаты при запуске простого скрипта из файла
- **Важно:** Это проверка работы скрипта из файла (согласно правилам - Python только из файлов)

**D2) Python скрипт с аргументами:**

```powershell
python backend/scripts/debug/list_pipeline_runs.py --limit 1
```

- Проверить, ломается ли терминал/чаты при запуске скрипта с аргументами
- Проверить, что скрипт действительно выполнился и вывел результат

**D3) Python скрипт с относительными путями в аргументах:**

```powershell
python backend/scripts/debug/sqlite_select.py --sql-file backend/scripts/debug/check_all_groups.sql
```

- Проверить, ломается ли терминал/чаты при передаче путей в аргументах
- Проверить, что скрипт выполнился и вывел результат SQL-запроса

**E1) Запись в temp файл (без операций над содержимым):**

```powershell
$p = 'C:\Projects\PhotoSorter\README.md'; $t = 'C:\Temp\test_readme.md'; Get-Content -LiteralPath $p -Raw | Set-Content -LiteralPath $t -Encoding utf8
```

- Проверить, ломается ли терминал/чаты при записи файла

**E2) Запись с операциями над содержимым (replace):**

```powershell
$p = 'C:\Projects\PhotoSorter\History.log'; $t = 'C:\Temp\test_history.md'; (Get-Content -LiteralPath $p -Raw) -replace '2026-01-21','TEST' | Set-Content -LiteralPath $t -Encoding utf8
```

- Проверить, ломается ли терминал/чаты при операциях над содержимым

**F1) Тест с кириллицей в пути (чтение):**

```powershell
Get-Content -LiteralPath 'C:\Users\mzaborov\YandexDisk\Работы, тексты, презентации\test.txt' -Raw -ErrorAction SilentlyContinue
```

- Проверить, ломается ли терминал/чаты при работе с путями с кириллицей

**F2) Python скрипт, который работает с путями с кириллицей:**

```powershell
python -c "from pathlib import Path; p = Path(r'C:\Users\mzaborov\YandexDisk\Работы, тексты, презентации'); print(p.exists())"
```

- Проверить, ломается ли терминал/чаты при работе Python с путями с кириллицей

**G) Python скрипт с выводом в stdout (более сложный):**

```powershell
python backend/scripts/debug/diagnose_terminal_issue.py
```

- Проверить, ломается ли терминал/чаты при запуске скрипта с выводом
- Проверить, что скрипт выполнился полностью и вывел результаты диагностики

### 1.2 Фиксация результатов

**Для каждой ступеньки зафиксировать:**

- Работает ли терминал после команды
- Ломаются ли чаты (все или только новые)
- Есть ли Connection Error
- Время выполнения команды
- Вывод команды (если есть)

**Цель:** Определить минимальную команду, которая ломает терминал, и понять причину (слэши/кириллица/Python)

### 1.3 Проверка настроек Shell Integration

- Проверить настройки Cursor: `terminal.integrated.shellIntegration.enabled`
- Проверить настройки PowerShell: `terminal.integrated.defaultProfile.windows`
- Проверить настройки терминала в workspace: `%APPDATA%\Cursor\User\workspaceStorage\<workspace-hash>\workspace.json`

### 1.4 Проверка логов Cursor

- Проверить логи Cursor: `%APPDATA%\Cursor\logs\`
- Найти ошибки, связанные с терминалом или Shell Integration
- Зафиксировать точное время и последовательность событий при поломке

## Этап 2: Решения (по приоритету)

### 2.1 Отключение Shell Integration (быстрое решение)

**Действия:**

- Отключить Shell Integration в настройках Cursor: `terminal.integrated.shellIntegration.enabled = false`
- Проверить, решает ли это проблему
- Если решает - добавить настройку в workspace settings

**Файлы для изменения:**

- `.vscode/settings.json` (workspace settings) - добавить настройку отключения Shell Integration

### 2.2 Изменение настроек терминала

**Действия:**

- Изменить профиль терминала на cmd вместо PowerShell
- Или изменить настройки буферизации терминала
- Проверить настройки кодировки терминала

**Файлы для изменения:**

- `.vscode/settings.json` - настройки терминала

### 2.3 Обходной путь: запуск Python через обёртку

**Действия:**

- Создать PowerShell скрипт-обёртку для запуска Python команд
- Обёртка будет перехватывать вывод и форматировать его безопасным образом
- Использовать обёртку вместо прямого запуска `python`

**Файлы для создания:**

- `backend/scripts/tools/run_python_safe.ps1` - безопасная обёртка для запуска Python

### 2.4 Очистка workspace настроек терминала

**Действия:**

- Создать скрипт для очистки битых настроек терминала из `state.vscdb`
- Скрипт будет удалять только настройки терминала, сохраняя чаты
- Запускать скрипт автоматически или вручную при необходимости

**Файлы для создания:**

- `backend/scripts/debug/clean_terminal_settings.py` - скрипт очистки настроек терминала

## Этап 3: Долгосрочное решение

### 3.1 Обновление правил Cursor

**Действия:**

- Обновить правило `.cursor/rules/python-run-only-from-files.mdc` с информацией о проблеме
- Добавить инструкции по обходным путям
- Добавить информацию о настройках терминала

### 3.2 Мониторинг проблемы

**Действия:**

- Зафиксировать версию Cursor, при которой возникает проблема
- Проверить, решена ли проблема в новых версиях Cursor
- Создать issue в репозитории Cursor (если проблема воспроизводится)

## Этап 4: Документация

### 4.1 Обновление History.log

**Действия:**

- Добавить запись о диагностике и решении проблемы
- Зафиксировать найденное решение

### 4.2 Обновление README

**Действия:**

- Добавить раздел о проблеме с терминалом (если проблема не решена полностью)
- Добавить инструкции по обходным путям

## Порядок выполнения (ОБНОВЛЕНО)

1. **Чистый старт** (Этап 0) - удалить workspaceStorage и начать с чистого листа
2. **Диагностика по ступенькам** (Этап 1) - тестировать команды от простых к сложным, выяснить что именно ломает (слэши/кириллица/Python)
3. **Фиксация результатов** - зафиксировать минимальную команду, которая ломает терминал
4. **Решение** (Этап 2) - применить решение на основе результатов диагностики
5. **Долгосрочное решение** (Этап 3) - обновление правил и мониторинг
6. **Документация** (Этап 4) - фиксация решения

## Риски

- Отключение Shell Integration может ухудшить функциональность терминала (потеря интеграции с Cursor)
- Очистка workspace настроек может удалить важные настройки (нужна резервная копия)
- Обходные пути могут замедлить работу

## Критерии успеха

- Терминал работает стабильно при выполнении Python команд
- Чаты не ломаются при выполнении Python команд
- Не требуется удаление workspaceStorage для восстановления работы
- Выявлена точная причина поломки (слэши/кириллица/Python/другое)

## Процесс тестирования по ступенькам

### Важно перед началом

1. **Создать резервную копию чатов** (если они важны):

   - Скопировать `%APPDATA%\Cursor\User\workspaceStorage\<workspace-hash>\state.vscdb` в безопасное место
   - После удаления workspaceStorage чаты будут потеряны

2. **Закрыть Cursor полностью** перед удалением workspaceStorage

3. **После каждого теста проверять:**

   - Работает ли терминал (можно ли выполнить следующую команду)
   - Работают ли чаты (старые и новые)
   - Есть ли Connection Error

### Формат фиксации результатов

Для каждой ступеньки записать:

```
Ступенька X: [название]
Команда: [команда]
Результат терминала: ✅ работает / ❌ ломается
Чаты: ✅ работают / ❌ ломаются (все/только новые)
Connection Error: да/нет
Время выполнения: [секунды]
Вывод команды: [первые 100 символов, если есть]
Примечания: [любые наблюдения]
```

**Пример:**

```
Ступенька C1: python --version
Команда: python --version
Результат терминала: ❌ ломается
Чаты: ❌ ломаются (все)
Connection Error: да
Время выполнения: 2 сек
Вывод команды: Python 3.14.0
Примечания: Команда выполнилась, но после этого терминал перестал отвечать
```

### Интерпретация результатов

- **Если ломается на A1-A2:** Проблема в базовой работе терминала PowerShell, не связана с путями/Python
- **Если ломается на B1-B3:** Проблема в работе с файлами или путями со слэшами
  - B1 ломает → проблема с чтением файлов вообще
  - B2 ломает → проблема с путями со слэшами (backend/scripts/)
  - B3 ломает → проблема с `-NoProfile` или запуском подпроцессов
- **Если ломается на C1-C3:** Проблема специфична для Python команд
  - C1 ломает → проблема с любым Python
  - C2 ломает → проблема с inline Python командами
  - C3 ломает → проблема с выводом путей из Python
- **Если ломается на D1-D3:** Проблема в запуске Python скриптов из файлов
  - D1 ломает → проблема с запуском скриптов из файлов вообще (нарушение правила "Python только из файлов")
  - D2 ломает → проблема с аргументами командной строки при запуске из файла
  - D3 ломает → проблема с путями в аргументах при запуске из файла
- **Если ломается на E1-E2:** Проблема в операциях записи файлов
  - E1 ломает → проблема с записью файлов
  - E2 ломает → проблема с операциями над содержимым (replace)
- **Если ломается на F1-F2:** Проблема в обработке кириллицы в путях
  - F1 ломает → проблема с кириллицей в PowerShell
  - F2 ломает → проблема с кириллицей в Python
- **Если ломается на G:** Проблема в выводе большого количества данных из Python скриптов