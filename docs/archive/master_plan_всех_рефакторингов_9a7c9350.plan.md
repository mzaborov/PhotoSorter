---
name: Master Plan всех рефакторингов
overview: Объединенный план реализации 5 задач с учетом зависимостей и пересечений. Миграция file_path→file_id должна быть выполнена ДО рефакторингов UI, чтобы избежать двойной работы.
todos:
  - id: stage0_backfill_taken_at
    content: "ЭТАП 0: Создать скрипт backfill_taken_at.py для заполнения даты съемки (независимая задача)"
    status: pending
  - id: stage1_db_prep
    content: "ЭТАП 1.1: Добавить колонки file_id во все таблицы и создать индексы"
    status: completed
  - id: stage1_migrate_data
    content: "ЭТАП 1.2: Создать и выполнить скрипт миграции данных (заполнение file_id из files по file_path)"
    status: completed
  - id: stage1_validate
    content: "ЭТАП 1.3: Валидация данных миграции - проверить целостность"
    status: completed
  - id: stage1_backend_update
    content: "ЭТАП 1.4: Обновить методы FaceStore, DedupStore, PipelineStore для работы с file_id"
    status: completed
  - id: stage1_api_update
    content: "ЭТАП 1.5: Обновить API эндпойнты для принятия file_id (с fallback на file_path)"
    status: completed
  - id: stage1_constraints
    content: "ЭТАП 1.6: Сделать file_id NOT NULL и добавить FOREIGN KEY constraints"
    status: completed
  - id: stage1_diagrams
    content: "ЭТАП 1.7: Обновить диаграммы entities (as_is и to_be) под file_id"
    status: completed
  - id: stage1_remove_file_path
    content: "ЭТАП 1.8: Удалить избыточные file_path/path из всех таблиц (привести к 3NF)"
    status: completed
  - id: stage1_remove_manual_labels_redundancy
    content: "ЭТАП 1.9: Удалить избыточные колонки *_manual_* из files (привести к 3NF)"
    status: completed
  - id: stage2_photo_card_module
    content: "ЭТАП 2.1: Создать единый модуль photo_card.js и шаблон photo_card.html (работа с file_id)"
    status: completed
  - id: stage2_photo_card_api
    content: "ЭТАП 2.2: Реализовать API для редактирования rectangles (с file_id)"
    status: completed
  - id: stage2_photo_card_editing
    content: "ЭТАП 2.3: Реализовать функциональность редактирования (drag&drop через якоря, изменение персоны, изменение типа привязки, удаление; добавление новых rectangles отложено)"
    status: completed
  - id: stage2_photo_card_navigation
    content: "ЭТАП 2.4: Реализовать навигацию по списку и UNDO систему"
    status: completed
  - id: stage2_photo_card_integration
    content: "ЭТАП 2.5: Интегрировать карточку фотографий в faces.html, person_detail.html, face_cluster_detail.html"
    status: completed
  - id: stage3_person_list_api
    content: "ЭТАП 3.1: Исправить API для списка персон - подсчеты через file_id (JOIN с files)"
    status: completed
  - id: stage3_person_list_ui
    content: "ЭТАП 3.2: Обновить UI списка персон - переименовать колонки, добавить кликабельные ссылки"
    status: completed
  - id: stage3_person_detail_api
    content: "ЭТАП 3.3: Расширить API карточки персоны для всех типов привязки (с file_id)"
    status: completed
  - id: stage3_person_detail_ui
    content: "ЭТАП 3.4: Обновить UI карточки персоны - режимы просмотра, вкладки, подвкладки, таблица кластеров"
    status: completed
  - id: stage3_photo_card_buttons
    content: "ЭТАП 3.4b: Кнопки на карточке фото — Аватар только для архива; для сортировки: Посторонний, Кот, Не лицо, Другой (выпадашка персон)"
    status: completed
  - id: stage3_unassigned_clusters
    content: "ЭТАП 3.5: Обновить форму неназначенных кластеров - показ сортируемых кластеров"
    status: completed
  - id: stage3_sync_list_after_card_changes
    content: "ЭТАП 3.6: Синхронизация списка персоны после изменений в карточке фотографий - отправка события при закрытии карточки, обновление списка с позиционированием по file_id + rectangle_id"
    status: completed
  - id: stage4_video_improvements
    content: "ЭТАП 4.1: Улучшить работу с видео - ключевые кадры, смена кадра, исправление разметки"
    status: pending
  - id: stage4_sorting_rules
    content: "ЭТАП 4.2: Реализовать применение правил сортировки из folders и перемещение в архив (с file_id)"
    status: pending
  - id: stage5_rename_rectangles_tables
    content: "ЭТАП 5: Миграция переименования таблиц rectangles (face_rectangles → photo_rectangles, face_person_manual_assignments → person_rectangle_manual_assignments, добавление is_face)"
    status: completed
---

# Master Plan: Порядок реализации всех рефакторингов

## Анализ зависимостей

### Ключевое пересечение: file_path vs file_id

**Критическое наблюдение:**

- План "рефакторинг карточки фотографий" явно указывает: "Использование `file_path` вместо `file_id`: В текущей архитектуре все API и таблицы работают с `file_path`... Это архитектурное ограничение, которое требует большого рефакторинга для перехода на `file_id`."
- План "миграция file_path → file_id" - это фундаментальная архитектурная миграция, затрагивающая все таблицы и API.

**Вывод:** Миграция `file_path → file_id` должна быть выполнена **ДО** рефакторингов UI (карточка фотографий, карточка персоны), иначе придется переписывать UI дважды.

### Зависимости между планами:

```
[Заполнение даты съемки] (независимая задача)
    ↓
[Миграция file_path → file_id] (фундаментальная, блокирует остальные)
    ↓
[Рефакторинг карточки фотографий] (использует file_path → нужно переделать на file_id)
    ↓
[Рефакторинг списка и карточки персоны] (использует file_path → нужно переделать на file_id)
    ↓
[Завершение UI сортировки] (частично выполнена, требует доработок после миграции)
```

## Порядок реализации (поэтапно)

### ЭТАП 0: Независимые задачи (можно делать параллельно)

**Задача: Заполнение даты съемки**

- Скрипт `backend/scripts/tools/backfill_taken_at.py`
- Не зависит от других задач
- Можно выполнить сразу

**Детальный план:** [`.cursor/plans/заполнение_даты_съемки.plan.md`](.cursor/plans/заполнение_даты_съемки.plan.md)

**Статус:** Все задачи pending, готово к началу

---

### ЭТАП 1: Миграция file_path → file_id (ФУНДАМЕНТАЛЬНАЯ)

**Критичность:** ВЫСОКАЯ - блокирует все UI рефакторинги

**Зачем первым:** Все последующие рефакторинги UI должны работать с `file_id`, иначе придется переписывать дважды.

**Шаги реализации (из плана миграции):**

1. **Подготовка БД** (2-3 дня)

   - Добавить колонки `file_id INTEGER` (NULL) во все таблицы
   - Создать индексы на `file_id`
   - Скрипт миграции данных: заполнение `file_id` из `files` по `file_path`
   - Валидация данных

2. **Обновление backend** (3-4 дня)

   - Обновить методы `FaceStore` для работы с `file_id`
   - Обновить методы `DedupStore`/`PipelineStore` для работы с `file_id`
   - API эндпойнты: принять `file_id` (с fallback на `file_path` для обратной совместимости)
   - Сделать `file_id NOT NULL` и добавить FOREIGN KEY

3. **Обновление диаграмм** (1 день)

   - Обновить `docs/diagrams/entities_as_is.puml`
   - Обновить `docs/diagrams/entities_to_be.puml`
   - Сгенерировать PNG

**Файлы:**

- `backend/common/db.py` - обновление схемы и методов
- `backend/scripts/migration/file_path_to_file_id.py` - скрипт миграции
- `backend/web_api/routers/faces.py` - обновление API
- `backend/web_api/routers/face_clusters.py` - обновление API
- Диаграммы

**Риски:**

- Высокий риск - миграция больших таблиц
- Нужна резервная копия БД
- Тестирование на копии production данных

**Детальный план:** [`.cursor/plans/миграция_с_file_path_на_file_id_fd267bed.plan.md`](.cursor/plans/миграция_с_file_path_на_file_id_fd267bed.plan.md)

---

### ЭТАП 2: Рефакторинг карточки фотографий

**Зависимость:** Требует завершения ЭТАП 1 (работа с `file_id` вместо `file_path`)

**Адаптация под file_id:**

- Параметр `file_path` заменить на `file_id` в `openPhotoCard(options)`
- API эндпойнты принимать `file_id`
- `list_context.items` содержать `file_id` вместо `file_path`
- Определение режима (archive/sorting) через запрос к БД по `file_id`

**Шаги реализации:**

1. **Создание единого модуля** (3-4 дня)

   - `backend/web_api/static/photo_card.js` - единый модуль карточки
   - `backend/web_api/templates/photo_card.html` - HTML структура
   - Отрисовка rectangles с правильными цветами
   - Плашки со списком rectangles

2. **API для редактирования** (2-3 дня)

   - Эндпойнты работают с `file_id`
   - Контроль взаимной исключительности привязок
   - Проверка дубликатов
   - Специальные действия (кот, нет людей, посторонний)

3. **Функциональность редактирования** (3-4 дня)

   - Drag & drop для перемещения
   - Изменение типа привязки
   - Изменение персоны
   - Добавление/удаление rectangles

4. **Навигация и UNDO** (2-3 дня)

   - Логика навигации по списку с `file_id`
   - Сохранение контекста
   - UNDO система

5. **Интеграция в страницы** (2-3 дня)

   - `faces.html` - интеграция
   - `person_detail.html` - интеграция
   - `face_cluster_detail.html` - интеграция

**Файлы:**

- `backend/web_api/static/photo_card.js` - новый
- `backend/web_api/templates/photo_card.html` - новый
- `backend/web_api/routers/faces.py` - обновление API (с `file_id`)
- `backend/web_api/templates/faces.html` - интеграция
- `backend/web_api/templates/person_detail.html` - интеграция
- `backend/web_api/templates/face_cluster_detail.html` - интеграция

**Детальный план:** [`.cursor/plans/рефакторинг_карточки_фотографий.plan.md`](.cursor/plans/рефакторинг_карточки_фотографий.plan.md)

---

### ЭТАП 3: Рефакторинг списка и карточки персоны

**Зависимость:** Требует завершения ЭТАП 1 и ЭТАП 2 (работа с `file_id`, интеграция карточки фотографий)

**Адаптация под file_id:**

- API определения архив/прогон через запрос к `files` по `file_id`
- Убрать использование `file_path LIKE 'disk:/Фото%'` в SQL
- Запросы с JOIN на `files` по `file_id`

**Шаги реализации:**

1. **API для списка** (1-2 дня)

   - Исправить подсчеты через `file_id` (JOIN с `files`)
   - Разделение архив/прогон через `files.inventory_scope` или путь в `files.path`
   - Функция `_is_archive_path()` удалить, использовать JOIN

2. **UI списка** (1 день)

   - Переименовать "Архив / Прогон" → "Фотоархив / Сортируется"
   - Кликабельные ссылки на закладки карточки персоны

3. **API для карточки** (2-3 дня)

   - Расширить для всех типов привязки
   - Определение архив/прогон через JOIN с `files` по `file_id`
   - Метаданные о типе привязки

4. **UI карточки** (3-4 дня)

   - Режимы просмотра (Общий / Детальный)
   - Вкладки: "Фотоархив" / "Сортируется"
   - Подвкладки: "Через кластеры", "Через прямоугольники", "Прямая привязка"
   - Встроенная таблица кластеров
   - Якоря URL для прямого перехода

5. **Форма неназначенных** (1-2 дня)

   - Показ сортируемых кластеров
   - Фильтр архив/прогон/все

6. **Синхронизация списка после изменений в карточке** (1 день)

   - Отправка события `photoCardClosed` при закрытии карточки (с `file_id` + `rectangle_id`)
   - Обработка события на странице персоны - обновление списка через `loadPerson()`
   - Позиционирование на нужный элемент по `file_id` + `rectangle_id` после обновления
   - Добавление data-атрибутов для поиска элементов (`data-file-id`, `data-face-id`, `data-person-rectangle-id`)

**Файлы:**

- `backend/web_api/routers/face_clusters.py` - обновление API (с `file_id`)
- `backend/web_api/templates/persons_list.html` - обновление UI
- `backend/web_api/templates/person_detail.html` - обновление UI + обработка события синхронизации
- `backend/web_api/templates/face_clusters.html` - обновление
- `backend/web_api/static/photo_card.js` - отправка события при закрытии карточки

**Детальный план:** [`.cursor/plans/рефакторинг_списка_и_карточки_персоны.plan.md`](.cursor/plans/рефакторинг_списка_и_карточки_персоны.plan.md)

---

### ЭТАП 4: Завершение UI сортировки (доработки)

**Зависимость:** Требует завершения ЭТАП 1-3 (работа с `file_id`, новые UI компоненты)

**Адаптация:** Обновить оставшиеся задачи под новую архитектуру с `file_id`

**Оставшиеся задачи (из плана):**

1. **Работа с видео** (2-3 дня)

   - Улучшить выбор ключевых кадров (приоритет кадров с лицами)
   - Смена ключевого кадра с автодетекцией
   - Исправление разметки лиц и прямоугольников на кадрах

2. **Целевая сортировка** (3-4 дня)

   - Применение правил сортировки из `folders`
   - Локальная сортировка в папки прогона (с `file_id`)
   - Перемещение в фотоархив на YaDisk

**Файлы:**

- `backend/scripts/tools/video_keyframes.py` - улучшение
- `backend/web_api/routers/faces.py` - API для видео
- `backend/logic/pipeline/local_sort.py` - обновление под `file_id`
- `backend/web_api/routers/pipeline.py` - новые эндпойнты

**Детальный план:** [`.cursor/plans/завершение_ui_сортировки_исходной_папки_f47c84c8.plan.md`](.cursor/plans/завершение_ui_сортировки_исходной_папки_f47c84c8.plan.md)

---

## Точки остановки для тестирования UI

**Рекомендуемые моменты для остановки и тестирования:**

### ✅ После ЭТАП 1.5 (API обновлен) - Тестирование базовой работы с file_id

**Что можно тестировать:**

- API эндпойнты принимают `file_id` (с fallback на `file_path`)
- Все существующие API работают корректно
- Обратная совместимость с `file_path` сохраняется

**Статус:** Backend готов к работе с `file_id`, но UI еще на `file_path`

---

### ✅ После ЭТАП 2.1 (Базовая карточка) - Тестирование просмотра фотографий

**Что можно тестировать:**

- Карточка фотографий открывается и отображает фото
- Отрисовка rectangles с правильными цветами работает
- Плашки со списком rectangles отображаются
- Навигация по списку работает (базовая версия)

**Статус:** Базовая карточка готова к использованию, редактирование еще в разработке

---

### ✅ После ЭТАП 2.2 (API для редактирования) - Тестирование API редактирования

**Что можно тестировать:**

- API эндпойнты для обновления/удаления rectangles работают
- Контроль взаимной исключительности привязок работает
- Проверка дубликатов работает
- Специальные действия (кот, нет людей, посторонний) работают через API

**Статус:** Backend полностью готов, UI редактирование можно тестировать через API клиент

---

### ✅ После ЭТАП 2.3 (Полное редактирование) - Тестирование полного редактирования

**Что можно тестировать:**

- Drag & drop для перемещения rectangles работает
- Изменение типа привязки работает
- Изменение персоны работает
- Добавление/удаление rectangles работает
- Все функции редактирования доступны в UI

**Статус:** Карточка фотографий полностью функциональна, можно тестировать все сценарии редактирования

---

### ✅ После ЭТАП 2.5 (Интеграция карточки) - Тестирование карточки во всех местах

**Что можно тестировать:**

- Карточка фотографий работает на странице `faces.html`
- Карточка фотографий работает на странице `person_detail.html`
- Карточка фотографий работает на странице `face_cluster_detail.html`
- Навигация между файлами работает во всех контекстах (с поддержкой `api_fallback`)
- UNDO система работает (отмена обновлений, назначений, изменения типа привязки)
- Режим редактирования с якорями для перемещения и изменения размера rectangles
- Изменение типа привязки (кластер ↔ ручная) через меню действий
- Меню действий корректно показывает опции в зависимости от состояния rectangle

**Статус:** ✅ **ЭТАП 2 ПОЛНОСТЬЮ ЗАВЕРШЕН!** Карточка фотографий полностью интегрирована и функциональна. Можно тестировать полный workflow.

**⚠️ КРИТИЧЕСКАЯ ТОЧКА ОСТАНОВКИ:** Рекомендуется остановиться здесь для полного тестирования карточки фотографий перед переходом к следующему этапу.

**Примечание:** Добавление новых rectangles через рисование отложено (требует доработки API для добавления одного rectangle, сейчас есть только замена всех через `/api/faces/manual-rectangles`).

---

### ✅ После ЭТАП 3.2 (Список персон) - Тестирование списка персон

**Что можно тестировать:**

- Список персон отображает правильные подсчеты через `file_id`
- Колонки переименованы на "Фотоархив / Сортируется"
- Кликабельные ссылки ведут на правильные закладки карточки персоны

**Статус:** Список персон готов к использованию

---

### ✅ После ЭТАП 3.4 (Карточка персоны) - Тестирование карточки персоны

**Что можно тестировать:**

- Карточка персоны отображает все типы привязки (кластеры, ручные, прямая)
- Режимы просмотра (Общий / Детальный) работают
- Вкладки "Фотоархив" / "Сортируется" работают
- Подвкладки "Через кластеры", "Через прямоугольники", "Прямая привязка" работают
- Встроенная таблица кластеров отображается
- Якоря URL для прямого перехода работают

**Статус:** Карточка персоны полностью функциональна

---

### ✅ После ЭТАП 3.6 (Синхронизация списка) - Тестирование синхронизации

**Что можно тестировать:**

- При закрытии карточки фотографий список персоны автоматически обновляется
- После обновления списка позиционирование происходит на правильный элемент (по `file_id` + `rectangle_id`)
- Изменение привязки лица к другой персоне в карточке корректно отражается в списке
- Элемент, который больше не принадлежит персоне, исчезает из списка
- Позиционирование работает даже если список изменился (элемент переместился или исчез)

**Статус:** Синхронизация списка работает корректно

**⚠️ КРИТИЧЕСКАЯ ТОЧКА ОСТАНОВКИ:** Рекомендуется остановиться здесь для полного тестирования всей функциональности персон (включая синхронизацию) перед переходом к доработкам.

---

## Итоговая временная оценка

- **ЭТАП 0:** 1-2 дня (заполнение даты съемки)
- **ЭТАП 1:** 6-10 дней (миграция file_id) ⚠️ КРИТИЧНО
- **ЭТАП 2:** 12-17 дней (карточка фотографий)
- **ЭТАП 3:** 9-13 дней (карточка персоны + синхронизация списка)
- **ЭТАП 4:** 5-7 дней (доработки UI сортировки)

**Общая оценка:** 32-48 рабочих дней (6-9 недель)

---

## Рекомендации по реализации

### Подход "маленькими шагами":

1. **После каждого этапа:**

   - Тестирование на реальных данных
   - Коммит с понятным сообщением
   - Проверка работоспособности существующего функционала

2. **Во время миграции file_id (ЭТАП 1):**

   - Поддержка обратной совместимости (принимать и `file_id`, и `file_path`)
   - Постепенный переход: сначала backend, потом frontend
   - Мониторинг производительности

3. **При рефакторингах UI (ЭТАП 2-3):**

   - Использовать новый компонент карточки фотографий во всех местах
   - Сохранить обратную совместимость API
   - Тестировать все сценарии использования

### Риски и меры предосторожности:

1. **Миграция file_id:**

   - Резервная копия БД обязательна
   - Тестирование на копии production
   - Постепенный rollout (dev → production)

2. **Рефакторинги UI:**

   - Сохранение существующего функционала
   - Тестирование всех страниц после изменений
   - Проверка производительности с большими объемами данных

---

## Рекомендации по тестированию

### Стратегия тестирования:

1. **После каждой критической точки остановки:**

   - Полное тестирование функциональности
   - Проверка всех сценариев использования
   - Тестирование с реальными данными
   - Проверка производительности

2. **Критические точки остановки:**

   - **После ЭТАП 2.5** - полное тестирование карточки фотографий
   - **После ЭТАП 3.4** - полное тестирование всей функциональности персон

3. **Инкрементальное тестирование:**

   - После каждого подэтапа можно делать частичное тестирование
   - Но полное тестирование рекомендуется после критических точек

### Что тестировать на каждом этапе:

- **ЭТАП 1:** Backend API, работа с БД, производительность запросов
- **ЭТАП 2:** UI карточки фотографий, все функции редактирования, интеграция
- **ЭТАП 3:** UI списка персон, карточки персоны, все режимы просмотра
- **ЭТАП 4:** Работа с видео, целевая сортировка

---

## Распределение работы между 5 агентами (последовательно)

### Важно

Агенты работают **последовательно**, каждый ждет завершения предыдущего.

### АГЕНТ 1: Миграция file_path → file_id

**Соответствует:** ЭТАП 1 (все подэтапы 1.1-1.7)

**Задачи:**

- ✅ ЭТАП 1.1: Добавить колонки file_id во все таблицы и создать индексы
- ✅ ЭТАП 1.2: Создать и выполнить скрипт миграции данных
- ✅ ЭТАП 1.3: Валидация данных миграции
- ✅ ЭТАП 1.4: Обновить методы FaceStore, DedupStore, PipelineStore
- ✅ ЭТАП 1.5: Обновить API эндпойнты для принятия file_id
- ✅ ЭТАП 1.6: Сделать file_id NOT NULL и добавить FOREIGN KEY
- ✅ ЭТАП 1.7: Обновить диаграммы entities
- ✅ ЭТАП 1.8: Удалить избыточные file_path/path из всех таблиц (привести к 3NF)
- ✅ ЭТАП 1.9: Удалить дублирование колонок из files_manual_labels (привести к 3NF)

**Ход выполнения:**

- ✅ **ЭТАП 1.1 (завершен):** Добавлены колонки `file_id INTEGER` (NULL) во все 7 таблиц и созданы индексы в `backend/common/db.py`
- ✅ **ЭТАП 1.2 (завершен):** Выполнена миграция данных. Обновлено 54356 записей, пропущено 1684 проблемных пути (остались с file_id = NULL)
- ✅ **ЭТАП 1.3 (завершен):** Валидация данных миграции завершена. Все записи с существующими путями успешно мигрированы. Проблемные пути остались с file_id = NULL (ожидаемо)
- ✅ **ЭТАП 1.4 (завершен):** Обновлены методы FaceStore для работы с file_id (12 методов). Добавлены вспомогательные функции `_get_file_id_from_path()` и `_get_file_id()`. Все методы поддерживают обратную совместимость (принимают file_id или file_path)
- ✅ **ЭТАП 1.5 (завершен):** Обновлены API эндпойнты в `face_clusters.py` (4 эндпойнта) и `faces.py` (4 эндпойнта) для принятия file_id с fallback на file_path. Все эндпойнты протестированы и работают
- ✅ **ЭТАП 1.6 (завершен):** Применены NOT NULL и FOREIGN KEY constraints для file_id во всех 7 таблицах. Удалены старые записи с NULL file_id (3807 записей из старых прогонов). Включена поддержка FOREIGN KEY в `get_connection()`
- ✅ **ЭТАП 1.7 (завершен):** Обновлены диаграммы entities (as_is и to_be) под file_id. Добавлены связи files → все таблицы через file_id. Обновлены PNG диаграммы

**✅ ЭТАП 1 ПОЛНОСТЬЮ ЗАВЕРШЕН!** Миграция file_path → file_id полностью выполнена. БД приведена к 3NF. Все избыточности удалены.

**Выполнено:**
- ✅ **ЭТАП 1.8:** Удалены избыточные `file_path`/`path` из 7 таблиц (БД приведена к 3NF)
- ✅ **ЭТАП 1.9:** Удалены избыточные колонки `*_manual_*` из `files` (6 колонок удалены, БД приведена к 3NF)

**Детальный план:** [`.cursor/plans/миграция_с_file_path_на_file_id_fd267bed.plan.md`](.cursor/plans/миграция_с_file_path_на_file_id_fd267bed.plan.md)

**Оценка:** 6-10 дней

**Результат:** Backend готов к работе с `file_id`, API принимает `file_id` (с fallback на `file_path`)

---

### АГЕНТ 2: Карточка фотографий

**Соответствует:** ЭТАП 2 (все подэтапы 2.1-2.5)

**Зависимость:** Требует завершения АГЕНТ 1 (работа с `file_id`)

**Задачи:**

- ✅ ЭТАП 2.1: Создать единый модуль photo_card.js и шаблон photo_card.html (работа с file_id)
- ✅ ЭТАП 2.2: Реализовать API для редактирования rectangles (с file_id)
- ✅ ЭТАП 2.3: Реализовать функциональность редактирования (drag&drop, изменение персоны, добавление/удаление)
- ✅ ЭТАП 2.4: Реализовать навигацию по списку и UNDO систему
- ✅ ЭТАП 2.5: Интегрировать карточку фотографий в faces.html, person_detail.html, face_cluster_detail.html

**Ход выполнения:**

- ✅ **ЭТАП 2.1 (завершен):** Создана базовая структура единого модуля карточки фотографий:
  - Создан `backend/web_api/static/photo_card.js` с функцией `openPhotoCard()` для работы с `file_id` (приоритет) и `file_path` (fallback)
  - Создан `backend/web_api/templates/photo_card.html` с базовой HTML структурой карточки
  - Реализована базовая функциональность: открытие карточки, загрузка изображения, загрузка rectangles через API, отрисовка rectangles с правильными цветами
  - Поддержка режимов archive/sorting, навигация (базовая структура), переключение видимости rectangles

- ✅ **ЭТАП 2.2 (завершен):** Реализованы API эндпойнты для редактирования rectangles:
  - `POST /api/faces/rectangle/update` - обновление rectangle (координаты, тип, персона) с контролем взаимной исключительности привязок
  - `POST /api/faces/rectangle/delete` - удаление rectangle (помечает как ignore_flag = 1)
  - `POST /api/faces/rectangles/assign-outsider` - назначение всех неназначенных rectangles персоне "Посторонний"
  - `POST /api/faces/file/mark-as-cat` - пометка файла как "кот" (удаляет rectangles, устанавливает метку)
  - `POST /api/faces/file/mark-as-no-people` - пометка файла как "нет людей" (удаляет rectangles, устанавливает метку)
  - `GET /api/faces/rectangles/duplicates-check` - проверка дубликатов персоны на фото
  - Все эндпойнты поддерживают `file_id` (приоритет) и `file_path` (fallback)
  - Реализован контроль взаимной исключительности: rectangle может быть либо в кластере, либо иметь ручную привязку
  - Добавлен `assignment_type` в ответ API `/api/faces/rectangles` для различения типов привязок

- ✅ **ЭТАП 2.3 (завершен, частично):** Реализована функциональность редактирования:
  - ✅ Режим редактирования с якорями для перемещения и изменения размера rectangles (9 якорей: углы, стороны, центр)
  - ✅ Изменение типа привязки (кластер ↔ ручная) через меню действий
  - ✅ Изменение персоны через диалог выбора персоны
  - ✅ Удаление rectangles
  - ⚠️ Добавление новых rectangles (рисование) - отложено (требует доработки API для добавления одного rectangle)

- ✅ **ЭТАП 2.4 (завершен):** Реализованы навигация по списку и UNDO система:
  - ✅ Полная навигация между фото (prev/next) с поддержкой `api_fallback` для загрузки страниц за пределами загруженных `items`
  - ✅ Навигация клавиатурой (стрелки влево/вправо)
  - ✅ Сохранение контекста в `sessionStorage` при закрытии карточки (current_index, параметры API)
  - ✅ UNDO система с поддержкой отмены действий: `update_rectangle`, `assign_person`, `change_assignment_type`
  - ✅ Кнопка UNDO в интерфейсе с автоматическим показом/скрытием

- ✅ **ЭТАП 2.5 (завершен):** Интегрирована карточка фотографий во все страницы:
  - ✅ `faces.html` - интегрирована с `list_context` и `api_fallback` для навигации по результатам сортировки
  - ✅ `person_detail.html` - интегрирована с `list_context` для навигации по лицам персоны
  - ✅ `face_cluster_detail.html` - интегрирована с `list_context` для навигации по лицам кластера
  - ✅ Все интеграции поддерживают `highlight_rectangle` для выделения конкретного rectangle при открытии

**Детальный план:** [`.cursor/plans/рефакторинг_карточки_фотографий.plan.md`](.cursor/plans/рефакторинг_карточки_фотографий.plan.md)

**✅ ЭТАП 2 ПОЛНОСТЬЮ ЗАВЕРШЕН!** Рефакторинг карточки фотографий полностью выполнен. Все основные функции реализованы и интегрированы.

**Оценка:** 12-17 дней

**Результат:** Единая карточка фотографий готова и интегрирована во все страницы. Реализованы: навигация, редактирование (через якоря), изменение типа привязки, UNDO система, меню действий.

**Критическая точка остановки:** ✅ Достигнута. Можно тестировать полный workflow карточки фотографий.

**Примечание:** Добавление новых rectangles через рисование отложено (требует доработки API для добавления одного rectangle).

---

### АГЕНТ 3: Карточка персоны

**Соответствует:** ЭТАП 3 (все подэтапы 3.1-3.5)

**Зависимость:** Требует завершения АГЕНТ 1 и АГЕНТ 2 (работа с `file_id`, использование карточки фотографий)

**Задачи:**

- ✅ ЭТАП 3.1: Исправить API для списка персон - подсчеты через file_id (JOIN с files) - ЗАВЕРШЕНО
- ✅ ЭТАП 3.2: Обновить UI списка персон - вернута логика этапа 2 (кластеры - одно число, лица - 4 разреза) - ЗАВЕРШЕНО
- ✅ ЭТАП 3.3: Расширить API карточки персоны для всех типов привязки (с file_id) - ЗАВЕРШЕНО
- ✅ ЭТАП 3.4: Обновить UI карточки персоны - режимы просмотра, вкладки, подвкладки, цветные бейджи типов привязки - ЗАВЕРШЕНО (таблица кластеров - TODO)
- ✅ ЭТАП 3.4b: Кнопки на карточке фото — Аватар только для архива; для сортировки: Посторонний, Кот, Не лицо, Другой (выпадашка персон)
- ✅ ЭТАП 3.5: Обновить форму неназначенных кластеров - показ сортируемых кластеров (фильтр архив/прогон/все, визуальное разделение)
- ✅ ЭТАП 3.6: Синхронизация списка персоны после изменений в карточке фотографий - отправка события при закрытии, обновление списка с позиционированием по file_id + rectangle_id

**Детальный план:** [`.cursor/plans/рефакторинг_списка_и_карточки_персоны.plan.md`](.cursor/plans/рефакторинг_списка_и_карточки_персоны.plan.md)

**Оценка:** 8-12 дней

**Результат:** Список персон и карточка персоны полностью функциональны с поддержкой всех типов привязки

**✅ ЭТАП 3 ПОЛНОСТЬЮ ЗАВЕРШЕН!** Все задачи выполнены:
- ✅ ЭТАП 3.1: Исправлен API для списка персон
- ✅ ЭТАП 3.2: Обновлен UI списка персон
- ✅ ЭТАП 3.3: Расширен API карточки персоны для всех типов привязки
- ✅ ЭТАП 3.4: Обновлен UI карточки персоны (режимы, вкладки, подвкладки, бейджи)
- ✅ ЭТАП 3.4b: Реализованы кнопки на карточке фото в зависимости от контекста
- ✅ ЭТАП 3.5: Обновлена форма неназначенных кластеров с фильтром архив/прогон/все
- ✅ ЭТАП 3.6: Реализована синхронизация списка персоны после изменений в карточке фотографий

**Критическая точка остановки:** ✅ Достигнута. Можно тестировать всю функциональность персон, включая синхронизацию списка.

---

### АГЕНТ 4: Сортировка лиц (завершение UI сортировки)

**Соответствует:** ЭТАП 4 (подэтапы 4.1-4.2)

**Зависимость:** Требует завершения АГЕНТ 1-3 (работа с `file_id`, новые UI компоненты)

**Задачи:**

- ЭТАП 4.1: Улучшить работу с видео - ключевые кадры, смена кадра, исправление разметки
- ЭТАП 4.2: Реализовать применение правил сортировки из folders и перемещение в архив (с file_id)

**Детальный план:** [`.cursor/plans/завершение_ui_сортировки_исходной_папки_f47c84c8.plan.md`](.cursor/plans/завершение_ui_сортировки_исходной_папки_f47c84c8.plan.md)

**Оценка:** 5-7 дней

**Результат:** Улучшенная работа с видео и целевая сортировка по правилам

---

### АГЕНТ 5: Заполнение даты съемки

**Соответствует:** ЭТАП 0

**Зависимость:** Нет (независимая задача, можно делать в любое время)

**Задачи:**

- Создать скрипт `backend/scripts/tools/backfill_taken_at.py`
- Реализовать парсинг дат из имени файла
- Реализовать получение дат из системных атрибутов
- Интегрировать извлечение дат из EXIF
- Реализовать основную логику обработки с приоритетным порядком

**Детальный план:** [`.cursor/plans/заполнение_даты_съемки.plan.md`](.cursor/plans/заполнение_даты_съемки.plan.md)

**Оценка:** 1-2 дня

**Результат:** Скрипт для заполнения пустых значений `taken_at` для всех фотографий и видео

**Примечание:** Эту задачу можно выполнить в любое время (после АГЕНТ 1 или в конце)

---

## Сводная таблица распределения

| Агент | Задача | Этап Master Plan | Зависимости | Оценка времени |
|-------|--------|------------------|-------------|----------------|
| **АГЕНТ 1** | Миграция file_path → file_id | ЭТАП 1 | Нет (базовый) | 6-10 дней |
| **АГЕНТ 2** | Карточка фотографий | ЭТАП 2 | Требует АГЕНТ 1 | 12-17 дней |
| **АГЕНТ 3** | Карточка персоны | ЭТАП 3 | Требует АГЕНТ 1 + АГЕНТ 2 | 8-12 дней |
| **АГЕНТ 4** | Сортировка лиц | ЭТАП 4 | Требует АГЕНТ 1-3 | 5-7 дней |
| **АГЕНТ 5** | Даты съемки | ЭТАП 0 | Нет (независимая) | 1-2 дня |

**Общая оценка:** 32-48 рабочих дней (6-9 недель) при последовательной работе

**Порядок выполнения:** АГЕНТ 1 → АГЕНТ 2 → АГЕНТ 3 → АГЕНТ 4 (+ АГЕНТ 5 можно в любое время после АГЕНТ 1)

**ЭТАП 5 (Миграция переименования таблиц rectangles):** ✅ ЗАВЕРШЕН. Миграция выполнена через `_ensure_face_schema()` при запуске приложения. Таблицы переименованы: `face_rectangles` → `photo_rectangles`, `face_person_manual_assignments` → `person_rectangle_manual_assignments`. Добавлена колонка `is_face` (1=лицо, 0=персона). Во все SQL-запросы добавлен фильтр `is_face=1` для работы только с лицами. Детальный план: [`docs/archive/миграция_переименования_таблиц_rectangles_598f927a.plan.md`](docs/archive/миграция_переименования_таблиц_rectangles_598f927a.plan.md)

---

## Вопросы для уточнения

1. **Приоритет миграции file_id:**

   - Можно ли начать рефакторинги UI сейчас с `file_path`, а миграцию сделать позже? (риск двойной работы)
   - Или лучше сначала миграция, потом UI? (рекомендуется)

2. **Завершение UI сортировки:**

   - Какие задачи из плана критичны для текущей работы?
   - Можно ли отложить некритичные доработки?

3. **Параллельная работа:**

   - Можно ли делать "Заполнение даты съемки" параллельно с другими задачами?
