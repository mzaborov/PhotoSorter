---
name: Сортировка по финальным папкам архива
overview: Настройка правил сортировки на папках архива (disk:/Фото), новый шаг pipeline — разложить файлы по правилам локально, шаг переноса в фотоархив, встраивание в UI (Главная) и удаление рудиментарных кнопок.
todos:
  - id: folder-rules
    content: Настройка правил сортировки на папках архива (folders) — хранение и UI
    status: completed
  - id: pipeline-local-sort
    content: Новый шаг pipeline — разложить файлы по правилам локально
    status: completed
  - id: step4-sorting-folders-ui
    content: "Шаг 4 (sorting-folders): целевые папки без _no_faces, вкладка Путешествия с вложенными подвкладками"
    status: completed
  - id: pipeline-upload
    content: Шаг pipeline — перенести файлы в фотоархив (disk:/Фото)
    status: completed
  - id: ui-main-steps
    content: Встраивание в UI — шаги на Главную, убрать рудиментарные кнопки
    status: completed
isProject: false
---

# План: сортировка по финальным папкам (согласно README)

## Цель

Доделать сортировку по финальным папкам архива `disk:/Фото` согласно логике из `docs/README.md`: правила приоритета (только/вместе/содержит), разложение локально по правилам, перенос в фотоархив, единый поток в UI.

## Контекст из README

- **Правила**: `только:[X]`, `вместе:[A,B,C...]`, `содержит:[X,Y...]`; учёт `presence_score`; якорение (не трогать закреплённые файлы).

**Порядок приоритета (сверху — раньше)** — моноширинный блок для удобства чтения:

```
  №  Папка                      Путь                            Правило
  1  Без людей и животных       (имя уточнить)                   Нет людей и нет кошек/собак
  2  Агата                      disk:/Фото/Агата                 только:[Агата]
  3  Санек                      disk:/Фото/Санек                 только:[Санек]
  4  Нюся                       disk:/Фото/Нюся                  только:[Нюся]
  5  Темка                      disk:/Фото/Темка                 только:[Темка]
  6  Дети вместе                disk:/Фото/Дети вместе            вместе:[Агата, Санек, Нюся, Темка]
  7  Миша и Аня                 disk:/Фото/Миша и Аня             содержит:[Миша, Аня]
  8  Бабушки и Дедушки          disk:/Фото/Бабушки и Дедушки       содержит:[...] (список персон)
  9  Семья                      disk:/Фото/Семья                  содержит:[...] (список персон)
 10  Котэ и сцобако             disk:/Фото/Котэ и сцобако         Есть кошка/собака (животные)
 11  Другие люди                disk:/Фото/Другие люди            Есть люди, не сработало ничего выше
```

Дополнительно: Путешествия, Технологии (крупные папки в справочнике).

**Маппинг в новую структуру** — текущие вкладки Faces и куда попадают файлы после «разложить по правилам» и «перенести в архив»:

```
  Текущее место в UI              Смысл                              После шагов 2–4 (целевая папка архива)
  ─────────────────────────────────────────────────────────────────────────────────────────────────────────
  Люди → К разбору                 Файлы с лицами, ещё не разложены    Остаются в _faces до шага 2; после шага 2 — по правилам (Агата, Дети вместе, … или Другие люди)
  Люди → person_Агата (и др.)      Файлы, где назначена эта персона   только:[Агата] → disk:/Фото/Агата; если в кадре ещё кто-то — по приоритету (Дети вместе, Семья и т.д.)
  Люди → Много лиц                 ≥8 лиц, есть неназначенные        После разметки персон — по тем же правилам (вместе/содержит/Другие люди)
  Люди → Лица                      Все файлы с лицами                Просмотр; целевая папка у каждого по правилам
  Животные                         Файлы с животными                  disk:/Фото/Котэ и сцобако
  Нет людей → Фото/Видео к разбору Без лиц, не в группе               Остаются в _no_faces; при переносе — «Без людей и животных» или по группе/поездке
  Нет людей → group_*              Группы по месту/дате                disk:/Фото/Путешествия/<подпапка> или группа→папка по маппингу
```

Вкладки Faces не исчезают — остаются экраном разметки; после шагов 2–4 файлы получают целевую папку архива по правилам выше.

### Presence_score

**Уже считается.** Для фото: доля площади лица среди всех лиц в кадре `area(face_bbox) / sum(area(all_face_bbox))` — считается в `face_scan.py` и в `local_sort.py` (scan_faces_local), сохраняется в `photo_rectangles.presence_score`. Для видео в README описана «доля времени/кадров»; в коде при необходимости доработать. При шаге «разложить по правилам» использовать `presence_score` для приоритета (например не отправлять в «Дети вместе», если персона «мелькнула»).

### Животные → Котэ и сцобако

Вкладка **Животные** на странице Faces целиком соответствует папке архива **Котэ и сцобако** (`disk:/Фото/Котэ и сцобако`). Все файлы из вкладки «Животные» при сортировке по правилам должны попадать только в эту папку (без дополнительных подпапок по персонам).

### Поездки и группы → папки архива

- **Поездки:** файлы из «Нет людей», сгруппированные в поездки (по месту/дате, `trip_group`/`trip_label` в UI), нужно раскладывать по папкам. **Сначала — локальная раскладка** (в папки-аналоги целевой структуры), затем перенос в архив. Целевая структура: `disk:/Фото/Путешествия/<подпапка поездки>` (например «2023 Стамбул», «2024 Тургояк»). Группы хранятся в `file_groups.group_path` (например «Поездки/2023 Стамбул»).
- **Совпадающие названия поездок:** на диске или в архиве уже могут существовать папки с тем же именем (например уже есть «2024 Тургояк» и «2023 Стамбул»). Нужно определить политику: (a) **объединять** в существующую папку (добавлять файлы в уже существующую «2024 Тургояк»); (b) создавать **подпапку или суффикс** для новой партии (например «2024 Тургояк (2)» или «2024 Тургояк/2024-06»); (c) **запрос пользователя** при первом совпадении. Решение оформить в правилах или настройках шага.
- **Workaround: поездки по смыслу совпадают, названия различаются.** В рамках этого плана — только **скрипт синхронизации**: синхронизировать названия поездок между БД и папками ЯД (и при необходимости с Excel `Поездки.xlsx`), чтобы при сортировке по правилам использовались единые названия. Полный интерфейс поездок (таблица поездок с датами, привязка фото через папку ЯД и напрямую, список/карточка поездки, предложения по датам ±1 нед) — **отдельный план** [поездки_интерфейс_и_таблица.plan.md](.cursor/plans/поездки_интерфейс_и_таблица.plan.md).
- **Остальные группы (не поездки):** файлы «Нет людей» с группами Технологии, Чеки, Мемы, Дом и ремонт, Здоровье и т.д. **не заливаются на ЯД автоматически**. Они раскладываются по **локальным папкам** под корнем прогона (каждая группа — своя папка: `local:root/Технологии`, `local:root/Чеки` и т.д.). После «Переместить файлы локально» этим файлам выставляется `inventory_scope = 'local_done'` — они **убираются из прогона** (не показываются в шаге 4 / sorting_folders). Дальше пользователь вручную растаскивает их куда нужно.

## Ограничения и правила обработки

### Папки, которые не обрабатываются

При определении целевой папки и при перекладке **не обрабатываются** файлы из служебных папок: `_non_media`, `_broken_media`, `_deleted`, `_sorted`. Эти папки исключены из логики сортировки по правилам (файлы там не трогаем или не считаем кандидатами на перекладку по правилам).

### Временная раскладка vs целевая

- Текущая раскладка по папкам (`_faces`, `_quarantine`, `_animals`, `_people_no_face`, `_no_faces`) — **временная**. В целевой структуре архива (`disk:/Фото/...`) таких папок не будет.
- **Логика сортировки не зависит от того, где файл лежит на диске.** Целевая папка определяется только по данным в БД (персоны, привязки, группы, presence_score, правила). В том числе поддерживается сценарий: файлы уже разложены по целевым папкам локально (например `C:\tmp\Photo\Агата`) — пользователь может запустить сортировку заново (например после настройки Presence), и файлы переложатся по новым правилам.

### Шаг настройки Presence и повторный запуск

Нужен шаг, когда пользователь **просматривает локальные папки** (результат разложения по правилам) и **предлагает, как использовать Presence** для сортировки (пороги, исключения «мелькнувших» и т.п.). После настройки запускается сортировка заново — файлы перекладываются по обновлённым правилам с учётом presence_score.

### Сохранение привязок при перекладке

При любом перемещении файлов (локально или в архив):

- **Все привязки лиц и прямоугольников сохраняются** — меняется только путь файла в БД (`files.path`, ссылки в `photo_rectangles` через `file_id`; при смене пути — `update_file_path` по старый path → новый path). Thumbnail (кроп лица) привязан к прямоугольнику, не к пути; **пересчитывать thumbnail не требуется** при смене пути файла.

### Перенос в архив

- При переносе файла в фотоархив (`disk:/Фото/...`) нужно **менять тип/статус** с «сортируемый» на «фото» (например флаг или scope: из pipeline_run/source в archive), чтобы в UI и в последующих прогонах файл считался уже в архиве.
- Файл на **локальном диске** после успешной загрузки в архив **перемещать в папку `_sorted`** (чтобы не смешивать с ещё не разобранными).
- **После шага «перенести в архив» (шаг 4):** файлы, перенесённые в архив, **уходят с интерфейса Faces** — на странице Faces показываются только файлы, ещё не в архиве (сортируемые). В **карточке персоны** вкладка **«Фотоархив» уже есть**; файлы, уже в архиве (path в `disk:/Фото/...` или статус «в архиве»), отображаются на ней; при переносе в архив файлы «переезжают» на эту вкладку и не показываются в основной сетке сортируемых.

### Повторная обработка остатков

Всё, что осталось в `_faces`, `_quarantine`, `_animals`, `_people_no_face`, `_no_faces` или в исходной папке (например неразобранное видео), можно **повторно через интерфейс** проходить — перекладывать по правилам и дозагружать в архив. Отдельный сценарий: «добработать позже» (например предстоит разобраться с видео).

## Задачи

(Содержимое задач 1–5 и детализация по шагам сохранены в архивированной версии плана; все пункты помечены выполненными.)

## Выполнено в сессии 2026-01-31 (шаг 4 — sorting-folders)

- **Целевые папки для no_faces (без _no_faces):** в `sort_rules.determine_target_folder` для «Нет людей» с группой: поездки → `Путешествия/...` под корнем, остальное (Чеки, Здоровье и т.д.) — прямо под корнем. Имя папки из справочника — «Путешествия» (поддержаны и «Поездки»/«Путешествия» в `group_path`).
- **Страница sorting-folders:** одна вкладка «Путешествия» вместо плоского списка поездок; внутри — вложенные подвкладки (одна на поездку: 2024 Турция, 2025 Гончарка Москва и т.д.). Подвкладки визуально отделены от вкладок 1-го уровня (другой стиль, блок `.subtabs-wrap`). Группировка по ключам с `/Путешествия/` и по старым ключам `_no_faces/Поездки` и `_no_faces/Путешествия`.
- **Tooltip на вкладках:** при наведении показывается «Целевая папка: <полный путь>».
- **Файлы:** `backend/common/sort_rules.py`, `backend/web_api/templates/sorting_folders.html`, комментарии в `backend/web_api/routers/faces.py`.

## Связанные документы и планы

- `docs/README.md` — разделы «Целевые папки и порядок», «Точные правила сортировки», «Логика для сортировки с учётом лиц».
- Таблица `folders` и страница `/folders` — текущий справочник папок архива.
- **План «Поездки — таблица и интерфейс»** ([.cursor/plans/поездки_интерфейс_и_таблица.plan.md](.cursor/plans/поездки_интерфейс_и_таблица.plan.md)) — отдельная таблица поездок с датами, привязка фото (через папку ЯД и напрямую), интерфейс списка/карточки поездки, предложения по датам (±1 нед). В этом плане только скрипт синхронизации поездок для единообразия названий при сортировке.

## Завершение плана (2026-02-06)

Все задачи плана выполнены. Прогон 26: все фото отсортированы и перенесены в архив. Сделан бекап БД с пометкой `run26_all_sorted_archive`. Счётчики «Фотоархив»/«Сортируется» на странице персоны считаются только по `files.inventory_scope`. При переносе в архив обрабатывается 409 PathExistsError (файл уже на ЯД) — обновление БД без повторной загрузки. План перенесён в `docs/archive/`.
