# Миграция: Группы персон

## Цель
Добавить функциональность групп персон для организации списка персон и упрощения назначения персон в формах.

## Группы (в порядке приоритета)

1. **Я и Супруга** (order: 1)
   - Заборов Михаил
   - Рид Анна

2. **Дети** (order: 2)
   - Агата
   - Санек
   - Нюся
   - Темка

3. **Родственники** (order: 3)
   - Заборов Андрей
   - Света Заборова
   - Сергеев Александр
   - Сергеева Наталья
   - Бабушка Ева
   - Мама
   - Папа
   - Заборова Юля
   - Тимофей
   - Богдан
   - Ася

4. **Синяя диагональ** (order: 4)
   - Бульба
   - Шатин
   - Аксельрод
   - Тоха
   - Леня Штишевский

5. **Работа** (order: 5)
   - Герман Алексеев

---

## План выполнения

### ✅ Шаг 1: Миграция БД
- [x] Добавить поле `group` в таблицу `persons` (TEXT, NULL)
- [x] Добавить поле `group_order` в таблицу `persons` (INTEGER, NULL) - для сортировки групп
- [x] Обновить функцию `_ensure_columns` или создать миграцию в `backend/common/db.py`
- [ ] Протестировать миграцию на существующей БД

**Файлы:**
- `backend/common/db.py` - добавление полей через `_ensure_columns`

---

### ✅ Шаг 2: Константы групп
- [x] Создать константу `PERSON_GROUPS` с определением групп и их порядком
- [x] Создать функцию для получения порядка группы по имени
- [x] Создать функцию для получения списка всех групп

**Файлы:**
- `backend/web_api/routers/face_clusters.py` - добавить константы в начало файла

**Структура:**
```python
PERSON_GROUPS = {
    "Я и Супруга": {"order": 1},
    "Дети": {"order": 2},
    "Родственники": {"order": 3},
    "Синяя диагональ": {"order": 4},
    "Работа": {"order": 5},
}
```

---

### ✅ Шаг 3: Обновление API эндпойнтов

#### 3.1. `/api/persons/list`
- [x] Добавить поле `group` в SELECT запрос
- [x] Добавить поле `group_order` в SELECT запрос
- [x] Вернуть `group` и `group_order` в JSON ответе
- [x] Сортировать по `group_order` ASC, затем по `name` ASC

**Файлы:**
- `backend/web_api/routers/face_clusters.py` - функция `api_persons_list()`

#### 3.2. `/api/persons/stats`
- [x] Добавить поле `group` в SELECT запрос
- [x] Добавить поле `group_order` в SELECT запрос
- [x] Вернуть `group` и `group_order` в JSON ответе
- [x] Сортировать по `group_order` ASC, затем по `name` ASC

**Файлы:**
- `backend/web_api/routers/face_clusters.py` - функция `api_persons_stats()`

#### 3.3. `/api/persons/{person_id}` (GET)
- [x] Добавить поле `group` в SELECT запрос
- [x] Вернуть `group` в JSON ответе

**Файлы:**
- `backend/web_api/routers/face_clusters.py` - функция `api_person_detail()`

#### 3.4. `/api/persons/{person_id}` (PUT)
- [x] Разрешить изменение поля `group` через payload
- [x] Обновлять `group_order` на основе `PERSON_GROUPS`
- [x] Обновлять `updated_at` при изменении

**Файлы:**
- `backend/web_api/routers/face_clusters.py` - функция `api_person_update()`

#### 3.5. `/api/persons/create` (POST)
- [x] Разрешить указание `group` в payload при создании
- [x] Устанавливать `group_order` на основе `PERSON_GROUPS`

**Файлы:**
- `backend/web_api/routers/face_clusters.py` - функция `api_persons_create()`

---

### ✅ Шаг 4: Обновление UI - Список персон

#### 4.1. `persons_list.html`
- [x] Изменить функцию `loadPersons()` для группировки персон
- [x] Добавить отображение заголовков групп
- [x] Сортировать персон по группам (по `group_order`), внутри группы - по имени
- [x] Добавить визуальное разделение между группами (отступы, границы)

**Файлы:**
- `backend/web_api/templates/persons_list.html`

**Структура отображения:**
```
## Я и Супруга
- Заборов Михаил
- Рид Анна

## Дети
- Агата
- Санек
- Нюся
- Темка

...
```

---

### ✅ Шаг 5: Обновление UI - Карточка персоны

#### 5.1. `person_detail.html`
- [x] Добавить поле выбора группы (select) в секцию "Управление персоной"
- [x] Загружать список доступных групп из константы `PERSON_GROUPS`
- [x] Отображать текущую группу персоны
- [x] Добавить кнопку "Сохранить" для группы
- [x] Реализовать сохранение группы через `PUT /api/persons/{person_id}`

**Файлы:**
- `backend/web_api/templates/person_detail.html`

**Расположение:**
- В секции "Управление персоной", после поля "Имя персоны"

---

### ✅ Шаг 6: Обновление UI - Формы назначения персоны

#### 6.1. `face_cluster_detail.html` - модальное окно назначения
- [x] Изменить функцию загрузки списка персон для группировки
- [x] Использовать `<optgroup>` для группировки персон в `<select>`
- [x] Сортировать группы по `group_order`, внутри группы - по имени
- [x] Добавить группу "Без группы" для персон без группы (в конце списка)

**Файлы:**
- `backend/web_api/templates/face_cluster_detail.html`

**Структура select:**
```html
<select>
  <optgroup label="Я и Супруга">
    <option value="1">Заборов Михаил</option>
    <option value="2">Рид Анна</option>
  </optgroup>
  <optgroup label="Дети">
    <option value="3">Агата</option>
    ...
  </optgroup>
  ...
  <optgroup label="Без группы">
    <option value="10">Персона без группы</option>
  </optgroup>
</select>
```

#### 6.2. `person_detail.html` - модальное окно переназначения
- [x] Изменить функцию `reassignFace()` для группировки персон
- [x] Использовать `<optgroup>` для группировки персон в `<select>`
- [x] Сортировать группы по `group_order`, внутри группы - по имени
- [x] Добавить группу "Ближайшие по embeddings" (если есть) - в начале
- [x] Добавить группу "Без группы" для персон без группы (в конце списка)

**Файлы:**
- `backend/web_api/templates/person_detail.html`

---

### ✅ Шаг 7: Массовое назначение групп (опционально)

#### 7.1. Скрипт для назначения групп существующим персонам
- [x] Создать скрипт `backend/scripts/tools/assign_person_groups.py`
- [x] Реализовать логику сопоставления имен персон с группами
- [x] Обновить `group` и `group_order` для существующих персон
- [x] Добавить dry-run режим для проверки перед применением

**Файлы:**
- `backend/scripts/tools/assign_person_groups.py` (создан)

**Логика:**
- Читать список персон из БД
- Сопоставлять по имени с группами из `PERSON_GROUPS`
- Обновлять `group` и `group_order` в БД

**Использование:**
```bash
# Проверка (dry-run)
python backend/scripts/tools/assign_person_groups.py

# Применение изменений
python backend/scripts/tools/assign_person_groups.py --apply
```

---

### ✅ Шаг 8: Тестирование

#### 8.1. Функциональное тестирование
- [ ] Проверить отображение списка персон по группам
- [ ] Проверить редактирование группы в карточке персоны
- [ ] Проверить группировку в форме назначения кластера персоне
- [ ] Проверить группировку в форме переназначения лица
- [ ] Проверить создание новой персоны с указанием группы
- [ ] Проверить сортировку: группы в правильном порядке, внутри группы - по имени

#### 8.2. Проверка миграции БД
- [ ] Убедиться, что поля `group` и `group_order` добавлены
- [ ] Убедиться, что существующие персоны не сломались (NULL значения допустимы)
- [ ] Проверить работу с персонами без группы

---

### ✅ Шаг 9: Документация

#### 9.1. Обновление README
- [ ] Добавить описание функциональности групп персон
- [ ] Описать как назначать группы персон
- [ ] Описать порядок групп

**Файлы:**
- `docs/README.md` или `README.md`

---

## Примечания

- Поле `group` может быть NULL (персоны без группы)
- Поле `group_order` может быть NULL (для персон без группы, сортируются в конце)
- При создании новой персоны без указания группы - `group` и `group_order` остаются NULL
- В формах назначения персоны без группы отображаются в группе "Без группы" в конце списка
- Сортировка: сначала по `group_order` ASC (NULL в конце), затем по `name` ASC

---

## Статус выполнения

**Начато:** 2026-01-XX  
**Завершено:** 2026-01-XX  
**Статус:** ✅ ЗАВЕРШЕНО

**Выполнено:**
- ✅ Миграция БД (поля `group` и `group_order`)
- ✅ Константы групп и функции
- ✅ Все API эндпойнты обновлены
- ✅ UI списка персон с группировкой
- ✅ Карточка персоны с редактированием группы
- ✅ Формы назначения персоны с группировкой
- ✅ Скрипт массового назначения групп создан и протестирован

**Исправления:**
- ✅ Исправлена проблема с зарезервированным словом `group` в SQL (использованы кавычки)
- ✅ Исправлена ошибка кодировки в скрипте (заменена стрелка → на ->)

---

## История изменений

- 2026-01-XX - Создан план миграции
- 2026-01-XX - Реализована основная функциональность групп персон
- 2026-01-XX - Исправлена проблема с SQL зарезервированным словом `group`
- 2026-01-XX - Создан и протестирован скрипт массового назначения групп
- 2026-01-XX - Миграция завершена, план перенесен в архив
