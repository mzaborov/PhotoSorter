---
name: Завершение UI сортировки исходной папки
overview: Реализация расширенной системы привязки файлов к персонам (3 способа), реорганизация закладок с подзакладками по персонам, улучшение работы с видео, и целевая сортировка по папкам.
todos:
  - id: db_schema
    content: "Создать таблицы: person_rectangles, file_persons, file_groups, file_group_persons в backend/common/db.py"
    status: completed
  - id: api_person_assignments
    content: "Реализовать API для 3 способов привязки к персоне: POST /api/persons/assign-rectangle, assign-file, remove-assignment"
    status: completed
  - id: faces_tab_rename
    content: Переименовать вкладку 'Есть лица' в 'Люди' в faces.html и faces.py
    status: completed
  - id: person_subtabs
    content: Реализовать подзакладки по персонам в закладке Люди (динамические на основе кластеров и назначений)
    status: completed
  - id: people_no_face_move
    content: Перенести 'Люди без лица' в подзакладку 'Люди' -> 'К разбору'
    status: completed
  - id: quarantine_subtab
    content: Перенести 'Карантин' в подзакладку 'Нет людей'
    status: completed
  - id: no_faces_rename
    content: Переименовать 'Нет лиц' в 'Нет людей'
    status: completed
  - id: file_groups_hierarchical
    content: Реализовать иерархические группы для Нет людей (Поездки, Мемы, Здоровье и т.д.)
    status: completed
  - id: multiple_persons_ui
    content: "Реализовать UI для режима 'несколько персон': галочка 'Персона не одна', кнопка '+ Добавить персону'"
    status: completed
  - id: tab_switching_logic
    content: "Реализовать логику переключения закладок: файл пропадает с 'к разбору', появляется на подзакладках персон"
    status: completed
  - id: video_keyframes_improve
    content: Улучшить выбор ключевых кадров видео (приоритет кадров с лицами)
    status: pending
  - id: video_change_keyframe
    content: Реализовать смену ключевого кадра с автодетекцией лиц
    status: pending
  - id: video_face_marking_fix
    content: Исправить разметку лиц и прямоугольников на кадрах видео
    status: pending
  - id: person_detail_display
    content: Обновить отображение файлов в карточке персоны по способам привязки
    status: pending
  - id: persons_list_stats
    content: Добавить статистику по способам привязки в список персон
    status: in_progress
  - id: sort_rules_folders
    content: Реализовать применение правил сортировки из folders к файлам прогона
    status: pending
  - id: local_sort_folders
    content: Реализовать локальную сортировку файлов по правилам в папки прогона
    status: pending
  - id: move_to_archive
    content: Реализовать перемещение отсортированных файлов в фотоархив на YaDisk
    status: pending
---

# План: Завершение UI сортировки исходной папки

## Цели и ключевые идеи

### Основная цель

Завершить разработку UI для сортировки исходной папки (прогон 26), обеспечив полноценную работу с привязкой файлов к персонам, удобную организацию закладок и автоматическую сортировку по правилам.

### Ключевой User Story

**Основной сценарий использования:**

1. **Указание исходной папки:** Пользователь указывает исходную папку, которую нужно отсортировать
2. **Работа с дубликатами:** Сортировщик-автомат показывает дубликаты, пользователь их просматривает и нажимает кнопку "Удалить"
3. **Автоматическая категоризация:** Сортировщик-автомат раскладывает файлы по категориям (лица, животные, нет людей и т.д.)
4. **Ручная проверка и уточнение:** Пользователь проходит по категориям и проверяет/уточняет автоматическую сортировку:

- Назначает персон (3 способами: через лица, через прямоугольники, напрямую)
- Группирует файлы "Нет людей" по категориям (поездки, мемы, здоровье и т.д.)
- Исправляет ошибки автоматической сортировки

5. **Завершение и отправка в архив:** Пользователь нажимает "Ручная сортировка завершена" — файлы уезжают в фотоархив на YaDisk
6. **Удаление мусора:** Все отфильтрованное удаляется как мусор (только то, что пользователь явно пометил для удаления)

**Важные принципы:**

- **Ничего не теряется:** Все файлы можно восстановить (кроме мусора, который пользователь явно сказал удалить)
- **Сохранение ручных операций:** Все ручные операции сохраняются в БД, можно восстановить сортировку по истории действий
- **Обучение системы (фантазия):** Сортировщик обучается на ручных правках, автоматическая сортировка становится точнее, количество ручных действий сокращается

### Ключевые идеи

1. **Три способа привязки к персоне:**

- Через лица (face_labels) — уже реализовано
- Через прямоугольники без лица (person_rectangles) — новый способ для случаев, когда человек виден, но лицо не распознано
- Прямая привязка файла к персоне (file_persons) — для случаев, когда на фото есть человек, но нет конкретного прямоугольника

2. **Гибкая система закладок:**

- "Люди" (бывшая "Есть лица") с подзакладками по персонам
- "Нет людей" (бывшая "Нет лиц") с иерархическими группами
- Динамические подзакладки на основе кластеров и назначений
- Логика "к разбору" для файлов без назначенных персон

3. **Режим "несколько персон на файл":**

- Файл может быть привязан к нескольким персонам одновременно
- Файл показывается на всех соответствующих подзакладках персон
- Галочка "Персона не одна" для контроля поведения при назначении

4. **Улучшение работы с видео:**

- Умный выбор ключевых кадров (приоритет кадров с лицами)
- Возможность смены ключевого кадра с автодетекцией
- Исправление разметки на кадрах

5. **Целевая сортировка:**

- Правила сортировки из таблицы `folders`
- Локальная сортировка в папки прогона
- Перемещение в фотоархив на YaDisk с заполнением метаданных

6. **UX принципы:**

- Файлы "улетают" на подзакладки персон при назначении (без дерганий)
- Файлы с "к разбору" просто пропадают при назначении персоны
- Файлы с подзакладки персоны удаляются при изменении/удалении привязки
- Интуитивный интерфейс для работы с несколькими персонами

## 1. Привязка фото к персоне (3 способа)

### 1.1. База данных

**Новые таблицы:**

- `person_rectangles` — прямоугольники без лица, но с человеком:
- `id`, `pipeline_run_id`, `file_path`, `frame_idx` (для видео), `bbox_x/y/w/h`, `person_id`, `created_at`
- `file_persons` — простая привязка файла к персоне (без прямоугольника):
- `pipeline_run_id`, `file_path`, `person_id`, `created_at`, PRIMARY KEY (pipeline_run_id, file_path, person_id)

**Изменения в существующих таблицах:**

- `face_labels` — уже есть, используется для привязки через лица
- `files_manual_labels.people_no_face_person` — можно оставить для обратной совместимости, но основной механизм через `file_persons`

### 1.2. API для работы с привязками

**Новые эндпойнты:**

- `POST /api/persons/assign-rectangle` — назначить персону через прямоугольник без лица
- `POST /api/persons/assign-file` — назначить персону файлу напрямую (без прямоугольника)
- `POST /api/persons/remove-assignment` — удалить привязку (любого типа)
- `GET /api/persons/file-assignments` — получить все привязки файла (лица + прямоугольники + файлы)

**Изменения существующих:**

- `POST /api/faces/assign-person` — расширить для поддержки режима "несколько персон" (флаг `allow_multiple`)

### 1.3. Отображение в UI

**В таблице персон (`/persons`):**

- Добавить колонки: "Через лица", "Через прямоугольники", "Прямая привязка"
- Показывать статистику по всем 3 способам

**В карточке персоны (`/persons/{person_id}`):**

- Разделить файлы по способам привязки (вкладки или секции)
- Показывать превью с выделением соответствующих областей

## 2. Работа с видео

### 2.1. Улучшение выбора ключевых кадров

**Изменения:**

- В `backend/scripts/tools/video_keyframes.py` — улучшить алгоритм выбора кадров (искать кадры с лицами, избегать черных кадров)
- Добавить параметр `--prefer-faces` для приоритета кадров с лицами

### 2.2. Смена ключевого кадра с автодетекцией

**Новый API:**

- `POST /api/faces/video-change-keyframe` — изменить ключевой кадр для видео
- Параметры: `pipeline_run_id`, `path`, `frame_idx`, `auto_detect_faces` (bool)
- При `auto_detect_faces=true` — автоматически детектировать лица на новом кадре

**UI:**

- В модалке просмотра видео добавить кнопку "Изменить ключевой кадр"
- Показывать 3 кадра с возможностью выбора другого
- При выборе нового кадра — автоматически детектировать лица

### 2.3. Исправление разметки лиц и прямоугольников на кадрах

**Проблема:** Разметка может "съезжать" из-за изменения разрешения или ориентации кадра.

**Решение:**

- Использовать существующий `POST /api/faces/fix-clipping` (уже есть)
- Добавить автоматическую проверку при загрузке кадра (если координаты выходят за границы изображения — предупреждение)

### 2.4. Перекладывание видео в подзакладку при определении персоны

**Логика:**

- При назначении персоны видео (через любое из 3 способов) — файл автоматически появляется на подзакладке персоны
- Если персон несколько — файл показывается на всех соответствующих подзакладках

## 3. Реорганизация закладок

### 3.1. "Есть лица" → "Люди"

**Переименование:**

- Вкладка "Есть лица" → "Люди"
- В `backend/web_api/routers/faces.py` и `backend/web_api/templates/faces.html`

**Подзакладки по персонам:**

- Динамические подзакладки на основе кластеров лиц и назначенных персон
- Логика подзакладок:
- "К разбору" — файлы без назначенных персон (или с неопределенными лицами)
- Подзакладки для каждой персоны, у которой есть хотя бы один файл в прогоне (любым из 3 способов)

**API для подзакладок:**

- `GET /api/faces/results` — добавить параметр `person_id` для фильтрации по персоне
- `GET /api/faces/person-subtabs` — получить список подзакладок персон для текущего прогона

**Логика отображения файлов:**

- Файл показывается на подзакладке персоны, если:
- Есть `face_labels` с этой персоной, ИЛИ
- Есть `person_rectangles` с этой персоной, ИЛИ
- Есть `file_persons` с этой персоной
- Файл с несколькими персонами показывается на всех соответствующих подзакладках

### 3.2. "Люди без лица" → в подзакладку "Люди"

**Изменения:**

- Файлы из "Есть люди (без лиц)" переносятся в подзакладку "Люди" → "К разбору"
- "Люди без лиц" (без прямоугольников) — это тоже "к разбору"

### 3.3. "Карантин" → подзакладка "Нет людей"

**Изменения:**

- Вкладка "Карантин" становится подзакладкой в "Нет людей"
- Логика: файлы с `quarantine_manual=1` или `faces_auto_quarantine=1` попадают в "Нет людей" → "Карантин"

### 3.4. "Нет лиц" → "Нет людей"

**Переименование:**

- Вкладка "Нет лиц" → "Нет людей"

**Группы для "Нет людей":**

- Иерархическая структура групп:
- Поездки
- 2023 Турция
- 2024 Турция
- (другие поездки)
- Мемы
- Здоровье
- Чеки
- Дом и ремонт
- Артефакты людей (можно привязать персон)

**База данных:**

- Таблица `file_groups`:
- `id`, `pipeline_run_id`, `file_path`, `group_path` (например, "Поездки/2023 Турция"), `created_at`
- PRIMARY KEY (pipeline_run_id, file_path, group_path)
- Таблица `file_group_persons` (для "Артефакты людей"):
- `pipeline_run_id`, `file_path`, `group_path`, `person_id`, `created_at`
- PRIMARY KEY (pipeline_run_id, file_path, group_path, person_id)

**API:**

- `POST /api/files/assign-group` — назначить группу файлу
- `GET /api/files/groups` — получить список групп для прогона
- `POST /api/files/assign-group-person` — привязать персону к файлу в группе "Артефакты людей"

**UI:**

- В закладке "Нет людей" показывать подзакладки по группам
- При клике на файл — выпадашка для выбора группы (как сейчас персоны в кластерах)
- Для "Артефакты людей" — дополнительно возможность выбрать персону

## 4. Режим "несколько персон на файл"

### 4.1. UI для назначения персон

**В выпадашке назначения персоны:**

- Галочка "Персона не одна" (по умолчанию выключена)
- Если галочка включена — при назначении персоны файл НЕ улетает с текущей подзакладки
- Кнопка "+ Добавить персону" (для закладок типа "персона")

**Логика переключения закладок:**

- Если закладка "к разбору" — при назначении персоны файл просто пропадает (без дерганий)
- Если закладка "персона" — при изменении/удалении персоны файл удаляется оттуда и появляется только у тех персон, что остались, или "к разбору" если персон нет

### 4.2. Отображение нескольких персон

**В карточке файла:**

- Показывать список всех назначенных персон (например, "Агата, Санек")
- Кнопка "+ Добавить персону" рядом со списком
- При клике на персону в списке — возможность удалить привязку

## 5. Целевая сортировка по папкам

### 5.1. Правила сортировки в Folders

**Изменения в таблице `folders`:**

- Уже есть поле `content_rule` — использовать для хранения правил
- Правила в формате JSON или текстовом формате (см. README)

**Примеры правил:**

- `только:[Агата] `→ `disk:/Фото/Агата`
- `вместе:[Агата, Санек, Нюся, Темка] `→ `disk:/Фото/Дети вместе`
- `содержит:[Миша, Аня] `→ `disk:/Фото/Миша и Аня`

### 5.2. Локальная сортировка

**Новый API:**

- `POST /api/pipeline/sort-to-folders` — применить правила сортировки к файлам прогона
- Параметры: `pipeline_run_id`, `dry_run` (bool)
- Логика:

1. Для каждого файла определяем персон (через все 3 способа)
2. Применяем правила из `folders` по приоритету
3. Перемещаем файлы в соответствующие папки локально (в рамках прогона)

**Изменения в `_determine_target_folder`:**

- Расширить логику для учета персон и правил из `folders`

### 5.3. Перекладывание в фотоархив

**Новый API:**

- `POST /api/pipeline/move-to-archive` — переместить файлы из локальной сортировки в фотоархив на YaDisk
- Параметры: `pipeline_run_id`, `dry_run` (bool)
- Логика:

1. Читаем файлы из отсортированных папок прогона
2. Для каждого файла определяем целевую папку в архиве по правилам
3. Загружаем файл на YaDisk в целевую папку
4. Заполняем метаданные (персоны, группы, даты и т.д.)

## Файлы для изменения

### База данных

- `backend/common/db.py` — добавление таблиц `person_rectangles`, `file_persons`, `file_groups`, `file_group_persons`

### API роутеры

- `backend/web_api/routers/faces.py` — изменения для подзакладок, групп, работы с видео
- `backend/web_api/routers/face_clusters.py` — расширение для режима "несколько персон"
- `backend/web_api/routers/persons.py` — новый роутер для работы с привязками персон (или расширение существующего)

### Шаблоны

- `backend/web_api/templates/faces.html` — реорганизация закладок, подзакладки по персонам, группы
- `backend/web_api/templates/person_detail.html` — отображение файлов по способам привязки
- `backend/web_api/templates/persons_list.html` — статистика по способам привязки

### Скрипты

- `backend/scripts/tools/video_keyframes.py` — улучшение выбора ключевых кадров
- `backend/scripts/tools/local_sort_by_faces.py` — интеграция с правилами сортировки

## Порядок реализации

1. **База данных** — создать новые таблицы и миграции
2. **API для привязок** — реализовать 3 способа привязки к персоне
3. **Реорганизация закладок** — переименование, подзакладки по персонам
4. **Группы для "Нет людей"** — иерархические группы
5. **Режим "несколько персон"** — UI и логика
6. **Работа с видео** — улучшение ключевых кадров, смена кадра
7. **Целевая сортировка** — правила и перемещение в архив