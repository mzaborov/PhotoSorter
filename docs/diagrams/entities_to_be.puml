@startuml
hide circle
skinparam linetype ortho
skinparam classAttributeIconSize 0

title PhotoSorter — Entities (TO-BE)

' TO-BE: целевая схема под распознавание лиц + разметку + сортировку.
' Это не 1:1 с текущей БД, а желаемая структура.

class persons <<table>> {
  +id: INTEGER <<PK>>
  name: TEXT <<UNIQUE>>
  mode: TEXT                   ' active|deferred|never
  is_me: INTEGER               ' 0/1
  kinship: TEXT                ' степень родства/близости (уточним)
  avatar_face_id: INTEGER <<FK>>
  created_at: TEXT
  updated_at: TEXT
}

class person_groups <<table>> {
  +id: INTEGER <<PK>>
  name: TEXT <<UNIQUE>>
  created_at: TEXT
  updated_at: TEXT
}

class person_group_members <<table>> {
  +group_id: INTEGER <<FK>>
  +person_id: INTEGER <<FK>>
}

person_groups "1" -- "*" person_group_members : состав группы
persons "1" -- "*" person_group_members : членство в группе

class folders <<table>> {
  +id: INTEGER <<PK>>
  code: TEXT <<UNIQUE>>
  path: TEXT
  name: TEXT
  location: TEXT
  role: TEXT
  priority_after_code: TEXT
  sort_order: INTEGER
  content_rule: TEXT
}

class pipeline_runs <<table>> {
  +id: INTEGER <<PK>>
  kind: TEXT                    ' local_sort|...
  root_path: TEXT               ' локальный корень
  status: TEXT                  ' running|completed|failed
  step_num: INTEGER
  step_total: INTEGER
  step_title: TEXT
  apply: INTEGER
  skip_dedup: INTEGER
  dedup_run_id: INTEGER
  face_run_id: INTEGER
  started_at: TEXT
  updated_at: TEXT
  finished_at: TEXT
}

class media_files <<table>> {
  +id: INTEGER <<PK>>
  path: TEXT <<UNIQUE>>         ' disk:/... or local:...
  parent_path: TEXT             ' disk:/... (папка-родитель)
  storage: TEXT                 ' yadisk|local
  mime_type: TEXT
  media_type: TEXT              ' image|video
  size: INTEGER
  created: TEXT
  modified: TEXT
  last_dedup_run_id: INTEGER    ' последний прогон дедупа (логически)
}

class dedup_runs <<table>> {
  +id: INTEGER <<PK>>
  scope: TEXT
  root_path: TEXT
  status: TEXT
  limit_files: INTEGER
  max_download_bytes: INTEGER
  total_files: INTEGER
  started_at: TEXT
  finished_at: TEXT
  processed_files: INTEGER
  hashed_files: INTEGER
  meta_hashed_files: INTEGER
  downloaded_hashed_files: INTEGER
  skipped_large_files: INTEGER
  errors_count: INTEGER
  last_path: TEXT
  last_error: TEXT
}

dedup_runs "1" -- "*" media_files : прогон дедупа (последний для файла)
pipeline_runs "0..1" -- "0..1" dedup_runs : шаг (дедуп)

class face_runs <<table>> {
  +id: INTEGER <<PK>>
  scope: TEXT                   ' yadisk|local|...
  root_path: TEXT
  status: TEXT
  total_files: INTEGER
  processed_files: INTEGER
  faces_found: INTEGER
  started_at: TEXT
  finished_at: TEXT
  last_path: TEXT
  last_error: TEXT
}

class face_rectangles <<table>> {
  +id: INTEGER <<PK>>
  run_id: INTEGER <<FK>>
  file_id: INTEGER <<FK>>
  face_index: INTEGER
  bbox_x: INTEGER
  bbox_y: INTEGER
  bbox_w: INTEGER
  bbox_h: INTEGER
  confidence: REAL
  presence_score: REAL          ' photo: доля среди лиц в кадре
  thumb_jpeg: BLOB
  ignore_flag: INTEGER
  created_at: TEXT
}

face_runs "1" -- "*" face_rectangles : прямоугольники лиц
media_files "1" -- "*" face_rectangles : лица на файле
persons "0..1" -- "0..1" face_rectangles : аватар (лицо)
folders "0..1" -- "*" media_files : файлы в папке (parent_path)
pipeline_runs "0..1" -- "0..1" face_runs : шаг (лица)

class face_person_manual_assignments <<table>> {
  +id: INTEGER <<PK>>
  face_rectangle_id: INTEGER <<FK>>
  person_id: INTEGER <<FK>>
  source: TEXT                  ' manual|restored_from_gold|ai
  confidence: REAL
  created_at: TEXT
}

face_rectangles "1" -- "0..*" face_person_manual_assignments : ручные привязки лица
persons "1" -- "*" face_person_manual_assignments : ручная привязка к персоне

note right of face_person_manual_assignments
  ТОЛЬКО для ручных привязок отдельных лиц
  (не через кластеры)
  
  Кластеры привязаны к персонам через
  face_clusters.person_id напрямую
  
  Лица в кластере наследуют персону через:
  face_rectangles → face_cluster_members → 
  face_clusters.person_id
end note

class face_identity_candidates <<table>> {
  +id: INTEGER <<PK>>
  face_rectangle_id: INTEGER <<FK>>
  person_id: INTEGER <<FK>>
  score: REAL
  model_version: TEXT
  created_at: TEXT
}

face_rectangles "1" -- "*" face_identity_candidates : AI-кандидаты
persons "1" -- "*" face_identity_candidates : кандидат для лица

class file_anchors <<table>> {
  +id: INTEGER <<PK>>
  file_id: INTEGER <<FK>>
  anchor_type: TEXT             ' folder|person
  folder_path: TEXT             ' disk:/Фото/...
  person_id: INTEGER <<FK>>
  note: TEXT
  created_at: TEXT
}

media_files "1" -- "*" file_anchors : якоря
persons "1" -- "*" file_anchors : якорь на персону
folders "0..1" -- "*" file_anchors : якорь на папку (folder_path)

class video_face_tracks <<table>> {
  +id: INTEGER <<PK>>
  run_id: INTEGER <<FK>>
  file_id: INTEGER <<FK>>
  track_index: INTEGER
  start_ms: INTEGER
  end_ms: INTEGER
  presence_score: REAL          ' video: доля времени/кадров
  keyframe_ms: INTEGER
  keyframe_thumb_jpeg: BLOB
  created_at: TEXT
}

face_runs "1" -- "*" video_face_tracks : треки лиц
media_files "1" -- "*" video_face_tracks : треки на файле

class face_embeddings <<table>> {
  +id: INTEGER <<PK>>
  face_rectangle_id: INTEGER <<FK>>
  model: TEXT
  model_version: TEXT
  dims: INTEGER
  vector: BLOB                  ' float32[]
  created_at: TEXT
}

face_rectangles "1" -- "0..*" face_embeddings : эмбеддинги (модели/версии)

class face_clusters <<table>> {
  +id: INTEGER <<PK>>
  run_id: INTEGER <<FK>>
  person_id: INTEGER <<FK>>        ' прямая привязка кластера к персоне
  method: TEXT
  params_json: TEXT
  created_at: TEXT
}

class face_cluster_members <<table>> {
  +cluster_id: INTEGER <<FK>>
  +face_rectangle_id: INTEGER <<FK>>
}

face_runs "1" -- "*" face_clusters : кластеры
face_clusters "1" -- "*" face_cluster_members : элементы кластера
face_clusters "0..1" -- "0..1" persons : привязка кластера к персоне (person_id)
face_rectangles "1" -- "*" face_cluster_members : участие в кластере

note right of face_clusters
  person_id: прямая привязка кластера к персоне
  
  Все лица в кластере наследуют персону
  через JOIN с face_cluster_members
  
  Если person_id = NULL — кластер не назначен
end note

note bottom
  Семантика только:[X]:
  unknown-лица не мешают; true если среди распознанных персон нет Y != X.
end note

@enduml



