@startuml
hide circle
skinparam linetype ortho
skinparam classAttributeIconSize 0

title PhotoSorter — Entities (AS-IS)

class folders <<table>> {
  +id: INTEGER <<PK>>
  code: TEXT <<UNIQUE>>
  path: TEXT
  name: TEXT
  location: TEXT
  role: TEXT
  priority_after_code: TEXT
  sort_order: INTEGER
  content_rule: TEXT
}

class dedup_runs <<table>> {
  +id: INTEGER <<PK>>
  scope: TEXT
  root_path: TEXT
  status: TEXT
  limit_files: INTEGER
  max_download_bytes: INTEGER
  total_files: INTEGER
  started_at: TEXT
  finished_at: TEXT
  processed_files: INTEGER
  hashed_files: INTEGER
  meta_hashed_files: INTEGER
  downloaded_hashed_files: INTEGER
  skipped_large_files: INTEGER
  errors_count: INTEGER
  last_path: TEXT
  last_error: TEXT
}

class pipeline_runs <<table>> {
  +id: INTEGER <<PK>>
  kind: TEXT                    ' local_sort
  root_path: TEXT               ' C:\... (локальная папка)
  status: TEXT                  ' running|completed|failed
  step_num: INTEGER
  step_total: INTEGER
  step_title: TEXT
  apply: INTEGER
  skip_dedup: INTEGER
  dedup_run_id: INTEGER
  face_run_id: INTEGER
  pid: INTEGER
  last_src_path: TEXT
  last_dst_path: TEXT
  last_error: TEXT
  log_tail: TEXT
  started_at: TEXT
  updated_at: TEXT
  finished_at: TEXT
}

class files <<table>> {
  +id: INTEGER <<PK>>
  path: TEXT <<UNIQUE>>         ' disk:/... or local:...
  resource_id: TEXT             ' YaDisk stable id (optional)
  inventory_scope: TEXT         ' archive|source
  name: TEXT
  parent_path: TEXT
  size: INTEGER
  created: TEXT
  modified: TEXT
  mime_type: TEXT
  media_type: TEXT
  hash_alg: TEXT                ' sha256|md5
  hash_value: TEXT
  hash_source: TEXT             ' meta|download|local
  status: TEXT                  ' new|hashed|skipped_large|error|deleted
  error: TEXT
  scanned_at: TEXT
  hashed_at: TEXT
  last_run_id: INTEGER
  ignore_archive_dup_run_id: INTEGER
  duration_sec: INTEGER
  duration_source: TEXT
  duration_at: TEXT
  faces_count: INTEGER
  faces_run_id: INTEGER
  faces_scanned_at: TEXT
  faces_auto_quarantine: INTEGER
  faces_quarantine_reason: TEXT
  faces_auto_group: TEXT
  animals_auto: INTEGER
  animals_kind: TEXT
  people_no_face_person: TEXT  ' ТОЛЬКО для архивных файлов (глобальная привязка персоны)
  taken_at: TEXT
  gps_lat: REAL
  gps_lon: REAL
  place_country: TEXT
  place_city: TEXT
  place_source: TEXT
  place_at: TEXT
  image_width: INTEGER
  image_height: INTEGER
}

class geocode_cache <<table>> {
  +key: TEXT <<PK>>             ' "55.7558,37.6173" (rounded)
  lat: REAL
  lon: REAL
  country: TEXT
  city: TEXT
  source: TEXT                   ' yandex
  updated_at: TEXT
  raw_json: TEXT
}

class pipeline_run_metrics <<table>> {
  +pipeline_run_id: INTEGER <<PK>>
  computed_at: TEXT
  face_run_id: INTEGER
  step0_checked: INTEGER
  step0_non_media: INTEGER
  step0_broken_media: INTEGER
  step2_total: INTEGER
  step2_processed: INTEGER
  cats_total: INTEGER
  cats_mism: INTEGER
  faces_total: INTEGER
  faces_mism: INTEGER
  no_faces_total: INTEGER
  no_faces_mism: INTEGER
}

class preclean_state <<table>> {
  +pipeline_run_id: INTEGER <<PK>>
  root_path: TEXT
  dry_run: INTEGER
  checked: INTEGER
  non_media: INTEGER
  broken_media: INTEGER
  last_path: TEXT
  updated_at: TEXT
}

class preclean_moves <<table>> {
  +id: INTEGER <<PK>>
  pipeline_run_id: INTEGER
  kind: TEXT                    ' non_media|broken_media
  src_path: TEXT
  dst_path: TEXT
  is_applied: INTEGER
  created_at: TEXT
}

class files_manual_labels <<table>> {
  +pipeline_run_id: INTEGER <<PK>>
  +file_id: INTEGER <<PK,FK>> <<NOT NULL>>  ' FOREIGN KEY на files.id (путь через JOIN к files.path)
  faces_manual_label: TEXT
  faces_manual_at: TEXT
  people_no_face_manual: INTEGER
  people_no_face_person: TEXT
  animals_manual: INTEGER
  animals_manual_kind: TEXT
  animals_manual_at: TEXT
  quarantine_manual: INTEGER
  quarantine_manual_at: TEXT
}

class video_manual_frames <<table>> {
  +pipeline_run_id: INTEGER <<PK>>
  +file_id: INTEGER <<PK,FK>> <<NOT NULL>>  ' FOREIGN KEY на files.id (путь через JOIN к files.path)
  +frame_idx: INTEGER <<PK>>    ' 1..3
  t_sec: REAL
  rects_json: TEXT
  updated_at: TEXT
}

folders "0..1" -- "*" files : файлы в папке (parent_path, логически)
dedup_runs "1" -- "*" files : прогон дедупа
pipeline_runs "0..1" -- "0..1" dedup_runs : шаг 1 (дедуп)
pipeline_runs "1" -- "0..1" pipeline_run_metrics : метрики прогона
pipeline_runs "1" -- "0..1" preclean_state : состояние предочистки
pipeline_runs "1" -- "*" preclean_moves : перемещения предочистки
files "1" -- "*" files_manual_labels : файл (file_id)
files "1" -- "*" video_manual_frames : файл (file_id)
pipeline_runs "1" -- "*" files_manual_labels : ручные метки файлов
pipeline_runs "1" -- "*" video_manual_frames : ручные кадры видео
files "*" -- "0..1" geocode_cache : геокодирование (gps_lat, gps_lon, логически)

class face_runs <<table>> {
  +id: INTEGER <<PK>>
  scope: TEXT                   ' yadisk|local|...
  root_path: TEXT               ' disk:/Фото/Агата
  status: TEXT                  ' running|completed|failed
  total_files: INTEGER
  processed_files: INTEGER
  faces_found: INTEGER
  started_at: TEXT
  finished_at: TEXT
  last_path: TEXT
  last_error: TEXT
}

class face_rectangles <<table>> {
  +id: INTEGER <<PK>>
  run_id: INTEGER <<FK>>         ' NULL для архива (archive_scope='archive')
  archive_scope: TEXT             ' NULL|'' для прогонов, 'archive' для архива
  +file_id: INTEGER <<FK>> <<NOT NULL>>  ' FOREIGN KEY на files.id (путь через JOIN к files.path)
  face_index: INTEGER
  bbox_x: INTEGER
  bbox_y: INTEGER
  bbox_w: INTEGER
  bbox_h: INTEGER
  confidence: REAL
  presence_score: REAL
  thumb_jpeg: BLOB
  embedding: BLOB                 ' JSON float32[] (вектор лица)
  manual_person: TEXT             ' временно (до persons/person_id)
  ignore_flag: INTEGER
  is_manual: INTEGER
  manual_created_at: TEXT
  created_at: TEXT
}

files "1" -- "*" face_rectangles : файл (file_id)
face_runs "1" -- "*" face_rectangles : прямоугольники лиц
pipeline_runs "0..1" -- "0..1" face_runs : шаг 2 (лица)

class persons <<table>> {
  +id: INTEGER <<PK>>
  name: TEXT <<UNIQUE>>
  mode: TEXT                    ' active|deferred|never
  is_me: INTEGER
  kinship: TEXT
  avatar_face_id: INTEGER <<FK>>
  created_at: TEXT
  updated_at: TEXT
}

class face_clusters <<table>> {
  +id: INTEGER <<PK>>
  run_id: INTEGER <<FK>>         ' NULL для архива (archive_scope='archive')
  archive_scope: TEXT             ' NULL|'' для прогонов, 'archive' для архива
  person_id: INTEGER <<FK>>        ' прямая привязка кластера к персоне
  method: TEXT                    ' DBSCAN|HDBSCAN|...
  params_json: TEXT
  created_at: TEXT
}

class face_cluster_members <<table>> {
  cluster_id: INTEGER <<FK,PK>>
  face_rectangle_id: INTEGER <<FK,PK>>
}

class face_person_manual_assignments <<table>> {
  +id: INTEGER <<PK>>
  face_rectangle_id: INTEGER <<FK>>
  person_id: INTEGER <<FK>>
  source: TEXT                  ' manual|restored_from_gold|ai
  confidence: REAL
  created_at: TEXT
}

files "1" -- "*" face_rectangles : файл (file_id)
face_rectangles "0..1" -- "0..1" persons : avatar (avatar_face_id)
face_rectangles "1" -- "*" face_cluster_members : член кластера
face_clusters "1" -- "*" face_cluster_members : кластер
face_clusters "0..1" -- "0..1" persons : привязка кластера к персоне (person_id)
face_rectangles "1" -- "0..*" face_person_manual_assignments : ручные привязки лица
persons "1" -- "*" face_person_manual_assignments : ручная привязка к персоне
face_runs "1" -- "*" face_clusters : прогон кластеризации

class person_rectangles <<table>> {
  +id: INTEGER <<PK>>
  pipeline_run_id: INTEGER <<FK>>
  file_path: TEXT                    ' дублирование для удобства/производительности, путь также в files.path
  +file_id: INTEGER <<FK>> <<NOT NULL>>  ' FOREIGN KEY на files.id
  frame_idx: INTEGER
  bbox_x: INTEGER
  bbox_y: INTEGER
  bbox_w: INTEGER
  bbox_h: INTEGER
  person_id: INTEGER <<FK>>
  created_at: TEXT
}

class file_persons <<table>> {
  +pipeline_run_id: INTEGER <<PK>>
  file_path: TEXT                    ' дублирование для удобства/производительности, путь также в files.path
  +file_id: INTEGER <<PK,FK>> <<NOT NULL>>  ' FOREIGN KEY на files.id
  +person_id: INTEGER <<PK,FK>>
  created_at: TEXT
}

class file_groups <<table>> {
  +id: INTEGER <<PK>>
  pipeline_run_id: INTEGER <<FK>>
  file_path: TEXT                    ' дублирование для удобства/производительности, путь также в files.path
  +file_id: INTEGER <<FK>> <<NOT NULL>>  ' FOREIGN KEY на files.id
  group_path: TEXT
  created_at: TEXT
}

class file_group_persons <<table>> {
  +pipeline_run_id: INTEGER <<PK>>
  file_path: TEXT                    ' дублирование для удобства/производительности, путь также в files.path
  +file_id: INTEGER <<PK,FK>> <<NOT NULL>>  ' FOREIGN KEY на files.id
  +group_path: TEXT <<PK>>
  +person_id: INTEGER <<PK,FK>>
  created_at: TEXT
}

files "1" -- "*" person_rectangles : файл (file_id)
files "1" -- "*" file_persons : файл (file_id)
files "1" -- "*" file_groups : файл (file_id)
files "1" -- "*" file_group_persons : файл (file_id)
persons "1" -- "*" person_rectangles : прямоугольник без лица
persons "1" -- "*" file_persons : прямая привязка файла
persons "1" -- "*" file_group_persons : привязка через группу
pipeline_runs "1" -- "*" person_rectangles : прогон
pipeline_runs "1" -- "*" file_persons : прогон
pipeline_runs "1" -- "*" file_groups : прогон
pipeline_runs "1" -- "*" file_group_persons : прогон

note right of face_person_manual_assignments
  ТОЛЬКО для ручных привязок отдельных лиц
  (не через кластеры)
  
  Кластеры привязаны к персонам через
  face_clusters.person_id напрямую
  
  Лица в кластере наследуют персону через:
  face_rectangles → face_cluster_members → 
  face_clusters.person_id
end note

note right of face_clusters
  person_id: прямая привязка кластера к персоне
  
  Все лица в кластере наследуют персону
  через JOIN с face_cluster_members
  
  Если person_id = NULL — кластер не назначен
end note

note right of face_cluster_members
  Единственный источник истины:
  какое лицо в каком кластере
  
  PRIMARY KEY (cluster_id, face_rectangle_id)
  Одно лицо → один кластер
  
  Если лицо не в кластере (noise) —
  записи нет
end note

note right of face_rectangles
  presence_score (photo) =
  area(face_bbox) / sum(area(all_face_bbox))
  
  embedding: BLOB (JSON float32[])
  для распознавания лиц
end note

@enduml
