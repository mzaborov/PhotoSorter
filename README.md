# PhotoSorter
Сортировщик фотографий на Яндекс Диске

## Цель проекта

**PhotoSorter** — автоматизировать разбор и наведение порядка в фото/видео на Яндекс.Диске: находить дубликаты по содержимому, определять категорию (люди/дети/семья/животные/без людей) и раскладывать по заранее заданным папкам в `disk:/Фото`, с управлением правилами через Web UI.

## Термины

- **Архив**: в рамках проекта под “архивом” понимается папка **`disk:/Фото`** на Яндекс.Диске.

## Целевые папки и порядок (disk:/Фото)

Порядок приоритета (сверху — раньше):

1) Без людей и животных (папка будет заведена отдельно, имя уточним)
2) Агата — `disk:/Фото/Агата`
3) Санек — `disk:/Фото/Санек`
4) Нюся — `disk:/Фото/Нюся`
5) Темка — `disk:/Фото/Темка`
6) Дети вместе — `disk:/Фото/Дети вместе`
7) Миша и Аня — `disk:/Фото/Миша и Аня`
8) Бабушки и Дедушки — `disk:/Фото/Бабушки и Дедушки`
9) Семья — `disk:/Фото/Семья`
10) Котэ и собацо — `disk:/Фото/Котэ и собацо`
11) Другие люди — `disk:/Фото/Другие люди`

Дополнительно в учёте/справочнике есть крупные папки: `disk:/Фото/Путешествия`, `disk:/Фото/Технологии`.

## Точные правила сортировки

Обозначения:
- `только:[X]` — в кадре только X (и никаких других людей)
- `вместе:[A,B,C...]` — в кадре минимум двое из списка
- `содержит:[X,Y...]` — в кадре есть хотя бы один из списка

Правила применяются по порядку приоритета:

- Без людей и животных: если нет людей и нет кошек/собак → (отдельная ветка “без людей”)
- Агата: `только:[Агата]` → `disk:/Фото/Агата`
- Санек: `только:[Санек]` → `disk:/Фото/Санек`
- Нюся: `только:[Нюся]` → `disk:/Фото/Нюся`
- Темка: `только:[Темка]` → `disk:/Фото/Темка`
- Дети вместе: `вместе:[Агата, Санек, Нюся, Темка]` → `disk:/Фото/Дети вместе`
- Миша и Аня (широкое правило): `содержит:[Миша, Аня]` → `disk:/Фото/Миша и Аня`
- Бабушки и Дедушки: `содержит:[...список персон...]` → `disk:/Фото/Бабушки и Дедушки`
- Семья: `содержит:[...список персон...]` → `disk:/Фото/Семья`
- Котэ и собацо: если есть кошка/собака → `disk:/Фото/Котэ и собацо`
- Другие люди: если есть люди, но не сработало ничего выше → `disk:/Фото/Другие люди`

Правило “предыдущая папка по приоритету”: следующий этап выполняем только после завершения предыдущего (настраивается в правилах/БД).

## Что уже сделано

- Web UI (FastAPI): страницы `/`, `/folders`, `/browse`, `/duplicates`.
- SQLite-справочник папок (`folders`) + отображение в UI.
- Асинхронный рекурсивный подсчёт количества файлов по папкам в UI.
- API для подсчёта/отладки: `/api/folder-count/{code}`, `/api/path-count`, `/api/path-listing`, `/api/debug/build-info`.
- Стабилизация работы с Я.Диском: ретраи/таймауты, защита от циклов; увеличен таймаут YaDisk-вызовов до 60 секунд; исправлена нормализация путей (без `.strip()`).
- Дедупликация архива `disk:/Фото` (инвентаризация + хэши в SQLite) и страница `/duplicates` для просмотра групп дублей.
- Действия на `/duplicates`:
  - удаление “неотмеченных” копий в корзину,
  - “переместить в «Дети вместе» + удалить остальные” (с обработкой конфликтов имён),
  - открытие файла в веб-интерфейсе Я.Диска в режиме просмотра (slider).
- Превью дублей: `/api/yadisk/preview-image` отдаёт 307 redirect на YaDisk preview URL (без проксирования байтов через сервер).
- Исправление 403 на превью: `no-referrer` для картинок.
- Длительность видео: асинхронный `ffprobe` + кеш в SQLite (`yd_files.duration_sec`).
- Сверка архива (Reconcile Archive): кнопка на `/folders` и API, чтобы догонять ручные изменения на Я.Диске (перемещения/удаления/изменения).
- Основная “рабочая форма сортировки” на `/` (one-page):
  - выбор источника: Я.Диск (`disk:/...`, любая папка) или локальная папка (`C:\...`),
  - запуск скана источника и прогресс,
  - Шаг 1: дубли источника, которые уже есть в архиве `disk:/Фото` (удалить / “не дубль” до следующего перескана),
  - Шаг 2: дубли внутри источника (автовыбор “оставить 1”, кнопки “удалить копии” и “удалить всё (мусор)”),
  - превью для фото/видео (локальные видео — inline, видео на Я.Диске — открыть в slider), длительность локальных видео.

## Что планируется

- Модуль “источник → список объектов Photo” (фото+видео) с метаданными (дата/гео/тип).
- Схема БД для файлов, хэшей, статусов обработки, истории перемещений.
- Надёжная дедупликация по содержимому по всему Диску.
- Классификация людей/животных (Яндекс/локальная ML) и применение правил выше.
- Web UI для редактирования правил/приоритетов и контроля прогонов.

### Ближайшие шаги (план)

- Уточнить и стабилизировать UX “source → archive”: сообщения “архив не сканирован” vs “совпадений нет”, массовые действия и подтверждения.
- Распознавание лиц: хранение “персон”, эмбеддингов и результатов распознавания, страница для разметки/подтверждения и последующего применения правил раскладки.

## Проектировочные решения (Design Decisions)

- **DD-001 — API-first, без массового скачивания**: основная работа идёт через YaDisk API (листинг/метаданные/перемещения), чтобы не хранить всё локально; скачивание используется точечно (например, для хэша в DD-009).
- **DD-002 — Справочник папок и правил в SQLite**: конфигурация целевых папок/правил/приоритетов хранится в SQLite (`folders`) и используется Web UI.
- **DD-003 — Сортировка как цепочка приоритетов**: категории применяются строго по очереди (дети по одному → дети вместе → `содержит:[Миша, Аня]` → бабушки/дедушки → семья → животные → другие люди). Поддерживаем “следующий этап только после предыдущего”.
- **DD-004 — Устойчивость к проблемам API/путей**: используем ретраи/таймауты, защиту от циклов и диагностические эндпойнты. Таймаут YaDisk-вызовов увеличен до 60 секунд из‑за больших папок.
- **DD-005 — Web UI как инструмент контроля/отладки**: рекурсивные подсчёты загружаются асинхронно с прогрессом; есть drill-down просмотр папок (`/browse`) для поиска проблемных подпапок.
- **DD-006 — Секреты через `.env`/`secrets.env`**: токены/ключи не хардкодим, используем `secrets.env` (основной) и `.env` (fallback).
- **DD-007 — Минимум зависимостей и модульность**: ядро — Python + `yadisk`, `python-dotenv`, `sqlite3`; логика сортировки/доступ к Диску/БД разделяются по модулям.
- **DD-008 — Дедупликация по содержимому для фото и видео**: дедупликация применяется ко всем файлам (фото+видео), не только к изображениям.
- **DD-009 — Стратегия получения хэша (вариант B)**: если YaDisk не отдаёт `sha256/md5` в метаданных — скачиваем файл локально и считаем хэш сами; результат сохраняем в SQLite.
- **DD-010 — Сначала строим БД дублей, без действий на Диске**: первый шаг — только инвентаризация/группы дублей в БД; удаление/перемещения — позже через UI.
- **DD-011 — Разрешаем несколько KEEP**: в группе дублей можно оставить 1+ копий в разных папках, остальные помечаются на удаление.
- **DD-012 — Только “последний прогон”, без истории**: для каждого типа прогона храним только последнее состояние (можно запускать повторно — “resume по данным”, т.к. уже захешированные файлы не перехешируются).
- **DD-013 — Два scope для дедупликации**: `archive` (YaDisk `disk:/Фото`) и `source` (локальная папка-источник, например `C:\tmp\Photo`). Хэши складываем в одну общую таблицу, чтобы переиспользовать кэш.

## Web интерфейс (просмотр папок)

Установка зависимостей:

```bash
pip install -r requirements.txt
```

Запуск сервера (локально, рекомендуемый — без `--reload`):

```bash
uvicorn --app-dir . app.main:app --port 8000
```

Рекомендуемый режим разработки (Windows / PowerShell) — с авто‑reload:

```powershell
C:\Users\mzaborov\AppData\Local\Python\pythoncore-3.14-64\python.exe -m uvicorn --reload --app-dir . app.main:app --host 127.0.0.1 --port 8000
```

Проверка, что сервер “свежий” (после reload/рестарта):

```powershell
curl.exe -i --connect-timeout 1 --max-time 5 http://127.0.0.1:8000/api/debug/build-info
```

Ожидаем **HTTP 200** и совпадение заголовка **`x-photosorter-build`** с полем JSON **`build_id`**.

Открыть в браузере:
- `http://127.0.0.1:8000/` — основная форма сортировки (one-page)
- `http://127.0.0.1:8000/folders` — список папок (из SQLite)
- `http://127.0.0.1:8000/browse?path=disk:/Фото` — просмотр дерева папок
- `http://127.0.0.1:8000/duplicates` — просмотр дублей архива (архив= `disk:/Фото`)
- `http://127.0.0.1:8000/docs` — список API

## Быстрый старт после перезагрузки

1) Перейти в папку проекта.

2) Убедиться, что порт свободен:

```bash
netstat -ano | findstr :8000
```

3) Запустить сервер:

```bash
cd "C:\\Users\\mzaborov\\YandexDisk\\Работы, тексты, презентации\\PhotoSorter"
C:\\Users\\mzaborov\\AppData\\Local\\Python\\pythoncore-3.14-64\\python.exe -m uvicorn --app-dir . app.main:app --port 8000
```

4) Открыть:
- `/folders` — таблица папок
- В колонке "Путь" есть ссылка **↗** на просмотр вложенных папок (`/browse?path=...`)