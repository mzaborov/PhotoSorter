2026-01-01 14:12 (+03:00)
- Контекст: сформулировали задачу сортировки фото/видео по людям/категориям и удаления дублей.

2026-01-01 14:12 (+03:00)
- База данных: инициализировали SQLite БД `data/photosorter.db`, завели таблицу `folders` для справочника папок/правил.
2026-01-01 14:12 (+03:00)
- Подключение к Я.Диску: привели `yadisk_client.py` к безопасному модулю с `get_disk()` (без побочных эффектов при импорте).

2026-01-01 14:12 (+03:00)
- Справочник папок: сделали скан 1-го уровня `disk:/Фото` и загрузку в `folders`, добавили `name` и `sort_order`, настроили порядок этапов (в т.ч. «Бабушки и Дедушки»).

2026-01-01 14:44 (+03:00)
- Web UI: сделали локальный интерфейс просмотра папок (FastAPI + HTML), страницы `/` и `/folders` читают данные из SQLite.

2026-01-01 19:20 (+03:00)- Дедупликация (скан архива): зафиксировали, что “архив” = disk:/Фото; приняли вариант B (если YaDisk не даёт sha256/md5 — скачиваем и считаем хэш локально, пишем в SQLite) и допускаем несколько KEEP в группе дублей.

2026-01-01 20:10 (+03:00)- Дедупликация (упрощение прогонов): отказались от истории прогонов, оставили только “последний прогон” по scope (archive=YaDisk disk:/Фото, source=локальная папка-источник). Добавили запуск/прогресс для локального источника (первый путь: C:\tmp\Photo) и обновили README.

2026-01-01 20:35 (+03:00)- Дедупликация (просмотр дублей): добавили страницу /duplicates для read-only просмотра групп дублей (1 строка=группа, 2–3 файла), превью подтягивается через YaDisk get_meta; на /folders добавили ссылку на просмотр дублей и сделали “умные” подписи кнопки запуска.

2026-01-01 22:30 (+03:00)- Превью дублей через redirect: `/api/yadisk/preview-image` теперь отдаёт 307 на YaDisk preview URL вместо скачивания байтов на сервере, чтобы избежать 403/502. Страница `/duplicates` загружает превью через `<img src=...>`.

2026-01-01 22:40 (+03:00)- Превью YaDisk без 403 (no-referrer): На `/duplicates` отключили отправку `Referer` для превью (`meta referrer` + `img.referrerPolicy`), чтобы `downloader.disk.yandex.ru` не блокировал загрузку картинок (403).

2026-01-01 22:55 (+03:00)- Действия на /duplicates (удаление/перемещение/открытие): Добавили удаление неотмеченных копий в корзину, кнопку перемещения одной копии в «Дети вместе» с удалением остальных и открытие файла в веб‑интерфейсе Я.Диска по клику на превью.

2026-01-01 23:05 (+03:00)- Открытие файла в Я.Диске через slider: `api/yadisk/open` перевели на URL с `dialog=slider&idDialog=...`, чтобы по клику открывался просмотр файла, а не папка.

2026-01-02 00:22 (+03:00)- Длительность видео через ffprobe: Добавили асинхронный расчёт длительности видео с сохранением результата в SQLite и подгрузкой на странице `/duplicates` без блокировки UI.

2026-01-02 01:30 (+03:00)- Дедупликация архива + сверка (reconcile): Добавили просмотр/действия по дублям в Web UI, кеширование длительности видео и механизм «Сверить архив» (на базе `resource_id`) для догонки ручных изменений на Я.Диске.

2026-01-02 08:22 (+03:00)- Основная форма сортировки и 2 шага дедупликации: На главной странице `/` добавлен выбор источника (Я.Диск/локальная папка) и запуск. Реализованы шаги “уже есть в архиве” и “дубли внутри папки” с действиями удаления/игнора до следующего перескана.

2026-01-02 08:40 (+03:00)- Объединение шагов дедупликации и превью для source: На главной странице шаги “уже есть в архиве” и “дубли внутри папки” объединены и добавлены счётчики лишних копий. Убран запуск дедупликации источника с /folders и добавлен безопасный preview для локальных файлов.

2026-01-02 10:05 (+03:00)- Процесс: History.log без подтверждения: Зафиксировали правило — записи в `History.log` добавляются автоматически после каждой значимой вехи (не только при закрытии сессии), а закрытие сессии всегда пишется отдельной строкой.

2026-01-02 10:10 (+03:00)- Обновление PowerShell для стабильной отладки: Установили PowerShell 7.5.4 (pwsh) и переключили терминал в Cursor на pwsh, чтобы уменьшить зависания/ошибки Terminal Runner при выполнении команд.

2026-01-02 10:10 (+03:00)- Процесс: фиксация правил работы: Завели и обновили правила Cursor для ритуала завершения сессии и безопасного освобождения порта 8000; договорились, что изменения правил/процесса тоже считаются значимой вехой и фиксируются в History.log.

2026-01-02 10:15 (+03:00)- Процесс: отдельное правило History.log: Вынесли правила ведения `History.log` (без подтверждения, фиксируем вехи/правила/настройки среды) в отдельный Cursor-rule `.cursor/rules/history-log.mdc` и оставили в ритуале закрытия сессии ссылку на него.

2026-01-02 10:25 (+03:00)- Процесс: History.log в Git: Перестали игнорировать `History.log` и начали коммитить его вместе с кодом, чтобы сохранять вехи и ключевые настройки среды в репозитории.

2026-01-02 10:26 (+03:00)- Закрытие сессии: Обновили правила процесса (History.log теперь коммитим), привели README к актуальному one-page UI и подготовили репозиторий к воспроизводимому запуску (проверка build-info, чистка лишних файлов, коммит).

2026-01-03 00:27 (+03:00)- Распознавание лиц (требования): согласовали и зафиксировали в README раздел “Распознавание лиц (требования)”, включая Inbox с кластеризацией/массовыми решениями, формулу presence_score для фото (доля среди лиц) и семантику только:[X] (unknown не мешают). Уточнили имя папки на Я.Диске: disk:/Фото/Котэ и сцобако.

2026-01-03 12:03 (+03:00)- Распознавание лиц (старт, окружение): для ML-части завели отдельное окружение `.venv-face` на Python 3.12 (т.к. на Python 3.14 нет готовых wheels для onnxruntime/numpy). Добавили `requirements-face.txt` и скрипты запуска `scripts/run_face.ps1`/`scripts/run_server.ps1`.

2026-01-03 12:03 (+03:00)- Автодокументирование (UML диаграммы): добавили диаграммы сущностей AS-IS/TO-BE в `docs/diagrams` (PlantUML + PNG) и генератор `scripts/render_diagrams.py`, зафиксировали правило обновления диаграмм при изменениях структуры БД/архит-решений.

2026-01-03 21:54 (+03:00)- Распознавание лиц (переименование сущности): переименовали таблицу `face_detections` → `face_rectangles` (face-rectangle без информации о личности), добавили миграцию “на лету” в `FaceStore` и обновили AS-IS/TO-BE диаграммы с перегенерацией PNG.

2026-01-05 13:28 (+03:00)- Локальная сортировка (quick win): начали конвейер для локальной папки: дедуп → определение face_rectangles (YuNet) → разложить в лица/не лица → дальше лица (по именам, пока через manual_person) и не‑лица (по локации+году из EXIF/mtime). README перенесли в `docs/README.md`, корневой `README.md` стал ссылкой.

2026-01-05 14:03 (+03:00)- UI (Фотоархив): объединили навигацию “Папки” + “Дубли” в один вход “Фотоархив” (страница `/folders`), а “дубли” доступны внутри фотоархива; унифицировали подписи “← к Фотоархиву” на связанных страницах.

2026-01-05 15:35 (+03:00)- Конвейер локальной сортировки: добавили `pipeline_runs` в SQLite и реальный resume после рестарта (прогресс/лог/шаг сохраняются в БД, Web UI читает статус из БД). Исправили шаги раскладки внутри `_faces/_no_faces`, чтобы повторный запуск был идемпотентным и не создавал вложенные папки.

2026-01-05 23:55 (+03:00)- UI результатов шагов 1/2: вынесли результаты шага 1 в отдельную страницу с вкладками 1.1/1.2, а шаг 2 — в страницу с вкладками “Есть лица/Нет лиц”, бесконечной подгрузкой, ручной корректировкой (manual label + manual rectangles) и просмотром bbox по double click.
2026-01-05 23:55 (+03:00)- Закрытие сессии: почистили мусорные файлы, обновили диаграммы сущностей и подготовили репозиторий к воспроизводимому состоянию; дальше переходим к улучшению качества распознавания лиц.

2026-01-06 00:12 (+03:00)- UI разметки: добавили кнопку “Разметить” в просмотре (double click), чтобы включать режим ручной разметки face_rectangle прямо в модалке, без кнопки на карточке.
2026-01-06 00:13 (+03:00)- Превью локальных файлов: исправили баг, из-за которого в DRY_RUN переписывались пути в SQLite (на `_faces/_no_faces/_duplicates`) без реального перемещения файлов, ломая `/api/local/preview`. Для прогона `pipeline_run_id=6` сделали repair путей в `yd_files` и `face_rectangles`.
2026-01-06 00:13 (+03:00)- Закрытие сессии: проверили, что Web UI отвечает (build-info) и превью/разметка снова работают; репозиторий чистый, изменения закоммичены.

