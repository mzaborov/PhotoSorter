<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <title>PhotoSorter ‚Äî –ö–ª–∞—Å—Ç–µ—Ä—ã –ø–µ—Ä—Å–æ–Ω—ã</title>
    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      a { color: #0b57d0; text-decoration: none; }
      a:hover { text-decoration: underline; }
      code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
      .muted { color: #6b7280; }
      .wrap { max-width: 1400px; }
      .header { display:flex; align-items:baseline; justify-content:space-between; gap:12px; }
      .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
      .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f4f6; color:#374151; font-size:12px; }
      .btn { appearance:none; border:1px solid #d1d5db; background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:700; }
      .btn:hover { background:#f9fafb; }
      .btn:disabled { opacity: 0.6; cursor: not-allowed; }
      .btn.primary { background:#111827; color:#fff; border-color:#111827; }
      .btn.primary:hover { background:#374151; }
      .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top: 12px; }
      .grid { display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }
      .person-group { margin-bottom: 24px; }
      .person-group-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; padding:12px; background:#f9fafb; border-radius:12px; }
      .person-avatar { width: 48px; height: 48px; border-radius:50%; object-fit:cover; border:2px solid #e5e7eb; }
      .person-avatar-placeholder { width: 48px; height: 48px; border-radius:50%; background:#e5e7eb; display:flex; align-items:center; justify-content:center; font-size:20px; color:#6b7280; }
      .person-name { font-size:18px; font-weight:700; }
      .person-clusters-count { color:#6b7280; font-size:14px; }
      .card { width: 300px; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; background:#fff; }
      .card-header { padding: 10px 12px; background:#f9fafb; border-bottom: 1px solid #e5e7eb; }
      .card-body { padding: 10px 12px; }
      .kv { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; font-size:12px; color:#374151; }
      .actions { display:flex; gap:8px; margin-top: 10px; flex-wrap: wrap; }
      .select { border:1px solid #d1d5db; border-radius:10px; padding:8px 10px; font-size:14px; }
      .loading { opacity: 0.6; pointer-events: none; }
      .modal { position: fixed; inset: 0; background: rgba(17,24,39,0.82); display: none; align-items: center; justify-content: center; padding: 18px; z-index: 9999; }
      .modal.open { display: flex; }
      .modal-panel { background: #fff; border-radius: 14px; max-width: 94vw; max-height: 94vh; width: min(800px, 94vw); overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.35); }
      .modal-header { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; }
      .modal-body { padding: 16px; max-height: calc(94vh - 120px); overflow-y: auto; }
      .modal-footer { padding: 12px 16px; border-top: 1px solid #e5e7eb; display:flex; gap:10px; justify-content:flex-end; }
      .merge-indicator { display: inline-block; padding: 2px 6px; border-radius: 4px; background: #fef3c7; color: #92400e; font-size: 11px; font-weight: 600; margin-left: 6px; }
      .merge-indicator.has-suggestion { background: #dbeafe; color: #1e40af; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <div>
          <h2 style="margin:0;" id="pageTitle">–ö–ª–∞—Å—Ç–µ—Ä—ã –ø–µ—Ä—Å–æ–Ω—ã</h2>
          <div class="muted" style="margin-top:6px;">–ö–ª–∞—Å—Ç–µ—Ä—ã –ª–∏—Ü, –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —ç—Ç–æ–π –ø–µ—Ä—Å–æ–Ω–µ.</div>
        </div>
        <div class="muted">
          <a href="/persons" id="backLink">‚Üê –∫ —Å–ø–∏—Å–∫—É –ø–µ—Ä—Å–æ–Ω</a>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn" id="btnReload" type="button">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn" id="btnFindPendingMerges" type="button">–ù–∞–π—Ç–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
        <span class="muted" id="toast"></span>
      </div>

      <!-- –ë–ª–æ–∫ —Å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º–∏ –Ω–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ -->
      <div id="pendingMergesBlock" style="display: none; margin-top: 24px; padding: 16px; border: 1px solid #e5e7eb; border-radius: 12px; background: #f9fafb;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="margin: 0; font-size: 16px;">–ö–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ</h3>
          <button class="btn primary" id="btnApplyAllMerges" type="button">–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤—Å–µ</button>
        </div>
        <div id="pendingMergesList" style="display: flex; flex-direction: column; gap: 8px;">
          <!-- –°–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
        </div>
      </div>

      <div class="grid" id="clustersGrid"></div>
    </div>

    <!-- Modal –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –º–∞–ª–µ–Ω—å–∫–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ -->
    <div class="modal" id="modalMergeSuggestions">
      <div class="modal-panel" style="max-width: 90vw; width: min(1200px, 90vw);">
        <div class="modal-header">
          <h3 style="margin:0;">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—é –º–∞–ª–µ–Ω—å–∫–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤</h3>
          <button class="btn" type="button" onclick="closeModal('modalMergeSuggestions')">‚úï</button>
        </div>
        <div class="modal-body">
          <div id="mergeSuggestionsContent">
            <div class="muted" style="text-align: center; padding: 24px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π...</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" type="button" onclick="closeModal('modalMergeSuggestions')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>

    <script>
      // –ü–æ–ª—É—á–∞–µ–º person_id –∏–∑ URL
      const urlMatch = window.location.pathname.match(/\/persons\/(\d+)\/clusters/);
      const personId = urlMatch ? parseInt(urlMatch[1]) : null;
      let person = null;
      let clusters = [];
      let mergeSuggestions = [];
      
      // –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
      let clusterPage = 1;
      const clusterPageSize = 50;
      let clusterHasMore = true;
      let clusterTotalCount = null;
      let clusterLoading = false;
      let allLoadedClusters = [];

      function showToast(msg, duration = 3000) {
        const el = document.getElementById("toast");
        el.textContent = msg;
        setTimeout(() => { el.textContent = ""; }, duration);
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("open");
      }

      function openModal(modalId) {
        document.getElementById(modalId).classList.add("open");
      }

      function updateSentinel() {
        const sentinel = document.getElementById("clustersSentinel");
        if (sentinel) {
          sentinel.textContent = clusterLoading ? "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶" : (clusterHasMore ? "‚Ä¶" : "");
        }
      }

      async function loadPerson() {
        try {
          const resp = await fetch(`/api/persons/${personId}`);
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
          }
          const data = await resp.json();
          person = data.person;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
          const title = document.getElementById("pageTitle");
          if (title && person) {
            title.textContent = `–ö–ª–∞—Å—Ç–µ—Ä—ã –ø–µ—Ä—Å–æ–Ω—ã: ${person.name}`;
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞–∑–∞–¥
          const backLink = document.getElementById("backLink");
          if (backLink) {
            backLink.href = `/persons/${personId}`;
            backLink.textContent = `‚Üê –∫ –ø–µ—Ä—Å–æ–Ω–µ: ${person.name}`;
          }
        } catch (e) {
          console.error('[loadPerson] –û—à–∏–±–∫–∞:', e);
          showToast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω—ã: ${e}`);
        }
      }

      async function getFaceThumbnail(faceId) {
        if (!faceId) return null;
        try {
          const resp = await fetch(`/api/face-rectangles/${faceId}/thumbnail`);
          if (resp.ok) {
            const data = await resp.json();
            return data.thumb_jpeg_base64 ? `data:image/jpeg;base64,${data.thumb_jpeg_base64}` : null;
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞:', e);
        }
        return null;
      }

      async function loadClusters(reset = false) {
        if (clusterLoading) return;
        if (!reset && !clusterHasMore) return;
        
        clusterLoading = true;
        updateSentinel();
        
        const pageParam = `page=${clusterPage}`;
        const pageSizeParam = `page_size=${clusterPageSize}`;
        const personIdParam = `person_id=${personId}`;
        const url = `/api/face-clusters/list?${personIdParam}&${pageParam}&${pageSizeParam}`;
        
        try {
          if (reset) {
            clusterPage = 1;
            clusterHasMore = true;
            clusterTotalCount = null;
            allLoadedClusters = [];
            const grid = document.getElementById("clustersGrid");
            grid.innerHTML = "";
          }
          
          const resp = await fetch(url);
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
          }
          const data = await resp.json();
          const newClusters = data.clusters || [];
          
          console.log(`[loadClusters] –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: ${newClusters.length}, –≤—Å–µ–≥–æ: ${data.total}, —Å—Ç—Ä–∞–Ω–∏—Ü–∞: ${clusterPage}`);
          
          clusterTotalCount = data.total || clusterTotalCount;
          clusterHasMore = newClusters.length === clusterPageSize && (clusterTotalCount == null || allLoadedClusters.length + newClusters.length < clusterTotalCount);
          
          // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã –∫ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º
          allLoadedClusters.push(...newClusters);
          clusters = allLoadedClusters;
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã –≤ —Å–µ—Ç–∫—É
          if (newClusters.length > 0) {
            await appendClusters(newClusters);
          } else if (reset && clusterTotalCount === 0) {
            const grid = document.getElementById("clustersGrid");
            if (grid) {
              grid.innerHTML = '<div class="muted" style="padding: 24px; text-align: center;">–£ —ç—Ç–æ–π –ø–µ—Ä—Å–æ–Ω—ã –Ω–µ—Ç –∫–ª–∞—Å—Ç–µ—Ä–æ–≤.</div>';
            }
          }
          
          clusterPage += 1;
        } catch (e) {
          showToast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: ${e}`);
        } finally {
          clusterLoading = false;
          updateSentinel();
        }
      }

      async function appendClusters(newClusters) {
        const grid = document.getElementById("clustersGrid");
        if (!grid) return;
        
        for (const cluster of newClusters) {
          const card = await createClusterCard(cluster);
          grid.appendChild(card);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
        updateHeaderCount();
      }

      function updateHeaderCount() {
        const grid = document.getElementById("clustersGrid");
        if (!grid) return;
        const count = grid.children.length;
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      }

      async function createClusterCard(cluster) {
        const card = document.createElement("div");
        card.className = "card";
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º preview-–ª–∏—Ü–æ –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞
        let previewHtml = '';
        if (cluster.preview_face_id) {
          const previewUrl = await getFaceThumbnail(cluster.preview_face_id);
          if (previewUrl) {
            previewHtml = `<img src="${previewUrl}" alt="Preview" style="width:60px; height:60px; object-fit:cover; border-radius:6px; border:1px solid #e5e7eb;" />`;
          }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—é –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞
        let mergeIndicator = '';
        const suggestionAsSource = mergeSuggestions.find(s => s.source_cluster_id === cluster.id);
        const suggestionAsTarget = mergeSuggestions.find(s => s.target_cluster_id === cluster.id);
        
        if (suggestionAsSource || suggestionAsTarget) {
          const suggestion = suggestionAsSource || suggestionAsTarget;
          const isSource = !!suggestionAsSource;
          const otherClusterId = isSource ? suggestion.target_cluster_id : suggestion.source_cluster_id;
          const distancePercent = (suggestion.distance * 100).toFixed(1);
          mergeIndicator = `<span class="merge-indicator has-suggestion" title="–ï—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å –∫–ª–∞—Å—Ç–µ—Ä–æ–º #${otherClusterId} (—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distancePercent}%)">üîó –ú–∞–ª–µ–Ω—å–∫–∏–π</span>`;
        } else if (cluster.faces_count <= 2) {
          mergeIndicator = `<span class="merge-indicator" title="–ú–∞–ª–µ–Ω—å–∫–∏–π –∫–ª–∞—Å—Ç–µ—Ä (${cluster.faces_count} —Ñ–æ—Ç–æ)">–ú–∞–ª–µ–Ω—å–∫–∏–π</span>`;
        }
        
        // –í—ã–ø–∞–¥–∞—à–∫–∞ –¥–ª—è —Å–Ω—è—Ç–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        let optionsHtml = '<option value="">–°–Ω—è—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ</option>';
        
        card.innerHTML = `
          <div class="card-header" style="display:flex; gap:10px; align-items:start;">
            ${previewHtml ? `<div>${previewHtml}</div>` : ''}
            <div style="flex:1;">
              <div style="font-weight:700;">
                –ö–ª–∞—Å—Ç–µ—Ä #${cluster.id}
                ${mergeIndicator}
              </div>
              <div class="muted" style="font-size:11px; margin-top:4px;">
                ${cluster.faces_count} –ª–∏—Ü | Run ${cluster.run_id}
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="kv">
              <span class="pill">–ú–µ—Ç–æ–¥: ${cluster.method}</span>
              <span class="pill">–°–æ–∑–¥–∞–Ω: ${new Date(cluster.created_at).toLocaleString('ru-RU')}</span>
            </div>
            <div class="actions" style="display:flex; gap:8px; align-items:center; flex-wrap: wrap;">
              <a href="/face-clusters/${cluster.id}" class="btn" style="text-decoration:none; display:inline-block;">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
              ${suggestionAsSource ? `<button class="btn primary" type="button" onclick="acceptMergeSuggestion(${suggestion.source_cluster_id}, ${suggestion.target_cluster_id})" style="padding:6px 12px;">–û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Å #${suggestion.target_cluster_id}</button>` : ''}
              <select class="btn" style="padding:6px 12px; cursor:pointer; border:1px solid #d1d5db; border-radius:4px; background:white; min-width:180px;" onchange="assignPersonFromDropdown(${cluster.id}, this.value, event)" id="assign-select-${cluster.id}">
                ${optionsHtml}
              </select>
            </div>
          </div>
        `;
        
        return card;
      }

      async function assignPersonFromDropdown(clusterId, personId, event) {
        if (!clusterId) return;
        
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        
        const actualPersonId = personId === '' ? null : personId;
        
        try {
          const resp = await fetch(`/api/face-clusters/${clusterId}/assign-person`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ person_id: actualPersonId === null ? null : parseInt(actualPersonId) }),
          });
          
          if (resp.ok) {
            // –ï—Å–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–Ω—è—Ç–æ, —É–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Ç–µ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞
            if (actualPersonId === null) {
              const cardElement = document.querySelector(`[id="assign-select-${clusterId}"]`)?.closest('.card');
              if (cardElement) {
                cardElement.remove();
                updateHeaderCount();
                showToast(`–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–Ω—è—Ç–æ —Å –∫–ª–∞—Å—Ç–µ—Ä–∞ #${clusterId}`);
              }
            } else {
              showToast(`–ö–ª–∞—Å—Ç–µ—Ä #${clusterId} –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω`);
            }
          } else {
            let errorMsg = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
            try {
              const err = await resp.json();
              errorMsg = err.detail || err.message || err.error || JSON.stringify(err);
            } catch (e) {
              errorMsg = `HTTP ${resp.status}: ${resp.statusText}`;
            }
            showToast(`–û—à–∏–±–∫–∞: ${errorMsg}`, true);
            const select = document.getElementById(`assign-select-${clusterId}`);
            if (select) select.value = '';
          }
        } catch (e) {
          console.error(`[Assign] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ:`, e);
          showToast(`–û—à–∏–±–∫–∞: ${e}`, true);
          const select = document.getElementById(`assign-select-${clusterId}`);
          if (select) select.value = '';
        }
      }

      async function findPendingMerges() {
        const btn = document.getElementById("btnFindPendingMerges");
        btn.disabled = true;
        btn.textContent = "–ü–æ–∏—Å–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤...";
        
        try {
          // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
          const url = `/api/persons/${personId}/find-pending-merges?max_source_size=4&max_distance=0.3`;
          const resp = await fetch(url, { method: "POST" });
          
          if (!resp.ok) {
            const errorData = await resp.json().catch(() => ({}));
            throw new Error(errorData.detail || `HTTP ${resp.status}: ${resp.statusText}`);
          }
          
          const data = await resp.json();
          console.log(`[findPendingMerges] –û—Ç–≤–µ—Ç API:`, data);
          mergeSuggestions = data.suggestions || [];
          
          console.log(`[findPendingMerges] –ù–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: ${mergeSuggestions.length}`);
          if (mergeSuggestions.length > 0) {
            console.log(`[findPendingMerges] –ü–µ—Ä–≤—ã–µ 3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:`, mergeSuggestions.slice(0, 3));
            showToast(`–ù–∞–π–¥–µ–Ω–æ ${mergeSuggestions.length} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ`);
            await displayPendingMerges(mergeSuggestions);
          } else {
            showToast("–ö–∞–Ω–¥–∏–¥–∞—Ç—ã –Ω–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");
            document.getElementById("pendingMergesBlock").style.display = "none";
          }
        } catch (e) {
          console.error('[findPendingMerges] –û—à–∏–±–∫–∞:', e);
          showToast(`–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤: ${e}`, 10000);
        } finally {
          btn.disabled = false;
          btn.textContent = "–ù–∞–π—Ç–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ";
        }
      }

      async function loadPendingMerges() {
        try {
          const url = `/api/persons/${personId}/pending-merges`;
          const resp = await fetch(url);
          
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
          }
          
          const data = await resp.json();
          mergeSuggestions = data.suggestions || [];
          
          if (mergeSuggestions.length > 0) {
            await displayPendingMerges(mergeSuggestions);
          } else {
            document.getElementById("pendingMergesBlock").style.display = "none";
          }
        } catch (e) {
          console.error('[loadPendingMerges] –û—à–∏–±–∫–∞:', e);
        }
      }

      async function displayPendingMerges(suggestions) {
        const block = document.getElementById("pendingMergesBlock");
        const list = document.getElementById("pendingMergesList");
        
        if (suggestions.length === 0) {
          block.style.display = "none";
          return;
        }
        
        block.style.display = "block";
        
        let html = `<div class="muted" style="margin-bottom: 8px; font-size: 13px;">–ù–∞–π–¥–µ–Ω–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤: ${suggestions.length}</div>`;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º preview –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
        for (const suggestion of suggestions.slice(0, 10)) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 10
          const distancePercent = (suggestion.distance * 100).toFixed(1);
          
          // –ò—â–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã –≤ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
          const sourceCluster = allLoadedClusters.find(c => c.id === suggestion.source_cluster_id);
          const targetCluster = allLoadedClusters.find(c => c.id === suggestion.target_cluster_id);
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º preview –¥–ª—è source –∫–ª–∞—Å—Ç–µ—Ä–∞
          let sourcePreview = null;
          if (sourceCluster?.preview_face_id) {
            sourcePreview = await getFaceThumbnail(sourceCluster.preview_face_id);
          } else if (suggestion.source_cluster_id) {
            // –ï—Å–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ API
            try {
              const resp = await fetch(`/api/face-clusters/${suggestion.source_cluster_id}?limit=1`);
              if (resp.ok) {
                const clusterData = await resp.json();
                if (clusterData.faces && clusterData.faces.length > 0 && clusterData.faces[0].thumb_jpeg_base64) {
                  sourcePreview = `data:image/jpeg;base64,${clusterData.faces[0].thumb_jpeg_base64}`;
                }
              }
            } catch (e) {
              console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å preview –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞ ${suggestion.source_cluster_id}:`, e);
            }
          }
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º preview –¥–ª—è target –∫–ª–∞—Å—Ç–µ—Ä–∞
          let targetPreview = null;
          if (targetCluster?.preview_face_id) {
            targetPreview = await getFaceThumbnail(targetCluster.preview_face_id);
          } else if (suggestion.target_cluster_id) {
            // –ï—Å–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ API
            try {
              const resp = await fetch(`/api/face-clusters/${suggestion.target_cluster_id}?limit=1`);
              if (resp.ok) {
                const clusterData = await resp.json();
                if (clusterData.faces && clusterData.faces.length > 0 && clusterData.faces[0].thumb_jpeg_base64) {
                  targetPreview = `data:image/jpeg;base64,${clusterData.faces[0].thumb_jpeg_base64}`;
                }
              }
            } catch (e) {
              console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å preview –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞ ${suggestion.target_cluster_id}:`, e);
            }
          }
          
          const sourceThumb = sourcePreview 
            ? `<img src="${sourcePreview}" alt="Cluster ${suggestion.source_cluster_id}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 1px solid #e5e7eb;" />`
            : '<div style="width: 60px; height: 60px; background: #f3f4f6; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 10px;">–ù–µ—Ç</div>';
          
          const targetThumb = targetPreview 
            ? `<img src="${targetPreview}" alt="Cluster ${suggestion.target_cluster_id}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 1px solid #e5e7eb;" />`
            : '<div style="width: 60px; height: 60px; background: #f3f4f6; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 10px;">–ù–µ—Ç</div>';
          
          html += `
            <div style="padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; display: flex; gap: 12px; align-items: center; font-size: 13px;">
              <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                ${sourceThumb}
                <div style="font-size: 11px; color: #6b7280;">#${suggestion.source_cluster_id}</div>
                <div style="font-size: 10px; color: #9ca3af;">${suggestion.source_cluster_size} —Ñ–æ—Ç–æ</div>
              </div>
              <div style="flex: 1; text-align: center;">
                <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">
                  ‚Üí –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: <strong>${distancePercent}%</strong>
                </div>
              </div>
              <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                ${targetThumb}
                <div style="font-size: 11px; color: #6b7280;">#${suggestion.target_cluster_id}</div>
                <div style="font-size: 10px; color: #9ca3af;">${suggestion.target_cluster_size} —Ñ–æ—Ç–æ</div>
              </div>
            </div>
          `;
        }
        
        if (suggestions.length > 10) {
          html += `<div class="muted" style="margin-top: 8px; font-size: 12px;">...–∏ –µ—â–µ ${suggestions.length - 10} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</div>`;
        }
        
        list.innerHTML = html;
      }

      async function applyAllPendingMerges() {
        const btn = document.getElementById("btnApplyAllMerges");
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤—Å–µ ${mergeSuggestions.length} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤?`)) {
          return;
        }
        
        btn.disabled = true;
        btn.textContent = "–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ...";
        
        try {
          const url = `/api/persons/${personId}/apply-all-pending-merges`;
          const resp = await fetch(url, { method: "POST" });
          
          if (!resp.ok) {
            const errorData = await resp.json().catch(() => ({}));
            throw new Error(errorData.detail || `HTTP ${resp.status}: ${resp.statusText}`);
          }
          
          const data = await resp.json();
          const mergedCount = data.merged_count || 0;
          
          showToast(`–£—Å–ø–µ—à–Ω–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–æ ${mergedCount} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤`);
          document.getElementById("pendingMergesBlock").style.display = "none";
          mergeSuggestions = [];
          
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã
          await loadClusters(true);
        } catch (e) {
          console.error('[applyAllPendingMerges] –û—à–∏–±–∫–∞:', e);
          showToast(`–û—à–∏–±–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è: ${e}`, 10000);
        } finally {
          btn.disabled = false;
          btn.textContent = "–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤—Å–µ";
        }
      }

      async function reloadClusterCards() {
        // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Å —É—á–µ—Ç–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
        const grid = document.getElementById("clustersGrid");
        if (!grid) return;
        
        const cards = Array.from(grid.querySelectorAll('.card'));
        for (const card of cards) {
          const selectEl = card.querySelector('[id^="assign-select-"]');
          if (!selectEl) continue;
          
          const clusterIdMatch = selectEl.id.match(/assign-select-(\d+)/);
          if (!clusterIdMatch) continue;
          
          const clusterId = parseInt(clusterIdMatch[1]);
          const cluster = clusters.find(c => c.id === clusterId);
          if (!cluster) continue;
          
          const newCard = await createClusterCard(cluster);
          card.replaceWith(newCard);
        }
      }

      async function displayMergeSuggestions(suggestions) {
        const content = document.getElementById("mergeSuggestionsContent");
        
        if (suggestions.length === 0) {
          content.innerHTML = '<div class="muted" style="text-align: center; padding: 24px;">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—é –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>';
          return;
        }
        
        let html = `<div style="margin-bottom: 16px; font-size: 14px; color: #6b7280;">–ù–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: ${suggestions.length}</div>`;
        html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
        
        for (const suggestion of suggestions) {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º preview –¥–ª—è –æ–±–æ–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
          const sourceCluster = clusters.find(c => c.id === suggestion.source_cluster_id);
          const targetCluster = clusters.find(c => c.id === suggestion.target_cluster_id);
          
          const sourcePreview = sourceCluster?.preview_face_id ? await getFaceThumbnail(sourceCluster.preview_face_id) : null;
          const targetPreview = targetCluster?.preview_face_id ? await getFaceThumbnail(targetCluster.preview_face_id) : null;
          
          const sourceThumb = sourcePreview 
            ? `<img src="${sourcePreview}" alt="Cluster ${suggestion.source_cluster_id}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 1px solid #e5e7eb;" />`
            : '<div style="width: 60px; height: 60px; background: #f3f4f6; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 10px;">–ù–µ—Ç</div>';
          
          const targetThumb = targetPreview 
            ? `<img src="${targetPreview}" alt="Cluster ${suggestion.target_cluster_id}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 1px solid #e5e7eb;" />`
            : '<div style="width: 60px; height: 60px; background: #f3f4f6; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 10px;">–ù–µ—Ç</div>';
          
          const distancePercent = (suggestion.distance * 100).toFixed(1);
          const distanceColor = suggestion.distance < 0.25 ? '#10b981' : suggestion.distance < 0.30 ? '#f59e0b' : '#ef4444';
          
          html += `
            <div data-suggestion-id="${suggestion.source_cluster_id}-${suggestion.target_cluster_id}" style="display: flex; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; align-items: center;">
              <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                ${sourceThumb}
                <div style="font-size: 11px; color: #6b7280;">#${suggestion.source_cluster_id}</div>
                <div style="font-size: 10px; color: #9ca3af;">${suggestion.source_cluster_size} —Ñ–æ—Ç–æ</div>
              </div>
              <div style="flex: 1; text-align: center;">
                <div style="color: ${distanceColor}; font-size: 14px; font-weight: 600; margin-bottom: 4px;">
                  –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distancePercent}%
                </div>
                <div style="font-size: 12px; color: #6b7280;">${suggestion.person_name}</div>
              </div>
              <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                ${targetThumb}
                <div style="font-size: 11px; color: #6b7280;">#${suggestion.target_cluster_id}</div>
                <div style="font-size: 10px; color: #9ca3af;">${suggestion.target_cluster_size} —Ñ–æ—Ç–æ</div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn" type="button" onclick="rejectMergeSuggestion(${suggestion.source_cluster_id}, ${suggestion.target_cluster_id})" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db;">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                <button class="btn primary" type="button" onclick="acceptMergeSuggestion(${suggestion.source_cluster_id}, ${suggestion.target_cluster_id})" style="padding: 6px 12px;">–û–±—ä–µ–¥–∏–Ω–∏—Ç—å</button>
              </div>
            </div>
          `;
        }
        
        html += '</div>';
        content.innerHTML = html;
      }

      async function acceptMergeSuggestion(sourceClusterId, targetClusterId) {
        try {
          const resp = await fetch(`/api/face-clusters/merge`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              source_cluster_id: sourceClusterId, 
              target_cluster_id: targetClusterId 
            }),
          });
          
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
          }
          
          showToast(`–ö–ª–∞—Å—Ç–µ—Ä—ã #${sourceClusterId} –∏ #${targetClusterId} –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã`);
          
          // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞
          mergeSuggestions = mergeSuggestions.filter(s => 
            !(s.source_cluster_id === sourceClusterId && s.target_cluster_id === targetClusterId)
          );
          
          // –£–¥–∞–ª—è–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—É—é –ø–∞—Ä—É –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
          const content = document.getElementById("mergeSuggestionsContent");
          const suggestionEl = content.querySelector(`[data-suggestion-id="${sourceClusterId}-${targetClusterId}"]`);
          if (suggestionEl) {
            suggestionEl.remove();
          }
          
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã
          await loadClusters(true);
        } catch (e) {
          console.error('[acceptMergeSuggestion] –û—à–∏–±–∫–∞:', e);
          showToast(`–û—à–∏–±–∫–∞: ${e}`, 10000);
        }
      }

      function rejectMergeSuggestion(sourceClusterId, targetClusterId) {
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞
        mergeSuggestions = mergeSuggestions.filter(s => 
          !(s.source_cluster_id === sourceClusterId && s.target_cluster_id === targetClusterId)
        );
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        const content = document.getElementById("mergeSuggestionsContent");
        const suggestionEl = content.querySelector(`[data-suggestion-id="${sourceClusterId}-${targetClusterId}"]`);
        if (suggestionEl) {
          suggestionEl.style.display = 'none';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
        reloadClusterCards();
        
        showToast(`–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ #${sourceClusterId} –∏ #${targetClusterId} –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ`, 3000);
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      document.getElementById("btnReload").onclick = () => loadClusters(true);
      document.getElementById("btnFindPendingMerges").onclick = findPendingMerges;
      document.getElementById("btnApplyAllMerges").onclick = applyAllPendingMerges;
      
      // Sentinel –¥–ª—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞
      const sentinel = document.createElement("div");
      sentinel.id = "clustersSentinel";
      sentinel.className = "muted";
      sentinel.style.padding = "18px 0";
      sentinel.style.textAlign = "center";
      sentinel.textContent = clusterLoading ? "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶" : (clusterHasMore ? "‚Ä¶" : "");
      document.getElementById("clustersGrid").after(sentinel);
      
      const sentinelIo = new IntersectionObserver((entries) => {
        const e = entries && entries[0];
        if (e && e.isIntersecting) {
          if (!clusterLoading && clusterHasMore) {
            loadClusters(false);
          }
        }
      }, { root: null, rootMargin: "800px 0px", threshold: 0.01 });
      sentinelIo.observe(sentinel);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      async function init() {
        try {
          await loadPerson();
          await loadClusters(true);
          await loadPendingMerges(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        } catch (e) {
          console.error('[init] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', e);
          showToast(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${e}`, 10000);
        }
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    </script>
  </body>
</html>
