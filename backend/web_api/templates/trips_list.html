<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <title>PhotoSorter — Поездки</title>
    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      a { color: #0b57d0; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .muted { color: #6b7280; }
      .wrap { max-width: 1200px; }
      .header { display: flex; align-items: baseline; justify-content: space-between; gap: 12px; margin-bottom: 20px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
      .card { border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; background: #fff; transition: box-shadow 0.2s; }
      .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
      .card a { display: block; color: inherit; text-decoration: none; }
      .card a:hover { text-decoration: none; }
      .card-thumb { height: 140px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; }
      .card-thumb img { width: 100%; height: 100%; object-fit: cover; }
      .card-thumb .noimg { color: #9ca3af; font-size: 13px; }
      .card-body { padding: 12px 14px; }
      .card-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
      .card-meta { font-size: 13px; color: #6b7280; }
      .btn { padding: 8px 16px; border-radius: 8px; border: 1px solid #d1d5db; background: #fff; cursor: pointer; font-size: 14px; }
      .btn:hover { background: #f9fafb; }
      .btn-primary { background: #2563eb; color: #fff; border-color: #2563eb; }
      .btn-primary:hover { background: #1d4ed8; }
      .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 1000; }
      .modal-box { background: #fff; border-radius: 12px; padding: 20px; min-width: 320px; max-width: 90vw; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
      .modal-box h4 { margin: 0 0 12px; font-size: 18px; }
      .modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 12px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <h2 style="margin: 0;">Поездки</h2>
        <div style="display: flex; align-items: center; gap: 12px;">
          <button type="button" class="btn btn-primary" id="newTripBtn">Новая поездка</button>
          <span class="muted"><a href="/">Главная</a></span>
        </div>
      </div>

      <div id="newTripModal" class="modal-overlay" style="display: none;">
        <div class="modal-box">
          <h4>Новая поездка</h4>
          <p class="muted" style="margin: 0 0 12px;">Папку на Я.Диске можно привязать позже (sync).</p>
          <input type="text" id="newTripName" placeholder="Название поездки" style="width: 100%; padding: 8px 12px; margin-bottom: 12px; box-sizing: border-box;" />
          <div class="modal-actions">
            <button type="button" class="btn" id="newTripCancel">Отмена</button>
            <button type="button" class="btn btn-primary" id="newTripSubmit">Создать</button>
          </div>
        </div>
      </div>

      <div class="grid">
        {% for t in trips %}
        <div class="card">
          <a href="/trips/{{ t.id }}">
            <div class="card-thumb">
              {% if t.cover_preview_url %}
              <img src="{{ t.cover_preview_url }}" alt="" referrerpolicy="no-referrer" loading="lazy" />
              {% else %}
              <span class="noimg">Фото</span>
              {% endif %}
            </div>
            <div class="card-body">
              <div class="card-title">{{ t.name or "Поездка" }}</div>
              <div class="card-meta">
                {% if t.start_date %}{{ t.start_date }}{% if t.end_date and t.end_date != t.start_date %} — {{ t.end_date }}{% endif %}
                {% elif t.derived_start_date %}по фото: {{ t.derived_start_date }}{% if t.derived_end_date and t.derived_end_date != t.derived_start_date %} — {{ t.derived_end_date }}{% endif %}
                {% endif %}
                {% if t.place_country %}<br />{{ t.place_country }}{% endif %}
              </div>
            </div>
          </a>
        </div>
        {% endfor %}
      </div>

      {% if not trips %}
      <p class="muted">Поездок пока нет. Создайте новую поездку кнопкой выше или запустите импорт из Я.Диска.</p>
      {% endif %}
    </div>
    <script>
      (function() {
        var btn = document.getElementById('newTripBtn');
        var modal = document.getElementById('newTripModal');
        var input = document.getElementById('newTripName');
        var cancel = document.getElementById('newTripCancel');
        var submit = document.getElementById('newTripSubmit');
        if (!btn || !modal || !input) return;
        btn.addEventListener('click', function() {
          input.value = '';
          modal.style.display = 'flex';
          input.focus();
        });
        cancel.addEventListener('click', function() { modal.style.display = 'none'; });
        modal.addEventListener('click', function(e) { if (e.target === modal) modal.style.display = 'none'; });
        submit.addEventListener('click', async function() {
          var name = (input.value || '').trim() || 'Поездка';
          try {
            var r = await fetch('/api/trips', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: name }) });
            var data = await r.json();
            if (r.ok && data.id) {
              window.location = '/trips/' + data.id;
            } else {
              alert(data.detail || 'Ошибка создания поездки');
            }
          } catch (err) {
            console.error(err);
            alert('Ошибка: ' + err.message);
          }
        });
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') submit.click();
        });
      })();
    </script>
  </body>
</html>
