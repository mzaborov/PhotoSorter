<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- YaDisk preview hotlink –∑–∞—â–∏—Ç–∞: –ø—Ä–æ—Å–∏–º –±—Ä–∞—É–∑–µ—Ä –Ω–µ —Å–ª–∞—Ç—å Referer –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫ -->
    <meta name="referrer" content="no-referrer" />
    <title>PhotoSorter ‚Äî –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ª–∏—Ü</title>
    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      a { color: #0b57d0; text-decoration: none; }
      a:hover { text-decoration: underline; }
      code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
      .muted { color: #6b7280; }
      .wrap { max-width: 1400px; }
      .header { display:flex; align-items:baseline; justify-content:space-between; gap:12px; }
      .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
      .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f4f6; color:#374151; font-size:12px; }
      .inp { border:1px solid #d1d5db; border-radius:10px; padding:8px 10px; font-weight:700; width: 110px; }
      .inp:focus { outline: 2px solid rgba(59,130,246,0.35); outline-offset: 1px; }
      .btn { appearance:none; border:1px solid #d1d5db; background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:700; }
      .btn:hover { background:#f9fafb; }
      .btn:disabled { opacity: 0.6; cursor: not-allowed; }
      .btn.danger { border-color:#fecaca; background:#fff5f5; color:#991b1b; }
      .btn.danger:hover { background:#ffecec; }
      /* Compact buttons inside cards: 2 per row */
      .actions .btn {
        padding: 6px 8px;
        border-radius: 10px;
        font-size: 12px;
        line-height: 1.1;
        flex: 1 1 calc(50% - 8px);
        min-width: 0;
      }
      .actions { display:flex; gap:8px; align-items:center; margin-top: 10px; flex-wrap: wrap; }
      .tabs { display:flex; gap:8px; margin-top: 14px; }
      .tab { appearance:none; border:1px solid #d1d5db; background:#fff; padding:8px 10px; border-radius:999px; cursor:pointer; font-weight:700; }
      .tab.active { background:#111827; color:#fff; border-color:#111827; }
      .subtabs { display:flex; gap:8px; margin-top: 10px; }
      .subtab { appearance:none; border:1px solid #e5e7eb; background:#fff; padding:6px 10px; border-radius:999px; cursor:pointer; font-weight:700; font-size: 12px; color:#111827; }
      .subtab.active { background:#eef2ff; border-color:#c7d2fe; }
      .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top: 12px; }
      .grid { display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }
      .card { width: 240px; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; background:#fff; }
      .thumb { height: 140px; background:#fff; display:flex; align-items:center; justify-content:center; position:relative; cursor: zoom-in; }
      .thumb img { width: 100%; height: 100%; object-fit: contain; display:block; background:#fff; }
      .thumb video { width: 100%; height: 100%; object-fit: contain; display:block; background:#111827; }
      .vfbtn {
        position: absolute;
        right: 8px;
        top: 8px;
        z-index: 5;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.55);
        background: rgba(17,24,39,0.72);
        color: #fff;
        font-size: 12px;
        font-weight: 800;
        cursor: pointer;
        user-select: none;
      }
      .vfbtn:hover { background: rgba(17,24,39,0.85); }
      .thumb .noimg { color:#6b7280; font-size:12px; padding:10px; text-align:center; }
      .card-body { padding: 10px 10px 12px 10px; }
      .kv { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; font-size:12px; color:#374151; }
      .path { font-size: 12px; word-break: break-all; }
      /* .actions updated above */
      /* –í–∞—Ä–∏–∞–Ω—Ç A: "–º–∏–º–æ gold" ‚Äî –¥–µ–ª–∞–µ–º –∑–∞–º–µ—Ç–Ω–æ */
      .card.past-gold {
        background: #ffe4e6;         /* rose-200 */
        border-color: #fb7185;       /* rose-400 */
        box-shadow: 0 0 0 2px rgba(244, 63, 94, 0.35); /* rose-500 ring */
      }

      /* Modal viewer + drawing */
      .lb { position: fixed; inset: 0; background: rgba(17,24,39,0.82); display: none; align-items: center; justify-content: center; padding: 18px; z-index: 9999; }
      .lb.open { display: flex; }
      .lb-panel { background: #fff; border-radius: 14px; max-width: 94vw; max-height: 94vh; width: min(1200px, 94vw); overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.35); }
      .lb-top { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 12px; border-bottom: 1px solid #e5e7eb; }
      .lb-top code { font-size: 11px; }
      .lb-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
      .lb-tabs { display:flex; gap:8px; padding: 10px 12px; border-bottom: 1px solid #e5e7eb; background:#f9fafb; flex-wrap:wrap; }
      .lb-tab { appearance:none; border:1px solid #e5e7eb; background:#fff; padding:6px 10px; border-radius:999px; cursor:pointer; font-weight:800; font-size: 12px; color:#111827; }
      .lb-tab.active { background:#eef2ff; border-color:#c7d2fe; }
      .lb-body { background: #111827; display: flex; align-items: center; justify-content: center; padding: 10px; }
      .imgwrap { position: relative; display: inline-block; }
      .imgwrap img { max-width: 92vw; max-height: calc(92vh - 130px); width: auto; height: auto; display: block; background: #111827; }
      .imgwrap video { max-width: 92vw; max-height: calc(92vh - 130px); width: auto; height: auto; display: block; background: #111827; }
      .imgwrap canvas { position: absolute; left: 0; top: 0; pointer-events: auto; }
      .lb-bottom { padding: 10px 12px; border-top: 1px solid #e5e7eb; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
      .rectlist { display:flex; gap:8px; flex-wrap:wrap; }
      .rectpill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#1f2937; font-size:12px; }
      .draw-on { cursor: crosshair; }

      /* Sticky header (–≤—Å—ë, —á—Ç–æ –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º –±–ª–æ–∫–µ —Å–æ –≤–∫–ª–∞–¥–∫–∞–º–∏/–∫–Ω–æ–ø–∫–∞–º–∏) */
      .sticky-top {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: rgba(255,255,255,0.98);
        backdrop-filter: blur(6px);
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 12px;
        margin-bottom: 14px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="sticky-top" id="stickyTop">
        <div class="header">
          <div>
            <h2 style="margin:0;">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã ‚Äú–ª–∏—Ü–∞ / –Ω–µ—Ç –ª–∏—Ü‚Äù (—à–∞–≥ 2)</h2>
            <div class="muted" style="margin-top:6px;">–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ –ø—Ä–µ–≤—å—é ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏ –ª–∏—Ü. –í ‚Äú–ù–µ—Ç –ª–∏—Ü‚Äù –º–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Ç–∏—Ç—å –ª–∏—Ü–∞ –≤—Ä—É—á–Ω—É—é.</div>
          </div>
          <div class="muted"><a href="/">‚Üê –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a></div>
        </div>

        <div class="toolbar">
          <span class="pill">pipeline_run_id: <b id="prId">‚Äî</b></span>
          <span class="pill">face_run_id: <b id="frId">‚Äî</b></span>
          <span class="pill">root: <code id="rootPath">‚Äî</code></span>
          <span class="muted" id="toast"></span>
        </div>

        <div class="tabs">
          <button class="tab active" id="tabFaces" type="button">–ï—Å—Ç—å –ª–∏—Ü–∞</button>
          <button class="tab" id="tabQuarantine" type="button">–ö–∞—Ä–∞–Ω—Ç–∏–Ω</button>
          <button class="tab" id="tabAnimals" type="button">–ñ–∏–≤–æ—Ç–Ω—ã–µ</button>
          <button class="tab" id="tabPeopleNoFace" type="button">–ï—Å—Ç—å –ª—é–¥–∏ (–±–µ–∑ –ª–∏—Ü)</button>
          <button class="tab" id="tabNoFaces" type="button">–ù–µ—Ç –ª–∏—Ü</button>
        </div>

        <!-- 2-–π —É—Ä–æ–≤–µ–Ω—å (–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ): –ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è "–ï—Å—Ç—å –ª–∏—Ü–∞" -->
        <div class="subtabs" id="subtabsFaces" style="display:none;">
          <button class="subtab active" id="subFacesAll" type="button">–ù–µ–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ</button>
          <button class="subtab" id="subFacesMany" type="button">–ú–Ω–æ–≥–æ –ª–∏—Ü</button>
        </div>

        <div class="toolbar">
          <button class="btn" id="btnPrev" type="button">‚Üê</button>
          <span class="pill">—Å—Ç—Ä–∞–Ω–∏—Ü–∞: <b id="page">1</b></span>
          <button class="btn" id="btnNext" type="button">‚Üí</button>
          <span class="pill">–≤—Å–µ–≥–æ: <b id="total">‚Äî</b></span>
          <button class="btn" id="btnReload" type="button">–û–±–Ω–æ–≤–∏—Ç—å</button>
          <button class="btn" id="btnUndo" type="button" style="display:none;" title="Undo: –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π).">Undo</button>
          <button class="btn" id="btnSortIntoFolders" type="button" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º: _non_media, _broken_media, _faces, _quarantine, _animals, _people_no_face, _no_faces">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–∏</button>
        </div>

        <div class="toolbar">
          <span class="pill" id="posPill">–ø–æ–∑–∏—Ü–∏—è: ‚Äî</span>
          <span class="muted">—Å—Ç—Ä–æ–∫–∞:</span>
          <input class="inp" id="jumpRow" type="number" inputmode="numeric" min="1" step="1" placeholder="‚Ññ" />
          <button class="btn" id="btnJump" type="button">–ü–µ—Ä–µ–π—Ç–∏</button>
          <span class="muted" id="jumpHint"></span>
        </div>

        <!-- Filters for tab=no_faces -->
        <div class="toolbar" id="noFacesFilters" style="display:none;">
          <span class="pill">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: <b>–º–µ—Å—Ç–æ ‚Üí –¥–∞—Ç–∞</b></span>
          <span class="muted">–ø–µ—Ä–∏–æ–¥:</span>
          <input class="inp" id="nfFrom" type="date" style="width: 150px;" />
          <span class="muted">‚Äî</span>
          <input class="inp" id="nfTo" type="date" style="width: 150px;" />
          <button class="btn" id="btnNfApply" type="button">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <button class="btn" id="btnNfClear" type="button">–°–±—Ä–æ—Å</button>
        </div>
      </div>

      <div class="grid" id="grid"></div>
    </div>

    <div class="lb" id="lightbox" aria-hidden="true">
      <div class="lb-panel" role="dialog" aria-modal="true">
        <div class="lb-top">
          <code id="lbPath">‚Äî</code>
          <div class="lb-actions">
            <span class="pill" id="lbMode">–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
            <button class="btn" id="lbAnnotate" type="button" style="display:none;">–†–∞–∑–º–µ—Ç–∏—Ç—å</button>
            <button class="btn" id="lbClear" type="button" style="display:none;">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <button class="btn" id="lbSave" type="button" style="display:none;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn" id="lbClose" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
        <div class="lb-tabs" id="lbTabs" style="display:none;">
          <button class="lb-tab" id="lbTabVideo" type="button">–í–∏–¥–µ–æ</button>
          <button class="lb-tab" id="lbTabF1" type="button">–ö–∞–¥—Ä 1</button>
          <button class="lb-tab" id="lbTabF2" type="button">–ö–∞–¥—Ä 2</button>
          <button class="lb-tab" id="lbTabF3" type="button">–ö–∞–¥—Ä 3</button>
        </div>
        <div class="lb-body">
          <div class="imgwrap" id="imgWrap">
            <img id="lbImg" alt="preview" />
            <video id="lbVideo" controls preload="metadata" style="display:none;"></video>
            <canvas id="lbCanvas"></canvas>
          </div>
        </div>
        <div class="lb-bottom">
          <div class="muted">–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏:</div>
          <div class="rectlist" id="rectList"></div>
        </div>
      </div>
    </div>

    <script>
      function qs(sel, el=document) { return el.querySelector(sel); }
      function qsa(sel, el=document) { return Array.from(el.querySelectorAll(sel)); }
      function escapeHtml(s) {
        return (s ?? "").toString()
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll("\"", "&quot;")
          .replaceAll("'", "&#039;");
      }
      async function fetchJson(url, opts={}) {
        const r = await fetch(url, { cache:"no-store", ...opts });
        const t = await r.text();
        let j = null;
        try { j = t ? JSON.parse(t) : null; } catch (e) { j = null; }
        if (!r.ok) throw new Error((j && (j.detail || j.error)) ? (j.detail || j.error) : (t || `HTTP ${r.status}`));
        return j;
      }
      async function postJson(url, payload) {
        return await fetchJson(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload ?? {}) });
      }
      function setToast(msg, isErr=false) {
        const el = qs("#toast");
        el.textContent = msg || "";
        el.style.color = isErr ? "#991b1b" : "#6b7280";
      }
      function getParam(name) {
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      }

      let pipelineRunId = null;
      let tab = "faces";
      let subtab = "all"; // 2-–π —É—Ä–æ–≤–µ–Ω—å (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è tab=faces)
      let page = 1;
      const pageSize = 60;
      let loading = false;
      let hasMore = true;
      let totalCount = null;
      let loadedCount = 0;
      let jumpTargetRow = null; // 1-based

      // no_faces filters
      let nfFrom = null; // 'YYYY-MM-DD' or null
      let nfTo = null;
      const nfSort = "place_date";

      // visible-range tracking (for "–≥–¥–µ —è?")
      const visibleRows = new Set();
      let _posRaf = 0;
      function _posScheduleUpdate() {
        if (_posRaf) return;
        _posRaf = requestAnimationFrame(() => {
          _posRaf = 0;
          updatePositionPill();
        });
      }
      function _asInt(v) {
        const n = Number(v);
        return Number.isFinite(n) ? Math.trunc(n) : null;
      }
      function _cards() { return qsa("#grid .card[data-row]"); }
      function updatePositionPill() {
        const el = qs("#posPill");
        if (!el) return;
        const tot = (typeof totalCount === "number") ? totalCount : null;
        if (!visibleRows.size) {
          el.textContent = "–ø–æ–∑–∏—Ü–∏—è: ‚Äî";
          return;
        }
        const sorted = Array.from(visibleRows).sort((a,b) => a-b);
        const first = sorted[0];
        const last = sorted[sorted.length - 1];
        const top = Math.max(0, first - 1);
        const bottom = (tot != null) ? Math.max(0, tot - last) : null;
        el.textContent = `–ø–æ–∑–∏—Ü–∏—è: ${first}‚Äì${last}` + (tot != null ? ` –∏–∑ ${tot}; —Å–≤–µ—Ä—Ö—É ${top}; —Å–Ω–∏–∑—É ${bottom}` : `; —Å–≤–µ—Ä—Ö—É ${top}`);
      }
      const cardIo = new IntersectionObserver((entries) => {
        entries.forEach(e => {
          const el = e.target;
          const row = _asInt(el?.getAttribute?.("data-row"));
          if (!row) return;
          if (e.isIntersecting) visibleRows.add(row);
          else visibleRows.delete(row);
        });
        _posScheduleUpdate();
      }, { root: null, threshold: 0.1 });

      function observeNewCards() {
        _cards().forEach(el => {
          if (el.getAttribute("data-observed") === "1") return;
          el.setAttribute("data-observed", "1");
          try { cardIo.observe(el); } catch (e) {}
        });
      }

      function removeCardByPath(path) {
        const p = (path || "").toString();
        if (!p) return false;
        const cards = qsa("#grid .card");
        const card = cards.find(c => (c.getAttribute("data-path") || "") === p);
        if (!card) return false;
        const row = _asInt(card.getAttribute("data-row"));
        try { cardIo.unobserve(card); } catch (e) {}
        if (row) visibleRows.delete(row);
        card.remove();
        _posScheduleUpdate();
        return true;
      }

      // init tab/subtab from query (–¥–æ –ø–µ—Ä–≤–æ–≥–æ load)
      tab = (getParam("tab") || tab || "faces").toString().trim().toLowerCase() || "faces";
      if (!["faces","quarantine","animals","people_no_face","no_faces"].includes(tab)) tab = "faces";
      subtab = (getParam("subtab") || subtab || "all").toString().trim().toLowerCase() || "all";
      if (!["all","many_faces"].includes(subtab)) subtab = "all";
      if (tab !== "faces") subtab = "all";

      // init no_faces filters from URL (only used when tab=no_faces)
      nfFrom = (getParam("from") || "").toString().trim() || null;
      nfTo = (getParam("to") || "").toString().trim() || null;
      if (nfFrom && nfFrom.length > 10) nfFrom = nfFrom.slice(0, 10);
      if (nfTo && nfTo.length > 10) nfTo = nfTo.slice(0, 10);

      function updateUrlParams() {
        const u = new URL(window.location.href);
        u.searchParams.set("tab", tab);
        if (tab === "faces" && subtab && subtab !== "all") {
          u.searchParams.set("subtab", subtab);
        } else {
          u.searchParams.delete("subtab");
        }
        if (tab === "no_faces") {
          u.searchParams.set("sort", nfSort);
          if (nfFrom) u.searchParams.set("from", nfFrom);
          else u.searchParams.delete("from");
          if (nfTo) u.searchParams.set("to", nfTo);
          else u.searchParams.delete("to");
        } else {
          u.searchParams.delete("sort");
          u.searchParams.delete("from");
          u.searchParams.delete("to");
        }
        window.history.replaceState({}, "", u.toString());
      }

      function updateSubtabsVisibility() {
        const row = qs("#subtabsFaces");
        if (!row) return;
        row.style.display = (tab === "faces") ? "flex" : "none";
        const bAll = qs("#subFacesAll");
        const bMany = qs("#subFacesMany");
        if (bAll) bAll.classList.toggle("active", tab === "faces" && subtab === "all");
        if (bMany) bMany.classList.toggle("active", tab === "faces" && subtab === "many_faces");
      }

      function applyTabUI() {
        qs("#tabFaces").classList.toggle("active", tab === "faces");
        qs("#tabQuarantine").classList.toggle("active", tab === "quarantine");
        qs("#tabAnimals").classList.toggle("active", tab === "animals");
        qs("#tabPeopleNoFace").classList.toggle("active", tab === "people_no_face");
        qs("#tabNoFaces").classList.toggle("active", tab === "no_faces");
        updateSubtabsVisibility();
        const nf = qs("#noFacesFilters");
        if (nf) nf.style.display = (tab === "no_faces") ? "flex" : "none";
      }

      function setSubtab(st) {
        if (tab !== "faces") return;
        subtab = st;
        if (!["all","many_faces"].includes(subtab)) subtab = "all";
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/6ba4f132-2ab7-473c-8c73-3e4f328ef941',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'app/templates/faces.html:setSubtab',message:'ui_set_subtab',data:{tab:tab,subtab:subtab},timestamp:Date.now(),sessionId:'debug-session',runId:'pre-fix',hypothesisId:'HUI_SUBTAB'})}).catch(()=>{});
        // #endregion agent log
        updateSubtabsVisibility();
        updateUrlParams();
        page = 1;
        load(true);
      }

      function setTab(t) {
        tab = t;
        if (!["faces","quarantine","animals","people_no_face","no_faces"].includes(tab)) tab = "faces";
        if (tab !== "faces") subtab = "all";
        applyTabUI();
        updateUrlParams();
        page = 1;
        load(true);
      }
      qs("#tabFaces").onclick = () => setTab("faces");
      qs("#tabQuarantine").onclick = () => setTab("quarantine");
      qs("#tabAnimals").onclick = () => setTab("animals");
      qs("#tabPeopleNoFace").onclick = () => setTab("people_no_face");
      qs("#tabNoFaces").onclick = () => setTab("no_faces");
      qs("#subFacesAll").onclick = () => setSubtab("all");
      qs("#subFacesMany").onclick = () => setSubtab("many_faces");
      // –ü–∞–≥–∏–Ω–∞—Ü–∏—é –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω—É—é –ø–æ–¥–≥—Ä—É–∑–∫—É –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ.
      qs("#btnPrev").style.display = "none";
      qs("#btnNext").style.display = "none";
      qs("#page").textContent = "‚Äî";
      qs("#btnReload").onclick = () => load(true);

      function jumpToRow(n) {
        const nn = _asInt(n);
        const hint = qs("#jumpHint");
        if (!nn || nn < 1) {
          if (hint) hint.textContent = "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ ‚â• 1";
          return;
        }
        if (hint) hint.textContent = "";
        const targetPage = Math.floor((nn - 1) / pageSize) + 1;
        jumpTargetRow = nn;
        page = targetPage;
        load(true, { forcePage: targetPage });
      }
      qs("#btnJump").onclick = () => jumpToRow(qs("#jumpRow")?.value);
      qs("#jumpRow").addEventListener("keydown", (e) => {
        if (e.key === "Enter") jumpToRow(qs("#jumpRow")?.value);
      });

      async function refreshTabCounts() {
        if (!pipelineRunId) return;
        try {
          const data = await fetchJson(`/api/faces/tab-counts?pipeline_run_id=${encodeURIComponent(String(pipelineRunId))}`);
          const c = data?.counts || {};
          const scFaces = data?.subcounts?.faces || {};
          const manyCnt = Number(scFaces.many_faces ?? 0);
          const unsortedCnt = Number(scFaces.unsorted ?? 0);
          qs("#tabFaces").textContent = `–ï—Å—Ç—å –ª–∏—Ü–∞ (${Number(c.faces ?? 0)})`;
          qs("#tabQuarantine").textContent = `–ö–∞—Ä–∞–Ω—Ç–∏–Ω (${Number(c.quarantine ?? 0)})`;
          qs("#tabAnimals").textContent = `–ñ–∏–≤–æ—Ç–Ω—ã–µ (${Number(c.animals ?? 0)})`;
          qs("#tabPeopleNoFace").textContent = `–ï—Å—Ç—å –ª—é–¥–∏ (–±–µ–∑ –ª–∏—Ü) (${Number(c.people_no_face ?? 0)})`;
          qs("#tabNoFaces").textContent = `–ù–µ—Ç –ª–∏—Ü (${Number(c.no_faces ?? 0)})`;
          const bMany = qs("#subFacesMany");
          if (bMany) bMany.textContent = `–ú–Ω–æ–≥–æ –ª–∏—Ü (${manyCnt})`;
          const bAll = qs("#subFacesAll");
          if (bAll) bAll.textContent = `–ù–µ–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ (${unsortedCnt})`;
        } catch (e) {
          // best-effort
        }
      }

      function cardHtml(it, rowNum) {
        const path = it.path || "";
        const kind = it.preview_kind || "none";
        const pv = it.preview_url || "";
        const manual = (it.faces_manual_label || "").toLowerCase();
        const manualPill = manual ? `<span class="pill">manual: ${escapeHtml(manual)}</span>` : ``;
        const facesCnt = Number(it.faces_count || 0);
        const qReason = it.faces_quarantine_reason || "";
        const qPill = qReason ? `<span class="pill">q: ${escapeHtml(qReason)}</span>` : ``;
        const aKind = it.animals_kind || "";
        const aPill = aKind ? `<span class="pill">animal: ${escapeHtml(aKind)}</span>` : ``;
        const pnfPerson = it.people_no_face_person || "";
        const pnfPill = (tab === "people_no_face" && pnfPerson) ? `<span class="pill">person: ${escapeHtml(pnfPerson)}</span>` : ``;
        const placeC = (it.place_country || "").toString().trim();
        const placeCity = (it.place_city || "").toString().trim();
        const placeLabel = (placeC || placeCity) ? [placeC, placeCity].filter(Boolean).join(", ") : "";
        const takenAt = (it.taken_at || "").toString();
        const takenDate = (takenAt && takenAt.length >= 10) ? takenAt.slice(0, 10) : "";
        const placePill = (tab === "no_faces" && placeLabel) ? `<span class="pill">–º–µ—Å—Ç–æ: ${escapeHtml(placeLabel)}</span>` : ``;
        const datePill = (tab === "no_faces" && takenDate) ? `<span class="pill">–¥–∞—Ç–∞: ${escapeHtml(takenDate)}</span>` : ``;
        const framesBtn = (kind === "video" && pv)
          ? `<button class="vfbtn" type="button" data-act="frames" data-path="${escapeHtml(path)}" data-src="${escapeHtml(pv)}">–ö–∞–¥—Ä—ã</button>`
          : ``;
        const thumb = (kind === "image" && pv)
          ? `<img loading="lazy" alt="preview" referrerpolicy="no-referrer" src="${escapeHtml(pv)}" />`
          : (kind === "video" && pv)
            ? `<video controls muted preload="metadata" src="${escapeHtml(pv)}"></video>`
            : `<div class="noimg">–Ω–µ—Ç –ø—Ä–µ–≤—å—é</div>`;
        let btn = "";
        if (tab === "faces") {
          btn = `
            <button class="btn" data-action="mark_cat">–ö–æ—Ç</button>
            <button class="btn" data-action="mark_quarantine">–ö–∞—Ä–∞–Ω—Ç–∏–Ω</button>
            <button class="btn" data-action="people_no_face">–õ—é–¥–∏ –±–µ–∑ –ª–∏—Ü</button>
            <button class="btn danger" data-action="no_faces">–õ–∏—Ü –Ω–µ—Ç</button>
            <button class="btn danger" data-action="delete" title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª (–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ _delete)">üóëÔ∏è</button>
          `;
        } else if (tab === "no_faces") {
          btn = `
            <button class="btn" data-action="annotate_faces">–õ–∏—Ü–∞ –µ—Å—Ç—å (—Ä–∞–∑–º–µ—Ç–∏—Ç—å)</button>
            <button class="btn" data-action="mark_cat">–ö–æ—Ç</button>
            <button class="btn" data-action="people_no_face">–ï—Å—Ç—å –ª—é–¥–∏ (–±–µ–∑ –ª–∏—Ü)</button>
            <button class="btn danger" data-action="delete" title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª (–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ _delete)">üóëÔ∏è</button>
          `;
        } else if (tab === "quarantine") {
          btn = `
            <button class="btn" data-action="mark_faces">–ù–æ—Ä–º–∞–ª—å–Ω—ã–µ –ª–∏—Ü–∞</button>
            <button class="btn" data-action="mark_cat">–ö–æ—Ç</button>
            <button class="btn danger" data-action="no_faces">–õ–∏—Ü –Ω–µ—Ç</button>
            <button class="btn danger" data-action="delete" title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª (–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ _delete)">üóëÔ∏è</button>
          `;
        } else if (tab === "animals") {
          btn = `
            <button class="btn" data-action="mark_faces">–≠—Ç–æ –Ω–µ –∂–∏–≤–æ—Ç–Ω–æ–µ (–ª–∏—Ü–∞)</button>
            <button class="btn danger" data-action="not_animal_no_faces">–≠—Ç–æ –Ω–µ –∂–∏–≤–æ—Ç–Ω–æ–µ (–Ω–µ—Ç –ª–∏—Ü)</button>
            <button class="btn danger" data-action="delete" title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª (–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ _delete)">üóëÔ∏è</button>
          `;
        } else if (tab === "people_no_face") {
          btn = `
            <button class="btn" data-action="reset">–°–±—Ä–æ—Å</button>
            <button class="btn danger" data-action="delete" title="–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª (–ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ _delete)">üóëÔ∏è</button>
          `;
        }
        const pastGold = !!it.sorted_past_gold;
        const cls = pastGold ? "card past-gold" : "card";
        const qMan = Number(it.quarantine_manual || 0);
        const pnfMan = Number(it.people_no_face_manual || 0);
        const aMan = Number(it.animals_manual || 0);
        const aManKind = (it.animals_manual_kind || "").toString();
        const pnfPerson2 = (it.people_no_face_person || "").toString();
        return `
          <div class="${cls}"
               data-path="${escapeHtml(path)}"
               data-row="${Number(rowNum || 0) || ""}"
               data-faces-manual="${escapeHtml(manual)}"
               data-quarantine-manual="${escapeHtml(String(qMan))}"
               data-people-no-face-manual="${escapeHtml(String(pnfMan))}"
               data-people-no-face-person="${escapeHtml(pnfPerson2)}"
               data-animals-manual="${escapeHtml(String(aMan))}"
               data-animals-manual-kind="${escapeHtml(aManKind)}">
            <div class="thumb" data-path="${escapeHtml(path)}" data-kind="${escapeHtml(kind)}" data-src="${escapeHtml(pv)}">
              ${framesBtn}
              ${thumb}
            </div>
            <div class="card-body">
              <div class="path"><code>${escapeHtml(it.path_short || path)}</code></div>
              <div class="kv">
                ${rowNum ? `<span class="pill">#${Number(rowNum)}</span>` : ``}
                <span class="pill">–ª–∏—Ü: ${facesCnt}</span>
                ${manualPill}
                ${qPill}
                ${aPill}
                ${pnfPill}
                ${placePill}
                ${datePill}
                ${it.size_human ? `<span class="pill">${escapeHtml(it.size_human)}</span>` : ``}
              </div>
              <div class="actions">
                ${btn}
              </div>
            </div>
          </div>
        `;
      }

      async function load(reset=false, opts={}) {
        if (!pipelineRunId) return;
        if (loading) return;
        if (!reset && !hasMore) return;
        loading = true;
        setToast("");
        try {
          if (reset && opts && typeof opts.forcePage === "number" && opts.forcePage >= 1) {
            page = Math.trunc(opts.forcePage);
          }
          if (reset) {
            hasMore = true;
            totalCount = null;
            loadedCount = 0;
            visibleRows.clear();
            try { cardIo.disconnect(); } catch (e) {}
            qs("#grid").innerHTML = `<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>`;
          } else if (page === 1 && loadedCount === 0) {
            qs("#grid").innerHTML = `<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>`;
          }
          let url = `/api/faces/results?pipeline_run_id=${encodeURIComponent(String(pipelineRunId))}&tab=${encodeURIComponent(tab)}&subtab=${encodeURIComponent(subtab)}&page=${encodeURIComponent(String(page))}&page_size=${encodeURIComponent(String(pageSize))}`;
          if (tab === "no_faces") {
            url += `&sort=${encodeURIComponent(nfSort)}`;
            if (nfFrom) url += `&from=${encodeURIComponent(String(nfFrom))}`;
            if (nfTo) url += `&to=${encodeURIComponent(String(nfTo))}`;
          }
          const data = await fetchJson(url);
          // #region agent log
          fetch('http://127.0.0.1:7242/ingest/6ba4f132-2ab7-473c-8c73-3e4f328ef941',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'app/templates/faces.html:load',message:'ui_load_result',data:{tab:tab,subtab:subtab,total:Number(data?.total??-1),items_len:Array.isArray(data?.items)?data.items.length:-1},timestamp:Date.now(),sessionId:'debug-session',runId:'pre-fix',hypothesisId:'HAPI_FILTER'})}).catch(()=>{});
          // #endregion agent log
          qs("#prId").textContent = String(data.pipeline_run_id);
          qs("#frId").textContent = String(data.face_run_id);
          qs("#rootPath").textContent = data.root_path || "‚Äî";
          totalCount = (data.total != null) ? Number(data.total) : totalCount;
          qs("#total").textContent = String(totalCount ?? "‚Äî");
          const items = Array.isArray(data.items) ? data.items : [];
          const startRow = ((Number(page) - 1) * pageSize) + 1;
          if (reset) qs("#grid").innerHTML = "";
          if (!items.length && loadedCount === 0) {
            qs("#grid").innerHTML = `<div class="muted">–ü—É—Å—Ç–æ.</div>`;
          } else if (items.length) {
            qs("#grid").insertAdjacentHTML("beforeend", items.map((it, i) => cardHtml(it, startRow + i)).join(""));
          }
          loadedCount += items.length;
          hasMore = items.length === pageSize && (totalCount == null || loadedCount < totalCount);
          await refreshTabCounts();
          observeNewCards();
          _posScheduleUpdate();

          // if jump requested: scroll to the exact row within this page
          if (reset && jumpTargetRow != null) {
            const target = jumpTargetRow;
            jumpTargetRow = null;
            const el = _cards().find(c => _asInt(c.getAttribute("data-row")) === target);
            if (el) {
              el.scrollIntoView({ block: "start", behavior: "auto" });
              el.style.boxShadow = "0 0 0 2px rgba(59,130,246,0.45)";
              setTimeout(() => { try { el.style.boxShadow = ""; } catch (e) {} }, 1200);
            } else {
              window.scrollTo({ top: 0, behavior: "auto" });
            }
          }

          // actions
          qsa(".card button[data-action]").slice(-items.length * 1 - 2000).forEach(btn => {
            btn.addEventListener("click", async () => {
              const card = btn.closest(".card");
              const p = card?.getAttribute("data-path") || "";
              const action = btn.getAttribute("data-action");
              if (!p) return;
              try {
                const removeCard = () => removeCardByPath(p);

                function _getPrevManualFromCard(cardEl) {
                  const c = cardEl || {};
                  const facesManual = (c.getAttribute?.("data-faces-manual") || "").toString().trim().toLowerCase();
                  const qMan = Number(c.getAttribute?.("data-quarantine-manual") || 0);
                  const pnfMan = Number(c.getAttribute?.("data-people-no-face-manual") || 0);
                  const pnfPerson = (c.getAttribute?.("data-people-no-face-person") || "").toString() || "";
                  const aMan = Number(c.getAttribute?.("data-animals-manual") || 0);
                  const aManKind = (c.getAttribute?.("data-animals-manual-kind") || "").toString().trim().toLowerCase();
                  // precedence for UNDO snapshot: pick current run-scoped manual state
                  if (pnfMan === 1) return { label: "people_no_face", person: (pnfPerson || null) };
                  if (facesManual === "faces") return { label: "faces", person: null };
                  if (facesManual === "no_faces") return { label: "no_faces", person: null };
                  if (qMan === 1) return { label: "quarantine", person: null };
                  if (aMan === 1) return { label: (aManKind === "cat" ? "cat" : "cat"), person: null };
                  return { label: "", person: null };
                }

                function _pushUndo(state) {
                  if (!window.__undoStack) {
                    window.__undoStack = [];
                  }
                  if (state && state.path) {
                    window.__undoStack.push(state);
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Å—Ç–µ–∫ 10 –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏
                    if (window.__undoStack.length > 10) {
                      window.__undoStack.shift();
                    }
                  }
                  const b = qs("#btnUndo");
                  if (!b) return;
                  if (window.__undoStack && window.__undoStack.length > 0) {
                    b.style.display = "";
                  } else {
                    b.style.display = "none";
                  }
                }

                if (action === "delete") {
                  try {
                    const res = await postJson("/api/faces/delete", { pipeline_run_id: Number(pipelineRunId), path: p });
                    if (res.ok && res.undo_data) {
                      _pushUndo({
                        action: "delete",
                        path: res.undo_data.original_path,
                        delete_path: res.undo_data.delete_path,
                        undo_data: res.undo_data,
                      });
                    }
                    removeCard();
                    await refreshTabCounts();
                    setToast(`–§–∞–π–ª —É–¥–∞–ª—ë–Ω. –£–¥–∞–ª–µ–Ω–æ –∏–∑ gold: ${res.removed_from_gold || 0} –∑–∞–ø–∏—Å–µ–π.`);
                  } catch (e) {
                    setToast(e?.message || String(e), true);
                  }
                } else if (action === "no_faces") {
                  const prev = _getPrevManualFromCard(card);
                  await postJson("/api/faces/manual-label", { pipeline_run_id: Number(pipelineRunId), path: p, label: "no_faces" });
                  _pushUndo({ action: "manual_label", path: p, prev_label: prev.label, prev_person: prev.person });
                  if (tab === "faces" || tab === "quarantine") {
                    removeCard();
                    await refreshTabCounts();
                  } else {
                    await load(true);
                  }
                } else if (action === "mark_faces") {
                  const prev = _getPrevManualFromCard(card);
                  await postJson("/api/faces/manual-label", { pipeline_run_id: Number(pipelineRunId), path: p, label: "faces" });
                  _pushUndo({ action: "manual_label", path: p, prev_label: prev.label, prev_person: prev.person });
                  // –í –∫–∞—Ä–∞–Ω—Ç–∏–Ω–µ/–∂–∏–≤–æ—Ç–Ω—ã—Ö —Ä–∞–∑–º–µ—Ç–∫–∞ –∏–¥—ë—Ç –ø–æ—Ç–æ–∫–æ–º: –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞.
                  if (tab === "quarantine" || tab === "animals") {
                    removeCard();
                    await refreshTabCounts();
                  } else {
                    await load(true);
                  }
                } else if (action === "not_animal_no_faces") {
                  const prev = _getPrevManualFromCard(card);
                  await postJson("/api/faces/manual-label", { pipeline_run_id: Number(pipelineRunId), path: p, label: "not_animal_no_faces" });
                  _pushUndo({ action: "manual_label", path: p, prev_label: prev.label, prev_person: prev.person });
                  // –ü–æ—Ç–æ–∫–æ–≤–∞—è —á–∏—Å—Ç–∫–∞ –ª–æ–∂–Ω—ã—Ö –∫–æ—Ç–æ–≤: –±–µ–∑ reload —Å–ø–∏—Å–∫–∞, –ø—Ä–æ—Å—Ç–æ —É–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É.
                  if (tab === "animals") {
                    removeCard();
                    await refreshTabCounts();
                  } else {
                    await load(true);
                  }
                } else if (action === "mark_cat") {
                  // #region agent log
                  try {
                    const bn = (p || "").split(/[\\\\/]/).pop();
                    fetch('http://127.0.0.1:7242/ingest/6ba4f132-2ab7-473c-8c73-3e4f328ef941',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'app/templates/faces.html:mark_cat',message:'ui_click_mark_cat',data:{tab:tab,basename:bn||""},timestamp:Date.now(),sessionId:'debug-session',runId:'pre-fix',hypothesisId:'HNOFACES_CAT'})}).catch(()=>{});
                  } catch (e) {}
                  // #endregion agent log
                  const prev = _getPrevManualFromCard(card);
                  await postJson("/api/faces/manual-label", { pipeline_run_id: Number(pipelineRunId), path: p, label: "cat" });
                  _pushUndo({ action: "manual_label", path: p, prev_label: prev.label, prev_person: prev.person });
                  // –ü–æ—Ç–æ–∫–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: –±–µ–∑ –ø—Ä—ã–∂–∫–æ–≤/–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞
                  if (tab === "faces" || tab === "quarantine" || tab === "no_faces") {
                    removeCard();
                    await refreshTabCounts();
                  } else {
                    await load(true);
                  }
                } else if (action === "mark_quarantine") {
                  const prev = _getPrevManualFromCard(card);
                  await postJson("/api/faces/manual-label", { pipeline_run_id: Number(pipelineRunId), path: p, label: "quarantine" });
                  _pushUndo({ action: "manual_label", path: p, prev_label: prev.label, prev_person: prev.person });
                  // –ù–∞ –≤–∫–ª–∞–¥–∫–µ Faces –Ω–µ —Ö–æ—Ç–∏–º –¥—ë—Ä–≥–∞—Ç—å —Å–ø–∏—Å–æ–∫/—Å–∫—Ä–æ–ª–ª ‚Äî –ø—Ä–æ—Å—Ç–æ —É–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É.
                  if (tab === "faces") {
                    removeCard();
                    await refreshTabCounts();
                  } else {
                    await load(true);
                  }
                } else if (action === "annotate_faces") {
                  const thumb = card?.querySelector(".thumb[data-src]");
                  const src = thumb?.getAttribute("data-src") || "";
                  await openAnnotate(p, src);
                } else if (action === "people_no_face") {
                  const prev = _getPrevManualFromCard(card);
                  await postJson("/api/faces/manual-label", { pipeline_run_id: Number(pipelineRunId), path: p, label: "people_no_face" });
                  _pushUndo({ action: "manual_label", path: p, prev_label: prev.label, prev_person: prev.person });
                  // –ü–æ—Ç–æ–∫–æ–≤–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞: —É–≤–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É –±–µ–∑ reload (–∏–Ω–∞—á–µ –ø—Ä—ã–≥–∞–µ—Ç —Å–ø–∏—Å–æ–∫).
                  removeCard();
                  await refreshTabCounts();
                } else if (action === "reset") {
                  const prev = _getPrevManualFromCard(card);
                  await postJson("/api/faces/manual-label", { pipeline_run_id: Number(pipelineRunId), path: p, label: "" });
                  _pushUndo({ action: "manual_label", path: p, prev_label: prev.label, prev_person: prev.person });
                  // –ù–∞ –≤–∫–ª–∞–¥–∫–µ people_no_face —ç—Ç–æ "–ø–æ—Ç–æ–∫–æ–≤—ã–π" —Å–±—Ä–æ—Å: –ø—Ä–æ—Å—Ç–æ —É–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É.
                  removeCard();
                  await refreshTabCounts();
                }
              } catch (e) {
                setToast(e?.message || String(e), true);
              }
            });
          });

          // double click: show rectangles overlay (images only)
          qsa(".thumb[data-kind='image'][data-src]").slice(-items.length * 1 - 2000).forEach(el => {
            el.addEventListener("dblclick", async () => {
              const p = el.getAttribute("data-path") || "";
              const src = el.getAttribute("data-src") || "";
              if (!p || !src) return;
              await openViewer(p, src, { mode: "view" });
            });
          });

          // video frames button (do not rely on dblclick: <video controls> eats events)
          qsa("button.vfbtn[data-act='frames']").slice(-items.length * 1 - 2000).forEach(el => {
            el.addEventListener("click", async (e) => {
              try { e.preventDefault(); e.stopPropagation(); } catch (ee) {}
              const p = el.getAttribute("data-path") || "";
              const src = el.getAttribute("data-src") || "";
              if (!p || !src) return;
              await openVideoViewer(p, src);
            });
          });
        } catch (e) {
          setToast(e?.message || String(e), true);
          if (loadedCount === 0) qs("#grid").innerHTML = "";
          hasMore = false;
        } finally {
          loading = false;
        }
      }

      // --- viewer / annotate ---
      const lb = qs("#lightbox");
      const lbImg = qs("#lbImg");
      const lbVideo = qs("#lbVideo");
      const lbCanvas = qs("#lbCanvas");
      const lbCtx = lbCanvas.getContext("2d");
      const lbPath = qs("#lbPath");
      const lbMode = qs("#lbMode");
      const lbAnnotate = qs("#lbAnnotate");
      const lbClear = qs("#lbClear");
      const lbSave = qs("#lbSave");
      const rectList = qs("#rectList");
      const lbTabs = qs("#lbTabs");
      const lbTabVideo = qs("#lbTabVideo");
      const lbTabF1 = qs("#lbTabF1");
      const lbTabF2 = qs("#lbTabF2");
      const lbTabF3 = qs("#lbTabF3");
      let curPath = "";
      let curAutoRects = [];   // auto (read-only)
      let curManualRects = []; // manual (editable)
      let drawEnabled = false;
      let dragging = false;
      let dragStart = null;
      let tempRect = null;
      let curSrc = "";
      let curKind = "image"; // 'image' | 'video'
      let curVideoSrc = "";
      let curVideoFrameIdx = 0; // 0=video, 1..3=frame
      let curVideoFrames = null; // {frames:[...]}

      function closeLb() {
        lb.classList.remove("open");
        lb.setAttribute("aria-hidden","true");
        try { if (lbVideo) { lbVideo.pause(); lbVideo.removeAttribute("src"); lbVideo.load(); } } catch (e) {}
        curPath = "";
        curSrc = "";
        curAutoRects = [];
        curManualRects = [];
        curKind = "image";
        curVideoSrc = "";
        curVideoFrameIdx = 0;
        curVideoFrames = null;
        drawEnabled = false;
        dragging = false;
        dragStart = null;
        tempRect = null;
        lbCanvas.classList.remove("draw-on");
        if (lbAnnotate) lbAnnotate.style.display = "none";
        if (lbTabs) lbTabs.style.display = "none";
        if (lbImg) lbImg.style.display = "";
        if (lbVideo) lbVideo.style.display = "none";
      }
      qs("#lbClose").onclick = closeLb;
      lb.addEventListener("click", (e) => { if (e.target === lb) closeLb(); });
      window.addEventListener("keydown", (e) => { if (e.key === "Escape") closeLb(); });

      function renderRectList() {
        const all = [...(curAutoRects||[]), ...(curManualRects||[])];
        rectList.innerHTML = all.map((r, i) => `<span class="rectpill">#${i+1} ${r.w}√ó${r.h}</span>`).join("") || `<span class="muted">‚Äî</span>`;
      }

      function resizeCanvasToImage() {
        const w = lbImg.clientWidth;
        const h = lbImg.clientHeight;
        lbCanvas.width = Math.max(1, Math.floor(w));
        lbCanvas.height = Math.max(1, Math.floor(h));
        lbCanvas.style.width = w + "px";
        lbCanvas.style.height = h + "px";
      }

      function drawOverlay() {
        if (!lbCtx) return;
        resizeCanvasToImage();
        lbCtx.clearRect(0,0,lbCanvas.width, lbCanvas.height);
        if (curKind === "video" && curVideoFrameIdx === 0) {
          return; // no overlay on video playback
        }
        const iw = lbImg.naturalWidth || 1;
        const ih = lbImg.naturalHeight || 1;
        const sx = lbCanvas.width / iw;
        const sy = lbCanvas.height / ih;
        lbCtx.lineWidth = 2;
        // auto rects (yellow)
        lbCtx.strokeStyle = "rgba(250,204,21,0.95)";
        (curAutoRects || []).forEach(r => {
          lbCtx.strokeRect(r.x * sx, r.y * sy, r.w * sx, r.h * sy);
        });
        // manual rects (blue)
        lbCtx.strokeStyle = "rgba(59,130,246,0.95)";
        (curManualRects || []).forEach(r => {
          lbCtx.strokeRect(r.x * sx, r.y * sy, r.w * sx, r.h * sy);
        });
        // temp
        if (tempRect) {
          lbCtx.strokeStyle = "rgba(16,185,129,0.95)";
          lbCtx.strokeRect(tempRect.x * sx, tempRect.y * sy, tempRect.w * sx, tempRect.h * sy);
        }
      }

      async function fetchRects(path) {
        const data = await fetchJson(`/api/faces/rectangles?pipeline_run_id=${encodeURIComponent(String(pipelineRunId))}&path=${encodeURIComponent(path)}`);
        const rects = Array.isArray(data.rectangles) ? data.rectangles : [];
        const auto = [];
        const manual = [];
        rects.forEach(r => {
          const rr = { x: Number(r.bbox_x||0), y: Number(r.bbox_y||0), w: Number(r.bbox_w||0), h: Number(r.bbox_h||0) };
          const im = Number(r.is_manual || 0) === 1;
          (im ? manual : auto).push(rr);
        });
        return { auto, manual };
      }

      async function openViewer(path, src, opts={}) {
        curKind = "image";
        curPath = path;
        curSrc = src || "";
        lbPath.textContent = path;
        lbImg.referrerPolicy = "no-referrer";
        lbImg.draggable = false;
        if (lbTabs) lbTabs.style.display = "none";
        if (lbVideo) lbVideo.style.display = "none";
        if (lbImg) lbImg.style.display = "";
        lbImg.src = src;
        const isAnnotate = (opts.mode === "annotate");
        lbMode.textContent = isAnnotate ? "—Ä–∞–∑–º–µ—Ç–∫–∞" : "–ø—Ä–æ—Å–º–æ—Ç—Ä";
        lbClear.style.display = isAnnotate ? "" : "none";
        lbSave.style.display = isAnnotate ? "" : "none";
        // –í —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–†–∞–∑–º–µ—Ç–∏—Ç—å" (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫)
        if (lbAnnotate) lbAnnotate.style.display = (!isAnnotate && !!curSrc) ? "" : "none";
        drawEnabled = isAnnotate;
        lbCanvas.classList.toggle("draw-on", !!drawEnabled);

        lb.classList.add("open");
        lb.setAttribute("aria-hidden","false");

        await new Promise((resolve) => {
          if (lbImg.complete) return resolve();
          lbImg.onload = () => resolve();
          lbImg.onerror = () => resolve();
        });

        const rr = await fetchRects(path).catch(() => ({ auto: [], manual: [] }));
        curAutoRects = rr.auto || [];
        curManualRects = rr.manual || [];
        renderRectList();
        drawOverlay();
      }

      function _lbTabSetActive(which) {
        [lbTabVideo, lbTabF1, lbTabF2, lbTabF3].forEach(b => {
          if (!b) return;
          b.classList.toggle("active", b === which);
        });
      }

      async function _ensureVideoFramesLoaded() {
        if (curVideoFrames) return curVideoFrames;
        const data = await fetchJson(`/api/faces/video-manual-frames?pipeline_run_id=${encodeURIComponent(String(pipelineRunId))}&path=${encodeURIComponent(curPath)}`);
        curVideoFrames = data || { frames: [] };
        return curVideoFrames;
      }

      function _videoFrameObj(idx) {
        const arr = (curVideoFrames && Array.isArray(curVideoFrames.frames)) ? curVideoFrames.frames : [];
        return arr.find(x => Number(x?.frame_idx) === Number(idx)) || { frame_idx: idx, t_sec: null, rects: [] };
      }

      async function _showVideoTab() {
        curKind = "video";
        curVideoFrameIdx = 0;
        drawEnabled = false;
        lbCanvas.classList.remove("draw-on");
        lbMode.textContent = "–≤–∏–¥–µ–æ";
        if (lbAnnotate) lbAnnotate.style.display = "none";
        lbClear.style.display = "none";
        lbSave.style.display = "none";
        curAutoRects = [];
        curManualRects = [];
        renderRectList();
        if (lbImg) lbImg.style.display = "none";
        if (lbVideo) {
          lbVideo.style.display = "";
          lbVideo.src = curVideoSrc || "";
        }
        drawOverlay();
      }

      async function _showVideoFrame(idx) {
        curKind = "video";
        curVideoFrameIdx = Number(idx);
        if (!(curVideoFrameIdx >= 1 && curVideoFrameIdx <= 3)) return;
        if (lbVideo) {
          try { lbVideo.pause(); } catch (e) {}
          lbVideo.style.display = "none";
        }
        if (lbImg) lbImg.style.display = "";
        // default mode: view (allow "–†–∞–∑–º–µ—Ç–∏—Ç—å")
        lbMode.textContent = "–ø—Ä–æ—Å–º–æ—Ç—Ä";
        if (lbAnnotate) lbAnnotate.style.display = "";
        lbClear.style.display = "none";
        lbSave.style.display = "none";
        drawEnabled = false;
        lbCanvas.classList.remove("draw-on");

        await _ensureVideoFramesLoaded().catch(() => ({ frames: [] }));
        const fr = _videoFrameObj(curVideoFrameIdx);
        curAutoRects = [];
        curManualRects = Array.isArray(fr.rects) ? fr.rects.map(r => ({ x:Number(r.x||0), y:Number(r.y||0), w:Number(r.w||0), h:Number(r.h||0) })) : [];

        const frameUrl = `/api/faces/video-frame?pipeline_run_id=${encodeURIComponent(String(pipelineRunId))}&path=${encodeURIComponent(curPath)}&frame_idx=${encodeURIComponent(String(curVideoFrameIdx))}`;
        lbImg.referrerPolicy = "no-referrer";
        lbImg.draggable = false;
        lbImg.src = frameUrl;
        await new Promise((resolve) => {
          if (lbImg.complete) return resolve();
          lbImg.onload = () => resolve();
          lbImg.onerror = () => resolve();
        });
        renderRectList();
        drawOverlay();
      }

      async function openVideoViewer(path, src) {
        curKind = "video";
        curPath = path;
        curVideoSrc = src || "";
        curSrc = ""; // img preview is not used
        lbPath.textContent = path;
        if (lbTabs) lbTabs.style.display = "";

        lb.classList.add("open");
        lb.setAttribute("aria-hidden","false");

        curVideoFrames = null;
        await _ensureVideoFramesLoaded().catch(() => ({ frames: [] }));
        _lbTabSetActive(lbTabVideo);
        await _showVideoTab();
      }

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ "–ø—Ä–æ—Å–º–æ—Ç—Ä" -> "—Ä–∞–∑–º–µ—Ç–∫–∞" –ø—Ä—è–º–æ –≤ –º–æ–¥–∞–ª–∫–µ
      if (lbAnnotate) {
        lbAnnotate.onclick = async () => {
          if (!curPath) return;
          // –î–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –Ω—É–∂–µ–Ω src. –î–ª—è –≤–∏–¥–µ–æ-–∫–∞–¥—Ä–æ–≤ src = /api/faces/video-frame..., –æ–Ω —É–∂–µ —Å—Ç–æ–∏—Ç –≤ lbImg.
          if (curKind === "image" && !curSrc) return;
          // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–≤–∫–ª—é—á–∞–µ–º UI-—Ñ–ª–∞–≥–∏, –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ curAutoRects/curManualRects
          lbMode.textContent = "—Ä–∞–∑–º–µ—Ç–∫–∞";
          lbClear.style.display = "";
          lbSave.style.display = "";
          lbAnnotate.style.display = "none";
          drawEnabled = true;
          lbCanvas.classList.add("draw-on");
          drawOverlay();
          setToast("–†–µ–∂–∏–º —Ä–∞–∑–º–µ—Ç–∫–∏: –ø–æ—Ç—è–Ω–∏ –º—ã—à—å—é –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫.");
        };
      }

      function screenToNatural(pt) {
        const iw = lbImg.naturalWidth || 1;
        const ih = lbImg.naturalHeight || 1;
        const sx = iw / (lbImg.clientWidth || 1);
        const sy = ih / (lbImg.clientHeight || 1);
        return { x: pt.x * sx, y: pt.y * sy };
      }

      function getLocalPoint(e) {
        const rect = lbImg.getBoundingClientRect();
        const x = Math.max(0, Math.min(rect.width, e.clientX - rect.left));
        const y = Math.max(0, Math.min(rect.height, e.clientY - rect.top));
        return { x, y };
      }

      function enableDrawingHandlers() {
        lbCanvas.onmousedown = (e) => {
          if (!drawEnabled) return;
          if (!(e instanceof MouseEvent)) return;
          e.preventDefault();
          dragging = true;
          dragStart = getLocalPoint(e);
          tempRect = null;
        };
        lbCanvas.onmousemove = (e) => {
          if (!drawEnabled || !dragging || !dragStart) return;
          e.preventDefault();
          const p = getLocalPoint(e);
          const x0 = Math.min(dragStart.x, p.x);
          const y0 = Math.min(dragStart.y, p.y);
          const w0 = Math.abs(dragStart.x - p.x);
          const h0 = Math.abs(dragStart.y - p.y);
          const n0 = screenToNatural({ x: x0, y: y0 });
          const n1 = screenToNatural({ x: x0 + w0, y: y0 + h0 });
          tempRect = { x: Math.round(n0.x), y: Math.round(n0.y), w: Math.round(n1.x - n0.x), h: Math.round(n1.y - n0.y) };
          drawOverlay();
        };
        lbCanvas.onmouseup = (e) => {
          if (!drawEnabled || !dragging) return;
          e.preventDefault();
          dragging = false;
          if (tempRect && tempRect.w >= 8 && tempRect.h >= 8) {
            curManualRects.push(tempRect);
            tempRect = null;
            renderRectList();
          } else {
            tempRect = null;
          }
          drawOverlay();
        };
      }
      enableDrawingHandlers();

      lbClear.onclick = () => {
        curManualRects = [];
        tempRect = null;
        renderRectList();
        drawOverlay();
      };
      lbSave.onclick = async () => {
        try {
          const savedPath = curPath;
          if (curKind === "video" && curVideoFrameIdx >= 1 && curVideoFrameIdx <= 3) {
            const fr = _videoFrameObj(curVideoFrameIdx);
            await postJson("/api/faces/video-manual-frame", {
              pipeline_run_id: Number(pipelineRunId),
              path: curPath,
              frame_idx: Number(curVideoFrameIdx),
              t_sec: fr?.t_sec ?? null,
              rects: curManualRects
            });
          } else {
            await postJson("/api/faces/manual-rectangles", { pipeline_run_id: Number(pipelineRunId), path: curPath, rects: curManualRects });
          }
          closeLb();
          // –ù–∞ –≤–∫–ª–∞–¥–∫–µ "–ù–µ—Ç –ª–∏—Ü" —ç—Ç–æ –ø–æ—Ç–æ–∫–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–ª–∂–Ω–∞ —É–π—Ç–∏ –≤ "–ï—Å—Ç—å –ª–∏—Ü–∞" –±–µ–∑ –ø—Ä—ã–∂–∫–æ–≤ —Å–ø–∏—Å–∫–∞.
          if (tab === "no_faces") {
            removeCardByPath(savedPath);
          }
          await refreshTabCounts();
          setToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.");
        } catch (e) {
          setToast(e?.message || String(e), true);
        }
      };

      async function openAnnotate(path, src) {
        if (!src) { setToast("–ù–µ—Ç –ø—Ä–µ–≤—å—é –¥–ª—è —Ä–∞–∑–º–µ—Ç–∫–∏", true); return; }
        await openViewer(path, src, { mode: "annotate" });
      }

      // video tabs
      try {
        if (lbTabVideo) lbTabVideo.onclick = async () => { _lbTabSetActive(lbTabVideo); await _showVideoTab(); };
        if (lbTabF1) lbTabF1.onclick = async () => { _lbTabSetActive(lbTabF1); await _showVideoFrame(1); };
        if (lbTabF2) lbTabF2.onclick = async () => { _lbTabSetActive(lbTabF2); await _showVideoFrame(2); };
        if (lbTabF3) lbTabF3.onclick = async () => { _lbTabSetActive(lbTabF3); await _showVideoFrame(3); };
      } catch (e) {}

      // init from query
      const rid = getParam("pipeline_run_id");
      if (rid && /^\d+$/.test(rid)) pipelineRunId = Number(rid);
      qs("#prId").textContent = pipelineRunId != null ? String(pipelineRunId) : "‚Äî";
      // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –∫–Ω–æ–ø–∫–∏ "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–∏"
      const btnSort = qs("#btnSortIntoFolders");
      if (btnSort) {
        if (pipelineRunId != null) {
          btnSort.disabled = false;
          btnSort.style.display = "";
        } else {
          btnSort.disabled = true;
          btnSort.title = "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–∏ (—Ç—Ä–µ–±—É–µ—Ç—Å—è pipeline_run_id)";
        }
      }
      applyTabUI();
      updateUrlParams();
      // open video modal directly (used by /gold "–ö–∞–¥—Ä—ã" button)
      try {
        const ovp = getParam("open_video_path");
        if (ovp && pipelineRunId != null && String(ovp).startsWith("local:")) {
          const src = `/api/local/preview?path=${encodeURIComponent(String(ovp))}&pipeline_run_id=${encodeURIComponent(String(pipelineRunId))}`;
          // small delay so modal elements are ready
          setTimeout(() => { openVideoViewer(String(ovp), src).catch(() => {}); }, 50);
        }
      } catch (e) {}
      // wire no_faces filters
      try {
        if (nfFrom) qs("#nfFrom").value = nfFrom;
        if (nfTo) qs("#nfTo").value = nfTo;
        qs("#btnNfApply").onclick = () => {
          nfFrom = (qs("#nfFrom")?.value || "").toString().trim() || null;
          nfTo = (qs("#nfTo")?.value || "").toString().trim() || null;
          updateUrlParams();
          page = 1;
          load(true);
        };
        qs("#btnNfClear").onclick = () => {
          nfFrom = null;
          nfTo = null;
          if (qs("#nfFrom")) qs("#nfFrom").value = "";
          if (qs("#nfTo")) qs("#nfTo").value = "";
          updateUrlParams();
          page = 1;
          load(true);
        };
      } catch (e) {}
      // sentinel for infinite scroll
      const sentinel = document.createElement("div");
      sentinel.id = "sentinel";
      sentinel.className = "muted";
      sentinel.style.padding = "18px 0";
      sentinel.textContent = "‚Ä¶";
      qs("#grid").after(sentinel);
      const io = new IntersectionObserver((entries) => {
        const e = entries && entries[0];
        if (e && e.isIntersecting) {
          if (!loading && hasMore) {
            page += 1;
            load(false);
          }
        }
      }, { root: null, rootMargin: "800px 0px", threshold: 0.01 });
      io.observe(sentinel);

      refreshTabCounts();
      load(true);

      // Undo (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏–π)
      qs("#btnUndo").onclick = async () => {
        if (!window.__undoStack || window.__undoStack.length === 0) return;
        const st = window.__undoStack.pop(); // –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ
        if (!st || !st.path) {
          if (window.__undoStack.length === 0) {
            qs("#btnUndo").style.display = "none";
          }
          return;
        }
        try {
          qs("#btnUndo").disabled = true;
          if (st.action === "delete") {
            // –û—Ç–∫–∞—Ç —É–¥–∞–ª–µ–Ω–∏—è: –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∞–π–ª –∏–∑ _delete
            const undoData = st.undo_data;
            if (!undoData || !undoData.delete_path || !undoData.original_path) {
              setToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–∫–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∏—è", true);
              return;
            }
            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Ñ–∞–π–ª –æ–±—Ä–∞—Ç–Ω–æ
            const res = await postJson("/api/faces/restore-from-delete", {
              pipeline_run_id: Number(pipelineRunId),
              delete_path: undoData.delete_path,
              original_path: undoData.original_path,
              original_name: undoData.original_name,
              original_parent_path: undoData.original_parent_path,
            });
            if (res.ok) {
              // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ manual labels
              await postJson("/api/faces/manual-label", {
                pipeline_run_id: Number(pipelineRunId),
                path: undoData.original_path,
                label: "",
              });
              // –ó–∞—Ç–µ–º –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º manual labels –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
              if (undoData.original_people_no_face_manual) {
                await postJson("/api/faces/manual-label", {
                  pipeline_run_id: Number(pipelineRunId),
                  path: undoData.original_path,
                  label: "people_no_face",
                  person: undoData.original_people_no_face_person || "",
                });
              } else if (undoData.original_faces_manual_label) {
                await postJson("/api/faces/manual-label", {
                  pipeline_run_id: Number(pipelineRunId),
                  path: undoData.original_path,
                  label: undoData.original_faces_manual_label,
                });
              }
              if (undoData.original_quarantine_manual) {
                await postJson("/api/faces/manual-label", {
                  pipeline_run_id: Number(pipelineRunId),
                  path: undoData.original_path,
                  label: "quarantine",
                });
              }
              if (undoData.original_animals_manual) {
                await postJson("/api/faces/manual-label", {
                  pipeline_run_id: Number(pipelineRunId),
                  path: undoData.original_path,
                  label: "cat",
                });
              }
              setToast("Undo: —Ñ–∞–π–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ _delete.");
            } else {
              setToast(`–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ${res.detail || "unknown"}`, true);
            }
          } else if (st.action === "manual_label") {
            // –û—Ç–∫–∞—Ç manual label
            const payload = { pipeline_run_id: Number(pipelineRunId), path: String(st.path), label: String(st.prev_label || "") };
            if (String(st.prev_label || "") === "people_no_face" && st.prev_person) {
              payload.person = String(st.prev_person);
            }
            await postJson("/api/faces/manual-label", payload);
            setToast("Undo: –æ—Ç–∫–∞—Ç–∏–ª –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ.");
          }
          if (window.__undoStack.length === 0) {
            qs("#btnUndo").style.display = "none";
          }
          await refreshTabCounts();
          await load(true);
        } catch (e) {
          setToast(e?.message || String(e), true);
        } finally {
          qs("#btnUndo").disabled = false;
        }
      };

      // Sort into folders
      qs("#btnSortIntoFolders").onclick = async () => {
        if (pipelineRunId == null) {
          setToast("pipeline_run_id –Ω–µ –∑–∞–¥–∞–Ω", true);
          return;
        }
        if (!confirm("–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º?\n\n–®–∞–≥ 1: _non_media, _broken_media\n–®–∞–≥ 3: _faces, _quarantine, _animals, _people_no_face, _no_faces\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç —Ñ–∞–π–ª—ã –Ω–∞ YaDisk (–∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ) –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–∞–ø–∫–∏.")) {
          return;
        }
        try {
          qs("#btnSortIntoFolders").disabled = true;
          setToast("–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤...");
          const payload = { pipeline_run_id: Number(pipelineRunId), dry_run: false };
          const resp = await postJson("/api/faces/sort-into-folders", payload);
          if (resp.ok) {
            const moved = resp.moved_count || 0;
            const errors = resp.errors || [];
            if (errors.length > 0) {
              setToast(`–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ: ${moved}, –æ—à–∏–±–æ–∫: ${errors.length}`, true);
              console.error("Sort errors:", errors);
            } else {
              setToast(`–£—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${moved}`);
            }
            await refreshTabCounts();
            await load(true);
          } else {
            setToast("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ", true);
          }
        } catch (e) {
          setToast(e?.message || String(e), true);
        } finally {
          qs("#btnSortIntoFolders").disabled = false;
        }
      };
    </script>
  </body>
</html>


