<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <meta name="referrer" content="no-referrer" />
    <title>PhotoSorter ‚Äî –°–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω</title>
    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      a { color: #0b57d0; text-decoration: none; }
      a:hover { text-decoration: underline; }
      code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
      .muted { color: #6b7280; }
      .wrap { max-width: 1400px; }
      .header { display:flex; align-items:baseline; justify-content:space-between; gap:12px; margin-bottom:20px; }
      table { border-collapse: collapse; width: 100%; max-width: 1400px; margin-top: 14px; }
      th, td { border-bottom: 1px solid #e5e7eb; padding: 12px 10px; vertical-align: middle; text-align: left; }
      th { font-weight: 600; color: #111827; background: #fafafa; position: sticky; top: 0; }
      tr:hover { background: #f9fafb; }
      .person-avatar { width: 48px; height: 48px; border-radius:50%; object-fit:cover; border:2px solid #e5e7eb; }
      .person-avatar-placeholder { width: 48px; height: 48px; border-radius:50%; background:#e5e7eb; display:flex; align-items:center; justify-content:center; font-size:20px; color:#6b7280; }
      .person-name { font-weight: 600; }
      .person-name-link { color: #0b57d0; text-decoration: none; }
      .person-name-link:hover { text-decoration: underline; }
      .person-name.ignored { color: #6b7280; opacity: 0.7; }
      .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #f3f4f6; color: #374151; font-size: 12px; }
      .pill-link { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #e0f2fe; color: #0369a1; font-size: 12px; text-decoration: none; cursor: pointer; transition: all 0.2s; }
      .pill-link:hover { background: #bae6fd; color: #075985; text-decoration: none; transform: scale(1.05); }
      .btn { appearance:none; border:1px solid #d1d5db; background:#fff; padding:8px 16px; border-radius:10px; cursor:pointer; font-weight:600; font-size:14px; }
      .btn:hover { background:#f9fafb; }
      .btn:disabled { opacity: 0.6; cursor: not-allowed; }
      .btn.primary { background:#111827; color:#fff; border-color:#111827; }
      .btn.primary:hover { background:#374151; }
      .toast { color:#6b7280; font-size:14px; margin-left:12px; }
      .toast.success { color:#059669; }
      .toast.error { color:#dc2626; }
      .loading { opacity: 0.6; pointer-events: none; }
      .empty { text-align: center; padding: 40px; color: #6b7280; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <div>
          <h2 style="margin: 0;">–°–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω</h2>
          <div class="muted" style="margin-top: 6px;">–í—Å–µ –ø–µ—Ä—Å–æ–Ω—ã —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –∏ –ª–∏—Ü</div>
        </div>
        <div style="display:flex; align-items:center; gap:12px;">
          <button class="btn primary" id="btnSaveAllToGold" type="button" style="padding:6px 12px; font-size:14px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –≤ gold</button>
          <span class="toast" id="toast"></span>
          <span style="color:#6b7280;">¬∑</span>
          <a href="/face-clusters">–Ω–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ</a> ¬∑ <a href="/">‚Üê –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </div>
      </div>

      <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <div id="error" style="display: none; color: #991b1b; padding: 12px; background: #fff5f5; border: 1px solid #fecaca; border-radius: 12px; margin-top: 12px;"></div>
      <table id="personsTable" style="display: none;">
        <thead>
          <tr>
            <th>–ê–≤–∞—Ç–∞—Ä</th>
            <th>–ò–º—è</th>
            <th style="text-align: right;">–ö–ª–∞—Å—Ç–µ—Ä—ã</th>
            <th style="text-align: right;">–ß–µ—Ä–µ–∑ –ª–∏—Ü–∞</th>
            <th style="text-align: right;">–ß–µ—Ä–µ–∑ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏</th>
            <th style="text-align: right;">–ü—Ä—è–º–∞—è –ø—Ä–∏–≤—è–∑–∫–∞</th>
          </tr>
        </thead>
        <tbody id="personsTableBody">
        </tbody>
      </table>
      <div id="empty" class="empty" style="display: none;">–ù–µ—Ç –ø–µ—Ä—Å–æ–Ω</div>
    </div>

    <script>
      function escapeHtml(s) {
        return (s ?? "").toString()
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll("\"", "&quot;")
          .replaceAll("'", "&#039;");
      }

      function formatArchiveRunLinks(archiveCount, runCount, totalCount, archiveLink, runLink, archiveTitle, runTitle) {
        // –ï—Å–ª–∏ runLink –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –∏–ª–∏ —Ä–∞–≤–µ–Ω archiveLink, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–Ω—É —Å—Å—ã–ª–∫—É –¥–ª—è –æ–±–æ–∏—Ö
        if (!runLink || (typeof runLink === 'string' && runLink === archiveLink)) {
          // –û–¥–∏–Ω–∞–∫–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –æ–±–æ–∏—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤)
          if (totalCount > 0) {
            return `<a href="${archiveLink}" class="pill-link" title="${archiveTitle || '–ü–µ—Ä–µ–π—Ç–∏'}">${archiveCount} / ${runCount}</a>`;
          } else {
            return `<span class="pill">${archiveCount} / ${runCount}</span>`;
          }
        }
        
        // –†–∞–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è –∞—Ä—Ö–∏–≤–∞ –∏ –ø—Ä–æ–≥–æ–Ω–∞
        const archiveHtml = archiveCount > 0
          ? `<a href="${archiveLink}" class="pill-link" title="${archiveTitle || '–§–æ—Ç–æ–∞—Ä—Ö–∏–≤'}">${archiveCount}</a>`
          : `<span class="pill" style="opacity: 0.5;">${archiveCount}</span>`;
        
        const runHtml = runCount > 0
          ? `<a href="${runLink}" class="pill-link" title="${runTitle || '–°–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è'}">${runCount}</a>`
          : `<span class="pill" style="opacity: 0.5;">${runCount}</span>`;
        
        return `${archiveHtml} / ${runHtml}`;
      }

      async function getFaceThumbnail(faceId) {
        if (!faceId) return null;
        try {
          const resp = await fetch(`/api/face-rectangles/${faceId}/thumbnail`);
          if (resp.ok) {
            const data = await resp.json();
            return data.thumb_jpeg_base64 ? `data:image/jpeg;base64,${data.thumb_jpeg_base64}` : null;
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞:', e);
        }
        return null;
      }

      async function loadPersons() {
        const loadingEl = document.getElementById("loading");
        const errorEl = document.getElementById("error");
        const tableEl = document.getElementById("personsTable");
        const tableBodyEl = document.getElementById("personsTableBody");
        const emptyEl = document.getElementById("empty");

        try {
          const fetchStart = performance.now();
          const resp = await fetch("/api/persons/stats");
          const fetchTime = performance.now() - fetchStart;
          
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
          }
          const data = await resp.json();
          
          // –í—ã–≤–æ–¥–∏–º –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª—å (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å debug –¥–∞–Ω–Ω—ã–µ)
          if (data.debug && data.debug.metrics) {
            const metrics = data.debug.metrics;
            console.log("[api_persons_stats] Performance metrics:", {
              "Fetch time (ms)": fetchTime.toFixed(2),
              "Total server time (s)": metrics.total_time?.toFixed(3),
              "Step 1: Get persons (s)": metrics.step1_get_persons?.toFixed(3),
              "Step 2: Get clusters stats (s)": metrics.step2_get_clusters_stats?.toFixed(3),
              "Step 3: Get faces via clusters (s)": metrics.step3_get_faces_via_clusters?.toFixed(3),
              "Step 4: Get faces via manual (s)": metrics.step4_get_faces_via_manual?.toFixed(3),
              "Step 5: Get person rectangles (s)": metrics.step5_get_person_rectangles?.toFixed(3),
              "Step 6: Get file persons (s)": metrics.step6_get_file_persons?.toFixed(3),
              "Step 7: Build final list (s)": metrics.step7_build_final_list?.toFixed(3),
              "Avatar queries count": metrics.avatar_queries_count,
              "Persons count": data.persons?.length || 0,
            });
          }
          
          if (!data.persons || data.persons.length === 0) {
            loadingEl.style.display = "none";
            tableEl.style.display = "none";
            emptyEl.style.display = "block";
            return;
          }

          const persons = data.persons || [];
          
          // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω –ø–æ –≥—Ä—É–ø–ø–∞–º
          const groupedPersons = {};
          const noGroupPersons = [];
          
          for (const p of persons) {
            const groupName = p.group || null;
            if (groupName) {
              if (!groupedPersons[groupName]) {
                groupedPersons[groupName] = {
                  order: p.group_order || 999,
                  persons: []
                };
              }
              groupedPersons[groupName].persons.push(p);
            } else {
              noGroupPersons.push(p);
            }
          }
          
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≥—Ä—É–ø–ø—ã –ø–æ order
          const sortedGroups = Object.entries(groupedPersons).sort((a, b) => {
            return a[1].order - b[1].order;
          });
          
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã –ø–æ –∏–º–µ–Ω–∏
          for (const [groupName, groupData] of sortedGroups) {
            groupData.persons.sort((a, b) => {
              const nameA = (a.name || '').toLowerCase();
              const nameB = (b.name || '').toLowerCase();
              return nameA.localeCompare(nameB);
            });
          }
          
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω –±–µ–∑ –≥—Ä—É–ø–ø—ã –ø–æ –∏–º–µ–Ω–∏
          noGroupPersons.sort((a, b) => {
            const nameA = (a.name || '').toLowerCase();
            const nameB = (b.name || '').toLowerCase();
            return nameA.localeCompare(nameB);
          });
          
          // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π
          let html = '';
          
          // –†–µ–Ω–¥–µ—Ä–∏–º –≥—Ä—É–ø–ø—ã
          for (const [groupName, groupData] of sortedGroups) {
            html += `<tr class="group-header"><td colspan="6" style="background: #f3f4f6; font-weight: 700; padding: 16px 10px; border-bottom: 2px solid #d1d5db;">${escapeHtml(groupName)}</td></tr>`;
            
            for (const p of groupData.persons) {
              html += renderPersonRow(p);
            }
          }
          
          // –†–µ–Ω–¥–µ—Ä–∏–º –ø–µ—Ä—Å–æ–Ω –±–µ–∑ –≥—Ä—É–ø–ø—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
          if (noGroupPersons.length > 0) {
            html += `<tr class="group-header"><td colspan="6" style="background: #f3f4f6; font-weight: 700; padding: 16px 10px; border-bottom: 2px solid #d1d5db;">–ë–µ–∑ –≥—Ä—É–ø–ø—ã</td></tr>`;
            for (const p of noGroupPersons) {
              html += renderPersonRow(p);
            }
          }
          
          tableBodyEl.innerHTML = html;

          loadingEl.style.display = "none";
          errorEl.style.display = "none";
          tableEl.style.display = "table";
          emptyEl.style.display = "none";

          // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
          for (const p of persons) {
            if (p.avatar_face_id) {
              const row = tableBodyEl.querySelector(`tr[data-person-id="${p.id}"]`);
              const avatarCell = row?.querySelector('td');
              const placeholder = avatarCell?.querySelector('.person-avatar-placeholder[data-face-id]');
              
              if (placeholder) {
                try {
                  const avatarUrl = await getFaceThumbnail(p.avatar_face_id);
                  if (avatarUrl) {
                    const img = document.createElement('img');
                    img.src = avatarUrl;
                    img.alt = 'avatar';
                    img.className = 'person-avatar';
                    placeholder.replaceWith(img);
                  }
                } catch (e) {
                  console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä –¥–ª—è –ø–µ—Ä—Å–æ–Ω—ã ${p.name} (avatar_face_id=${p.avatar_face_id}):`, e);
                }
              }
            }
          }
        } catch (err) {
          loadingEl.style.display = "none";
          tableEl.style.display = "none";
          emptyEl.style.display = "none";
          errorEl.textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω: ${err.message}`;
          errorEl.style.display = "block";
        }
      }
      
      function renderPersonRow(p) {
        const isIgnored = p.is_ignored || false;
        const nameClass = isIgnored ? "person-name ignored" : "person-name";
        const nameHtml = `<a href="/persons/${p.id}" class="person-name-link ${nameClass}">${escapeHtml(p.name || `Person ${p.id}`)}</a>`;
        
        // –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ (–±—É–¥–µ—Ç –∑–∞–º–µ–Ω—ë–Ω –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏)
        const avatarPlaceholder = `<div class="person-avatar-placeholder" data-face-id="${p.avatar_face_id || ''}">üë§</div>`;
        
        // –ö–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞ –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –∏ –ª–∏—Ü (—Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ –∞—Ä—Ö–∏–≤ –∏ –ø—Ä–æ–≥–æ–Ω)
        const clustersCount = p.clusters_count || 0;
        const clustersCountArchive = p.clusters_count_archive || 0;
        const clustersCountRun = p.clusters_count_run || 0;
        
        const facesCount = p.faces_count || 0;
        const facesCountArchive = p.faces_count_archive || 0;
        const facesCountRun = p.faces_count_run || 0;
        
        // –†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Å–ø–æ—Å–æ–±–∞–º –ø—Ä–∏–≤—è–∑–∫–∏
        const facesViaClusters = p.faces_via_clusters || 0;
        const facesViaClustersArchive = p.faces_via_clusters_archive || 0;
        const facesViaClustersRun = p.faces_via_clusters_run || 0;
        const facesViaManual = p.faces_via_manual || 0;
        const facesViaManualArchive = p.faces_via_manual_archive || 0;
        const facesViaManualRun = p.faces_via_manual_run || 0;
        
        const personRectanglesCount = p.person_rectangles_files_count || 0;
        const personRectanglesCountArchive = p.person_rectangles_files_count_archive || 0;
        const personRectanglesCountRun = p.person_rectangles_files_count_run || 0;
        const filePersonsCount = p.file_persons_files_count || 0;
        const filePersonsCountArchive = p.file_persons_files_count_archive || 0;
        const filePersonsCountRun = p.file_persons_files_count_run || 0;
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã: —Ç–æ–ª—å–∫–æ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–∫–∞–∫ –≤ —ç—Ç–∞–ø–µ 2)
        const clustersHtml = clustersCount > 0 
          ? `<a href="/persons/${p.id}/clusters" class="pill-link" title="–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–ª–∞—Å—Ç–µ—Ä–∞–º">${clustersCount}</a>`
          : `<span class="pill">${clustersCount}</span>`;
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ª–∏—Ü–∞: 4 —Ä–∞–∑—Ä–µ–∑–∞ (–ê—Ä—Ö–∏–≤/–ü—Ä–æ–≥–æ–Ω √ó –ö–ª–∞—Å—Ç–µ—Ä—ã/–†—É—á–Ω—ã–µ) –∫–∞–∫ –≤ —ç—Ç–∞–ø–µ 2
        let facesHtml = '';
        if (facesCount > 0) {
          facesHtml = `<a href="/persons/${p.id}" class="pill-link" title="–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–∞—Ä—Ç–æ—á–∫–µ –ø–µ—Ä—Å–æ–Ω—ã">${facesCount}</a>`;
          // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–±–∏–≤–∫—É –ø–æ —Å–ø–æ—Å–æ–±–∞–º –ø—Ä–∏–≤—è–∑–∫–∏ (–∫–∞–∫ –≤ —ç—Ç–∞–ø–µ 2)
          const details = [];
          if (facesViaClusters > 0) {
            details.push(`–ö–ª–∞—Å—Ç–µ—Ä—ã: ${facesViaClusters} (${facesViaClustersArchive} –∞—Ä—Ö–∏–≤ / ${facesViaClustersRun} –ø—Ä–æ–≥–æ–Ω)`);
          }
          if (facesViaManual > 0) {
            details.push(`–†—É—á–Ω—ã–µ: ${facesViaManual} (${facesViaManualArchive} –∞—Ä—Ö–∏–≤ / ${facesViaManualRun} –ø—Ä–æ–≥–æ–Ω)`);
          }
          if (details.length > 0) {
            facesHtml += '<br/><span style="font-size: 11px; color: #6b7280;">' + details.join('<br/>') + '</span>';
          }
        } else {
          facesHtml = `<span class="pill">${facesCount}</span>`;
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∏: —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ê—Ä—Ö–∏–≤/–ü—Ä–æ–≥–æ–Ω
        let personRectanglesHtml = '';
        if (personRectanglesCount > 0) {
          personRectanglesHtml = `<span class="pill" title="–§–∞–π–ª–æ–≤ —Å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞–º–∏ –±–µ–∑ –ª–∏—Ü–∞">${personRectanglesCount}</span>`;
          // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–±–∏–≤–∫—É –ø–æ –∞—Ä—Ö–∏–≤—É/–ø—Ä–æ–≥–æ–Ω—É
          const details = [];
          if (personRectanglesCountArchive > 0 || personRectanglesCountRun > 0) {
            details.push(`${personRectanglesCountArchive} –∞—Ä—Ö–∏–≤ / ${personRectanglesCountRun} –ø—Ä–æ–≥–æ–Ω`);
          }
          if (details.length > 0) {
            personRectanglesHtml += '<br/><span style="font-size: 11px; color: #6b7280;">' + details.join('<br/>') + '</span>';
          }
        } else {
          personRectanglesHtml = `<span class="pill">${personRectanglesCount}</span>`;
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—Ä—è–º—É—é –ø—Ä–∏–≤—è–∑–∫—É: —Å —Ä–∞–∑–±–∏–≤–∫–æ–π –ê—Ä—Ö–∏–≤/–ü—Ä–æ–≥–æ–Ω
        let filePersonsHtml = '';
        if (filePersonsCount > 0) {
          filePersonsHtml = `<span class="pill" title="–§–∞–π–ª–æ–≤ —Å –ø—Ä—è–º–æ–π –ø—Ä–∏–≤—è–∑–∫–æ–π">${filePersonsCount}</span>`;
          // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–±–∏–≤–∫—É –ø–æ –∞—Ä—Ö–∏–≤—É/–ø—Ä–æ–≥–æ–Ω—É
          const details = [];
          if (filePersonsCountArchive > 0 || filePersonsCountRun > 0) {
            details.push(`${filePersonsCountArchive} –∞—Ä—Ö–∏–≤ / ${filePersonsCountRun} –ø—Ä–æ–≥–æ–Ω`);
          }
          if (details.length > 0) {
            filePersonsHtml += '<br/><span style="font-size: 11px; color: #6b7280;">' + details.join('<br/>') + '</span>';
          }
        } else {
          filePersonsHtml = `<span class="pill">${filePersonsCount}</span>`;
        }
        
        return `
          <tr ${isIgnored ? 'style="opacity: 0.7;"' : ""} data-person-id="${p.id}">
            <td>${avatarPlaceholder}</td>
            <td>${nameHtml}</td>
            <td style="text-align: right;">${clustersHtml}</td>
            <td style="text-align: right;">${facesHtml}</td>
            <td style="text-align: right;">${personRectanglesHtml}</td>
            <td style="text-align: right;">${filePersonsHtml}</td>
          </tr>
        `;
      }

      function showToast(message, isError = false) {
        const toastEl = document.getElementById('toast');
        if (!toastEl) return;
        toastEl.textContent = message;
        toastEl.className = isError ? 'toast error' : 'toast success';
        setTimeout(() => {
          toastEl.textContent = '';
          toastEl.className = 'toast';
        }, 5000);
      }

      async function saveAllToGold() {
        const btn = document.getElementById('btnSaveAllToGold');
        if (!btn) return;
        
        btn.disabled = true;
        btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        
        try {
          const resp = await fetch('/api/persons/save-all-to-gold', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
          });
          
          const data = await resp.json();
          if (!resp.ok) {
            throw new Error(data.detail || data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
          }
          
          showToast(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${data.persons_count} –ø–µ—Ä—Å–æ–Ω, ${data.faces_count} –ª–∏—Ü, ${data.files_updated} —Ñ–∞–π–ª–æ–≤`, false);
        } catch (e) {
          showToast(`–û—à–∏–±–∫–∞: ${e.message}`, true);
        } finally {
          btn.disabled = false;
          btn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –≤ gold';
        }
      }

      loadPersons();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–Ω–æ–ø–∫–∏
      document.getElementById('btnSaveAllToGold')?.addEventListener('click', saveAllToGold);
    </script>
  </body>
</html>