<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <title>PhotoSorter ‚Äî –ö–ª–∞—Å—Ç–µ—Ä—ã –ª–∏—Ü</title>
    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      a { color: #0b57d0; text-decoration: none; }
      a:hover { text-decoration: underline; }
      code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
      .muted { color: #6b7280; }
      .wrap { max-width: 1400px; }
      .header { display:flex; align-items:baseline; justify-content:space-between; gap:12px; }
      .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
      .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f4f6; color:#374151; font-size:12px; }
      .btn { appearance:none; border:1px solid #d1d5db; background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:700; }
      .btn:hover { background:#f9fafb; }
      .btn:disabled { opacity: 0.6; cursor: not-allowed; }
      .btn.primary { background:#111827; color:#fff; border-color:#111827; }
      .btn.primary:hover { background:#374151; }
      .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top: 12px; }
      .grid { display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }
      .person-group { margin-bottom: 24px; }
      .person-group-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; padding:12px; background:#f9fafb; border-radius:12px; }
      .person-group.ignored .person-group-header { background:#f3f4f6; opacity: 0.7; }
      .person-group.ignored .person-name { color:#6b7280; }
      .person-group.ignored .card { opacity: 0.8; border-color: #e5e7eb; }
      .person-avatar { width: 48px; height: 48px; border-radius:50%; object-fit:cover; border:2px solid #e5e7eb; }
      .person-avatar-placeholder { width: 48px; height: 48px; border-radius:50%; background:#e5e7eb; display:flex; align-items:center; justify-content:center; font-size:20px; color:#6b7280; }
      .person-name { font-size:18px; font-weight:700; }
      a.person-name { text-decoration:none; color:inherit; display:inline-block; }
      a.person-name:hover { text-decoration:underline !important; cursor:pointer; color:#0b57d0 !important; }
      .person-clusters-count { color:#6b7280; font-size:14px; }
      .card { width: 300px; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; background:#fff; }
      .card-header { padding: 10px 12px; background:#f9fafb; border-bottom: 1px solid #e5e7eb; }
      .card-body { padding: 10px 12px; }
      .thumb-grid { display:flex; gap:4px; flex-wrap:wrap; margin-top:8px; }
      .thumb { width: 60px; height: 60px; background:#fff; display:flex; align-items:center; justify-content:center; border:1px solid #e5e7eb; border-radius:6px; overflow:hidden; cursor: pointer; }
      .thumb img { width: 100%; height: 100%; object-fit: cover; }
      .thumb .noimg { color:#6b7280; font-size:10px; text-align:center; padding:4px; }
      .kv { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; font-size:12px; color:#374151; }
      .actions { display:flex; gap:8px; margin-top: 10px; flex-wrap: wrap; }
      .select { border:1px solid #d1d5db; border-radius:10px; padding:8px 10px; font-size:14px; }
      .input { border:1px solid #d1d5db; border-radius:10px; padding:8px 10px; font-size:14px; }
      .modal { position: fixed; inset: 0; background: rgba(17,24,39,0.82); display: none; align-items: center; justify-content: center; padding: 18px; z-index: 9999; }
      .modal.open { display: flex; }
      .modal-panel { background: #fff; border-radius: 14px; max-width: 94vw; max-height: 94vh; width: min(800px, 94vw); overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.35); }
      .modal-header { padding: 12px 16px; border-bottom: 1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; }
      .modal-body { padding: 16px; max-height: calc(94vh - 120px); overflow-y: auto; }
      .modal-footer { padding: 12px 16px; border-top: 1px solid #e5e7eb; display:flex; gap:10px; justify-content:flex-end; }
      .loading { opacity: 0.6; pointer-events: none; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <div>
          <h2 style="margin:0;">–ù–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã –ª–∏—Ü</h2>
          <div class="muted" style="margin-top:6px;">–ö–ª–∞—Å—Ç–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –ø–µ—Ä—Å–æ–Ω–µ. –ù–∞–∑–Ω–∞—á—å—Ç–µ –∏—Ö –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –ø–µ—Ä—Å–æ–Ω.</div>
        </div>
        <div class="muted">
          <a href="/persons">–ö —Å–ø–∏—Å–∫—É –ø–µ—Ä—Å–æ–Ω</a> ¬∑ <a href="/">‚Üê –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </div>
      </div>

      <div class="toolbar">
        <select class="select" id="selectRunId">
          <option value="">–í—Å–µ –ø—Ä–æ–≥–æ–Ω—ã</option>
        </select>
        <select class="select" id="selectScopeFilter">
          <option value="all">–í—Å–µ (–∞—Ä—Ö–∏–≤ + —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è)</option>
          <option value="archive">–¢–æ–ª—å–∫–æ –∞—Ä—Ö–∏–≤–Ω—ã–µ</option>
          <option value="run">–¢–æ–ª—å–∫–æ —Å–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ</option>
        </select>
        <button class="btn" id="btnReload" type="button">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn primary" id="btnCreatePerson" type="button">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω—É</button>
        <button class="btn" id="btnClusterize" type="button">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—é</button>
        <button class="btn" id="btnFindSuggestions" type="button">–ù–∞–π—Ç–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ —Å 1 –ª–∏—Ü–æ–º</button>
        <button class="btn" id="btnFindSimilarClusters" type="button">–ù–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–µ –æ–¥–∏–Ω–æ—á–Ω—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã</button>
        <span class="muted" id="toast"></span>
      </div>

      <div class="grid" id="clustersGrid"></div>
    </div>

    <!-- Modal –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω—ã -->
    <div class="modal" id="modalCreatePerson">
      <div class="modal-panel">
        <div class="modal-header">
          <h3 style="margin:0;">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω—É</h3>
          <button class="btn" type="button" onclick="closeModal('modalCreatePerson')">‚úï</button>
        </div>
        <div class="modal-body">
          <div style="margin-bottom:12px;">
            <label style="display:block; margin-bottom:4px; font-weight:700;">–ò–º—è:</label>
            <input type="text" class="input" id="inputPersonName" style="width:100%;" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–≥–∞—Ç–∞" />
          </div>
          <div style="margin-bottom:12px;">
            <label style="display:block; margin-bottom:4px; font-weight:700;">–†–µ–∂–∏–º:</label>
            <select class="select" id="selectPersonMode" style="width:100%;">
              <option value="active">active</option>
              <option value="deferred">deferred</option>
              <option value="never">never</option>
            </select>
          </div>
          <div style="margin-bottom:12px;">
            <label style="display:block; margin-bottom:4px; font-weight:700;">–†–æ–¥—Å—Ç–≤–æ:</label>
            <input type="text" class="input" id="inputPersonKinship" style="width:100%;" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¥–æ—á—å" />
          </div>
          <div>
            <label style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="checkboxIsMe" />
              <span>–≠—Ç–æ —è</span>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" type="button" onclick="closeModal('modalCreatePerson')">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn primary" type="button" onclick="createPerson()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Modal –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø–µ—Ä—Å–æ–Ω–µ -->
    <div class="modal" id="modalAssignPerson">
      <div class="modal-panel">
        <div class="modal-header">
          <h3 style="margin:0;">–ù–∞–∑–Ω–∞—á–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä –ø–µ—Ä—Å–æ–Ω–µ</h3>
          <button class="btn" type="button" onclick="closeModal('modalAssignPerson')">‚úï</button>
        </div>
        <div class="modal-body">
          <div>
            <label style="display:block; margin-bottom:4px; font-weight:700;">–ü–µ—Ä—Å–æ–Ω–∞:</label>
            <select class="select" id="selectAssignPerson" style="width:100%;">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω—É...</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" type="button" onclick="closeModal('modalAssignPerson')">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn primary" type="button" onclick="assignPerson()">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Modal –¥–ª—è –ø–æ—Ö–æ–∂–∏—Ö –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ -->
    <div class="modal" id="modalSimilarClusters">
      <div class="modal-panel" style="max-width: 90vw; width: min(1200px, 90vw);">
        <div class="modal-header">
          <h3 style="margin:0;">–ü–æ—Ö–æ–∂–∏–µ –æ–¥–∏–Ω–æ—á–Ω—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã</h3>
          <button class="btn" type="button" onclick="closeModal('modalSimilarClusters')">‚úï</button>
        </div>
        <div class="modal-body">
          <div id="similarClustersContent">
            <div class="muted" style="text-align: center; padding: 24px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Ö–æ–∂–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤...</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" type="button" onclick="closeModal('modalSimilarClusters')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Modal –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ —Å 1 –ª–∏—Ü–æ–º -->
    <div class="modal" id="modalSuggestions">
      <div class="modal-panel" style="max-width: 90vw; width: min(1200px, 90vw);">
        <div class="modal-header">
          <h3 style="margin:0;">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ —Å 1 –ª–∏—Ü–æ–º</h3>
          <button class="btn" type="button" onclick="closeModal('modalSuggestions')">‚úï</button>
        </div>
        <div class="modal-body">
          <div id="suggestionsContent">
            <div class="muted" style="text-align: center; padding: 24px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π...</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" type="button" onclick="closeModal('modalSuggestions')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>


    <script>
      let currentClusterId = null;
      let persons = [];
      let clusters = [];
      let runs = [];

      function showToast(msg, duration = 3000) {
        const el = document.getElementById("toast");
        el.textContent = msg;
        setTimeout(() => { el.textContent = ""; }, duration);
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("open");
      }

      function openModal(modalId) {
        document.getElementById(modalId).classList.add("open");
      }

      async function loadRuns() {
        try {
          const resp = await fetch("/api/face-runs/list");
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
          }
          const data = await resp.json();
          runs = data.runs || [];
          
          const select = document.getElementById("selectRunId");
          if (select) {
            select.innerHTML = '<option value="">–í—Å–µ –ø—Ä–æ–≥–æ–Ω—ã</option>';
            for (const run of runs) {
              const opt = document.createElement("option");
              opt.value = run.id;
              opt.textContent = `Run ${run.id}: ${run.root_path} (${run.faces_found} –ª–∏—Ü)`;
              select.appendChild(opt);
            }
          }
        } catch (e) {
          console.error('[loadRuns] –û—à–∏–±–∫–∞:', e);
          showToast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥–æ–Ω–æ–≤: ${e}`);
        }
      }

      async function loadPersons() {
        try {
          const resp = await fetch("/api/persons/list");
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
          }
          const data = await resp.json();
          persons = data.persons || [];
          
          console.log(`[loadPersons] –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–µ—Ä—Å–æ–Ω: ${persons.length}`);
          
          const select = document.getElementById("selectAssignPerson");
          if (select) {
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω—É...</option>';
            for (const person of persons) {
              const opt = document.createElement("option");
              opt.value = person.id;
              opt.textContent = person.name + (person.is_me ? " (—è)" : "");
              select.appendChild(opt);
            }
          }
        } catch (e) {
          console.error('[loadPersons] –û—à–∏–±–∫–∞:', e);
          showToast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω: ${e}`);
        }
      }

      async function loadClusters() {
        const grid = document.getElementById("clustersGrid");
        if (!grid) return;
        
        grid.innerHTML = '<div class="muted" style="padding: 24px; text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä—Å–æ–Ω –¥–ª—è –≤—ã–ø–∞–¥–∞—à–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        if (!persons || persons.length === 0) {
          await loadPersons();
        }
        
        const runId = document.getElementById("selectRunId").value;
        const scopeFilter = document.getElementById("selectScopeFilter").value;
        const params = ['unassigned_only=true', 'page_size=10000']; // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∫–ª–∞—Å—Ç–µ—Ä—ã —Å—Ä–∞–∑—É
        if (scopeFilter === 'archive') {
          params.push('archive_scope=archive');
        } else if (scopeFilter === 'run') {
          params.push('show_run_only=true');
        }
        if (runId) params.push(`run_id=${runId}`);
        const url = `/api/face-clusters/list?${params.join('&')}`;
        
        try {
          const resp = await fetch(url);
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
          }
          const data = await resp.json();
          clusters = data.clusters || [];
          
          console.log(`[loadClusters] –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: ${clusters.length}`);
          
          // –°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—É "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ"
          grid.innerHTML = "";
          
          // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –∞—Ä—Ö–∏–≤/–ø—Ä–æ–≥–æ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
          const archiveCount = clusters.filter(c => c.archive_scope === 'archive').length;
          const runCount = clusters.filter(c => c.archive_scope !== 'archive' && (c.run_id !== null && c.run_id !== undefined)).length;
          const countText = clusters.length > 0 && scopeFilter === 'all' && archiveCount > 0 && runCount > 0
            ? `${clusters.length} –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ (üì¶ ${archiveCount} –∞—Ä—Ö–∏–≤–Ω—ã—Ö, üîÑ ${runCount} —Å–æ—Ä—Ç–∏—Ä—É–µ–º—ã—Ö)`
            : `${clusters.length} –∫–ª–∞—Å—Ç–µ—Ä–æ–≤`;
          
          const unassignedDiv = document.createElement("div");
          unassignedDiv.className = "person-group";
          unassignedDiv.id = "person-group-unassigned";
          unassignedDiv.innerHTML = `
            <div class="person-group-header">
              <div class="person-avatar-placeholder">?</div>
              <div>
                <div class="person-name">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ</div>
                <div class="person-clusters-count">${countText}</div>
              </div>
            </div>
            <div class="grid" id="unassigned-clusters"></div>
          `;
          grid.appendChild(unassignedDiv);
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã
          if (clusters.length > 0) {
            await appendUnassignedClusters(clusters);
          } else {
            const unassignedGrid = document.getElementById("unassigned-clusters");
            if (unassignedGrid) {
              unassignedGrid.innerHTML = '<div class="muted" style="padding: 24px; text-align: center;">–ù–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>';
            }
          }
        } catch (e) {
          showToast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: ${e}`);
          grid.innerHTML = '<div class="muted" style="padding: 24px; text-align: center; color: #dc2626;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤</div>';
        }
      }

      async function getFaceThumbnail(faceId) {
        if (!faceId) return null;
        try {
          const resp = await fetch(`/api/face-rectangles/${faceId}/thumbnail`);
          if (resp.ok) {
            const data = await resp.json();
            return data.thumb_jpeg_base64 ? `data:image/jpeg;base64,${data.thumb_jpeg_base64}` : null;
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞:', e);
        }
        return null;
      }

      // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≥—Ä—É–ø–ø –¥–ª—è –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω –æ–¥–∏–Ω —Ä–∞–∑
      async function renderPersonGroups() {
        const grid = document.getElementById("clustersGrid");
        if (!grid) {
          console.error("clustersGrid –Ω–µ –Ω–∞–π–¥–µ–Ω!");
          return;
        }
        
        console.log(`[renderPersonGroups] –°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—ã –¥–ª—è ${(persons || []).length} –ø–µ—Ä—Å–æ–Ω, persons –º–∞—Å—Å–∏–≤:`, persons);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ persons –∑–∞–≥—Ä—É–∂–µ–Ω (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π, –Ω–æ –º–∞—Å—Å–∏–≤ –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å)
        if (!Array.isArray(persons)) {
          console.warn(`[renderPersonGroups] persons –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º, —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π:`, persons);
          persons = [];
        }
        
        // –†–∞–∑–¥–µ–ª—è–µ–º –ø–µ—Ä—Å–æ–Ω –Ω–∞ –æ–±—ã—á–Ω—ã–µ –∏ "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ"
        const regularPersons = (persons || []).filter(p => !p.is_ignored);
        const ignoredPerson = (persons || []).find(p => p.is_ignored);
        
        console.log(`[renderPersonGroups] –û–±—ã—á–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω: ${regularPersons.length}, –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö: ${ignoredPerson ? 1 : 0}`);
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –æ–±—ã—á–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω
        for (const person of regularPersons) {
          const groupDiv = document.createElement("div");
          groupDiv.className = "person-group";
          groupDiv.id = `person-group-${person.id}`;
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä –ø–µ—Ä—Å–æ–Ω—ã
          let avatarHtml = `<div class="person-avatar-placeholder">${person.name.charAt(0).toUpperCase()}</div>`;
          if (person.avatar_face_id) {
            try {
              const avatarUrl = await getFaceThumbnail(person.avatar_face_id);
              if (avatarUrl) {
                avatarHtml = `<img src="${avatarUrl}" alt="${person.name}" class="person-avatar" />`;
              }
            } catch (e) {
              console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞ –¥–ª—è –ø–µ—Ä—Å–æ–Ω—ã ${person.name}:`, e);
            }
          }
          
          groupDiv.innerHTML = `
            <div class="person-group-header">
              ${avatarHtml}
              <div>
                <a href="/persons/${person.id}" class="person-name">${person.name}</a>
                <div class="person-clusters-count">0 –∫–ª–∞—Å—Ç–µ—Ä–æ–≤, 0 –ª–∏—Ü</div>
              </div>
            </div>
            <div class="grid" id="person-${person.id}-clusters"></div>
          `;
          
          grid.appendChild(groupDiv);
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –≥—Ä—É–ø–ø—É "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ" - –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ–º, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–µ—Ä—Å–æ–Ω –Ω–µ—Ç
        const unassignedDiv = document.createElement("div");
        unassignedDiv.className = "person-group";
        unassignedDiv.id = "person-group-unassigned";
        unassignedDiv.innerHTML = `
          <div class="person-group-header">
            <div class="person-avatar-placeholder">?</div>
            <div>
              <div class="person-name">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ</div>
              <div class="person-clusters-count">0 –∫–ª–∞—Å—Ç–µ—Ä–æ–≤</div>
            </div>
          </div>
          <div class="grid" id="unassigned-clusters"></div>
        `;
        grid.appendChild(unassignedDiv);
        console.log(`[renderPersonGroups] –ì—Ä—É–ø–ø–∞ "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ" —Å–æ–∑–¥–∞–Ω–∞, id=${unassignedDiv.id}, DOM —ç–ª–µ–º–µ–Ω—Ç:`, unassignedDiv);
        
        // –†–µ–Ω–¥–µ—Ä–∏–º "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ" –≤ —Å–∞–º–æ–º –Ω–∏–∑—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if (ignoredPerson) {
          const ignoredDiv = document.createElement("div");
          ignoredDiv.className = "person-group ignored";
          ignoredDiv.id = `person-group-${ignoredPerson.id}`;
          ignoredDiv.innerHTML = `
            <div class="person-group-header">
              <div class="person-avatar-placeholder" style="font-size:24px;">üö´</div>
              <div>
                <a href="/persons/${ignoredPerson.id}" class="person-name">${ignoredPerson.name}</a>
                <div class="person-clusters-count">0 –∫–ª–∞—Å—Ç–µ—Ä–æ–≤, 0 –ª–∏—Ü</div>
              </div>
            </div>
            <div class="grid" id="person-${ignoredPerson.id}-clusters"></div>
          `;
          grid.appendChild(ignoredDiv);
        }
      }

      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã –≤ –≥—Ä—É–ø–ø—É "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ"
      async function appendUnassignedClusters(newClusters) {
        console.log(`[appendUnassignedClusters] –î–æ–±–∞–≤–ª—è–µ–º ${newClusters.length} –Ω–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤`);
        
        const groupElement = document.getElementById("person-group-unassigned");
        if (!groupElement) {
          console.error(`[appendUnassignedClusters] –ì—Ä—É–ø–ø–∞ "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!`);
          return;
        }
        
        const targetGrid = groupElement.querySelector("#unassigned-clusters");
        if (!targetGrid) {
          console.error(`[appendUnassignedClusters] #unassigned-clusters –Ω–µ –Ω–∞–π–¥–µ–Ω!`);
          return;
        }
        
        for (const cluster of newClusters) {
          const card = await createClusterCard(cluster, null);
          targetGrid.appendChild(card);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
        updateGroupCount(groupElement);
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≥—Ä—É–ø–ø—ã (—Å—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
      async function appendClustersToGroups(newClusters) {
        console.log(`[appendClustersToGroups] –î–æ–±–∞–≤–ª—è–µ–º ${newClusters.length} –∫–ª–∞—Å—Ç–µ—Ä–æ–≤, –ø–µ—Ä—Å–æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${persons.length}`);
        
        for (const cluster of newClusters) {
          const personId = cluster.person_id;
          const person = personId ? persons.find(p => p.id === personId) : null;
          
          let targetGrid = null;
          let groupElement = null;
          
          if (personId) {
            if (person?.is_ignored) {
              // –ì—Ä—É–ø–ø–∞ "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ"
              groupElement = document.getElementById(`person-group-${personId}`);
              targetGrid = groupElement?.querySelector(`#person-${personId}-clusters`);
            } else {
              // –û–±—ã—á–Ω–∞—è –ø–µ—Ä—Å–æ–Ω–∞
              groupElement = document.getElementById(`person-group-${personId}`);
              targetGrid = groupElement?.querySelector(`#person-${personId}-clusters`);
            }
          } else {
            // –ì—Ä—É–ø–ø–∞ "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ"
            groupElement = document.getElementById("person-group-unassigned");
            if (groupElement) {
              targetGrid = groupElement.querySelector("#unassigned-clusters");
              if (!targetGrid) {
                console.error(`[appendClustersToGroups] –ì—Ä—É–ø–ø–∞ "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ" –Ω–∞–π–¥–µ–Ω–∞ (id=${groupElement.id}), –Ω–æ #unassigned-clusters –Ω–µ –Ω–∞–π–¥–µ–Ω!`, groupElement);
              }
            } else {
              console.error(`[appendClustersToGroups] –ì—Ä—É–ø–ø–∞ "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ" (id=person-group-unassigned) –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DOM!`);
              // –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –≤–æ–æ–±—â–µ –µ—Å—Ç—å –≤ DOM
              const grid = document.getElementById("clustersGrid");
              if (grid) {
                const allGroups = grid.querySelectorAll('.person-group');
                console.error(`[appendClustersToGroups] –í DOM –Ω–∞–π–¥–µ–Ω–æ –≥—Ä—É–ø–ø: ${allGroups.length}, IDs:`, Array.from(allGroups).map(g => g.id));
              } else {
                console.error(`[appendClustersToGroups] clustersGrid –Ω–µ –Ω–∞–π–¥–µ–Ω!`);
              }
            }
          }
          
          if (!targetGrid) {
            console.warn(`[appendClustersToGroups] –ù–µ –Ω–∞–π–¥–µ–Ω–∞ targetGrid –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞ ${cluster.id}, personId=${personId}`);
            // –ï—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞–µ–º –µ—ë –Ω–∞ –ª–µ—Ç—É (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞ –ø–æ—è–≤–∏–ª–∞—Å—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø)
            if (personId && person) {
              // –ì—Ä—É–ø–ø–∞ –¥–ª—è –ø–µ—Ä—Å–æ–Ω—ã –¥–æ–ª–∂–Ω–∞ –±—ã–ª–∞ –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–∞ –≤ renderPersonGroups
              console.warn(`[appendClustersToGroups] –ü–µ—Ä—Å–æ–Ω–∞ ${personId} –Ω–µ –∏–º–µ–µ—Ç –≥—Ä—É–ø–ø—ã, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);
            } else if (!personId) {
              // –ì—Ä—É–ø–ø–∞ "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ" –¥–æ–ª–∂–Ω–∞ –≤—Å–µ–≥–¥–∞ –±—ã—Ç—å - —Å–æ–∑–¥–∞–µ–º –µ—ë –Ω–∞ –ª–µ—Ç—É, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
              console.warn(`[appendClustersToGroups] –ì—Ä—É–ø–ø–∞ "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞–µ–º –Ω–∞ –ª–µ—Ç—É`);
              const grid = document.getElementById("clustersGrid");
              if (grid) {
                const unassignedDiv = document.createElement("div");
                unassignedDiv.className = "person-group";
                unassignedDiv.id = "person-group-unassigned";
                unassignedDiv.innerHTML = `
                  <div class="person-group-header">
                    <div class="person-avatar-placeholder">?</div>
                    <div>
                      <div class="person-name">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ</div>
                      <div class="person-clusters-count">0 –∫–ª–∞—Å—Ç–µ—Ä–æ–≤</div>
                    </div>
                  </div>
                  <div class="grid" id="unassigned-clusters"></div>
                `;
                // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –≥—Ä—É–ø–ø–æ–π "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ" –∏–ª–∏ –≤ –∫–æ–Ω–µ—Ü
                const ignoredGroup = grid.querySelector('.person-group.ignored');
                if (ignoredGroup) {
                  grid.insertBefore(unassignedDiv, ignoredGroup);
                } else {
                  grid.appendChild(unassignedDiv);
                }
                groupElement = unassignedDiv;
                targetGrid = unassignedDiv.querySelector("#unassigned-clusters");
                console.log(`[appendClustersToGroups] –ì—Ä—É–ø–ø–∞ "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ" —Å–æ–∑–¥–∞–Ω–∞ –Ω–∞ –ª–µ—Ç—É`);
              }
            }
            
            if (!targetGrid) {
              console.error(`[appendClustersToGroups] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å/–Ω–∞–π—Ç–∏ targetGrid –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞ ${cluster.id}, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);
              continue;
            }
          }
          
          const card = await createClusterCard(cluster, person);
          targetGrid.appendChild(card);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –≥—Ä—É–ø–ø—ã
          updateGroupCount(groupElement);
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –≥—Ä—É–ø–ø—ã
      function updateGroupCount(groupElement) {
        const grid = groupElement?.querySelector('.grid');
        const countElement = groupElement?.querySelector('.person-clusters-count');
        if (!grid || !countElement) return;
        
        const count = grid.children.length;
        const personName = groupElement.querySelector('.person-name')?.textContent?.trim();
        
        if (personName === '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ') {
          countElement.textContent = `${count} –∫–ª–∞—Å—Ç–µ—Ä${count === 1 ? '' : count < 5 ? '–∞' : '–æ–≤'}`;
        } else {
          const totalFaces = Array.from(grid.querySelectorAll('.card')).reduce((sum, card) => {
            const facesText = card.querySelector('.muted')?.textContent?.match(/(\d+)\s+–ª–∏—Ü/)?.[1];
            return sum + (parseInt(facesText) || 0);
          }, 0);
          countElement.textContent = `${count} –∫–ª–∞—Å—Ç–µ—Ä${count === 1 ? '' : count < 5 ? '–∞' : '–æ–≤'}, ${totalFaces} –ª–∏—Ü`;
        }
      }

      async function renderClusters() {
        const grid = document.getElementById("clustersGrid");
        grid.innerHTML = "";
        
        if (clusters.length === 0) {
          grid.innerHTML = '<div class="muted">–ö–ª–∞—Å—Ç–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è –ø—Ä–æ–≥–æ–Ω–∞.</div>';
          return;
        }
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã –ø–æ –ø–µ—Ä—Å–æ–Ω–µ
        const clustersByPerson = new Map();
        const unassignedClusters = [];
        
        for (const cluster of clusters) {
          const personId = cluster.person_id;
          if (personId) {
            if (!clustersByPerson.has(personId)) {
              clustersByPerson.set(personId, []);
            }
            clustersByPerson.get(personId).push(cluster);
          } else {
            unassignedClusters.push(cluster);
          }
        }
        
        // –†–∞–∑–¥–µ–ª—è–µ–º –ø–µ—Ä—Å–æ–Ω –Ω–∞ –æ–±—ã—á–Ω—ã–µ –∏ "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ"
        const regularPersons = [];
        const ignoredPerson = [];
        
        for (const [personId, personClusters] of clustersByPerson.entries()) {
          const person = persons.find(p => p.id === personId);
          if (!person) continue;
          
          if (person.is_ignored) {
            ignoredPerson.push({ personId, personClusters, person });
          } else {
            regularPersons.push({ personId, personClusters, person });
          }
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –æ–±—ã—á–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω
        for (const { personId, personClusters, person } of regularPersons) {
          const groupDiv = document.createElement("div");
          groupDiv.className = "person-group";
          
          const totalFaces = personClusters.reduce((sum, c) => sum + c.faces_count, 0);
          
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–≤–∞—Ç–∞—Ä –ø–µ—Ä—Å–æ–Ω—ã
          let avatarHtml = `<div class="person-avatar-placeholder">${person.name.charAt(0).toUpperCase()}</div>`;
          if (person.avatar_face_id) {
            try {
              const avatarUrl = await getFaceThumbnail(person.avatar_face_id);
              if (avatarUrl) {
                avatarHtml = `<img src="${avatarUrl}" alt="${person.name}" class="person-avatar" />`;
              } else {
                console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä –¥–ª—è –ø–µ—Ä—Å–æ–Ω—ã ${person.name} (avatar_face_id=${person.avatar_face_id})`);
              }
            } catch (e) {
              console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞ –¥–ª—è –ø–µ—Ä—Å–æ–Ω—ã ${person.name}:`, e);
            }
          }
          // –£ –ø–µ—Ä—Å–æ–Ω—ã –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å avatar_face_id - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
          
          groupDiv.innerHTML = `
            <div class="person-group-header">
              ${avatarHtml}
              <div>
                <a href="/persons/${personId}" class="person-name">${person.name}</a>
                <div class="person-clusters-count">${personClusters.length} –∫–ª–∞—Å—Ç–µ—Ä${personClusters.length === 1 ? '' : personClusters.length < 5 ? '–∞' : '–æ–≤'}, ${totalFaces} –ª–∏—Ü</div>
              </div>
            </div>
            <div class="grid" id="person-${personId}-clusters"></div>
          `;
          
          grid.appendChild(groupDiv);
          
          const personGrid = groupDiv.querySelector(`#person-${personId}-clusters`);
          for (const cluster of personClusters) {
            const card = await createClusterCard(cluster, person);
            personGrid.appendChild(card);
          }
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –Ω–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã (–ø–µ—Ä–µ–¥ "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ")
        if (unassignedClusters.length > 0) {
          const unassignedDiv = document.createElement("div");
          unassignedDiv.className = "person-group";
          unassignedDiv.innerHTML = `
            <div class="person-group-header">
              <div class="person-avatar-placeholder">?</div>
              <div>
                <div class="person-name">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ</div>
                <div class="person-clusters-count">${unassignedClusters.length} –∫–ª–∞—Å—Ç–µ—Ä${unassignedClusters.length === 1 ? '' : unassignedClusters.length < 5 ? '–∞' : '–æ–≤'}</div>
              </div>
            </div>
            <div class="grid" id="unassigned-clusters"></div>
          `;
          grid.appendChild(unassignedDiv);
          
          const unassignedGrid = unassignedDiv.querySelector("#unassigned-clusters");
          for (const cluster of unassignedClusters) {
            const card = await createClusterCard(cluster, null);
            unassignedGrid.appendChild(card);
          }
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–º "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ" –≤ —Å–∞–º–æ–º –Ω–∏–∑—É (–ø–æ—Å–ª–µ –Ω–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö)
        for (const { personId, personClusters, person } of ignoredPerson) {
          const groupDiv = document.createElement("div");
          groupDiv.className = "person-group ignored";
          
          const totalFaces = personClusters.reduce((sum, c) => sum + c.faces_count, 0);
          
          // –ò–∫–æ–Ω–∫–∞ –≤–º–µ—Å—Ç–æ –∞–≤–∞—Ç–∞—Ä–∞ –¥–ª—è "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ"
          const avatarHtml = `<div class="person-avatar-placeholder" style="font-size:24px;">üö´</div>`;
          
          groupDiv.innerHTML = `
            <div class="person-group-header">
              ${avatarHtml}
              <div>
                <a href="/persons/${personId}" class="person-name">${person.name}</a>
                <div class="person-clusters-count">${personClusters.length} –∫–ª–∞—Å—Ç–µ—Ä${personClusters.length === 1 ? '' : personClusters.length < 5 ? '–∞' : '–æ–≤'}, ${totalFaces} –ª–∏—Ü</div>
              </div>
            </div>
            <div class="grid" id="person-${personId}-clusters"></div>
          `;
          
          grid.appendChild(groupDiv);
          
          const personGrid = groupDiv.querySelector(`#person-${personId}-clusters`);
          for (const cluster of personClusters) {
            const card = await createClusterCard(cluster, person);
            personGrid.appendChild(card);
          }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π" –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –Ω–∞ #clustersGrid –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        
      }
      
      function attachClusterActionHandlers() {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ #clustersGrid
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
        // –ù–µ –Ω—É–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–∑ - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–∂–µ –µ—Å—Ç—å
      }
      
      async function updateSingleClusterInDOM(clusterId, updatedClusters) {
        // –ù–∞—Ö–æ–¥–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä –≤ –Ω–æ–≤–æ–º —Å–ø–∏—Å–∫–µ
        const updatedCluster = updatedClusters.find(c => c.id === clusterId);
        if (!updatedCluster) {
          // –ï—Å–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–µ—Å—å —Å–ø–∏—Å–æ–∫
          clusters = updatedClusters;
          await renderClusters();
          return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Ç–µ—Ä –≤ –º–∞—Å—Å–∏–≤–µ
        const clusterIndex = clusters.findIndex(c => c.id === clusterId);
        if (clusterIndex !== -1) {
          clusters[clusterIndex] = updatedCluster;
        }
        
        // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤ DOM
        const cardElement = document.querySelector(`[id="assign-select-${clusterId}"]`)?.closest('.card');
        if (!cardElement) {
          // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–µ—Å—å —Å–ø–∏—Å–æ–∫
          clusters = updatedClusters;
          await renderClusters();
          // renderClusters —É–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç attachClusterActionHandlers
          return;
        }
        
        // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä—Å–æ–Ω—É –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞
        const person = updatedCluster.person_id ? persons.find(p => p.id === updatedCluster.person_id) : null;
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É
        const newCard = await createClusterCard(updatedCluster, person);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≤ –∫–∞–∫—É—é –≥—Ä—É–ø–ø—É –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
        const currentGroup = cardElement.closest('.person-group');
        const targetPersonId = updatedCluster.person_id;
        
        // –ù–∞—Ö–æ–¥–∏–º —Ü–µ–ª–µ–≤—É—é –≥—Ä—É–ø–ø—É
        let targetGrid = null;
        if (targetPersonId) {
          const person = persons.find(p => p.id === targetPersonId);
          if (person?.is_ignored) {
            // –ò—â–µ–º –≥—Ä—É–ø–ø—É "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ"
            const ignoredGroup = document.querySelector('.person-group.ignored');
            targetGrid = ignoredGroup?.querySelector('.grid');
          } else {
            // –ò—â–µ–º –≥—Ä—É–ø–ø—É –ø–µ—Ä—Å–æ–Ω—ã
            targetGrid = document.querySelector(`#person-${targetPersonId}-clusters`);
          }
        } else {
          // –ò—â–µ–º –≥—Ä—É–ø–ø—É "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ"
          targetGrid = document.querySelector('#unassigned-clusters');
        }
        
        // –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–∞—è –≥—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–µ—Å—å —Å–ø–∏—Å–æ–∫
        if (!targetGrid) {
          clusters = updatedClusters;
          await renderClusters();
          return;
        }
        
        // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ —É–∂–µ –≤ –Ω—É–∂–Ω–æ–π –≥—Ä—É–ø–ø–µ, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë
        const currentGrid = currentGroup?.querySelector('.grid');
        if (targetGrid === currentGrid) {
          cardElement.replaceWith(newCard);
        } else {
          // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤ —Ü–µ–ª–µ–≤—É—é –≥—Ä—É–ø–ø—É
          cardElement.remove();
          targetGrid.appendChild(newCard);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –≤ –≥—Ä—É–ø–ø–∞—Ö
          updateGroupCounts();
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π" —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ –Ω—É–∂–Ω–æ
      }
      
      function updateGroupCounts() {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –≥—Ä—É–ø–ø
        document.querySelectorAll('.person-group').forEach(group => {
          const grid = group.querySelector('.grid');
          const countElement = group.querySelector('.person-clusters-count');
          if (grid && countElement) {
            const count = grid.children.length;
            const personName = group.querySelector('.person-name')?.textContent;
            if (personName === '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ') {
              countElement.textContent = `${count} –∫–ª–∞—Å—Ç–µ—Ä${count === 1 ? '' : count < 5 ? '–∞' : '–æ–≤'}`;
            } else {
              const totalFaces = Array.from(grid.querySelectorAll('.card')).reduce((sum, card) => {
                const facesText = card.querySelector('.muted')?.textContent?.match(/(\d+)\s+–ª–∏—Ü/)?.[1];
                return sum + (parseInt(facesText) || 0);
              }, 0);
              countElement.textContent = `${count} –∫–ª–∞—Å—Ç–µ—Ä${count === 1 ? '' : count < 5 ? '–∞' : '–æ–≤'}, ${totalFaces} –ª–∏—Ü`;
            }
          }
        });
      }
      
      async function createClusterCard(cluster, person) {
        const card = document.createElement("div");
        card.className = "card";
        
        const personName = person ? person.name : (cluster.person_name || "");
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º preview-–ª–∏—Ü–æ –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞
        let previewHtml = '';
        if (cluster.preview_face_id) {
          const previewUrl = await getFaceThumbnail(cluster.preview_face_id);
          if (previewUrl) {
            previewHtml = `<img src="${previewUrl}" alt="Preview" style="width:60px; height:60px; object-fit:cover; border-radius:6px; border:1px solid #e5e7eb;" />`;
          }
        }
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º
        let assignControl = '';
        const currentPersonId = cluster.person_id;
        const ignoredPerson = persons.find(p => p.is_ignored);
        
        // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ" (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤)
        let ignoredButton = '';
        if (!currentPersonId && ignoredPerson) {
          ignoredButton = `<button class="btn" type="button" data-action="assign-ignored" data-cluster-id="${cluster.id}" data-person-id="${ignoredPerson.id}" style="padding:6px 10px; cursor:pointer; border:1px solid #d1d5db; border-radius:4px; background:white; font-size:18px;" title="–ù–∞–∑–Ω–∞—á–∏—Ç—å –Ω–∞ –ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ">üö´</button>`;
        }
        
        // –í—ã–ø–∞–¥–∞—à–∫–∞ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –¥—Ä—É–≥–∏—Ö –ø–µ—Ä—Å–æ–Ω
        let optionsHtml = '';
        if (currentPersonId) {
          // –ï—Å–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω - –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–°–Ω—è—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ"
          optionsHtml = '<option value="">–°–Ω—è—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ</option>';
        } else {
          // –ï—Å–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω
          optionsHtml = '<option value="">–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω—É...</option>';
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω (—Ç–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–µ, "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ" –∏—Å–∫–ª—é—á–∞–µ–º –∏–∑ –≤—ã–ø–∞–¥–∞—à–∫–∏)
        const regularPersons = persons.filter(p => !p.is_ignored);
        
        for (const p of regularPersons) {
          const selected = currentPersonId && p.id === currentPersonId ? ' selected' : '';
          optionsHtml += `<option value="${p.id}"${selected}>${p.name}${p.is_me ? ' (—è)' : ''}</option>`;
        }
        
        const selectHtml = `<select class="btn" style="padding:6px 12px; cursor:pointer; border:1px solid #d1d5db; border-radius:4px; background:white; min-width:180px;" onchange="assignPersonFromDropdown(${cluster.id}, this.value, event)" id="assign-select-${cluster.id}">${optionsHtml}</select>`;
        
        // –ï—Å–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–ø–∞–¥–∞—à–∫—É, –∏–Ω–∞—á–µ –∫–Ω–æ–ø–∫—É + –≤—ã–ø–∞–¥–∞—à–∫—É
        assignControl = currentPersonId ? selectHtml : `${ignoredButton}${selectHtml}`;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–ª–∞—Å—Ç–µ—Ä–∞ (–∞—Ä—Ö–∏–≤/–ø—Ä–æ–≥–æ–Ω) –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è
        const isArchive = cluster.archive_scope === 'archive';
        const isRun = !isArchive && (cluster.run_id !== null && cluster.run_id !== undefined);
        const scopeLabel = isArchive ? 'üì¶ –ê—Ä—Ö–∏–≤' : (isRun ? 'üîÑ –°–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è' : '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
        const scopeColor = isArchive ? '#6b7280' : (isRun ? '#0b57d0' : '#9ca3af');
        
        card.innerHTML = `
          <div class="card-header" style="display:flex; gap:10px; align-items:start;">
            ${previewHtml ? `<div>${previewHtml}</div>` : ''}
            <div style="flex:1;">
              <div style="font-weight:700;">–ö–ª–∞—Å—Ç–µ—Ä #${cluster.id}</div>
              <div class="muted" style="font-size:11px; margin-top:4px;">
                ${cluster.faces_count} –ª–∏—Ü | ${scopeLabel}${cluster.run_id ? ` | Run ${cluster.run_id}` : ''}
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="kv">
              <span class="pill">–ú–µ—Ç–æ–¥: ${cluster.method}</span>
              <span class="pill">–°–æ–∑–¥–∞–Ω: ${new Date(cluster.created_at).toLocaleString('ru-RU')}</span>
            </div>
            <div class="actions" style="display:flex; gap:8px; align-items:center;">
              <a href="/face-clusters/${cluster.id}" class="btn" style="text-decoration:none; display:inline-block;">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
              ${assignControl}
            </div>
          </div>
        `;
        
        return card;
      }
      
      async function assignPersonFromDropdown(clusterId, personId, event) {
        if (!clusterId) {
          return;
        }
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω event
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        
        // –ï—Å–ª–∏ personId –ø—É—Å—Ç–æ–π - —ç—Ç–æ —Å–Ω—è—Ç–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        const actualPersonId = personId === '' ? null : personId;
        
        console.log(`[Assign] –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ ${clusterId} –ø–µ—Ä—Å–æ–Ω–µ ${actualPersonId || '(—Å–Ω—è—Ç–∏–µ)'}`);
        
        try {
          const resp = await fetch(`/api/face-clusters/${clusterId}/assign-person`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ person_id: actualPersonId === null ? null : parseInt(actualPersonId) }),
          });
          
          console.log(`[Assign] –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: status=${resp.status}, ok=${resp.ok}`);
          
          if (resp.ok) {
            const result = await resp.json();
            console.log(`[Assign] –†–µ–∑—É–ª—å—Ç–∞—Ç:`, result);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω (–º–æ–∂–µ—Ç –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤–∞—è)
            await loadPersons();
            
            // –ï—Å–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä –±—ã–ª –Ω–∞–∑–Ω–∞—á–µ–Ω –ø–µ—Ä—Å–æ–Ω–µ, —É–¥–∞–ª—è–µ–º –µ–≥–æ –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö
            if (actualPersonId !== null) {
              // –ö–ª–∞—Å—Ç–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω - —É–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑ DOM
              const cardElement = document.querySelector(`[id="assign-select-${clusterId}"]`)?.closest('.card');
              if (cardElement) {
                cardElement.remove();
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≥—Ä—É–ø–ø—ã "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ"
                const groupElement = document.getElementById("person-group-unassigned");
                if (groupElement) {
                  updateGroupCount(groupElement);
                }
                showToast(`–ö–ª–∞—Å—Ç–µ—Ä #${clusterId} –Ω–∞–∑–Ω–∞—á–µ–Ω –ø–µ—Ä—Å–æ–Ω–µ`);
              }
            } else {
              // –ö–ª–∞—Å—Ç–µ—Ä —Å–Ω—è—Ç —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
              await loadClusters();
            }
          } else {
            let errorMsg = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
            try {
              const err = await resp.json();
              errorMsg = err.detail || err.message || err.error || JSON.stringify(err);
              console.error(`[Assign] –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:`, err);
            } catch (e) {
              errorMsg = `HTTP ${resp.status}: ${resp.statusText}`;
              console.error(`[Assign] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞:`, e);
            }
            showToast(`–û—à–∏–±–∫–∞: ${errorMsg}`, true);
            // –°–±—Ä–æ—Å –≤—ã–ø–∞–¥–∞—à–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            const select = document.getElementById(`assign-select-${clusterId}`);
            if (select) select.value = '';
          }
        } catch (e) {
          console.error(`[Assign] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ:`, e);
          showToast(`–û—à–∏–±–∫–∞: ${e}`, true);
          const select = document.getElementById(`assign-select-${clusterId}`);
          if (select) select.value = '';
        }
      }


      function assignCluster(clusterId) {
        currentClusterId = clusterId;
        openModal("modalAssignPerson");
      }

      async function assignPerson() {
        const personId = document.getElementById("selectAssignPerson").value;
        if (!personId || !currentClusterId) return;
        
        try {
          const resp = await fetch(`/api/face-clusters/${currentClusterId}/assign-person`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ person_id: parseInt(personId) }),
          });
          
          if (resp.ok) {
            showToast("–ö–ª–∞—Å—Ç–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω –ø–µ—Ä—Å–æ–Ω–µ");
            closeModal("modalAssignPerson");
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –∏ –ø–µ—Ä—Å–æ–Ω
            await Promise.all([loadPersons(), loadClusters()]);
          } else {
            let errorMsg = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
            try {
              const err = await resp.json();
              errorMsg = err.detail || err.message || err.error || JSON.stringify(err);
            } catch (e) {
              errorMsg = `HTTP ${resp.status}: ${resp.statusText}`;
            }
            showToast(`–û—à–∏–±–∫–∞: ${errorMsg}`);
          }
        } catch (e) {
          const errorMsg = e instanceof Error ? e.message : String(e);
          showToast(`–û—à–∏–±–∫–∞: ${errorMsg}`);
        }
      }

      async function createPerson() {
        const name = document.getElementById("inputPersonName").value.trim();
        if (!name) {
          showToast("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω—ã");
          return;
        }
        
        const mode = document.getElementById("selectPersonMode").value;
        const kinship = document.getElementById("inputPersonKinship").value.trim() || null;
        const isMe = document.getElementById("checkboxIsMe").checked ? 1 : 0;
        
        try {
          const resp = await fetch("/api/persons/create", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, mode, is_me: isMe, kinship }),
          });
          
          if (resp.ok) {
            showToast("–ü–µ—Ä—Å–æ–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞");
            closeModal("modalCreatePerson");
            document.getElementById("inputPersonName").value = "";
            document.getElementById("inputPersonKinship").value = "";
            document.getElementById("checkboxIsMe").checked = false;
            loadPersons();
          } else {
            let errorMsg = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
            try {
              const err = await resp.json();
              errorMsg = err.detail || err.message || err.error || JSON.stringify(err);
            } catch (e) {
              errorMsg = `HTTP ${resp.status}: ${resp.statusText}`;
            }
            showToast(`–û—à–∏–±–∫–∞: ${errorMsg}`);
          }
        } catch (e) {
          const errorMsg = e instanceof Error ? e.message : String(e);
          showToast(`–û—à–∏–±–∫–∞: ${errorMsg}`);
        }
      }

      async function clusterize() {
        const runId = document.getElementById("selectRunId").value;
        if (!runId) {
          showToast("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–≥–æ–Ω –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏");
          return;
        }
        
        if (!confirm(`–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è run_id=${runId}?`)) return;
        
        try {
          const resp = await fetch("/api/face-clusters/clusterize", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ run_id: parseInt(runId), eps: 0.4, min_samples: 2 }),
          });
          
          if (resp.ok) {
            const result = await resp.json();
            showToast(`–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${result.clusters_count} –∫–ª–∞—Å—Ç–µ—Ä–æ–≤, ${result.noise_count} —à—É–º`);
            loadClusters();
          } else {
            let errorMsg = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
            try {
              const err = await resp.json();
              errorMsg = err.detail || err.message || err.error || JSON.stringify(err);
            } catch (e) {
              errorMsg = `HTTP ${resp.status}: ${resp.statusText}`;
            }
            showToast(`–û—à–∏–±–∫–∞: ${errorMsg}`);
          }
        } catch (e) {
          const errorMsg = e instanceof Error ? e.message : String(e);
          showToast(`–û—à–∏–±–∫–∞: ${errorMsg}`);
        }
      }

      async function saveAllToGold() {
        const btn = document.getElementById("btnSaveAllToGold");
        btn.disabled = true;
        btn.textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
        try {
          const response = await fetch("/api/persons/save-all-to-gold", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.detail || data.error || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
          }
          showToast(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${data.persons_count} –ø–µ—Ä—Å–æ–Ω, ${data.faces_count} –ª–∏—Ü, ${data.files_updated} —Ñ–∞–π–ª–æ–≤`, false);
        } catch (e) {
          showToast(`–û—à–∏–±–∫–∞: ${e.message}`, true);
        } finally {
          btn.disabled = false;
          btn.textContent = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –≤ gold";
        }
      }

      // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π" - –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
      // –î–æ–±–∞–≤–ª—è–µ–º –î–û –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ —Å—Ä–∞–∑—É –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
      const clustersGrid = document.getElementById("clustersGrid");
      if (clustersGrid) {
        clustersGrid.addEventListener('click', async (e) => {
          const btn = e.target.closest('button[data-action="assign-ignored"]');
          if (!btn) return;
          
          // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–µ –≤–∏–¥—ã –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∏ –≤—Å–ø–ª—ã—Ç–∏—è
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          
          const clusterId = parseInt(btn.getAttribute('data-cluster-id'));
          const personId = btn.getAttribute('data-person-id');
          
          if (clusterId && personId) {
            await assignPersonFromDropdown(clusterId, personId, e);
          }
          
          return false;
        }, { capture: false, passive: false });
      }
      
      async function findSuggestions() {
        const btn = document.getElementById("btnFindSuggestions");
        btn.disabled = true;
        btn.textContent = "–ü–æ–∏—Å–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π...";
        
        try {
          const runId = document.getElementById("selectRunId").value;
          const params = ['max_distance=0.45'];
          if (runId) {
            params.push(`run_id=${runId}`);
          } else {
            params.push('archive_scope=archive');
          }
          
          const url = `/api/face-clusters/suggestions-for-single?${params.join('&')}`;
          const resp = await fetch(url);
          
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
          }
          
          const data = await resp.json();
          const suggestions = data.suggestions || [];
          
          console.log(`[findSuggestions] –ù–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: ${suggestions.length}`);
          
          if (suggestions.length === 0) {
            showToast("–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –í—Å–µ –∫–ª–∞—Å—Ç–µ—Ä—ã —Å 1 –ª–∏—Ü–æ–º —É–∂–µ –∏–º–µ—é—Ç –ø–µ—Ä—Å–æ–Ω—É –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ—Ö–æ–∂–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤.");
            openModal("modalSuggestions");
            displaySuggestions([]);
          } else {
            openModal("modalSuggestions");
            await displaySuggestions(suggestions);
          }
        } catch (e) {
          console.error('[findSuggestions] –û—à–∏–±–∫–∞:', e);
          showToast(`–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: ${e}`, 10000);
        } finally {
          btn.disabled = false;
          btn.textContent = "–ù–∞–π—Ç–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ —Å 1 –ª–∏—Ü–æ–º";
        }
      }
      
      async function displaySuggestions(suggestions) {
        const content = document.getElementById("suggestionsContent");
        
        if (suggestions.length === 0) {
          content.innerHTML = '<div class="muted" style="text-align: center; padding: 24px;">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>';
          return;
        }
        
        let html = `<div style="margin-bottom: 16px; font-size: 14px; color: #6b7280;">–ù–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: ${suggestions.length}</div>`;
        html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
        
        for (const suggestion of suggestions) {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º thumbnail –ª–∏—Ü–∞
          const thumbUrl = await getFaceThumbnail(suggestion.face_id);
          const thumbHtml = thumbUrl 
            ? `<img src="${thumbUrl}" alt="Face" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #e5e7eb;" />`
            : '<div style="width: 80px; height: 80px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #9ca3af;">–ù–µ—Ç —Ñ–æ—Ç–æ</div>';
          
          const distancePercent = (suggestion.distance * 100).toFixed(1);
          const distanceColor = suggestion.distance < 0.25 ? '#10b981' : suggestion.distance < 0.30 ? '#f59e0b' : '#ef4444';
          
          html += `
            <div data-cluster-id="${suggestion.cluster_id}" style="display: flex; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; align-items: center;">
              ${thumbHtml}
              <div style="flex: 1;">
                <div style="font-weight: 700; margin-bottom: 4px;">–ö–ª–∞—Å—Ç–µ—Ä #${suggestion.cluster_id}</div>
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                  –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞: <strong>${suggestion.suggested_person_name}</strong>
                </div>
                <div style="font-size: 12px; color: ${distanceColor};">
                  –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distancePercent}% (–∫–ª–∞—Å—Ç–µ—Ä #${suggestion.suggested_cluster_id})
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn" type="button" onclick="rejectSuggestion(${suggestion.cluster_id})" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db;">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                <button class="btn primary" type="button" onclick="acceptSuggestion(${suggestion.cluster_id}, ${suggestion.suggested_person_id})" style="padding: 6px 12px;">–ü—Ä–∏–Ω—è—Ç—å</button>
              </div>
            </div>
          `;
        }
        
        html += '</div>';
        content.innerHTML = html;
      }
      
      async function acceptSuggestion(clusterId, personId) {
        try {
          const resp = await fetch(`/api/face-clusters/${clusterId}/assign-person`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ person_id: personId }),
          });
          
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
          }
          
          showToast(`–ö–ª–∞—Å—Ç–µ—Ä #${clusterId} –Ω–∞–∑–Ω–∞—á–µ–Ω –ø–µ—Ä—Å–æ–Ω–µ`);
          
          // –£–¥–∞–ª—è–µ–º –ø—Ä–∏–Ω—è—Ç–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞
          const content = document.getElementById("suggestionsContent");
          const suggestionEl = content.querySelector(`[data-cluster-id="${clusterId}"]`);
          if (suggestionEl) {
            suggestionEl.remove();
          }
          
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –∫–ª–∞—Å—Ç–µ—Ä –∏–∑ –Ω–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö
          await loadClusters();
        } catch (e) {
          console.error('[acceptSuggestion] –û—à–∏–±–∫–∞:', e);
          showToast(`–û—à–∏–±–∫–∞: ${e}`, 10000);
        }
      }
      
      function rejectSuggestion(clusterId) {
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞ (–ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ)
        const content = document.getElementById("suggestionsContent");
        const suggestionEl = content.querySelector(`[data-cluster-id="${clusterId}"]`) || 
                            Array.from(content.querySelectorAll('.card, div[style*="border"]')).find(el => 
                              el.textContent.includes(`–ö–ª–∞—Å—Ç–µ—Ä #${clusterId}`)
                            );
        if (suggestionEl) {
          suggestionEl.style.display = 'none';
        }
        showToast(`–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞ #${clusterId} –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ`, 3000);
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      async function findSimilarClusters() {
        const btn = document.getElementById("btnFindSimilarClusters");
        btn.disabled = true;
        btn.textContent = "–ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤...";
        
        try {
          const runId = document.getElementById("selectRunId").value;
          const params = ['max_distance=0.6'];
          if (runId) {
            params.push(`run_id=${runId}`);
          } else {
            params.push('archive_scope=archive');
          }
          
          const url = `/api/face-clusters/similar-single-clusters?${params.join('&')}`;
          const resp = await fetch(url);
          
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
          }
          
          const data = await resp.json();
          const pairs = data.pairs || [];
          
          console.log(`[findSimilarClusters] –ù–∞–π–¥–µ–Ω–æ –ø–∞—Ä: ${pairs.length}`);
          
          if (pairs.length === 0) {
            showToast("–ü–æ—Ö–æ–∂–∏–µ –æ–¥–∏–Ω–æ—á–Ω—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");
            openModal("modalSimilarClusters");
            displaySimilarClusters([]);
          } else {
            openModal("modalSimilarClusters");
            await displaySimilarClusters(pairs);
          }
        } catch (e) {
          console.error('[findSimilarClusters] –û—à–∏–±–∫–∞:', e);
          showToast(`–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ—Ö–æ–∂–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: ${e}`, 10000);
        } finally {
          btn.disabled = false;
          btn.textContent = "–ù–∞–π—Ç–∏ –ø–æ—Ö–æ–∂–∏–µ –æ–¥–∏–Ω–æ—á–Ω—ã–µ –∫–ª–∞—Å—Ç–µ—Ä—ã";
        }
      }
      
      async function displaySimilarClusters(pairs) {
        const content = document.getElementById("similarClustersContent");
        
        if (pairs.length === 0) {
          content.innerHTML = '<div class="muted" style="text-align: center; padding: 24px;">–ü–æ—Ö–æ–∂–∏–µ –∫–ª–∞—Å—Ç–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>';
          return;
        }
        
        let html = `<div style="margin-bottom: 16px; font-size: 14px; color: #6b7280;">–ù–∞–π–¥–µ–Ω–æ –ø–∞—Ä –ø–æ—Ö–æ–∂–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: ${pairs.length}</div>`;
        html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
        
        for (const pair of pairs) {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º thumbnails –æ–±–æ–∏—Ö –ª–∏—Ü
          const thumb1Url = await getFaceThumbnail(pair.cluster1_face_id);
          const thumb2Url = await getFaceThumbnail(pair.cluster2_face_id);
          
          const thumb1Html = thumb1Url 
            ? `<img src="${thumb1Url}" alt="Face" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #e5e7eb;" />`
            : '<div style="width: 80px; height: 80px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #9ca3af;">–ù–µ—Ç —Ñ–æ—Ç–æ</div>';
          
          const thumb2Html = thumb2Url 
            ? `<img src="${thumb2Url}" alt="Face" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #e5e7eb;" />`
            : '<div style="width: 80px; height: 80px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #9ca3af;">–ù–µ—Ç —Ñ–æ—Ç–æ</div>';
          
          const distancePercent = (pair.distance * 100).toFixed(1);
          const distanceColor = pair.distance < 0.25 ? '#10b981' : pair.distance < 0.30 ? '#f59e0b' : '#ef4444';
          
          html += `
            <div data-pair-id="${pair.cluster1_id}-${pair.cluster2_id}" style="display: flex; gap: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; align-items: center;">
              <div style="display: flex; gap: 8px; align-items: center;">
                ${thumb1Html}
                <div style="font-weight: 700; color: #374151;">#${pair.cluster1_id}</div>
              </div>
              <div style="flex: 1; text-align: center; color: ${distanceColor}; font-size: 14px;">
                ‚Üî –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distancePercent}%
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <div style="font-weight: 700; color: #374151;">#${pair.cluster2_id}</div>
                ${thumb2Html}
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn" type="button" onclick="rejectMerge(${pair.cluster1_id}, ${pair.cluster2_id})" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db;">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                <button class="btn primary" type="button" onclick="acceptMerge(${pair.cluster1_id}, ${pair.cluster2_id})" style="padding: 6px 12px;">–û–±—ä–µ–¥–∏–Ω–∏—Ç—å</button>
              </div>
            </div>
          `;
        }
        
        html += '</div>';
        content.innerHTML = html;
      }
      
      async function acceptMerge(cluster1Id, cluster2Id) {
        try {
          // –û–±—ä–µ–¥–∏–Ω—è–µ–º: cluster1 -> cluster2 (cluster2 –æ—Å—Ç–∞–µ—Ç—Å—è, cluster1 –∏—Å—á–µ–∑–∞–µ—Ç)
          const resp = await fetch(`/api/face-clusters/merge`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              source_cluster_id: cluster1Id, 
              target_cluster_id: cluster2Id 
            }),
          });
          
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
          }
          
          showToast(`–ö–ª–∞—Å—Ç–µ—Ä—ã #${cluster1Id} –∏ #${cluster2Id} –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã`);
          
          // –£–¥–∞–ª—è–µ–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—É—é –ø–∞—Ä—É –∏–∑ —Å–ø–∏—Å–∫–∞
          const content = document.getElementById("similarClustersContent");
          const pairEl = content.querySelector(`[data-pair-id="${cluster1Id}-${cluster2Id}"]`);
          if (pairEl) {
            pairEl.remove();
          }
          
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞
          await loadClusters();
        } catch (e) {
          console.error('[acceptMerge] –û—à–∏–±–∫–∞:', e);
          showToast(`–û—à–∏–±–∫–∞: ${e}`, 10000);
        }
      }
      
      function rejectMerge(cluster1Id, cluster2Id) {
        // –£–¥–∞–ª—è–µ–º –ø–∞—Ä—É –∏–∑ —Å–ø–∏—Å–∫–∞ (–ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º –µ—ë)
        const content = document.getElementById("similarClustersContent");
        const pairEl = content.querySelector(`[data-pair-id="${cluster1Id}-${cluster2Id}"]`);
        if (pairEl) {
          pairEl.style.display = 'none';
        }
        showToast(`–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ #${cluster1Id} –∏ #${cluster2Id} –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ`, 3000);
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      document.getElementById("btnReload").onclick = () => { loadClusters(); loadPersons(); };
      document.getElementById("btnCreatePerson").onclick = () => openModal("modalCreatePerson");
      document.getElementById("btnClusterize").onclick = clusterize;
      document.getElementById("btnFindSuggestions").onclick = findSuggestions;
      document.getElementById("btnFindSimilarClusters").onclick = findSimilarClusters;
      document.getElementById("selectRunId").onchange = () => loadClusters();
      document.getElementById("selectScopeFilter").onchange = () => loadClusters();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      async function init() {
        try {
          await loadRuns();
          await loadPersons();
          await loadClusters();
        } catch (e) {
          console.error('[init] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', e);
          showToast(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${e}`, 10000);
        }
      }
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    </script>
  </body>
</html>
