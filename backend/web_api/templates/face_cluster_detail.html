<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <meta name="referrer" content="no-referrer" />
    <title>PhotoSorter ‚Äî –ö–ª–∞—Å—Ç–µ—Ä –ª–∏—Ü</title>
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <symbol id="icon-line-copy-right" viewBox="0 0 16 16" fill="none">
        <rect x="5.5" y="5.5" width="9" height="9" stroke="currentColor" stroke-width="1.2" fill="none" rx="1.5" stroke-linejoin="round"/>
        <rect x="1.5" y="1.5" width="9" height="9" stroke="currentColor" stroke-width="1.2" fill="none" rx="1.5" stroke-linejoin="round"/>
      </symbol>
    </svg>
    <style>
      :root { color-scheme: light; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
      a { color: #0b57d0; text-decoration: none; }
      a:hover { text-decoration: underline; }
      code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
      .muted { color: #6b7280; }
      .wrap { max-width: 1400px; }
      .header { display:flex; align-items:baseline; justify-content:space-between; gap:12px; margin-bottom:20px; }
      .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
      .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f3f4f6; color:#374151; font-size:12px; }
      .btn { appearance:none; border:1px solid #d1d5db; background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:700; }
      .btn:hover { background:#f9fafb; }
      .btn:disabled { opacity: 0.6; cursor: not-allowed; }
      .btn.primary { background:#111827; color:#fff; border-color:#111827; }
      .btn.primary:hover { background:#374151; }
      .thumb-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap:12px; margin-top:16px; }
      .thumb { width: 100%; aspect-ratio: 1; background:#fff; display:flex; align-items:center; justify-content:center; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden; cursor: pointer; position:relative; }
      .thumb img { width: 100%; height: 100%; object-fit: cover; }
      .thumb .noimg { color:#6b7280; font-size:11px; text-align:center; padding:8px; }
      .thumb:hover { border-color:#0b57d0; }
      .thumb .remove-btn { position:absolute; top:4px; right:4px; background:rgba(0,0,0,0.7); color:#fff; border:none; border-radius:4px; padding:4px 6px; font-size:11px; cursor:pointer; display:none; }
      .thumb:hover .remove-btn { display:block; }
      .thumb .remove-btn:hover { background:rgba(220,38,38,0.9); }
      .thumb .face-actions { position:absolute; bottom:4px; left:4px; right:4px; display:none; gap:4px; flex-wrap:wrap; }
      .thumb:hover .face-actions { display:flex; }
      .thumb .face-btn { background:rgba(0,0,0,0.8); color:#fff; border:none; border-radius:4px; padding:4px 6px; font-size:10px; cursor:pointer; flex:1; min-width:0; }
      .thumb .face-btn:hover { background:rgba(0,0,0,0.95); }
      .info-section { background:#f9fafb; border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin-bottom:20px; }
      .info-section h3 { margin:0 0 12px 0; }
      .kv { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; font-size:13px; }
      .loading { opacity: 0.6; pointer-events: none; }
      /* Undo —Å–∏—Å—Ç–µ–º–∞ */
      .undo-toast { position: fixed; bottom: 20px; right: 20px; background: #111827; color: #fff; padding: 12px 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; display: none; gap: 12px; align-items: center; }
      .undo-toast.show { display: flex; }
      .undo-toast .undo-btn { background: #fff; color: #111827; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 700; }
      .undo-toast .undo-btn:hover { background: #f3f4f6; }
      /* Lightbox */
      .lb { position: fixed; inset: 0; background: rgba(17,24,39,0.82); display: none; align-items: center; justify-content: center; padding: 18px; z-index: 9999; }
      .lb.open { display: flex; }
      .lb-panel { background: #fff; border-radius: 14px; max-width: 92vw; max-height: 92vh; width: min(1200px, 92vw); overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.35); }
      .lb-top { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 12px; border-bottom: 1px solid #e5e7eb; }
      .lb-body { background: #111827; display: flex; align-items: center; justify-content: center; position: relative; }
      .lb-body img { max-width: 92vw; max-height: calc(92vh - 56px); width: auto; height: auto; display: block; object-fit: contain; background: #111827; }
      .lb-rectangle { position: absolute; border: 3px solid #0b57d0; pointer-events: none; box-shadow: 0 0 0 2px rgba(11, 87, 208, 0.3); z-index: 1001; }
      .lb-rectangle.other { border-color: #fbbf24; box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.3); z-index: 1000; pointer-events: auto; cursor: pointer; }
      .lb-rectangle-label { 
        position: absolute; 
        background: rgba(251, 191, 36, 0.95); 
        color: #111827; 
        padding: 3px 8px; 
        font-size: 12px; 
        font-weight: 700; 
        border-radius: 4px; 
        white-space: nowrap; 
        z-index: 10001; 
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(251, 191, 36, 1);
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .lb-rectangle-label:hover {
        background: rgba(251, 191, 36, 1);
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <div>
          <h2 style="margin:0;">–ö–ª–∞—Å—Ç–µ—Ä #<span id="clusterId">-</span></h2>
          <div class="muted" style="margin-top:6px;" id="clusterInfo">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <div>
          <a href="/face-clusters" id="backLink" class="muted">‚Üê –∫ —Å–ø–∏—Å–∫—É –∫–ª–∞—Å—Ç–µ—Ä–æ–≤</a>
        </div>
      </div>

      <div class="info-section">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∞—Å—Ç–µ—Ä–µ</h3>
        <div class="kv" id="clusterMeta"></div>
        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary" id="btnAssignPerson" type="button">–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω—É</button>
          <button class="btn" id="btnAssignIgnored" type="button" style="display:none; font-size:18px;" title="–ù–∞–∑–Ω–∞—á–∏—Ç—å –Ω–∞ –ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ">üö´</button>
          <button class="btn" id="btnConfirmToGold" type="button" style="display:none;">–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤ gold</button>
        </div>
      </div>

      <div>
        <h3>–í—Å–µ –ª–∏—Ü–∞ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ (<span id="facesCount">-</span>)</h3>
        <div class="muted" style="margin-top:6px;">–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ –ª–∏—Ü–æ ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</div>
        <div id="facesGridContainer">
          <div id="facesGridArchive" style="margin-bottom:24px;">
            <h4 style="margin:0 0 12px 0; font-size:16px; font-weight:600; color:#1f2937;">–ê—Ä—Ö–∏–≤</h4>
            <div class="thumb-grid" id="facesGridArchiveContent"></div>
          </div>
          <div id="facesGridRun">
            <h4 style="margin:0 0 12px 0; font-size:16px; font-weight:600; color:#1f2937;">–¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥–æ–Ω</h4>
            <div class="thumb-grid" id="facesGridRunContent"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Undo toast -->
    <div class="undo-toast" id="undoToast">
      <span id="undoMessage"></span>
      <button class="undo-btn" id="undoBtn" onclick="undoLastAction()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
    </div>

    <!-- Lightbox –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª–Ω–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ -->
    <div class="lb" id="lightbox" style="display: none;">
      <div class="lb-panel">
        <div class="lb-top">
          <div class="muted"><code id="lbPath"></code></div>
          <div style="display:flex; gap:10px; align-items:center;">
            <a id="lbOpen" class="pill" href="#" target="_blank" rel="noopener noreferrer" style="display:none;">–û—Ç–∫—Ä—ã—Ç—å</a>
            <button class="btn" type="button" onclick="closeLightbox()">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
        <div class="lb-body" id="lbBody">
          <img id="lbImg" alt="preview" />
          <div id="lbRectangle" class="lb-rectangle"></div>
        </div>
      </div>
    </div>

    <!-- Modal –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø–µ—Ä—Å–æ–Ω–µ -->
    <div class="modal" id="modalAssignPerson" style="position: fixed; inset: 0; background: rgba(17,24,39,0.82); display: none; align-items: center; justify-content: center; padding: 18px; z-index: 100000;">
      <div class="modal-panel" style="background: #fff; border-radius: 14px; max-width: 94vw; max-height: 94vh; width: min(500px, 94vw); overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.35);">
        <div class="modal-header" style="padding: 12px 16px; border-bottom: 1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
          <h3 style="margin:0;">–ù–∞–∑–Ω–∞—á–∏—Ç—å –∫–ª–∞—Å—Ç–µ—Ä –ø–µ—Ä—Å–æ–Ω–µ</h3>
          <button class="btn" type="button" onclick="closeModal('modalAssignPerson')">‚úï</button>
        </div>
        <div class="modal-body" style="padding: 16px; max-height: calc(94vh - 120px); overflow-y: auto;">
          <div style="margin-bottom:16px;">
            <label style="display:block; margin-bottom:4px; font-weight:700;">–ü–µ—Ä—Å–æ–Ω–∞:</label>
            <select class="select" id="selectAssignPerson" style="width:100%; border:1px solid #d1d5db; border-radius:10px; padding:8px 10px; font-size:14px;">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω—É...</option>
            </select>
            <button class="btn primary" type="button" onclick="assignPerson()" style="width:100%; margin-top:12px;">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
          </div>
          <div style="margin-top:16px; padding-top:16px; border-top:1px solid #e5e7eb;">
            <div style="margin-bottom:8px; font-weight:700;">–ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é:</div>
            <input type="text" id="inputNewPersonName" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω—ã" style="width:100%; border:1px solid #d1d5db; border-radius:10px; padding:8px 10px; font-size:14px; margin-bottom:8px;" />
            <button class="btn" type="button" onclick="createPersonAndAssign()" style="width:100%;">–°–æ–∑–¥–∞—Ç—å –∏ –Ω–∞–∑–Ω–∞—á–∏—Ç—å</button>
          </div>
        </div>
        <div class="modal-footer" style="padding: 12px 16px; border-top: 1px solid #e5e7eb; display:flex; gap:10px; justify-content:flex-end;">
          <button class="btn" type="button" onclick="closeModal('modalAssignPerson')">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>

    <script src="/static/face_rectangles_viewer.js"></script>
    <script>
      // –ü–æ–ª—É—á–∞–µ–º cluster_id –∏–∑ URL: /face-clusters/123
      const pathParts = window.location.pathname.split('/').filter(p => p);
      const clusterId = parseInt(pathParts[pathParts.length - 1]) || 0;
      // #region agent log
      (async () => {
        try {
          await fetch('/api/debug/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              location: 'face_cluster_detail.html:176',
              message: 'clusterId determined',
              data: { pathname: window.location.pathname, pathParts: pathParts, clusterId: clusterId },
              timestamp: Date.now(),
              sessionId: 'debug-session',
              runId: 'pre-fix',
              hypothesisId: 'D'
            })
          }).catch(() => {});
        } catch (e) {}
      })();
      // #endregion
      let persons = [];
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –º–æ–¥—É–ª—è –ü–ï–†–ï–î –ª—é–±—ã–º–∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è–º–∏
      const drawAllFaceRectanglesFromModule = typeof drawAllFaceRectangles !== 'undefined' ? drawAllFaceRectangles : null;
      const drawFaceRectangleFromModule = typeof drawFaceRectangle !== 'undefined' ? drawFaceRectangle : null;
      let clusterInfo = null;
      let undoStack = []; // –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è undo
      let currentFaceBbox = null; // Bbox —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –ª–∏—Ü–∞
      let currentFaceId = null; // ID —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –ª–∏—Ü–∞
      let currentFilePath = null; // –ü—É—Ç—å –∫ —Ç–µ–∫—É—â–µ–º—É —Ñ–∞–π–ª—É –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–ø–ø–∏–Ω–≥–∞
      let allFacesOnImage = []; // –í—Å–µ –ª–∏—Ü–∞ –Ω–∞ —Ç–µ–∫—É—â–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏

      function showToast(msg, duration = 3000) {
        // –¢–∏—Ö–∏–π toast - —Ç–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Å–æ–ª—å, –±–µ–∑ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        if (msg) console.log('[Toast]', msg);
      }

      function showUndoToast(msg, duration = 5000) {
        const toast = document.getElementById('undoToast');
        const message = document.getElementById('undoMessage');
        if (toast && message) {
          message.textContent = msg;
          toast.classList.add('show');
          setTimeout(() => {
            toast.classList.remove('show');
          }, duration);
        }
      }

      async function undoLastAction() {
        if (undoStack.length === 0) return;
        
        const action = undoStack.pop();
        const toast = document.getElementById('undoToast');
        if (toast) toast.classList.remove('show');
        
        try {
          if (action.type === 'remove_face') {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ª–∏—Ü–æ –≤ –∫–ª–∞—Å—Ç–µ—Ä
            const resp = await fetch(`/api/face-clusters/${action.cluster_id}/add-face`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ face_rectangle_id: action.face_rectangle_id }),
            });
            if (resp.ok) {
              showToast('–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
              loadCluster();
            } else {
              const err = await resp.json();
              showToast(`–û—à–∏–±–∫–∞: ${err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            }
          } else if (action.type === 'ignore_face') {
            // –£–±–∏—Ä–∞–µ–º ignore_flag
            const resp = await fetch(`/api/face-rectangles/${action.face_rectangle_id}/unignore`, {
              method: 'POST',
            });
            if (resp.ok) {
              showToast('–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
              loadCluster();
            } else {
              const err = await resp.json();
              showToast(`–û—à–∏–±–∫–∞: ${err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            }
          } else if (action.type === 'move_face') {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ª–∏—Ü–æ –≤ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –∫–ª–∞—Å—Ç–µ—Ä (target_cluster_id) –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫, –∞ source_cluster_id –∫–∞–∫ —Ü–µ–ª—å
            const resp = await fetch(`/api/face-clusters/${action.target_cluster_id}/move-face-to-cluster`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                face_rectangle_id: action.face_rectangle_id,
                target_cluster_id: action.source_cluster_id,
              }),
            });
            if (resp.ok) {
              showToast('–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
              // –û–±–Ω–æ–≤–ª—è–µ–º clusterId –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
              const pathParts = window.location.pathname.split('/').filter(p => p);
              const currentClusterId = parseInt(pathParts[pathParts.length - 1]) || 0;
              if (currentClusterId === action.target_cluster_id) {
                // –ï—Å–ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ü–µ–ª–µ–≤–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
                loadCluster();
              } else {
                // –ï—Å–ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
                loadCluster();
              }
            } else {
              const err = await resp.json();
              showToast(`–û—à–∏–±–∫–∞: ${err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            }
          }
        } catch (e) {
          showToast(`–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã: ${e}`);
        }
      }

      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.style.display = 'none';
          console.log('–ú–æ–¥–∞–ª –∑–∞–∫—Ä—ã—Ç —á–µ—Ä–µ–∑ closeModal:', modalId);
        } else {
          console.error('–ú–æ–¥–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω:', modalId);
        }
        // –û—á–∏—â–∞–µ–º currentAssignFaceId –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∞
        if (modalId === 'modalAssignPerson') {
          window.currentAssignFaceId = null;
        }
      }

      function openModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
      }

      async function loadPersons() {
        try {
          const resp = await fetch('/api/persons/list');
          const data = await resp.json();
          persons = data.persons || [];
          
          const select = document.getElementById('selectAssignPerson');
          select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω—É...</option>';
          
          // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω –ø–æ –≥—Ä—É–ø–ø–∞–º
          const groupedPersons = {};
          const noGroupPersons = [];
          
          for (const p of persons) {
            if (p.is_ignored) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ"
            const groupName = p.group || null;
            if (groupName) {
              if (!groupedPersons[groupName]) {
                groupedPersons[groupName] = {
                  order: p.group_order || 999,
                  persons: []
                };
              }
              groupedPersons[groupName].persons.push(p);
            } else {
              noGroupPersons.push(p);
            }
          }
          
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≥—Ä—É–ø–ø—ã –ø–æ order
          const sortedGroups = Object.entries(groupedPersons).sort((a, b) => {
            return a[1].order - b[1].order;
          });
          
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã –ø–æ –∏–º–µ–Ω–∏
          for (const [groupName, groupData] of sortedGroups) {
            groupData.persons.sort((a, b) => {
              const nameA = (a.name || '').toLowerCase();
              const nameB = (b.name || '').toLowerCase();
              return nameA.localeCompare(nameB);
            });
          }
          
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω –±–µ–∑ –≥—Ä—É–ø–ø—ã –ø–æ –∏–º–µ–Ω–∏
          noGroupPersons.sort((a, b) => {
            const nameA = (a.name || '').toLowerCase();
            const nameB = (b.name || '').toLowerCase();
            return nameA.localeCompare(nameB);
          });
          
          // –†–µ–Ω–¥–µ—Ä–∏–º –≥—Ä—É–ø–ø—ã
          for (const [groupName, groupData] of sortedGroups) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = groupName;
            for (const p of groupData.persons) {
              const opt = document.createElement('option');
              opt.value = p.id;
              opt.textContent = p.name + (p.is_me ? ' (—è)' : '');
              optgroup.appendChild(opt);
            }
            select.appendChild(optgroup);
          }
          
          // –†–µ–Ω–¥–µ—Ä–∏–º –ø–µ—Ä—Å–æ–Ω –±–µ–∑ –≥—Ä—É–ø–ø—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
          if (noGroupPersons.length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = '–ë–µ–∑ –≥—Ä—É–ø–ø—ã';
            for (const p of noGroupPersons) {
              const opt = document.createElement('option');
              opt.value = p.id;
              opt.textContent = p.name + (p.is_me ? ' (—è)' : '');
              optgroup.appendChild(opt);
            }
            select.appendChild(optgroup);
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω:', e);
        }
      }

      async function loadCluster() {
        // #region agent log
        try {
          await fetch('/api/debug/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              location: 'face_cluster_detail.html:371',
              message: 'loadCluster called',
              data: { clusterId: clusterId },
              timestamp: Date.now(),
              sessionId: 'debug-session',
              runId: 'pre-fix',
              hypothesisId: 'D'
            })
          }).catch(() => {});
        } catch (e) {}
        // #endregion
        try {
          // #region agent log
          try {
            await fetch('/api/debug/log', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                location: 'face_cluster_detail.html:375',
                message: 'before fetch',
                data: { url: `/api/face-clusters/${clusterId}` },
                timestamp: Date.now(),
                sessionId: 'debug-session',
                runId: 'pre-fix',
                hypothesisId: 'D'
              })
            }).catch(() => {});
          } catch (e) {}
          // #endregion
          const resp = await fetch(`/api/face-clusters/${clusterId}`, {
            method: 'GET',
            headers: { 'Accept': 'application/json' },
          });
          // #region agent log
          try {
            await fetch('/api/debug/log', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                location: 'face_cluster_detail.html:380',
                message: 'after fetch',
                data: { status: resp.status, statusText: resp.statusText, ok: resp.ok },
                timestamp: Date.now(),
                sessionId: 'debug-session',
                runId: 'pre-fix',
                hypothesisId: 'D'
              })
            }).catch(() => {});
          } catch (e) {}
          // #endregion
          if (!resp.ok) {
            const errorText = await resp.text();
            // #region agent log
            try {
              await fetch('/api/debug/log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  location: 'face_cluster_detail.html:384',
                  message: 'fetch not ok',
                  data: { status: resp.status, statusText: resp.statusText, errorText: errorText },
                  timestamp: Date.now(),
                  sessionId: 'debug-session',
                  runId: 'pre-fix',
                  hypothesisId: 'D'
                })
              }).catch(() => {});
            } catch (e) {}
            // #endregion
            throw new Error(`HTTP ${resp.status}: ${resp.statusText}. ${errorText}`);
          }
          clusterInfo = await resp.json();
          // #region agent log
          try {
            await fetch('/api/debug/log', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                location: 'face_cluster_detail.html:388',
                message: 'clusterInfo loaded',
                data: {
                  cluster_id: clusterInfo?.cluster_id,
                  total_faces: clusterInfo?.total_faces,
                  faces_count: clusterInfo?.faces?.length,
                  persons_count: clusterInfo?.persons?.length
                },
                timestamp: Date.now(),
                sessionId: 'debug-session',
                runId: 'pre-fix',
                hypothesisId: 'D'
              })
            }).catch(() => {});
          } catch (e) {}
          // #endregion
          
          document.getElementById('clusterId').textContent = clusterId;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É "–Ω–∞–∑–∞–¥" –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –Ω–∞–∑–Ω–∞—á–µ–Ω –ª–∏ –∫–ª–∞—Å—Ç–µ—Ä –ø–µ—Ä—Å–æ–Ω–µ
          const backLink = document.getElementById('backLink');
          if (backLink && clusterInfo.persons && clusterInfo.persons.length > 0) {
            // –ï—Å–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω –ø–µ—Ä—Å–æ–Ω–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –ø–µ—Ä—Å–æ–Ω—ã
            const personId = clusterInfo.persons[0].id; // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –ø–µ—Ä—Å–æ–Ω—É
            backLink.href = `/persons/${personId}/clusters`;
            backLink.textContent = `‚Üê –∫ –∫–ª–∞—Å—Ç–µ—Ä–∞–º –ø–µ—Ä—Å–æ–Ω—ã`;
          } else {
            // –ï—Å–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö
            backLink.href = `/face-clusters`;
            backLink.textContent = `‚Üê –∫ –Ω–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–º –∫–ª–∞—Å—Ç–µ—Ä–∞–º`;
          }
          
          const totalFaces = clusterInfo.total_faces || 0;
          const personNames = (clusterInfo.persons || []).map(p => p.name).join(', ');
          
          document.getElementById('facesCount').textContent = totalFaces;
          document.getElementById('clusterInfo').textContent = 
            `${totalFaces} –ª–∏—Ü | Run ${clusterInfo.run_id || '?'}${personNames ? ` | ${personNames}` : ' | –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ'}`;
          
          const meta = document.getElementById('clusterMeta');
          meta.innerHTML = `
            <span class="pill">–ú–µ—Ç–æ–¥: ${clusterInfo.method || '?'}</span>
            <span class="pill">–°–æ–∑–¥–∞–Ω: ${clusterInfo.created_at ? new Date(clusterInfo.created_at).toLocaleString('ru-RU') : '?'}</span>
            ${personNames ? `<span class="pill">–ü–µ—Ä—Å–æ–Ω–∞: ${personNames}</span>` : ''}
          `;
          
          const faces = clusterInfo.faces || clusterInfo.example_faces || [];
          
          // –†–∞–∑–¥–µ–ª—è–µ–º –ª–∏—Ü–∞ –Ω–∞ –∞—Ä—Ö–∏–≤–Ω—ã–µ –∏ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–≥–æ–Ω–∞
          const archiveGrid = document.getElementById('facesGridArchiveContent');
          const runGrid = document.getElementById('facesGridRunContent');
          const archiveSection = document.getElementById('facesGridArchive');
          const runSection = document.getElementById('facesGridRun');
          
          if (!archiveGrid || !runGrid || !archiveSection || !runSection) {
            console.error('Grid elements not found');
            return;
          }
          
          const archiveFaces = faces.filter(f => f.is_archive);
          const runFaces = faces.filter(f => f.is_run);
          
          // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –æ–¥–Ω–æ–≥–æ –ª–∏—Ü–∞
          const renderFace = (face) => {
            const thumbData = face.thumb_jpeg_base64 ? 
              `data:image/jpeg;base64,${face.thumb_jpeg_base64}` : 
              null;
            
            const fileName = face.file_path ? face.file_path.split(/[/\\]/).pop() : '?';
            const escapedPath = (face.file_path || '').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            const bboxJson = face.bbox ? JSON.stringify(face.bbox).replace(/"/g, '&quot;') : '';
            return `
              <div class="thumb" title="${escapedPath}" data-face-id="${face.face_id}" data-file-path="${escapedPath}" data-bbox="${bboxJson}" ondblclick="handleFaceDoubleClick(this)">
                ${thumbData ? `<img src="${thumbData}" alt="${fileName}" />` : '<div class="noimg">–ù–µ—Ç –ø—Ä–µ–≤—å—é</div>'}
                <button class="remove-btn" onclick="event.stopPropagation(); removeFace(${face.face_id})" title="–ò—Å–∫–ª—é—á–∏—Ç—å –∏–∑ –∫–ª–∞—Å—Ç–µ—Ä–∞">‚úï</button>
                <div class="face-actions">
                  <button class="face-btn" onclick="event.stopPropagation(); ignoreFace(${face.face_id})" title="–≠—Ç–æ –Ω–µ –ª–∏—Ü–æ">–ù–µ –ª–∏—Ü–æ</button>
                  <button class="face-btn" onclick="event.stopPropagation(); moveToOtherCluster(${face.face_id})" title="–≠—Ç–æ –¥—Ä—É–≥–æ–π —á–µ–ª–æ–≤–µ–∫">–î—Ä—É–≥–æ–π</button>
                </div>
              </div>
            `;
          };
          
          // –†–µ–Ω–¥–µ—Ä–∏–º –∞—Ä—Ö–∏–≤–Ω—ã–µ –ª–∏—Ü–∞
          if (archiveFaces.length === 0) {
            archiveSection.style.display = 'none';
          } else {
            archiveSection.style.display = 'block';
            archiveGrid.innerHTML = archiveFaces.map(renderFace).join('');
          }
          
          // –†–µ–Ω–¥–µ—Ä–∏–º –ª–∏—Ü–∞ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–≥–æ–Ω–∞
          if (runFaces.length === 0) {
            runSection.style.display = 'none';
          } else {
            runSection.style.display = 'block';
            runGrid.innerHTML = runFaces.map(renderFace).join('');
          }
          
          // –ï—Å–ª–∏ –Ω–µ—Ç –ª–∏—Ü –≤–æ–æ–±—â–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          if (faces.length === 0) {
            archiveSection.style.display = 'block';
            archiveGrid.innerHTML = '<div class="muted">–ù–µ—Ç –ª–∏—Ü –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ</div>';
            runSection.style.display = 'none';
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤ gold" –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–∞—è –ø–µ—Ä—Å–æ–Ω–∞
          updateConfirmToGoldButton();
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ"
          const btnIgnored = document.getElementById('btnAssignIgnored');
          const ignoredPerson = persons.find(p => p.is_ignored);
          if (btnIgnored && ignoredPerson) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω –∏–ª–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–µ –Ω–∞ "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ"
            const hasPerson = clusterInfo.persons && clusterInfo.persons.length > 0;
            const isIgnored = hasPerson && clusterInfo.persons.some(p => p.id === ignoredPerson.id);
            btnIgnored.style.display = isIgnored ? 'none' : 'inline-block';
          }
        } catch (e) {
          // #region agent log
          try {
            await fetch('/api/debug/log', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                location: 'face_cluster_detail.html:575',
                message: 'loadCluster exception',
                data: {
                  error: e instanceof Error ? e.message : String(e),
                  error_type: e instanceof Error ? e.constructor.name : typeof e,
                  clusterId: clusterId
                },
                timestamp: Date.now(),
                sessionId: 'debug-session',
                runId: 'pre-fix',
                hypothesisId: 'D'
              })
            }).catch(() => {});
          } catch (e2) {}
          // #endregion
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞:', e);
          const errorMsg = e instanceof Error ? e.message : String(e);
          if (errorMsg.includes('Failed to fetch') || errorMsg.includes('NetworkError')) {
            showToast('–û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://127.0.0.1:8000', true);
          } else {
            showToast(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞: ${errorMsg}`, true);
          }
        }
      }

      function assignCluster() {
        openModal('modalAssignPerson');
      }

      async function assignIgnoredPerson() {
        const ignoredPerson = persons.find(p => p.is_ignored);
        if (!ignoredPerson) {
          showToast('–ü–µ—Ä—Å–æ–Ω–∞ "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', true);
          return;
        }
        
        try {
          const resp = await fetch(`/api/face-clusters/${clusterId}/assign-person`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ person_id: ignoredPerson.id }),
          });
          
          if (resp.ok) {
            showToast('–ö–ª–∞—Å—Ç–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ"');
            await loadCluster();
          } else {
            const err = await resp.json();
            showToast(`–û—à–∏–±–∫–∞: ${err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ "–ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ":', e);
          showToast(`–û—à–∏–±–∫–∞: ${e.message}`);
        }
      }

      async function assignPerson() {
        console.log('assignPerson –≤—ã–∑–≤–∞–Ω–∞, currentAssignFaceId:', window.currentAssignFaceId);
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä –∏–ª–∏ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ª–∏—Ü–æ
        if (window.currentAssignFaceId) {
          console.log('–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ª–∏—Ü–æ, –≤—ã–∑—ã–≤–∞–µ–º assignPersonToFace');
          await assignPersonToFace();
          return;
        }
        
        console.log('–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä');
        const personId = document.getElementById('selectAssignPerson').value;
        if (!personId || !clusterId) {
          console.log('–ü–µ—Ä—Å–æ–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –∏–ª–∏ –Ω–µ—Ç clusterId');
          return;
        }
        
        try {
          console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø–µ—Ä—Å–æ–Ω–µ:', { clusterId, personId });
          const resp = await fetch(`/api/face-clusters/${clusterId}/assign-person`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ person_id: parseInt(personId) }),
          });
          
          if (resp.ok) {
            console.log('–ö–ª–∞—Å—Ç–µ—Ä —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω –ø–µ—Ä—Å–æ–Ω–µ');
            closeModal('modalAssignPerson');
            window.currentAssignFaceId = null;
            await loadCluster();
          } else {
            const err = await resp.json();
            console.error('–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞:', e);
        }
      }
      
      async function openAssignPersonModalForFace(faceRectangleId) {
        console.log('openAssignPersonModalForFace –≤—ã–∑–≤–∞–Ω–∞ —Å face_id:', faceRectangleId);
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º face_rectangle_id –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        window.currentAssignFaceId = faceRectangleId;
        console.log('currentAssignFaceId —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', window.currentAssignFaceId);
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω—ã
        const modal = document.getElementById('modalAssignPerson');
        console.log('–ú–æ–¥–∞–ª –Ω–∞–π–¥–µ–Ω:', !!modal);
        if (modal) {
          openModal('modalAssignPerson');
          console.log('–ú–æ–¥–∞–ª –æ—Ç–∫—Ä—ã—Ç');
        } else {
          console.error('–ú–æ–¥–∞–ª modalAssignPerson –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        }
      }
      
      async function assignPersonToFace() {
        const faceRectangleId = window.currentAssignFaceId;
        console.log('assignPersonToFace –≤—ã–∑–≤–∞–Ω–∞, faceRectangleId:', faceRectangleId);
        if (!faceRectangleId) {
          console.error('–ù–µ—Ç face_rectangle_id –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è');
          return;
        }
        
        const personId = document.getElementById('selectAssignPerson').value;
        console.log('–í—ã–±—Ä–∞–Ω–Ω–∞—è –ø–µ—Ä—Å–æ–Ω–∞ ID:', personId);
        if (!personId) {
          console.log('–ü–µ—Ä—Å–æ–Ω–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞');
          return;
        }
        
        try {
          console.log('–ò—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π –∫–ª–∞—Å—Ç–µ—Ä –¥–ª—è –ª–∏—Ü–∞:', faceRectangleId);
          // –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π –∫–ª–∞—Å—Ç–µ—Ä –¥–ª—è —ç—Ç–æ–≥–æ –ª–∏—Ü–∞
          const findResp = await fetch(`/api/face-rectangles/${faceRectangleId}/find-cluster`, {
            method: 'POST',
          });
          
          if (!findResp.ok) {
            const err = await findResp.json();
            console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞:', err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            return;
          }
          
          const findData = await findResp.json();
          console.log('–ù–∞–π–¥–µ–Ω –∫–ª–∞—Å—Ç–µ—Ä:', findData.cluster_id);
          
          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
          const modal = document.getElementById('modalAssignPerson');
          if (modal) {
            modal.style.display = 'none';
            console.log('–ú–æ–¥–∞–ª –∑–∞–∫—Ä—ã—Ç');
          }
          window.currentAssignFaceId = null;
          
          if (!findData.cluster_id) {
            console.log('–ë–ª–∏–∂–∞–π—à–∏–π –∫–ª–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω - –Ω–∞–∑–Ω–∞—á–∞–µ–º –ø–µ—Ä—Å–æ–Ω—É –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ face_rectangle');
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –ø–µ—Ä—Å–æ–Ω—É –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ face_rectangle
            const assignFaceResp = await fetch(`/api/face-rectangles/${faceRectangleId}/assign-person`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ person_id: parseInt(personId) }),
            });
            
            if (assignFaceResp.ok) {
              const assignData = await assignFaceResp.json();
              console.log('–ü–µ—Ä—Å–æ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –Ω–∞ –ª–∏—Ü–æ:', assignData);
              if (assignData.cluster_id) {
                console.log(`‚úÖ –õ–∏—Ü–æ –ø–æ–ø–∞–ª–æ –≤ –∫–ª–∞—Å—Ç–µ—Ä #${assignData.cluster_id}`);
              } else {
                console.log('‚ö†Ô∏è –õ–∏—Ü–æ –Ω–µ –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ (cluster_id = null). –ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–µ—Ä—Å–æ–Ω—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –µ—ë –ª–∏—Ü.');
              }
              // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ª–∏—Ü–∞—Ö –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
              if (currentFilePath) {
                fetch(`/api/file-faces?file_path=${encodeURIComponent(currentFilePath)}`)
                  .then(res => res.json())
                  .then(data => {
                    allFacesOnImage = data.faces || [];
                    // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞
                    const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                                 clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
                    const originalImageSize = face?.image_size;
                    if (drawAllFaceRectanglesFromModule) {
                      drawAllFaceRectanglesFromModule(allFacesOnImage || [], currentFaceId, originalImageSize, null);
                    }
                    drawFaceRectangleLocal();
                  })
                  .catch(err => {
                    console.error('Failed to reload faces:', err);
                  });
              }
            } else {
              const err = await assignFaceResp.json();
              console.error('–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω—ã:', err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
            return;
          }
          
          console.log('–ù–∞–∑–Ω–∞—á–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä –ø–µ—Ä—Å–æ–Ω–µ:', { cluster_id: findData.cluster_id, person_id: parseInt(personId) });
          // –ù–∞–∑–Ω–∞—á–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä –ø–µ—Ä—Å–æ–Ω–µ
          const assignResp = await fetch(`/api/face-clusters/${findData.cluster_id}/assign-person`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ person_id: parseInt(personId) }),
          });
          
          console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', assignResp.status, assignResp.statusText);
          
          if (assignResp.ok) {
            console.log('–ö–ª–∞—Å—Ç–µ—Ä —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω –ø–µ—Ä—Å–æ–Ω–µ, –æ–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ª–∏—Ü–∞—Ö –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
            if (currentFilePath) {
              console.log('–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ª–∏—Ü–∞—Ö –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏:', currentFilePath);
              fetch(`/api/file-faces?file_path=${encodeURIComponent(currentFilePath)}`)
                .then(res => res.json())
                .then(data => {
                  console.log('–ü–æ–ª—É—á–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –ª–∏—Ü–∞—Ö:', data.faces?.length);
                  allFacesOnImage = data.faces || [];
                  // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞
                  const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                               clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
                  const originalImageSize = face?.image_size;
                  if (drawAllFaceRectanglesFromModule) {
                    drawAllFaceRectanglesFromModule(allFacesOnImage || [], currentFaceId, originalImageSize, null);
                  }
                  drawFaceRectangleLocal();
                })
                .catch(err => {
                  console.error('Failed to reload faces:', err);
                });
            }
          } else {
            const err = await assignResp.json();
            console.error('–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞:', e);
          // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª –¥–∞–∂–µ –ø—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–∏
          const modal = document.getElementById('modalAssignPerson');
          if (modal) {
            modal.style.display = 'none';
          }
          window.currentAssignFaceId = null;
        }
      }
      
      async function removeFace(faceRectangleId) {
        try {
          const resp = await fetch(`/api/face-clusters/${clusterId}/remove-face`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ face_rectangle_id: faceRectangleId }),
          });
          
          if (resp.ok) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è undo
            undoStack.push({
              type: 'remove_face',
              face_rectangle_id: faceRectangleId,
              cluster_id: clusterId,
            });
            showUndoToast('–õ–∏—Ü–æ –∏—Å–∫–ª—é—á–µ–Ω–æ –∏–∑ –∫–ª–∞—Å—Ç–µ—Ä–∞');
            loadCluster();
          } else {
            const err = await resp.json();
            showToast(`–û—à–∏–±–∫–∞: ${err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
          }
        } catch (e) {
          showToast(`–û—à–∏–±–∫–∞: ${e}`);
        }
      }

      async function findClusterForFace(faceRectangleId) {
        try {
          // –ò—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π –∫–ª–∞—Å—Ç–µ—Ä –¥–ª—è —ç—Ç–æ–≥–æ –ª–∏—Ü–∞
          const resp = await fetch(`/api/face-rectangles/${faceRectangleId}/find-cluster`, {
            method: 'POST',
          });
          
          if (resp.ok) {
            const data = await resp.json();
            if (data.cluster_id) {
              // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
              const clusterUrl = `/face-clusters/${data.cluster_id}`;
              window.open(clusterUrl, '_blank');
            }
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞:', e);
        }
      }

      async function ignoreFace(faceRectangleId) {
        try {
          const resp = await fetch(`/api/face-rectangles/${faceRectangleId}/ignore`, {
            method: 'POST',
          });
          
          if (resp.ok) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è undo
            undoStack.push({
              type: 'ignore_face',
              face_rectangle_id: faceRectangleId,
            });
            showUndoToast('–õ–∏—Ü–æ –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ "–Ω–µ –ª–∏—Ü–æ"');
            loadCluster();
          } else {
            const err = await resp.json();
            showToast(`–û—à–∏–±–∫–∞: ${err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
          }
        } catch (e) {
          showToast(`–û—à–∏–±–∫–∞: ${e}`);
        }
      }

      async function moveToOtherCluster(faceRectangleId) {
        try {
          showToast('–ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞...');
          const resp = await fetch(`/api/face-clusters/${clusterId}/move-face-to-cluster`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              face_rectangle_id: faceRectangleId,
              target_cluster_id: null,  // null = –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫
            }),
          });
          
          if (resp.ok) {
            const data = await resp.json();
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è undo
            undoStack.push({
              type: 'move_face',
              face_rectangle_id: faceRectangleId,
              source_cluster_id: clusterId,
              target_cluster_id: data.target_cluster_id,
            });
            
            if (data.target_cluster_id) {
              showUndoToast(`–õ–∏—Ü–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –∫–ª–∞—Å—Ç–µ—Ä #${data.target_cluster_id}`);
            } else {
              showUndoToast('–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–ª–∞—Å—Ç–µ—Ä –¥–ª—è —ç—Ç–æ–≥–æ –ª–∏—Ü–∞');
            }
            loadCluster();
          } else {
            const err = await resp.json();
            showToast(`–û—à–∏–±–∫–∞: ${err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
          }
        } catch (e) {
          showToast(`–û—à–∏–±–∫–∞: ${e}`);
        }
      }

      function openLightbox() {
        document.getElementById('lightbox').classList.add('open');
      }

      function closeLightbox() {
        document.getElementById('lightbox').classList.remove('open');
        currentFaceBbox = null;
        const lbRectangle = document.getElementById('lbRectangle');
        if (lbRectangle) {
          lbRectangle.style.display = 'none';
        }
      }

      function handleFaceDoubleClick(element) {
        const faceId = parseInt(element.getAttribute('data-face-id'));
        const filePath = element.getAttribute('data-file-path');
        const bboxStr = element.getAttribute('data-bbox');
        let bboxData = null;
        if (bboxStr) {
          try {
            bboxData = JSON.parse(bboxStr.replace(/&quot;/g, '"'));
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ bbox:', e);
          }
        }
        
        openFaceImage(faceId, filePath, bboxData);
      }

      function openFaceImage(faceId, filePath, bboxData) {
        // –ù–∞—Ö–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏—Ü–µ
        const faces = clusterInfo.faces || clusterInfo.example_faces || [];
        const face = faces.find(f => f.face_id === faceId);
        if (!face) {
          return;
        }
        
        const path = face.file_path || filePath;
        currentFilePath = path; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç—å –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–ø–ø–∏–Ω–≥–∞
        const lb = document.getElementById('lightbox');
        const lbPath = document.getElementById('lbPath');
        const lbImg = document.getElementById('lbImg');
        const lbOpen = document.getElementById('lbOpen');
        const lbRectangle = document.getElementById('lbRectangle');
        const lbFixClipping = document.getElementById('lbFixClipping');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–ø–∏–Ω–≥" —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–Ω–µ –¥–ª—è –≤–∏–¥–µ–æ)
        if (lbFixClipping) {
          const shouldShow = path && !path.match(/\.(mp4|mov|avi|mkv|webm|m4v|3gp)$/i);
          lbFixClipping.style.display = shouldShow ? '' : 'none';
        }
        
        if (lbPath) lbPath.textContent = path;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º faceId –∏ bbox –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
        currentFaceId = faceId;
        if (bboxData && typeof bboxData === 'object') {
          currentFaceBbox = bboxData;
        } else if (face && face.bbox) {
          currentFaceBbox = face.bbox;
        } else {
          currentFaceBbox = null;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ EXIF orientation, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        const hasImageSize = face?.image_size && face.image_size.width && face.image_size.height;
        const hasExifOrientation = face?.image_size?.exif_orientation !== null && face?.image_size?.exif_orientation !== undefined;
        if (!hasImageSize || (!hasExifOrientation && path)) {
          // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
          fetch(`/api/image-dimensions?path=${encodeURIComponent(path)}&save=true`)
            .then(res => res.json())
            .then(data => {
              if (data.ok && data.width && data.height) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤ clusterInfo –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ª–∏—Ü–∞
                if (face) {
                  face.image_size = { 
                    width: data.width, 
                    height: data.height,
                    exif_orientation: data.exif_orientation || null
                  };
                }
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º rectangles —Å –Ω–æ–≤—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏
                if (lbImg && lbImg.complete) {
                  // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞
                  const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                               clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
                  const originalImageSize = face?.image_size;
                  if (drawAllFaceRectanglesFromModule) {
                    drawAllFaceRectanglesFromModule(allFacesOnImage || [], currentFaceId, originalImageSize, null);
                  }
                  drawFaceRectangleLocal();
                }
              }
            })
            .catch(err => {
              console.error('Failed to load image dimensions:', err);
            });
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º rectangle –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if (lbRectangle) {
          lbRectangle.style.display = 'none';
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL –¥–ª—è –ø—Ä–µ–≤—å—é
        let previewUrl = '';
        let openUrl = '';
        
        if (path.startsWith('disk:')) {
          previewUrl = `/api/yadisk/preview-image?size=XL&path=${encodeURIComponent(path)}`;
          openUrl = `/api/yadisk/open?path=${encodeURIComponent(path)}`;
        } else if (path.startsWith('local:')) {
          previewUrl = `/api/local/preview?path=${encodeURIComponent(path)}`;
          openUrl = '#';
        }
        
        if (lbOpen) {
          if (openUrl && openUrl !== '#') {
            lbOpen.href = openUrl;
            lbOpen.style.display = 'inline-block';
          } else {
            lbOpen.style.display = 'none';
          }
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
        if (window.openPhotoCard) {
          // –§–æ—Ä–º–∏—Ä—É–µ–º list_context –∏–∑ –≤—Å–µ—Ö –ª–∏—Ü –∫–ª–∞—Å—Ç–µ—Ä–∞
          const allFaces = clusterInfo.faces || clusterInfo.example_faces || [];
          const currentIndex = allFaces.findIndex(f => f.face_id === currentFaceId);
          
          const items = allFaces.map(f => ({
            file_id: f.file_id || null,
            file_path: f.file_path || null,
            face_rectangle_id: f.face_id || null,
            person_rectangle_id: null
          }));
          
          const listContext = {
            source_page: "face_cluster_detail",
            items: items,
            current_index: currentIndex >= 0 ? currentIndex : 0,
            total_count: items.length,
            api_fallback: null
          };
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º pipeline_run_id –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
          const faceData = allFaces.find(f => f.face_id === currentFaceId);
          // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å pipeline_run_id –∏–∑ clusterInfo –∏–ª–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞
          const pipelineRunId = clusterInfo?.pipeline_run_id || faceData?.pipeline_run_id || faceData?.run_id || null;
          
          window.openPhotoCard({
            file_id: face?.file_id || null,
            file_path: path,
            pipeline_run_id: pipelineRunId,
            list_context: listContext,
            highlight_rectangle: {
              type: 'face_rectangle',
              id: currentFaceId
            }
          });
          return; // –í—ã—Ö–æ–¥–∏–º, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π lightbox
        }
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º lightbox —Å—Ä–∞–∑—É, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (fallback)
        openLightbox();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ª–∏—Ü–∞ –Ω–∞ —ç—Ç–æ–º —Ñ–æ—Ç–æ
        console.log('openFaceImage: –∑–∞–≥—Ä—É–∂–∞–µ–º –ª–∏—Ü–∞, currentFaceId=', currentFaceId, '—Ç–∏–ø:', typeof currentFaceId);
        fetch(`/api/file-faces?file_path=${encodeURIComponent(path)}`)
          .then(res => res.json())
          .then(data => {
            allFacesOnImage = data.faces || [];
            console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ª–∏—Ü –Ω–∞ —Ñ–æ—Ç–æ:', allFacesOnImage.length, allFacesOnImage);
            console.log('–°—Ä–∞–≤–Ω–µ–Ω–∏–µ currentFaceId —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –ª–∏—Ü–∞–º–∏:', {
              currentFaceId,
              currentFaceIdType: typeof currentFaceId,
              faceIds: allFacesOnImage.map(f => ({id: f.face_id, type: typeof f.face_id})),
              matchesStrict: allFacesOnImage.filter(f => f.face_id === currentFaceId).length,
              matchesNum: allFacesOnImage.filter(f => Number(f.face_id) === Number(currentFaceId)).length,
              matchesStr: allFacesOnImage.filter(f => String(f.face_id) === String(currentFaceId)).length
            });
            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –≤—Å–µ rectangles (–µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ)
            tryDrawAllFaces();
          })
          .catch(err => {
            console.error('Failed to load faces on image:', err);
            allFacesOnImage = [];
          });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ (–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ openFaceImage)
        function tryDrawAllFaces() {
          const lbImgCheck = document.getElementById('lbImg');
          if (lbImgCheck && lbImgCheck.complete && allFacesOnImage !== undefined) {
            console.log('tryDrawAllFaces: –≥–æ—Ç–æ–≤–æ –∫ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ', {
              imageComplete: lbImgCheck.complete,
              facesLoaded: allFacesOnImage !== undefined,
              facesCount: allFacesOnImage?.length || 0
            });
            // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞
            const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                         clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
            const originalImageSize = face?.image_size;
            if (drawAllFaceRectanglesFromModule) {
              drawAllFaceRectanglesFromModule(allFacesOnImage || [], currentFaceId, originalImageSize, null);
            }
            drawFaceRectangleLocal();
          }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        if (lbImg && previewUrl) {
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ onload
          lbImg.onload = function() {// –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –≤—Å–µ rectangles (–µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ –ª–∏—Ü–∞—Ö —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã)
            tryDrawAllFaces();
            // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä—ã –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø—ã—Ç–∞–µ–º—Å—è –∏—Ö –ø–æ–ª—É—á–∏—Ç—å
            const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                         clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
            const hasImageSize = face?.image_size && face.image_size.width && face.image_size.height;
            const hasExifOrientation = face?.image_size?.exif_orientation !== null && face?.image_size?.exif_orientation !== undefined;
            if ((!hasImageSize || (!hasExifOrientation && path)) && path) {
              // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
              fetch(`/api/image-dimensions?path=${encodeURIComponent(path)}&save=true`)
                .then(res => res.json())
                .then(data => {
                  if (data.ok && data.width && data.height) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤ clusterInfo –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ª–∏—Ü–∞
                    if (face) {
                      face.image_size = { 
                        width: data.width, 
                        height: data.height,
                        exif_orientation: data.exif_orientation || null
                      };
                    }
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º rectangle —Å –Ω–æ–≤—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏
                    requestAnimationFrame(() => {
                      requestAnimationFrame(() => {
                        // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞
                    const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                                 clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
                    const originalImageSize = face?.image_size;
                    if (drawAllFaceRectanglesFromModule) {
                      drawAllFaceRectanglesFromModule(allFacesOnImage || [], currentFaceId, originalImageSize, null);
                    }
                    drawFaceRectangleLocal();
                      });
                    });
                  } else {
                    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã, —Ä–∏—Å—É–µ–º —Å —ç–≤—Ä–∏—Å—Ç–∏–∫–æ–π
                    requestAnimationFrame(() => {
                      requestAnimationFrame(() => {
                        // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞
                    const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                                 clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
                    const originalImageSize = face?.image_size;
                    if (drawAllFaceRectanglesFromModule) {
                      drawAllFaceRectanglesFromModule(allFacesOnImage || [], currentFaceId, originalImageSize, null);
                    }
                    drawFaceRectangleLocal();
                      });
                    });
                  }
                })
                .catch(err => {
                  console.error('Failed to load image dimensions:', err);
                  // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Ä–∏—Å—É–µ–º —Å —ç–≤—Ä–∏—Å—Ç–∏–∫–æ–π
                  requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                      // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞
                    const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                                 clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
                    const originalImageSize = face?.image_size;
                    if (drawAllFaceRectanglesFromModule) {
                      drawAllFaceRectanglesFromModule(allFacesOnImage || [], currentFaceId, originalImageSize, null);
                    }
                    drawFaceRectangleLocal();
                    });
                  });
                });
            } else {
              // –†–∞–∑–º–µ—Ä—ã —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ —Ä–∏—Å—É–µ–º
              requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                  // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞
                  const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                               clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
                  const originalImageSize = face?.image_size;
                  if (drawAllFaceRectanglesFromModule) {
                    drawAllFaceRectanglesFromModule(allFacesOnImage || [], currentFaceId, originalImageSize, null);
                  }
                  drawFaceRectangleLocal();
                });
              });
            }
          };
          
          // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏ —ç—Ç–æ —Ç–æ—Ç –∂–µ URL, –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
          if (lbImg.src !== previewUrl && !lbImg.src.includes(previewUrl)) {
            lbImg.src = previewUrl;
          } else if (lbImg.complete) {
            // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏ —Ä–∏—Å—É–µ–º rectangle
            const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                         clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
            const hasImageSize = face?.image_size && face.image_size.width && face.image_size.height;
            const hasExifOrientation = face?.image_size?.exif_orientation !== null && face?.image_size?.exif_orientation !== undefined;
            if ((!hasImageSize || (!hasExifOrientation && path)) && path) {
              // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
              fetch(`/api/image-dimensions?path=${encodeURIComponent(path)}&save=true`)
                .then(res => res.json())
                .then(data => {
                  if (data.ok && data.width && data.height) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤ clusterInfo –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ª–∏—Ü–∞
                    if (face) {
                      face.image_size = { 
                        width: data.width, 
                        height: data.height,
                        exif_orientation: data.exif_orientation || null
                      };
                    }
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º rectangle —Å –Ω–æ–≤—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏
                    requestAnimationFrame(() => {
                      requestAnimationFrame(() => {
                        // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞
                    const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                                 clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
                    const originalImageSize = face?.image_size;
                    if (drawAllFaceRectanglesFromModule) {
                      drawAllFaceRectanglesFromModule(allFacesOnImage || [], currentFaceId, originalImageSize, null);
                    }
                    drawFaceRectangleLocal();
                      });
                    });
                  } else {
                    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã, —Ä–∏—Å—É–µ–º —Å —ç–≤—Ä–∏—Å—Ç–∏–∫–æ–π
                    requestAnimationFrame(() => {
                      requestAnimationFrame(() => {
                        // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞
                    const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                                 clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
                    const originalImageSize = face?.image_size;
                    if (drawAllFaceRectanglesFromModule) {
                      drawAllFaceRectanglesFromModule(allFacesOnImage || [], currentFaceId, originalImageSize, null);
                    }
                    drawFaceRectangleLocal();
                      });
                    });
                  }
                })
                .catch(err => {
                  console.error('Failed to load image dimensions:', err);
                  // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Ä–∏—Å—É–µ–º —Å —ç–≤—Ä–∏—Å—Ç–∏–∫–æ–π
                  requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                      // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞
                    const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                                 clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
                    const originalImageSize = face?.image_size;
                    if (drawAllFaceRectanglesFromModule) {
                      drawAllFaceRectanglesFromModule(allFacesOnImage || [], currentFaceId, originalImageSize, null);
                    }
                    drawFaceRectangleLocal();
                    });
                  });
                });
            } else {
              // –†–∞–∑–º–µ—Ä—ã —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ —Ä–∏—Å—É–µ–º
              requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                  // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞
                  const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                               clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
                  const originalImageSize = face?.image_size;
                  if (drawAllFaceRectanglesFromModule) {
                    drawAllFaceRectanglesFromModule(allFacesOnImage || [], currentFaceId, originalImageSize, null);
                  }
                  drawFaceRectangleLocal();
                });
              });
            }
          }
        }
      }
      

      function drawFaceRectangleLocal() {
        if (!currentFaceBbox) {
          return;
        }
        
        const lbImg = document.getElementById('lbImg');
        if (!lbImg || !lbImg.complete) {
          return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞
        const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                     clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
        const originalImageSize = face?.image_size;
        const currentPerson = clusterInfo.persons?.[0];
        
        // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –º–æ–¥—É–ª—è
        if (drawFaceRectangleFromModule) {
          drawFaceRectangleFromModule(
            currentFaceBbox,
            originalImageSize,
            currentPerson?.name,
            currentPerson?.is_me,
            clusterId // –ò—Å–ø–æ–ª—å–∑—É–µ–º clusterId –∏–∑ URL
          );
        }
      }

      async function createPersonAndAssign() {
        const name = document.getElementById('inputNewPersonName').value.trim();
        if (!name) {
          console.log('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω—ã');
          return;
        }
        
        try {
          // –°–æ–∑–¥–∞—ë–º –ø–µ—Ä—Å–æ–Ω—É
          const createResp = await fetch('/api/persons/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, mode: 'active' }),
          });
          
          if (!createResp.ok) {
            let errorMsg = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            let errorObj = null;
            try {
              errorObj = await createResp.json();
              // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º detail: –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π –∏–ª–∏ –º–∞—Å—Å–∏–≤–æ–º –æ–±—ä–µ–∫—Ç–æ–≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
              if (errorObj.detail) {
                if (Array.isArray(errorObj.detail)) {
                  errorMsg = errorObj.detail.map((e) => e.msg || JSON.stringify(e)).join('; ');
                } else {
                  errorMsg = String(errorObj.detail);
                }
              } else {
                errorMsg = errorObj.message || errorObj.error || JSON.stringify(errorObj);
              }
            } catch (e) {
              errorMsg = `HTTP ${createResp.status}: ${createResp.statusText}`;
            }
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω—ã:', errorMsg);
            return;
          }
          
          const person = await createResp.json();
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä –∏–ª–∏ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ª–∏—Ü–æ
          if (window.currentAssignFaceId) {
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ª–∏—Ü–æ
            const faceRectangleId = window.currentAssignFaceId;
            // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π –∫–ª–∞—Å—Ç–µ—Ä
            const findResp = await fetch(`/api/face-rectangles/${faceRectangleId}/find-cluster`, {
              method: 'POST',
            });
            
            if (findResp.ok) {
              const findData = await findResp.json();
              if (findData.cluster_id) {
                const assignResp = await fetch(`/api/face-clusters/${findData.cluster_id}/assign-person`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ person_id: person.id }),
                });
                
                if (assignResp.ok) {
                  closeModal('modalAssignPerson');
                  document.getElementById('inputNewPersonName').value = '';
                  window.currentAssignFaceId = null;
                  loadPersons();
                  // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ª–∏—Ü–∞—Ö –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
                  if (currentFilePath) {
                    fetch(`/api/file-faces?file_path=${encodeURIComponent(currentFilePath)}`)
                      .then(res => res.json())
                      .then(data => {
                        allFacesOnImage = data.faces || [];
                        // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞
                    const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                                 clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
                    const originalImageSize = face?.image_size;
                    if (drawAllFaceRectanglesFromModule) {
                      drawAllFaceRectanglesFromModule(allFacesOnImage || [], currentFaceId, originalImageSize, null);
                    }
                    drawFaceRectangleLocal();
                      })
                      .catch(err => {
                        console.error('Failed to reload faces:', err);
                      });
                  }
                } else {
                  const err = await assignResp.json();
                  console.error('–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
              }
            }
          } else {
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä
            const assignResp = await fetch(`/api/face-clusters/${clusterId}/assign-person`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ person_id: person.id }),
            });
            
            if (assignResp.ok) {
              closeModal('modalAssignPerson');
              document.getElementById('inputNewPersonName').value = '';
              loadPersons();
              loadCluster();
            } else {
              let errorMsg = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
              try {
                const err = await assignResp.json();
                errorMsg = err.detail || err.message || err.error || JSON.stringify(err);
              } catch (e) {
                errorMsg = `HTTP ${assignResp.status}: ${assignResp.statusText}`;
              }
              console.error('–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:', errorMsg);
            }
          }
        } catch (e) {
          const errorMsg = e instanceof Error ? e.message : (typeof e === 'object' ? JSON.stringify(e) : String(e));
          console.error('–û—à–∏–±–∫–∞:', errorMsg);
        }
      }

      function updateConfirmToGoldButton() {
        const hasPerson = (clusterInfo.persons || []).length > 0;
        const btnGold = document.getElementById('btnConfirmToGold');
        if (btnGold) {
          btnGold.style.display = hasPerson ? 'inline-block' : 'none';
          if (hasPerson) {
            const personName = clusterInfo.persons[0].name;
            btnGold.textContent = `–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤ gold (${personName}_gold)`;
          }
        }
      }

      async function confirmToGold() {
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∞—Å—Ç–µ—Ä–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–µ—Ä—Å–æ–Ω–µ
        await loadCluster();
        
        const persons = clusterInfo.persons || [];
        if (persons.length === 0) {
          showToast('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∑–Ω–∞—á—å—Ç–µ –ø–µ—Ä—Å–æ–Ω—É –∫–ª–∞—Å—Ç–µ—Ä—É');
          return;
        }
        
        const personName = persons[0].name;
        const goldName = `${personName}_gold`;
        
        if (!confirm(`–ó–∞–ø–∏—Å–∞—Ç—å –≤—Å–µ –ª–∏—Ü–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤ gold –∫–∞–∫ "${goldName}"?\n\n–≠—Ç–æ –¥–æ–±–∞–≤–∏—Ç –≤—Å–µ –ª–∏—Ü–∞ –∏–∑ –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤ —Ñ–∞–π–ª faces_manual_rects_gold.ndjson.`)) return;
        
        try {
          const resp = await fetch(`/api/face-clusters/${clusterId}/confirm-to-gold`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ person_name: goldName }),
          });
          
          if (resp.ok) {
            const data = await resp.json();
            showToast(`–ó–∞–ø–∏—Å–∞–Ω–æ –≤ gold: ${data.paths_updated} —Ñ–∞–π–ª–æ–≤, ${data.faces_count} –ª–∏—Ü`);
          } else {
            const err = await resp.json();
            showToast(`–û—à–∏–±–∫–∞: ${err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
          }
        } catch (e) {
          showToast(`–û—à–∏–±–∫–∞: ${e}`);
        }
      }

      // –ó–∞–∫—Ä—ã—Ç–∏–µ lightbox –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ Escape
      document.addEventListener('click', (e) => {
        const lb = document.getElementById('lightbox');
        if (lb && e.target === lb) {
          closeLightbox();
        }
      });
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeLightbox();
        }
      });

      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ rectangles –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
      window.addEventListener('resize', () => {
        if (document.getElementById('lightbox').classList.contains('open')) {
          // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Ü–∞
          const face = clusterInfo.faces?.find(f => f.face_id === currentFaceId) || 
                       clusterInfo.example_faces?.find(f => f.face_id === currentFaceId);
          const originalImageSize = face?.image_size;
          if (drawAllFaceRectanglesFromModule) {
            drawAllFaceRectanglesFromModule(allFacesOnImage || [], currentFaceId, originalImageSize, null);
          }
          drawFaceRectangleLocal();
        }
      });
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–ø–∏–Ω–≥"
      async function handleFixClipping() {
        console.log('[FixClipping] handleFixClipping called', { currentFilePath, clusterInfo });
        if (!currentFilePath) {
          const msg = '–ù–µ—Ç –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É. currentFilePath: ' + (currentFilePath || 'null');
          console.error('[FixClipping]', msg);
          showToast(msg, true);
          alert(msg); // –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          return;
        }
        // API —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å path - —Å–∫—Ä–∏–ø—Ç recalc_face_bbox.py —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é —Å –ë–î
        // face_run_id –∏ face_rectangle_id –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã (–¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
        const faceRunId = clusterInfo?.run_id || null;
        console.log('[FixClipping] faceRunId:', faceRunId, 'currentFaceId:', currentFaceId, 'path:', currentFilePath);
        const btn = document.getElementById('lbFixClipping');
        if (!btn) {
          console.error('[FixClipping] –ö–Ω–æ–ø–∫–∞ lbFixClipping –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
          alert('–ö–Ω–æ–ø–∫–∞ lbFixClipping –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); // –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          return;
        }
        try {
          btn.disabled = true;
          // –£–±—Ä–∞–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ - –æ–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–∏—Ö–æ
          const requestPayload = {
            path: currentFilePath,
          };
          
          // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞—ë–º face_run_id –∏–ª–∏ face_rectangle_id –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          if (faceRunId) {
            requestPayload.face_run_id = Number(faceRunId);
          } else if (currentFaceId) {
            requestPayload.face_rectangle_id = Number(currentFaceId);
          }
          
          console.log('[FixClipping] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', requestPayload);
          const resp = await fetch('/api/faces/fix-clipping', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestPayload),
          });
          console.log('[FixClipping] –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, status:', resp.status);
          if (!resp.ok) {
            let errorDetail = '';
            try {
              const errorJson = await resp.json();
              errorDetail = errorJson.detail || errorJson.error || JSON.stringify(errorJson);
            } catch {
              const errorText = await resp.text();
              errorDetail = errorText || `HTTP ${resp.status}`;
            }
            console.error('[FixClipping] HTTP –æ—à–∏–±–∫–∞:', resp.status, errorDetail);
            const errorMsg = `–û—à–∏–±–∫–∞ ${resp.status}: ${errorDetail}`;
            showToast(errorMsg, true);
            alert(errorMsg); // –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            return;
          }
          const res = await resp.json();
          console.log('[FixClipping] –†–µ–∑—É–ª—å—Ç–∞—Ç:', res);
          if (res.ok) {
            // –£–±—Ä–∞–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ - –æ–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–∏—Ö–æ
            console.log('[FixClipping] –£—Å–ø–µ—Ö: –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–æ –ª–∏—Ü:', res.updated_count || 0);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
            const savedFaceId = currentFaceId;
            const savedFilePath = currentFilePath;
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å bbox –≤ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏
            loadCluster().then(() => {
              // –ï—Å–ª–∏ lightbox –æ—Ç–∫—Ä—ã—Ç, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
              // (–¥–∞–∂–µ –µ—Å–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, thumb_jpeg –º–æ–≥ –±—ã—Ç—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω)
              if (savedFaceId) {
                // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç —Å –Ω–æ–≤—ã–º bbox
                const faceEl = document.querySelector(`[data-face-id="${savedFaceId}"]`);
                if (faceEl) {
                  // –û–±–Ω–æ–≤–ª—è–µ–º bbox –∏–∑ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–≥–æ clusterInfo –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–µ–º
                  const faces = clusterInfo.faces || clusterInfo.example_faces || [];
                  const face = faces.find(f => f.face_id === savedFaceId);
                  if (face && face.bbox) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º data-bbox –∞—Ç—Ä–∏–±—É—Ç —ç–ª–µ–º–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –ø—Ä–∏ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                    const bboxJson = JSON.stringify(face.bbox).replace(/"/g, '&quot;');
                    faceEl.setAttribute('data-bbox', bboxJson);
                    console.log('[FixClipping] –û–±–Ω–æ–≤–ª—ë–Ω data-bbox –∞—Ç—Ä–∏–±—É—Ç:', face.bbox);
                  }
                  // –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ–º lightbox, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ –∏ thumb_jpeg
                  console.log('[FixClipping] –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ–º lightbox –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                  handleFaceDoubleClick(faceEl);
                } else {
                  console.warn('[FixClipping] –≠–ª–µ–º–µ–Ω—Ç –ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:', savedFaceId);
                }
              }
            }).catch(err => {
              console.error('[FixClipping] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –∫–ª–∞—Å—Ç–µ—Ä–∞:', err);
            });
          } else {
            const errorMsg = res.detail || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞';
            console.error('[FixClipping] –û—à–∏–±–∫–∞ –≤ –æ—Ç–≤–µ—Ç–µ:', errorMsg);
            showToast(errorMsg, true);
            alert(errorMsg); // –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          }
        } catch (e) {
          const errorMsg = e?.message || String(e);
          console.error('[FixClipping] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ:', errorMsg, e);
          showToast(errorMsg, true);
          alert('–û—à–∏–±–∫–∞: ' + errorMsg); // –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        } finally {
          btn.disabled = false;
        }
      }

      function initPage() {
        try {
          const btnAssign = document.getElementById('btnAssignPerson');
          const btnIgnored = document.getElementById('btnAssignIgnored');
          const btnGold = document.getElementById('btnConfirmToGold');
          if (btnAssign) btnAssign.onclick = assignCluster;
          if (btnIgnored) btnIgnored.onclick = assignIgnoredPerson;
          if (btnGold) btnGold.onclick = confirmToGold;
          
          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–ø–∏–Ω–≥"
          const btnFixClipping = document.getElementById('lbFixClipping');
          if (btnFixClipping) {
            btnFixClipping.onclick = handleFixClipping;
          }
          
          loadPersons();
          loadCluster();
        } catch (e) {
          console.error('initPage error:', e);
        }
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPage);
      } else {
        initPage();
      }
    </script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –µ–¥–∏–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π -->
    {% include "photo_card.html" %}
    <script src="/static/photo_card.js?v=47"></script>
  </body>
</html>
