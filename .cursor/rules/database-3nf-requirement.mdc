---
alwaysApply: true
---
# Требование соблюдения 3NF при модификации БД

## Цель
Обеспечить нормализованную структуру БД и предотвратить избыточность данных.

## Правило

**При любой модификации схемы БД (создание/изменение таблиц, добавление колонок) НУЖНО СТРОГО соблюдать 3NF (третью нормальную форму).**

### Что такое 3NF

3NF требует:
1. Таблица в 2NF (все неключевые атрибуты полностью зависят от первичного ключа)
2. Нет транзитивных зависимостей (неключевые атрибуты не зависят от других неключевых атрибутов)

**Основное правило:** Если данные можно получить через JOIN по FOREIGN KEY, их НЕ нужно дублировать в таблице.

### Примеры нарушений 3NF

❌ **НЕПРАВИЛЬНО:**
- Хранить `file_path` в таблице, где есть `file_id` (FK на `files.id`) - путь можно получить через JOIN
- Хранить `faces_manual_label` в `files`, если есть `files_manual_labels` с FK на `files.id`
- Дублировать колонки из связанной таблицы через FK

✅ **ПРАВИЛЬНО:**
- Использовать только `file_id` (FK), получать `file_path` через JOIN к `files.path`
- Хранить метки только в `files_manual_labels`, получать через JOIN при необходимости

### Исключения

**Исключения из 3NF разрешены ТОЛЬКО:**
1. Для улучшения производительности (избежание JOIN в критичных запросах)
2. С явным согласованием с пользователем**Процесс согласования исключения:**
1. Ассистент предлагает исключение с обоснованием (какой запрос будет быстрее, на сколько)
2. Пользователь явно подтверждает исключение
3. В комментарии к схеме БД указывается причина исключения

**Пример комментария:**
```sql
-- ИСКЛЮЧЕНИЕ ИЗ 3NF: file_path дублируется для производительности
-- Обоснование: запросы по file_path выполняются 1000+ раз в секунду,
-- JOIN к files.path добавляет 5-10ms задержку
-- Согласовано: [дата] [пользователь]
file_path TEXT NOT NULL,  -- Дублирование для производительности
file_id INTEGER NOT NULL,  -- FK на files.id
```

### Проверка перед модификацией

Перед любым изменением схемы БД:
1. Проверить, не дублируются ли данные через FK
2. Если есть дублирование - предложить убрать или обосновать исключение
3. Если исключение - получить согласование пользователя### Инструменты проверки

Использовать скрипты для проверки нормализации:
- `backend/scripts/debug/check_normalization.py` - проверка 3NF
- `backend/scripts/debug/analyze_files_manual_columns_usage.py` - анализ использования колонок

### История нарушений

Известные нарушения 3NF, которые были исправлены:
- ✅ `file_path`/`path` в 7 таблицах (исправлено в ЭТАП 1.8, 2026-01-21)
- ✅ `*_manual_*` колонки в `files` (исправлено в ЭТАП 1.9, 2026-01-21)

**Текущее состояние:** БД приведена к 3NF, все избыточности удалены.
